(window.webpackJsonp=window.webpackJsonp||[]).push([[5],{1242:function(e,t){!function(e){e.plot.plugins.push({init:function(t){var a={first:{x:-1,y:-1},second:{x:-1,y:-1},show:!1,active:!1},r={},n=null;function i(e){a.active&&(h(e),t.getPlaceholder().trigger("plotselecting",[o()]))}function s(i){1==i.which&&(document.body.focus(),void 0!==document.onselectstart&&null==r.onselectstart&&(r.onselectstart=document.onselectstart,document.onselectstart=function(){return!1}),void 0!==document.ondrag&&null==r.ondrag&&(r.ondrag=document.ondrag,document.ondrag=function(){return!1}),c(a.first,i),a.active=!0,n=function(e){!function(e){n=null,void 0!==document.onselectstart&&(document.onselectstart=r.onselectstart),void 0!==document.ondrag&&(document.ondrag=r.ondrag),a.active=!1,h(e),m()?l(e):(t.getPlaceholder().trigger("plotunselected",[]),t.getPlaceholder().trigger("plotselecting",[null])),setTimeout(function(){t.isSelecting=!1},10)}(e)},e(document).one("mouseup",n))}function o(){if(!m())return null;if(!a.show)return null;var r={},n=a.first,i=a.second,s=t.getAxes();return e.each(s,function(e,t){t.used&&(anyUsed=!1)}),e.each(s,function(e,t){t.used;var a=t.c2p(n[t.direction]),s=t.c2p(i[t.direction]);r[e]={from:Math.min(a,s),to:Math.max(a,s)}}),r}function l(e){var a=o();a.ctrlKey=e.ctrlKey,a.metaKey=e.metaKey,t.getPlaceholder().trigger("plotselected",[a]),a.xaxis&&a.yaxis&&t.getPlaceholder().trigger("selected",[{x1:a.xaxis.from,y1:a.yaxis.from,x2:a.xaxis.to,y2:a.yaxis.to}])}function u(e,t,a){return t<e?e:t>a?a:t}function c(e,r){var n=t.getOptions(),i=t.getPlaceholder().offset(),s=t.getPlotOffset();e.x=u(0,r.pageX-i.left-s.left,t.width()),e.y=u(0,r.pageY-i.top-s.top,t.height()),"y"==n.selection.mode&&(e.x=e==a.first?0:t.width()),"x"==n.selection.mode&&(e.y=e==a.first?0:t.height())}function h(e){null!=e.pageX&&(c(a.second,e),m()?(t.isSelecting=!0,a.show=!0,t.triggerRedrawOverlay()):p(!0))}function p(e){a.show&&(a.show=!1,t.triggerRedrawOverlay(),e||t.getPlaceholder().trigger("plotunselected",[]))}function d(e,a){var r,n,i,s,o=t.getAxes();for(var l in o)if((r=o[l]).direction==a&&(e[s=a+r.n+"axis"]||1!=r.n||(s=a+"axis"),e[s])){n=e[s].from,i=e[s].to;break}if(e[s]||(r="x"==a?t.getXAxes()[0]:t.getYAxes()[0],n=e[a+"1"],i=e[a+"2"]),null!=n&&null!=i&&n>i){var u=n;n=i,i=u}return{from:n,to:i,axis:r}}function m(){var e=t.getOptions().selection.minSize;return Math.abs(a.second.x-a.first.x)>=e&&Math.abs(a.second.y-a.first.y)>=e}t.clearSelection=p,t.setSelection=function(e,r){var n,i=t.getOptions();"y"==i.selection.mode?(a.first.x=0,a.second.x=t.width()):(n=d(e,"x"),a.first.x=n.axis.p2c(n.from),a.second.x=n.axis.p2c(n.to)),"x"==i.selection.mode?(a.first.y=0,a.second.y=t.height()):(n=d(e,"y"),a.first.y=n.axis.p2c(n.from),a.second.y=n.axis.p2c(n.to)),a.show=!0,t.triggerRedrawOverlay(),!r&&m()&&l()},t.getSelection=o,t.hooks.bindEvents.push(function(e,t){null!=e.getOptions().selection.mode&&(t.mousemove(i),t.mousedown(s))}),t.hooks.drawOverlay.push(function(t,r){if(a.show&&m()){var n=t.getPlotOffset(),i=t.getOptions();r.save(),r.translate(n.left,n.top);var s=e.color.parse(i.selection.color);r.strokeStyle=s.scale("a",.8).toString(),r.lineWidth=1,r.lineJoin=i.selection.shape,r.fillStyle=s.scale("a",.4).toString();var o=Math.min(a.first.x,a.second.x)+.5,l=Math.min(a.first.y,a.second.y)+.5,u=Math.abs(a.second.x-a.first.x)-1,c=Math.abs(a.second.y-a.first.y)-1;r.fillRect(o,l,u,c),r.strokeRect(o,l,u,c),r.restore()}}),t.hooks.shutdown.push(function(t,a){a.unbind("mousemove",i),a.unbind("mousedown",s),n&&e(document).unbind("mouseup",n)})},options:{selection:{mode:null,color:"#e8cfac",shape:"round",minSize:5}},name:"selection",version:"1.1"})}(jQuery)},1243:function(e,t){!function(e){jQuery.plot.plugins.push({init:function(e){e.hooks.processDatapoints.push(function(e,t,a){if(null!=t.stack&&!1!==t.stack){var r=function(e,t){for(var a=null,r=0;r<t.length&&e!=t[r];++r)t[r].stack==e.stack&&(a=t[r]);return a}(t,e.getData());if(r){for(var n,i,s,o,l,u,c,h,p=a.pointsize,d=a.points,m=r.datapoints.pointsize,f=r.datapoints.points,g=[],v=t.lines.show,y=t.bars.horizontal,b=p>2&&(y?a.format[2].x:a.format[2].y),S=v&&t.lines.steps,x=y?1:0,w=y?0:1,T=0,C=0;!(T>=d.length&&C>=f.length);){if(c=g.length,T<d.length&&null==d[T]){for(h=0;h<p;++h)g.push(d[T+h]);T+=p}else if(T>=d.length){for(h=0;h<p;++h)g.push(f[C+h]);b&&(g[c+2]=f[C+w]),C+=m}else if(C>=f.length){for(h=0;h<p;++h)g.push(d[T+h]);T+=p}else if(C<f.length&&null==f[C])C+=m;else{if(n=d[T+x],i=d[T+w],o=f[C+x],l=f[C+w],u=0,n==o){for(h=0;h<p;++h)g.push(d[T+h]);g[c+w]+=l,u=l,T+=p,C+=m}else if(n>o){if(0==T){for(h=0;h<p;++h)g.push(f[C+h]);u=l}if(T>0&&null!=d[T-p]){for(s=i+(d[T-p+w]-i)*(o-n)/(d[T-p+x]-n),g.push(o),g.push(s+l),h=2;h<p;++h)g.push(d[T+h]);u=l}C+=m}else{for(h=0;h<p;++h)g.push(d[T+h]);C>0&&null!=f[C-m]&&(u=l+(f[C-m+w]-l)*(n-o)/(f[C-m+x]-o)),g[c+w]+=u,T+=p}fromgap=!1,c!=g.length&&b&&(g[c+2]=u)}if(S&&c!=g.length&&c>0&&null!=g[c]&&g[c]!=g[c-p]&&g[c+1]!=g[c-p+1]){for(h=0;h<p;++h)g[c+p+h]=g[c+h];g[c+1]=g[c-p+1]}}a.points=g}}})},options:{series:{stack:null}},name:"stack",version:"1.2"})}()},1244:function(e,t){!function(e){jQuery.plot.plugins.push({init:function(e){var t={},a=!1,r={};function n(e){var t=e.length,a={};if(t>0)for(var r=0;r<t;r++)if(e[r].stackpercent){var n=0,i=1;e[r].bars&&e[r].bars.horizontal&&!0===e[r].bars.horizontal&&(n=1,i=0);for(var s=e[r].data.length,o=0;o<s;o++){var l=0;null!=e[r].data[o][1]&&(l=e[r].data[o][i]),a[e[r].data[o][n]+""]?a[e[r].data[o][n]+""]+=l:a[e[r].data[o][n]+""]=l}}return a}e.hooks.processRawData.push(function(e,t,i,s){if(a||(a=!0,r=n(e.getData())),1==t.stackpercent){var o=i.length;t.percents=[];var l=0,u=1;t.bars&&t.bars.horizontal&&!0===t.bars.horizontal&&(l=1,u=0);for(var c=0;c<o;c++){var h=r[i[c][l]+""];h>0?t.percents.push(100*i[c][u]/h):t.percents.push(0)}}}),e.hooks.processDatapoints.push(function(e,i,s){if(i.stackpercent){a||(r=n(e.getData()));var o=[],l=0,u=1;i.bars&&i.bars.horizontal&&!0===i.bars.horizontal&&(l=1,u=0);for(var c=0;c<s.points.length;c+=3)t[s.points[c+l]]||(t[s.points[c+l]]=0),o[c+l]=s.points[c+l],o[c+u]=s.points[c+u]+t[s.points[c+l]],o[c+2]=t[s.points[c+l]],t[s.points[c+l]]+=s.points[c+u],r[o[c+l]+""]>0?(o[c+u]=100*o[c+u]/r[o[c+l]+""],o[c+2]=100*o[c+2]/r[o[c+l]+""]):(o[c+u]=0,o[c+2]=0);s.points=o}})},options:{series:{stackpercent:null}},name:"stackpercent",version:"0.1"})}()},1245:function(e,t){!function(e){"use strict";e.plot.plugins.push({init:function(t){function a(e,t,a,r,n,i,s,o){var l,u,c,h,p,d;return d=((c=s-n)*(t-i)-(h=o-i)*(e-n))/(-c*(u=r-t)+(l=a-e)*h),(p=(-u*(e-n)+l*(t-i))/(-c*u+l*h))>=0&&p<=1&&d>=0&&d<=1?[e+d*l,t+d*u]:null}t.hooks.drawSeries.push(function(t,r,n){var i,s,o,l,u,c,h;function p(e,t){r.beginPath(),r.moveTo(n.xaxis.p2c(e)+c.left,n.yaxis.p2c(t)+c.top)}function d(e,t){console.assert(t>e,"expects the end index to be greater than the start index");var a,r,n=0===e||null===o[e-1]||null===u[e-1],i=!1;for(a=e;a<t;a++)if(null===o[a*s+1]||null===u[a*s+1])i=!1,n=!0;else if(o[a*s+1]===u[a*l+1])i=!0,n=!1;else{if(o[a*s+1]>u[a*l+1])return n?p(o[a*s],o[a*s+1]):i?p(o[(a-1)*s],o[(a-1)*s+1]):p((r=m(a))[0],r[1]),void g(a,t);n=!1,i=!1}}function m(e){var t,r;for(console.assert(e>0,"expects the second point in the series line segment"),t=1;t<u.length/l;t++)if(null!==(r=a(o[(e-1)*s],o[(e-1)*s+1],o[e*s],o[e*s+1],u[(t-1)*l],u[(t-1)*l+1],u[t*l],u[t*l+1])))return r;console.error("intersectionPoint() should only be called when an intersection happens")}function f(e,t){var a;for(console.assert(e>=t,"the start should be the rightmost point, and the end should be the leftmost (excluding the equal or intersecting point)"),a=e;a>=t;a--)r.lineTo(i.xaxis.p2c(u[a*l])+c.left,i.yaxis.p2c(u[a*l+1])+c.top);r.closePath(),r.fill()}function g(e,t){var a,i;for(console.assert(e<=t,"the start should be the rightmost point, and the end should be the leftmost (excluding the equal or intersecting point)"),a=e;a<t;a++){if(null===o[a*s+1]&&a>e)return f(a-1,e),void d(a,t);if(o[a*s+1]===u[a*l+1])return f(a,e),void d(a,t);if(o[a*s+1]<u[a*l+1])return i=m(a),r.lineTo(n.xaxis.p2c(i[0])+c.left,n.yaxis.p2c(i[1])+c.top),f(a,e),void d(a,t);r.lineTo(n.xaxis.p2c(o[a*s])+c.left,n.yaxis.p2c(o[a*s+1])+c.top)}f(t,e)}null!==n.fillBelowTo&&(i=function(e,t){var a;for(a=0;a<t.length;++a)if(t[a].id===e.fillBelowTo)return t[a];return null}(n,t.getData()))&&(s=n.datapoints.pointsize,o=n.datapoints.points,l=i.datapoints.pointsize,u=i.datapoints.points,c=t.getPlotOffset(),function(){if(o.length/s!=u.length/l)return console.error("Refusing to graph inconsistent number of points"),!1;var e;for(e=0;e<o.length/s;e++)if(null!==o[e*s]&&null!==u[e*l]&&o[e*s]!==u[e*l])return console.error("Refusing to graph points without matching value"),!1;return!0}()&&((h=e.color.parse(n.color)).a=.4,h.normalize(),r.fillStyle=h.toString(),d(0,o.length/s)))})},options:{series:{fillBelowTo:null}},name:"fillbelow",version:"0.1.0"})}(jQuery)},1246:function(e,t){!function(e){jQuery.plot.plugins.push({init:function(e){var t={x:-1,y:-1,locked:!1};function a(a){t.locked||-1!=t.x&&(t.x=-1,e.triggerRedrawOverlay())}function r(a){if(!t.locked)if(e.getSelection&&e.getSelection())t.x=-1;else{var r=e.offset();t.x=Math.max(0,Math.min(a.pageX-r.left,e.width())),t.y=Math.max(0,Math.min(a.pageY-r.top,e.height())),e.triggerRedrawOverlay()}}e.setCrosshair=function(a){if(a){var r=e.p2c(a);t.x=Math.max(0,Math.min(r.left,e.width())),t.y=Math.max(0,Math.min(r.top,e.height()))}else t.x=-1;e.triggerRedrawOverlay()},e.clearCrosshair=e.setCrosshair,e.lockCrosshair=function(a){a&&e.setCrosshair(a),t.locked=!0},e.unlockCrosshair=function(){t.locked=!1},e.hooks.bindEvents.push(function(e,t){e.getOptions().crosshair.mode&&(t.mouseout(a),t.mousemove(r))}),e.hooks.drawOverlay.push(function(e,a){var r=e.getOptions().crosshair;if(r.mode){var n=e.getPlotOffset();if(a.save(),a.translate(n.left,n.top),-1!=t.x){var i=e.getOptions().crosshair.lineWidth%2?.5:0;if(a.strokeStyle=r.color,a.lineWidth=r.lineWidth,a.lineJoin="round",a.beginPath(),-1!=r.mode.indexOf("x")){var s=Math.floor(t.x)+i;a.moveTo(s,0),a.lineTo(s,e.height())}if(-1!=r.mode.indexOf("y")){var o=Math.floor(t.y)+i;a.moveTo(0,o),a.lineTo(e.width(),o)}a.stroke()}a.restore()}}),e.hooks.shutdown.push(function(e,t){t.unbind("mouseout",a),t.unbind("mousemove",r)})},options:{crosshair:{mode:null,color:"rgba(170, 0, 0, 0.80)",lineWidth:1}},name:"crosshair",version:"1.0"})}()},1247:function(e,t){!function(e){jQuery.plot.plugins.push({init:function(e){e.hooks.processDatapoints.push(function(e,t,a){t.dashes.show&&e.hooks.draw.push(function(e,r){var n=e.getPlotOffset(),i=t.xaxis,s=t.yaxis;function o(e,n){var o,l,u=a.points,c=a.pointsize,h=null,p=null,d=0,m=!0;t.dashes.dashLength[0]?(o=t.dashes.dashLength[0],l=t.dashes.dashLength[1]?t.dashes.dashLength[1]:o):l=o=t.dashes.dashLength,r.beginPath();for(var f=c;f<u.length;f+=c){var g=u[f-c],v=u[f-c+1],y=u[f],b=u[f+1];if(null!=g&&null!=y){if(v<=b&&v<s.min){if(b<s.min)continue;g=(s.min-v)/(b-v)*(y-g)+g,v=s.min}else if(b<=v&&b<s.min){if(v<s.min)continue;y=(s.min-v)/(b-v)*(y-g)+g,b=s.min}if(v>=b&&v>s.max){if(b>s.max)continue;g=(s.max-v)/(b-v)*(y-g)+g,v=s.max}else if(b>=v&&b>s.max){if(v>s.max)continue;y=(s.max-v)/(b-v)*(y-g)+g,b=s.max}if(g<=y&&g<i.min){if(y<i.min)continue;v=(i.min-g)/(y-g)*(b-v)+v,g=i.min}else if(y<=g&&y<i.min){if(g<i.min)continue;b=(i.min-g)/(y-g)*(b-v)+v,y=i.min}if(g>=y&&g>i.max){if(y>i.max)continue;v=(i.max-g)/(y-g)*(b-v)+v,g=i.max}else if(y>=g&&y>i.max){if(g>i.max)continue;b=(i.max-g)/(y-g)*(b-v)+v,y=i.max}g==h&&v==p||r.moveTo(i.p2c(g)+e,s.p2c(v)+n);var S,x=i.p2c(g)+e,w=s.p2c(v)+n,T=i.p2c(y)+e,C=s.p2c(b)+n;do{0==(S=k(d>0?d:m?o:l)).deltaX&&0==S.deltaY||(m?r.lineTo(x+S.deltaX,w+S.deltaY):r.moveTo(x+S.deltaX,w+S.deltaY)),m=!m,d=S.remainder,x+=S.deltaX,w+=S.deltaY}while(S.distance>0);h=y,p=b}function k(e){var t=Math.sqrt(Math.pow(T-x,2)+Math.pow(C-w,2));if(t<=e)return{deltaX:T-x,deltaY:C-w,distance:t,remainder:e-t};var a=C>w?1:-1;return{deltaX:(T>x?1:-1)*Math.sqrt(Math.pow(e,2)/(1+Math.pow((C-w)/(T-x),2))),deltaY:a*Math.sqrt(Math.pow(e,2)-Math.pow(e,2)/(1+Math.pow((C-w)/(T-x),2))),distance:e,remainder:0}}}r.stroke()}r.save(),r.translate(n.left,n.top),r.lineJoin="round";var l=t.dashes.lineWidth,u=t.shadowSize;if(l>0&&u>0){r.lineWidth=u,r.strokeStyle="rgba(0,0,0,0.1)";var c=Math.PI/18;o(Math.sin(c)*(l/2+u/2),Math.cos(c)*(l/2+u/2)),r.lineWidth=u/2,o(Math.sin(c)*(l/2+u/4),Math.cos(c)*(l/2+u/4))}r.lineWidth=l,r.strokeStyle=t.color,l>0&&o(0,0),r.restore()})})},options:{series:{dashes:{show:!1,lineWidth:2,dashLength:10}}},name:"dashes",version:"0.1"})}()},1248:function(e,t){
/*!
 * jquery.flot.gauge v1.1.0 *
 *
 * Flot plugin for rendering gauge charts.
 *
 * Copyright (c) 2015 @toyoty99.
 * Licensed under the MIT license.
 */
!function(e){var t=function(){var t,i,s,o,l,u=function(e,r){t=r,i=e.getPlaceholder(),s=e.getOptions(),o=s.series.gauges,l=e.getData(),a(o.debug)};function c(e,t){"auto"===e.gauge.width&&(e.gauge.width=Math.max(5,t/8)),"auto"===e.label.margin&&(e.label.margin=Math.max(1,t/20)),"auto"===e.label.font.size&&(e.label.font.size=Math.max(5,t/8)),"auto"===e.value.margin&&(e.value.margin=Math.max(1,t/30)),"auto"===e.value.font.size&&(e.value.font.size=Math.max(5,t/9)),"auto"===e.threshold.width&&(e.threshold.width=Math.max(3,t/100)),"auto"===e.threshold.label.margin&&(e.threshold.label.margin=Math.max(3,t/40)),"auto"===e.threshold.label.font.size&&(e.threshold.label.font.size=Math.max(5,t/15))}function h(e,t,a){var r=e.gauge.startAngle+(e.gauge.endAngle-e.gauge.startAngle)*((a-e.gauge.min)/(e.gauge.max-e.gauge.min));return r<e.gauge.startAngle?r=e.gauge.startAngle:r>e.gauge.endAngle&&(r=e.gauge.endAngle),r}function p(e,a,r,i,s,o,l,u,c,h){s!==o&&(t.save(),n(t,e,a,r,i,s,o,l,u,c),h&&(n(t,e,a,r,i,s,o),t.clip(),t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=10,t.shadowColor="gray",n(t,e,a,r+1,i+2,s,o,l,1)),t.restore())}function d(e,t,a,n,i,s){m(a.cx+(t.thresholdLabelMargin+t.thresholdLabelFontSize/2+t.radius)*Math.cos(r(s)),a.cy+(t.thresholdLabelMargin+t.thresholdLabelFontSize/2+t.radius)*Math.sin(r(s)),"flotGagueThresholdValue"+n,e.threshold.label.formatter?e.threshold.label.formatter(i):i,e.threshold.label,s)}function m(t,a,r,n,s,o){var l=e("."+r,i),u=l.length;u||((l=e("<span></span>")).attr("id",r),l.css("position","absolute"),l.css("top",a+"px"),s.font.size&&l.css("font-size",s.font.size+"px"),s.font.family&&l.css("font-family",s.font.family),s.color&&l.css("color",s.color),s.background.color&&l.css("background-color",s.background.color),s.background.opacity&&l.css("opacity",s.background.opacity),i.append(l)),l.text(n),l.css("left",t+"px"),l.css("left",parseInt(l.css("left"))-l.width()/2+"px"),!u&&o&&(l.css("top",parseInt(l.css("top"))-l.height()/2+"px"),l.css("transform","rotate("+(180*o+90)+"deg)"))}return u.prototype.calculateLayout=function(){var e=i.width(),t=i.height(),a=Math.min(l.length,o.layout.columns),n=Math.ceil(l.length/a),s=o.layout.margin,u=o.layout.hMargin,h=o.layout.vMargin,p=(e-2*s-u*(a-1))/a,d=(t-2*s-h*(n-1))/n;if(o.layout.square){var m=Math.min(p,d);p=m,d=m}c(o,p);var f=o.cell.margin,g=0,v=0;o.label.show&&(g=o.label.margin,v=o.label.font.size);var y=0,b=0;o.value.show&&(y=o.value.margin,b=o.value.font.size);var S=0;o.threshold.show&&(S=o.threshold.width);var x=0,w=0;o.threshold.label.show&&(x=o.threshold.label.margin,w=o.threshold.label.font.size);for(var T=p/2-f-S-2*x-w,C=o.gauge.startAngle,k=o.gauge.endAngle,_=(k-C)/100,E=-1,M=C;M<k;M+=_)E=Math.max(E,Math.sin(r(M)));var P=(d-2*f-2*g-v)/(1+(E=Math.max(E,Math.sin(r(k)))));P*E<y+b/2&&(P=d-2*f-2*g-v-y-b/2);var D=P-2*x-w-S,$=Math.min(T,D),A=o.gauge.width;A>=$&&(A=Math.max(3,$/3));var I=2*x+w+S+$;return{canvasWidth:e,canvasHeight:t,margin:s,hMargin:u,vMargin:h,columns:a,rows:n,cellWidth:p,cellHeight:d,cellMargin:f,labelMargin:g,labelFontSize:v,valueMargin:y,valueFontSize:b,width:A,radius:$,thresholdWidth:S,thresholdLabelMargin:x,thresholdLabelFontSize:w,gaugeOuterHeight:Math.max(I*(1+E),I+y+b/2)}},u.prototype.calculateAutoValues=c,u.prototype.calculateCellLayout=function(e,t,a){var r=function(e,t){return t%e}(t.columns,a),n=function(e,t){return Math.floor(t/e)}(t.columns,a),i=t.margin+(t.cellWidth+t.hMargin)*r,s=t.margin+(t.cellHeight+t.vMargin)*n,o=i+t.cellWidth/2,l=s+t.cellMargin+2*t.labelMargin+t.labelFontSize+t.thresholdWidth+t.thresholdLabelFontSize+2*t.thresholdLabelMargin+t.radius,u=t.cellHeight-2*t.cellMargin-2*t.labelMargin-t.labelFontSize-t.gaugeOuterHeight,c=0;return"middle"===e.cell.vAlign?c=u/2:"bottom"===e.cell.vAlign&&(c=u),l+=c,{col:r,row:n,x:i,y:s,offsetY:c,cellWidth:t.cellWidth,cellHeight:t.cellHeight,cellMargin:t.cellMargin,cx:o,cy:l}},u.prototype.drawBackground=function(e){o.frame.show&&(t.save(),t.strokeStyle=s.grid.borderColor,t.lineWidth=s.grid.borderWidth,t.strokeRect(0,0,e.canvasWidth,e.canvasHeight),s.grid.backgroundColor&&(t.fillStyle=s.grid.backgroundColor,t.fillRect(0,0,e.canvasWidth,e.canvasHeight)),t.restore())},u.prototype.drawCellBackground=function(e,a){t.save(),e.cell.border&&e.cell.border.show&&e.cell.border.color&&e.cell.border.width&&(t.strokeStyle=e.cell.border.color,t.lineWidth=e.cell.border.width,t.strokeRect(a.x,a.y,a.cellWidth,a.cellHeight)),e.cell.background&&e.cell.background.color&&(t.fillStyle=e.cell.background.color,t.fillRect(a.x,a.y,a.cellWidth,a.cellHeight)),t.restore()},u.prototype.drawGauge=function(e,t,a,n,i){var s=e.gauge.shadow.show?e.gauge.shadow.blur:0;p(a.cx,a.cy,t.radius,t.width,r(e.gauge.startAngle),r(e.gauge.endAngle),e.gauge.border.color,e.gauge.border.width,e.gauge.background.color,s);var o=function(e,t){for(var a,r=0;r<e.threshold.values.length;r++){var n=e.threshold.values[r];if(a=n.color,t<n.value)break}return a}(e,i),l=h(e,t,i);p(a.cx,a.cy,t.radius-1,t.width-2,r(e.gauge.startAngle),r(l),o,1,o,s)},u.prototype.drawThreshold=function(e,a,i){for(var s=e.gauge.startAngle,o=0;o<e.threshold.values.length;o++){var l=e.threshold.values[o];c1=l.color,a2=h(e,0,l.value),n(t,i.cx,i.cy,a.radius+a.thresholdWidth,a.thresholdWidth-2,r(s),r(a2),c1,1,c1),s=a2}},u.prototype.drawLable=function(e,t,a,r,n){m(a.cx,a.y+a.cellMargin+t.labelMargin+a.offsetY,"flotGagueLabel"+r,e.label.formatter?e.label.formatter(n.label,n.data[0][1]):text,e.label)},u.prototype.drawValue=function(e,t,a,r,n){m(a.cx,a.cy-e.value.font.size/2,"flotGagueValue"+r,e.value.formatter?e.value.formatter(n.label,n.data[0][1]):text,e.value)},u.prototype.drawThresholdValues=function(e,t,a,r){d(e,t,a,"Min"+r,e.gauge.min,e.gauge.startAngle),d(e,t,a,"Max"+r,e.gauge.max,e.gauge.endAngle);for(var n=0;n<e.threshold.values.length;n++){var i=e.threshold.values[n];if(i.value>e.gauge.min&&i.value<e.gauge.max){var s=h(e,0,i.value);d(e,t,a,r+"_"+n,i.value,s)}}},u}();function a(e){return"undefined"!=typeof Logger?new Logger(e):null}function r(e){return e*Math.PI}function n(e,t,a,r,n,i,s,o,l,u){if(i!==s){e.save(),e.beginPath(),e.arc(t,a,r,i,s,!1),e.lineTo(t+(r-n)*Math.cos(s),a+(r-n)*Math.sin(s)),e.arc(t,a,r-n,s,i,!0),e.closePath(),l&&(e.lineWidth=l),o&&(e.strokeStyle=o,e.stroke()),u&&(e.fillStyle=u,e.fill()),e.restore()}}var i={series:{gauges:{debug:{log:!1,layout:!1,alert:!1},show:!1,layout:{margin:5,columns:3,hMargin:5,vMargin:5,square:!1},frame:{show:!0},cell:{background:{color:null},border:{show:!0,color:"black",width:1},margin:5,vAlign:"middle"},gauge:{width:"auto",startAngle:.9,endAngle:2.1,min:0,max:100,background:{color:"white"},border:{color:"lightgray",width:2},shadow:{show:!0,blur:5}},label:{show:!0,margin:"auto",background:{color:null,opacity:0},font:{size:"auto",family:"sans-serif"},color:null,formatter:function(e,t){return e}},value:{show:!0,margin:"auto",background:{color:null,opacity:0},font:{size:"auto",family:"sans-serif"},color:null,formatter:function(e,t){return parseInt(t)}},threshold:{show:!0,width:"auto",label:{show:!0,margin:"auto",background:{color:null,opacity:0},font:{size:"auto",family:",sans-serif"},color:null,formatter:function(e){return e}},values:[{value:50,color:"lightgreen"},{value:80,color:"yellow"},{value:100,color:"red"}]}}}};e.plot.plugins.push({init:function(r){r.hooks.processOptions.push(function(e,t){a(t.series.gauges.debug),t.series.gauges.show&&(t.grid.show=!1,t.legend.show=!1),t.series.gauges.threshold.values.sort(function(e,t){return e.value<t.value?-1:e.value>t.value?1:0})}),r.hooks.draw.push(function(r,n){var i=r.getOptions().series.gauges;if(a(i.debug),i.show){var s=r.getData();if(s&&s.length){var o=new t(r,n),l=o.calculateLayout();i.debug.layout,o.drawBackground(l);for(var u=0;u<s.length;u++){var c=s[u],h=e.extend({},i,c.gauges);c.gauges&&o.calculateAutoValues(h,l.cellWidth);var p=o.calculateCellLayout(h,l,u);o.drawCellBackground(h,p),h.debug.layout,h.label.show&&o.drawLable(h,l,p,u,c),o.drawGauge(h,l,p,c.label,c.data[0][1]),h.threshold.show&&o.drawThreshold(h,l,p),h.threshold.label.show&&o.drawThresholdValues(h,l,p,u),h.value.show&&o.drawValue(h,l,p,u,c)}}}})},options:i,name:"gauge",version:"1.1.0"})}(jQuery)},1249:function(e,t){ace.define("ace/mode/prometheus_highlight_rules",["require","exports","module","ace/lib/oop","ace/mode/text_highlight_rules"],function(e,t,a){"use strict";var r=e("../lib/oop"),n=e("./text_highlight_rules").TextHighlightRules,i=function(){var e=this.createKeywordMapper({"support.function":"abs|absent|ceil|changes|clamp_max|clamp_min|count_scalar|day_of_month|day_of_week|days_in_month|delta|deriv|drop_common_labels|exp|floor|histogram_quantile|holt_winters|hour|idelta|increase|irate|label_replace|ln|log2|log10|minute|month|predict_linear|rate|resets|round|scalar|sort|sort_desc|sqrt|time|vector|year|avg_over_time|min_over_time|max_over_time|sum_over_time|count_over_time|quantile_over_time|stddev_over_time|stdvar_over_time",keyword:"count|count_values|min|max|avg|sum|stddev|stdvar|bottomk|topk|quantile","constant.language":"true|false|null|__name__|job"},"identifier",!0);this.$rules={start:[{token:"string",regex:/"(?:[^"\\]|\\.)*?"/},{token:"string",regex:"'.*?'"},{token:"constant.numeric",regex:"[-]?\\d+(?:(?:\\.\\d*)?(?:[eE][+-]?\\d+)?)?\\b"},{token:"constant.language",regex:"\\d+[smhdwy]"},{token:"keyword.operator.binary",regex:"\\+|\\-|\\*|\\/|%|\\^|==|!=|<=|>=|<|>|and|or|unless"},{token:"keyword.other",regex:"keep_common|offset|bool"},{token:"keyword.control",regex:"by|without|on|ignoring|group_left|group_right",next:"start-label-list-matcher"},{token:"variable",regex:"\\$[A-Za-z0-9_]+"},{token:e,regex:"[a-zA-Z_:][a-zA-Z0-9_:]*"},{token:"paren.lparen",regex:"[[(]"},{token:"paren.lparen.label-matcher",regex:"{",next:"start-label-matcher"},{token:"paren.rparen",regex:"[\\])]"},{token:"paren.rparen.label-matcher",regex:"}"},{token:"text",regex:"\\s+"}],"start-label-matcher":[{token:"entity.name.tag.label-matcher",regex:"[a-zA-Z_][a-zA-Z0-9_]*"},{token:"keyword.operator.label-matcher",regex:"=~|=|!~|!="},{token:"string.quoted.label-matcher",regex:"\"[^\"]*\"|'[^']*'"},{token:"punctuation.operator.label-matcher",regex:","},{token:"paren.rparen.label-matcher",regex:"}",next:"start"}],"start-label-list-matcher":[{token:"paren.lparen.label-list-matcher",regex:"[(]"},{token:"entity.name.tag.label-list-matcher",regex:"[a-zA-Z_][a-zA-Z0-9_]*"},{token:"punctuation.operator.label-list-matcher",regex:","},{token:"paren.rparen.label-list-matcher",regex:"[)]",next:"start"}]},this.normalizeRules()};r.inherits(i,n),t.PrometheusHighlightRules=i}),ace.define("ace/mode/prometheus_completions",["require","exports","module","ace/token_iterator","ace/lib/lang"],function(e,t,a){"use strict";var r=e("../lib/lang"),n=["by","without","keep_common","offset","bool","and","or","unless","ignoring","on","group_left","group_right","count","count_values","min","max","avg","sum","stddev","stdvar","bottomk","topk","quantile"].map(function(e){return{caption:e,value:e,meta:"keyword",score:Number.MAX_VALUE}});var i=[{name:"abs()",value:"abs",def:"abs(v instant-vector)",docText:"Returns the input vector with all sample values converted to their absolute value."},{name:"absent()",value:"absent",def:"absent(v instant-vector)",docText:"Returns an empty vector if the vector passed to it has any elements and a 1-element vector with the value 1 if the vector passed to it has no elements. This is useful for alerting on when no time series exist for a given metric name and label combination."},{name:"ceil()",value:"ceil",def:"ceil(v instant-vector)",docText:"Rounds the sample values of all elements in `v` up to the nearest integer."},{name:"changes()",value:"changes",def:"changes(v range-vector)",docText:"For each input time series, `changes(v range-vector)` returns the number of times its value has changed within the provided time range as an instant vector."},{name:"clamp_max()",value:"clamp_max",def:"clamp_max(v instant-vector, max scalar)",docText:"Clamps the sample values of all elements in `v` to have an upper limit of `max`."},{name:"clamp_min()",value:"clamp_min",def:"clamp_min(v instant-vector, min scalar)",docText:"Clamps the sample values of all elements in `v` to have a lower limit of `min`."},{name:"count_scalar()",value:"count_scalar",def:"count_scalar(v instant-vector)",docText:"Returns the number of elements in a time series vector as a scalar. This is in contrast to the `count()` aggregation operator, which always returns a vector (an empty one if the input vector is empty) and allows grouping by labels via a `by` clause."},{name:"day_of_month()",value:"day_of_month",def:"day_of_month(v=vector(time()) instant-vector)",docText:"Returns the day of the month for each of the given times in UTC. Returned values are from 1 to 31."},{name:"day_of_week()",value:"day_of_week",def:"day_of_week(v=vector(time()) instant-vector)",docText:"Returns the day of the week for each of the given times in UTC. Returned values are from 0 to 6, where 0 means Sunday etc."},{name:"days_in_month()",value:"days_in_month",def:"days_in_month(v=vector(time()) instant-vector)",docText:"Returns number of days in the month for each of the given times in UTC. Returned values are from 28 to 31."},{name:"delta()",value:"delta",def:"delta(v range-vector)",docText:"Calculates the difference between the first and last value of each time series element in a range vector `v`, returning an instant vector with the given deltas and equivalent labels. The delta is extrapolated to cover the full time range as specified in the range vector selector, so that it is possible to get a non-integer result even if the sample values are all integers."},{name:"deriv()",value:"deriv",def:"deriv(v range-vector)",docText:"Calculates the per-second derivative of the time series in a range vector `v`, using simple linear regression."},{name:"drop_common_labels()",value:"drop_common_labels",def:"drop_common_labels(instant-vector)",docText:"Drops all labels that have the same name and value across all series in the input vector."},{name:"exp()",value:"exp",def:"exp(v instant-vector)",docText:"Calculates the exponential function for all elements in `v`.\nSpecial cases are:\n* `Exp(+Inf) = +Inf` \n* `Exp(NaN) = NaN`"},{name:"floor()",value:"floor",def:"floor(v instant-vector)",docText:"Rounds the sample values of all elements in `v` down to the nearest integer."},{name:"histogram_quantile()",value:"histogram_quantile",def:"histogram_quantile(φ float, b instant-vector)",docText:"Calculates the φ-quantile (0 ≤ φ ≤ 1) from the buckets `b` of a histogram. The samples in `b` are the counts of observations in each bucket. Each sample must have a label `le` where the label value denotes the inclusive upper bound of the bucket. (Samples without such a label are silently ignored.) The histogram metric type automatically provides time series with the `_bucket` suffix and the appropriate labels."},{name:"holt_winters()",value:"holt_winters",def:"holt_winters(v range-vector, sf scalar, tf scalar)",docText:"Produces a smoothed value for time series based on the range in `v`. The lower the smoothing factor `sf`, the more importance is given to old data. The higher the trend factor `tf`, the more trends in the data is considered. Both `sf` and `tf` must be between 0 and 1."},{name:"hour()",value:"hour",def:"hour(v=vector(time()) instant-vector)",docText:"Returns the hour of the day for each of the given times in UTC. Returned values are from 0 to 23."},{name:"idelta()",value:"idelta",def:"idelta(v range-vector)",docText:"Calculates the difference between the last two samples in the range vector `v`, returning an instant vector with the given deltas and equivalent labels."},{name:"increase()",value:"increase",def:"increase(v range-vector)",docText:"Calculates the increase in the time series in the range vector. Breaks in monotonicity (such as counter resets due to target restarts) are automatically adjusted for. The increase is extrapolated to cover the full time range as specified in the range vector selector, so that it is possible to get a non-integer result even if a counter increases only by integer increments."},{name:"irate()",value:"irate",def:"irate(v range-vector)",docText:"Calculates the per-second instant rate of increase of the time series in the range vector. This is based on the last two data points. Breaks in monotonicity (such as counter resets due to target restarts) are automatically adjusted for."},{name:"label_replace()",value:"label_replace",def:"label_replace(v instant-vector, dst_label string, replacement string, src_label string, regex string)",docText:"For each timeseries in `v`, `label_replace(v instant-vector, dst_label string, replacement string, src_label string, regex string)`  matches the regular expression `regex` against the label `src_label`.  If it matches, then the timeseries is returned with the label `dst_label` replaced by the expansion of `replacement`. `$1` is replaced with the first matching subgroup, `$2` with the second etc. If the regular expression doesn't match then the timeseries is returned unchanged."},{name:"ln()",value:"ln",def:"ln(v instant-vector)",docText:"calculates the natural logarithm for all elements in `v`.\nSpecial cases are:\n * `ln(+Inf) = +Inf`\n * `ln(0) = -Inf`\n * `ln(x < 0) = NaN`\n * `ln(NaN) = NaN`"},{name:"log2()",value:"log2",def:"log2(v instant-vector)",docText:"Calculates the binary logarithm for all elements in `v`. The special cases are equivalent to those in `ln`."},{name:"log10()",value:"log10",def:"log10(v instant-vector)",docText:"Calculates the decimal logarithm for all elements in `v`. The special cases are equivalent to those in `ln`."},{name:"minute()",value:"minute",def:"minute(v=vector(time()) instant-vector)",docText:"Returns the minute of the hour for each of the given times in UTC. Returned values are from 0 to 59."},{name:"month()",value:"month",def:"month(v=vector(time()) instant-vector)",docText:"Returns the month of the year for each of the given times in UTC. Returned values are from 1 to 12, where 1 means January etc."},{name:"predict_linear()",value:"predict_linear",def:"predict_linear(v range-vector, t scalar)",docText:"Predicts the value of time series `t` seconds from now, based on the range vector `v`, using simple linear regression."},{name:"rate()",value:"rate",def:"rate(v range-vector)",docText:"Calculates the per-second average rate of increase of the time series in the range vector. Breaks in monotonicity (such as counter resets due to target restarts) are automatically adjusted for. Also, the calculation extrapolates to the ends of the time range, allowing for missed scrapes or imperfect alignment of scrape cycles with the range's time period."},{name:"resets()",value:"resets",def:"resets(v range-vector)",docText:"For each input time series, `resets(v range-vector)` returns the number of counter resets within the provided time range as an instant vector. Any decrease in the value between two consecutive samples is interpreted as a counter reset."},{name:"round()",value:"round",def:"round(v instant-vector, to_nearest=1 scalar)",docText:"Rounds the sample values of all elements in `v` to the nearest integer. Ties are resolved by rounding up. The optional `to_nearest` argument allows specifying the nearest multiple to which the sample values should be rounded. This multiple may also be a fraction."},{name:"scalar()",value:"scalar",def:"scalar(v instant-vector)",docText:"Given a single-element input vector, `scalar(v instant-vector)` returns the sample value of that single element as a scalar. If the input vector does not have exactly one element, `scalar` will return `NaN`."},{name:"sort()",value:"sort",def:"sort(v instant-vector)",docText:"Returns vector elements sorted by their sample values, in ascending order."},{name:"sort_desc()",value:"sort_desc",def:"sort_desc(v instant-vector)",docText:"Returns vector elements sorted by their sample values, in descending order."},{name:"sqrt()",value:"sqrt",def:"sqrt(v instant-vector)",docText:"Calculates the square root of all elements in `v`."},{name:"time()",value:"time",def:"time()",docText:"Returns the number of seconds since January 1, 1970 UTC. Note that this does not actually return the current time, but the time at which the expression is to be evaluated."},{name:"vector()",value:"vector",def:"vector(s scalar)",docText:"Returns the scalar `s` as a vector with no labels."},{name:"year()",value:"year",def:"year(v=vector(time()) instant-vector)",docText:"Returns the year for each of the given times in UTC."},{name:"avg_over_time()",value:"avg_over_time",def:"avg_over_time(range-vector)",docText:"The average value of all points in the specified interval."},{name:"min_over_time()",value:"min_over_time",def:"min_over_time(range-vector)",docText:"The minimum value of all points in the specified interval."},{name:"max_over_time()",value:"max_over_time",def:"max_over_time(range-vector)",docText:"The maximum value of all points in the specified interval."},{name:"sum_over_time()",value:"sum_over_time",def:"sum_over_time(range-vector)",docText:"The sum of all values in the specified interval."},{name:"count_over_time()",value:"count_over_time",def:"count_over_time(range-vector)",docText:"The count of all values in the specified interval."},{name:"quantile_over_time()",value:"quantile_over_time",def:"quantile_over_time(scalar, range-vector)",docText:"The φ-quantile (0 ≤ φ ≤ 1) of the values in the specified interval."},{name:"stddev_over_time()",value:"stddev_over_time",def:"stddev_over_time(range-vector)",docText:"The population standard deviation of the values in the specified interval."},{name:"stdvar_over_time()",value:"stdvar_over_time",def:"stdvar_over_time(range-vector)",docText:"The population standard variance of the values in the specified interval."}].map(function(e){return{caption:e.name,value:e.value,docHTML:function(e){var t=r.escapeHTML(e.docText);return t=function(e){return e=(e=e.replace(/```(.+)```/,"<pre>$1</pre>")).replace(/`([^`]+)`/,"<code>$1</code>")}(function(e,t){for(var a=[],r=0,n=0,i=t=t||60,s="",o=0;o<e.length;o++)" "===e[o]?r=o:o>=i&&0!=r&&(s=e.slice(n,r),a.push(s),n=r+1,i=o+t,r=0);return s=e.slice(n),a.push(s),a.join("&nbsp<br>")}(t,40)),["<b>",r.escapeHTML(e.def),"</b>","<hr></hr>",t,"<br>&nbsp"].join("")}(e),meta:"function",score:Number.MAX_VALUE}}),s=function(){};(function(){this.getCompletions=function(e,t,a,r,s){var o=t.getTokenAt(a.row,a.column);if("entity.name.tag.label-matcher"===o.type||"string.quoted.label-matcher"===o.type||"entity.name.tag.label-list-matcher"===o.type)return s(null,[]);s(null,n.concat(i))}}).call(s.prototype),t.PrometheusCompletions=s}),ace.define("ace/mode/behaviour/prometheus",["require","exports","module","ace/lib/oop","ace/mode/behaviour","ace/mode/behaviour/cstyle","ace/token_iterator"],function(e,t,a){"use strict";var r=e("../../lib/oop"),n=(e("../behaviour").Behaviour,e("./cstyle").CstyleBehaviour);e("../../token_iterator").TokenIterator;var i=function(){this.inherit(n),this.add("braces","insertion",function(e,t,a,r,i){if("{"==i){var s=a.getSelectionRange(),o=r.doc.getTextRange(s);if(""!==o&&a.getWrapBehavioursEnabled())return function(e,t,a,r){var n=e.end.row-e.start.row;return{text:a+t+r,selection:[0,e.start.column+1,n,e.end.column+(n?0:1)]}}(s,o,"{","}");if(n.isSaneInsertion(a,r))return{text:"{}",selection:[1,1]}}else if("}"==i){var l=a.getCursorPosition(),u=r.doc.getLine(l.row);if("}"==u.substring(l.column,l.column+1))if(null!==r.$findOpeningBracket("}",{column:l.column+1,row:l.row})&&n.isAutoInsertedClosing(l,u,i))return{text:"",selection:[1,1]}}}),this.add("braces","deletion",function(e,t,a,r,n){var i=r.doc.getTextRange(n);if(!n.isMultiLine()&&"{"==i&&"}"==r.doc.getLine(n.start.row).substring(n.start.column+1,n.start.column+2))return n.end.column++,n})};r.inherits(i,n),t.PrometheusBehaviour=i}),ace.define("ace/mode/prometheus",["require","exports","module","ace/lib/oop","ace/mode/text","ace/mode/prometheus_highlight_rules"],function(e,t,a){"use strict";var r=e("../lib/oop"),n=e("./text").Mode,i=e("./prometheus_highlight_rules").PrometheusHighlightRules,s=e("./prometheus_completions").PrometheusCompletions,o=e("./behaviour/prometheus").PrometheusBehaviour,l=function(){this.HighlightRules=i,this.$behaviour=new o,this.$completer=new s,this.completer=this.$completer};r.inherits(l,n),function(){this.$id="ace/mode/prometheus"}.call(l.prototype),t.Mode=l})},1250:function(e,t){ace.define("ace/snippets/prometheus",["require","exports","module"],function(e,t,a){"use strict";t.snippets=[{content:"rate(${1:metric}[${2:range}])",name:"rate()",scope:"prometheus",tabTrigger:"r"}],t.scope="prometheus"})},1251:function(e,t){!function(e){var t=10,a=.95;var r={series:{pie:{show:!1,radius:"auto",innerRadius:0,startAngle:1.5,tilt:1,shadow:{left:5,top:15,alpha:.02},offset:{top:0,left:"auto"},stroke:{color:"#fff",width:1},label:{show:"auto",formatter:function(e,t){return"<div style='font-size:x-small;text-align:center;padding:2px;color:"+t.color+";'>"+e+"<br/>"+Math.round(t.percent)+"%</div>"},radius:1,background:{color:null,opacity:0},threshold:0},combine:{threshold:-1,color:null,label:"Other"},highlight:{opacity:.5}}}};e.plot.plugins.push({init:function(n){var i=null,s=null,o=null,l=null,u=null,c=!1,h=null,p=[];function d(t,a,n){c||(c=!0,i=t.getCanvas(),s=e(i).parent(),r=t.getOptions(),t.setData(function(t){for(var a=0,n=0,i=0,s=r.series.pie.combine.color,o=[],l=0;l<t.length;++l){var u=t[l].data;e.isArray(u)&&1==u.length&&(u=u[0]),e.isArray(u)?!isNaN(parseFloat(u[1]))&&isFinite(u[1])?u[1]=+u[1]:u[1]=0:u=!isNaN(parseFloat(u))&&isFinite(u)?[1,+u]:[1,0],t[l].data=[u]}for(var l=0;l<t.length;++l)a+=t[l].data[0][1];for(var l=0;l<t.length;++l){var u=t[l].data[0][1];u/a<=r.series.pie.combine.threshold&&(n+=u,i++,s||(s=t[l].color))}for(var l=0;l<t.length;++l){var u=t[l].data[0][1];(i<2||u/a>r.series.pie.combine.threshold)&&o.push({data:[[1,u]],color:t[l].color,label:t[l].label,angle:u*Math.PI*2/a,percent:u/(a/100)})}return i>1&&o.push({data:[[1,n]],color:s,label:r.series.pie.combine.label,angle:n*Math.PI*2/a,percent:n/(a/100)}),o}(t.getData())))}function m(n,i){if(s){var p=n.getPlaceholder().width(),d=n.getPlaceholder().height(),m=s.children().filter(".legend").children().width()||0;h=i,c=!1,o=Math.min(p,d/r.series.pie.tilt)/2,u=d/2+r.series.pie.offset.top,l=p/2,"auto"==r.series.pie.offset.left?r.legend.position.match("w")?l+=m/2:l-=m/2:l+=r.series.pie.offset.left,l<o?l=o:l>p-o&&(l=p-o);var g=n.getData(),v=0;do{v>0&&(o*=a),v+=1,y(),r.series.pie.tilt<=.8&&b()}while(!S()&&v<t);v>=t&&(y(),s.prepend("<div class='error'>Could not draw pie with labels contained inside canvas</div>")),n.setSeries&&n.insertLegend&&(n.setSeries(g),n.insertLegend())}function y(){h.clearRect(0,0,p,d),s.children().filter(".pieLabel, .pieLabelBackground").remove()}function b(){var e=r.series.pie.shadow.left,t=r.series.pie.shadow.top,a=r.series.pie.shadow.alpha,n=r.series.pie.radius>1?r.series.pie.radius:o*r.series.pie.radius;if(!(n>=p/2-e||n*r.series.pie.tilt>=d/2-t||n<=10)){h.save(),h.translate(e,t),h.globalAlpha=a,h.fillStyle="#000",h.translate(l,u),h.scale(1,r.series.pie.tilt);for(var i=1;i<=10;i++)h.beginPath(),h.arc(0,0,n,0,2*Math.PI,!1),h.fill(),n-=i;h.restore()}}function S(){var t=Math.PI*r.series.pie.startAngle,a=r.series.pie.radius>1?r.series.pie.radius:o*r.series.pie.radius;h.save(),h.translate(l,u),h.scale(1,r.series.pie.tilt),h.save();for(var n=t,i=0;i<g.length;++i)g[i].startAngle=n,c(g[i].angle,g[i].color,!0);if(h.restore(),r.series.pie.stroke.width>0){for(h.save(),h.lineWidth=r.series.pie.stroke.width,n=t,i=0;i<g.length;++i)c(g[i].angle,r.series.pie.stroke.color,!1);h.restore()}return f(h),h.restore(),!r.series.pie.label.show||function(){for(var a=t,n=r.series.pie.label.radius>1?r.series.pie.label.radius:o*r.series.pie.label.radius,i=0;i<g.length;++i){if(g[i].percent>=100*r.series.pie.label.threshold&&!c(g[i],a,i))return!1;a+=g[i].angle}return!0;function c(t,a,i){if(0==t.data[0][1])return!0;var o,c=r.legend.labelFormatter,h=r.series.pie.label.formatter;o=c?c(t.label,t):t.label,h&&(o=h(o,t));var m=(a+t.angle+a)/2,f=l+Math.round(Math.cos(m)*n),g=u+Math.round(Math.sin(m)*n)*r.series.pie.tilt,v="<span class='pieLabel' id='pieLabel"+i+"' style='position:absolute;top:"+g+"px;left:"+f+"px;'>"+o+"</span>";s.append(v);var y=s.children("#pieLabel"+i),b=g-y.height()/2,S=f-y.width()/2;if(y.css("top",b),y.css("left",S),0-b>0||0-S>0||d-(b+y.height())<0||p-(S+y.width())<0)return!1;if(0!=r.series.pie.label.background.opacity){var x=r.series.pie.label.background.color;null==x&&(x=t.color);var w="top:"+b+"px;left:"+S+"px;";e("<div class='pieLabelBackground' style='position:absolute;width:"+y.width()+"px;height:"+y.height()+"px;"+w+"background-color:"+x+";'></div>").css("opacity",r.series.pie.label.background.opacity).insertBefore(y)}return!0}}();function c(e,t,r){e<=0||isNaN(e)||(r?h.fillStyle=t:(h.strokeStyle=t,h.lineJoin="round"),h.beginPath(),Math.abs(e-2*Math.PI)>1e-9&&h.moveTo(0,0),h.arc(0,0,a,n,n+e/2,!1),h.arc(0,0,a,n+e/2,n+e,!1),h.closePath(),n+=e,r?h.fill():h.stroke())}}}function f(e){if(r.series.pie.innerRadius>0){e.save();var t=r.series.pie.innerRadius>1?r.series.pie.innerRadius:o*r.series.pie.innerRadius;e.globalCompositeOperation="destination-out",e.beginPath(),e.fillStyle=r.series.pie.stroke.color,e.arc(0,0,t,0,2*Math.PI,!1),e.fill(),e.closePath(),e.restore(),e.save(),e.beginPath(),e.strokeStyle=r.series.pie.stroke.color,e.arc(0,0,t,0,2*Math.PI,!1),e.stroke(),e.closePath(),e.restore()}}function g(e,t){for(var a=!1,r=-1,n=e.length,i=n-1;++r<n;i=r)(e[r][1]<=t[1]&&t[1]<e[i][1]||e[i][1]<=t[1]&&t[1]<e[r][1])&&t[0]<(e[i][0]-e[r][0])*(t[1]-e[r][1])/(e[i][1]-e[r][1])+e[r][0]&&(a=!a);return a}function v(e){b("plothover",e)}function y(e){b("plotclick",e)}function b(e,t){var a=n.offset(),i=function(e,t){for(var a,r,i=n.getData(),s=n.getOptions(),c=s.series.pie.radius>1?s.series.pie.radius:o*s.series.pie.radius,p=0;p<i.length;++p){var d=i[p];if(d.pie.show){if(h.save(),h.beginPath(),h.moveTo(0,0),h.arc(0,0,c,d.startAngle,d.startAngle+d.angle/2,!1),h.arc(0,0,c,d.startAngle+d.angle/2,d.startAngle+d.angle,!1),h.closePath(),a=e-l,r=t-u,h.isPointInPath){if(h.isPointInPath(e-l,t-u))return h.restore(),{datapoint:[d.percent,d.data],dataIndex:0,series:d,seriesIndex:p}}else if(g([[0,0],[c*Math.cos(d.startAngle),c*Math.sin(d.startAngle)],[c*Math.cos(d.startAngle+d.angle/4),c*Math.sin(d.startAngle+d.angle/4)],[c*Math.cos(d.startAngle+d.angle/2),c*Math.sin(d.startAngle+d.angle/2)],[c*Math.cos(d.startAngle+d.angle/1.5),c*Math.sin(d.startAngle+d.angle/1.5)],[c*Math.cos(d.startAngle+d.angle),c*Math.sin(d.startAngle+d.angle)]],[a,r]))return h.restore(),{datapoint:[d.percent,d.data],dataIndex:0,series:d,seriesIndex:p};h.restore()}}return null}(parseInt(t.pageX-a.left),parseInt(t.pageY-a.top));if(r.grid.autoHighlight)for(var c=0;c<p.length;++c){var d=p[c];d.auto!=e||i&&d.series==i.series||S(d.series)}i&&function(e,t){var a=x(e);-1==a?(p.push({series:e,auto:t}),n.triggerRedrawOverlay()):t||(p[a].auto=!1)}(i.series,e);var m={pageX:t.pageX,pageY:t.pageY};s.trigger(e,[m,i])}function S(e){null==e&&(p=[],n.triggerRedrawOverlay());var t=x(e);-1!=t&&(p.splice(t,1),n.triggerRedrawOverlay())}function x(e){for(var t=0;t<p.length;++t)if(p[t].series==e)return t;return-1}n.hooks.processOptions.push(function(e,t){t.series.pie.show&&(t.grid.show=!1,"auto"==t.series.pie.label.show&&(t.legend.show?t.series.pie.label.show=!1:t.series.pie.label.show=!0),"auto"==t.series.pie.radius&&(t.series.pie.label.show?t.series.pie.radius=.75:t.series.pie.radius=1),t.series.pie.tilt>1?t.series.pie.tilt=1:t.series.pie.tilt<0&&(t.series.pie.tilt=0))}),n.hooks.bindEvents.push(function(e,t){var a=e.getOptions();a.series.pie.show&&(a.grid.hoverable&&t.unbind("mousemove").mousemove(v),a.grid.clickable&&t.unbind("click").click(y))}),n.hooks.processDatapoints.push(function(e,t,a,r){e.getOptions().series.pie.show&&d(e)}),n.hooks.drawOverlay.push(function(e,t){e.getOptions().series.pie.show&&function(e,t){var a=e.getOptions(),r=a.series.pie.radius>1?a.series.pie.radius:o*a.series.pie.radius;t.save(),t.translate(l,u),t.scale(1,a.series.pie.tilt);for(var n=0;n<p.length;++n)i(p[n].series);function i(e){e.angle<=0||isNaN(e.angle)||(t.fillStyle="rgba(255, 255, 255, "+a.series.pie.highlight.opacity+")",t.beginPath(),Math.abs(e.angle-2*Math.PI)>1e-9&&t.moveTo(0,0),t.arc(0,0,r,e.startAngle,e.startAngle+e.angle/2,!1),t.arc(0,0,r,e.startAngle+e.angle/2,e.startAngle+e.angle,!1),t.closePath(),t.fill())}f(t),t.restore()}(e,t)}),n.hooks.draw.push(function(e,t){e.getOptions().series.pie.show&&m(e,t)})},options:r,name:"pie",version:"1.1"})}(jQuery)},1261:function(e,t,a){"use strict";J.$inject=["$sanitize","dashboardSrv","contextSrv","$compile"],Bt.$inject=["instanceSettings","$q","backendSrv","templateSrv"],Gt.$inject=["$compile"],Wt.$inject=["$compile","templateSrv","popoverSrv"],In.$inject=["element","event","plot"],Fn.$inject=["element","event","plot"],Ln.$inject=["plot"],Gn.$inject=["timeSrv","popoverSrv","contextSrv"],Jn.$inject=["$scope","$element","popoverSrv"],Qi.$inject=["$q","uiSegmentSrv"],zi.$inject=["$q","uiSegmentSrv"],cs.$inject=["$compile","datasourceSrv","$rootScope","$q","$http","$templateCache"],ks.$inject=["$scope","$rootScope","$location","$timeout","timeSrv","templateSrv","linkSrv"],Ds.$inject=["$location","$timeout","$rootScope"],qs.$inject=["$rootScope","$q","$location","$timeout","contextSrv","dashboardSrv","$window"],Us.$inject=["timer","alertSrv","$location"],Gs.$inject=["variableSrv"],bo.$inject=["$compile","$sanitize","linkSrv"],Ro.$inject=["$routeProvider"],Uo.$inject=["$compile"],Qo.$inject=["dynamicDirectiveSrv"],a.r(t);var r={};a.r(r),a.d(r,"PanelCtrl",function(){return Le}),a.d(r,"MetricsPanelCtrl",function(){return ze}),a.d(r,"QueryCtrl",function(){return Ye}),a.d(r,"alertTab",function(){return Je}),a.d(r,"loadPluginCss",function(){return os});var n={};a.r(n),a.d(n,"convertSeriesListToCsv",function(){return Tt}),a.d(n,"exportSeriesListToCsv",function(){return Ct}),a.d(n,"convertSeriesListToCsvColumns",function(){return kt}),a.d(n,"exportSeriesListToCsvColumns",function(){return _t}),a.d(n,"convertTableDataToCsv",function(){return Et}),a.d(n,"exportTableDataToCsv",function(){return Mt}),a.d(n,"saveSaveBlob",function(){return Pt});var i={};a.r(i),a.d(i,"default",function(){return Dt});var s={};a.r(s),a.d(s,"Datasource",function(){return Bt}),a.d(s,"QueryCtrl",function(){return oa}),a.d(s,"ConfigCtrl",function(){return ua}),a.d(s,"AnnotationsQueryCtrl",function(){return ca});var o={};a.r(o),a.d(o,"Datasource",function(){return da}),a.d(o,"QueryCtrl",function(){return ma}),a.d(o,"ConfigCtrl",function(){return fa}),a.d(o,"AnnotationsQueryCtrl",function(){return ga});var l={};a.r(l),a.d(l,"Datasource",function(){return Fa}),a.d(l,"QueryCtrl",function(){return Va}),a.d(l,"ConfigCtrl",function(){return Ua}),a.d(l,"AnnotationsQueryCtrl",function(){return ja});var u={};a.r(u),a.d(u,"Datasource",function(){return Ba}),a.d(u,"QueryCtrl",function(){return Qa}),a.d(u,"ConfigCtrl",function(){return Ha}),a.d(u,"AnnotationsQueryCtrl",function(){return za});var c={};a.r(c),a.d(c,"GrafanaDatasource",function(){return Ya}),a.d(c,"Datasource",function(){return Ya}),a.d(c,"QueryCtrl",function(){return Ga}),a.d(c,"AnnotationsQueryCtrl",function(){return Wa});var h={};a.r(h),a.d(h,"Datasource",function(){return hr}),a.d(h,"QueryCtrl",function(){return pr}),a.d(h,"ConfigCtrl",function(){return dr}),a.d(h,"AnnotationsQueryCtrl",function(){return mr});var p={};a.r(p),a.d(p,"LoggingConfigCtrl",function(){return br}),a.d(p,"Datasource",function(){return yr}),a.d(p,"ConfigCtrl",function(){return br});var d={};a.r(d),a.d(d,"MixedDatasource",function(){return Sr}),a.d(d,"Datasource",function(){return Sr});var m={};a.r(m),a.d(m,"MysqlDatasource",function(){return wr}),a.d(m,"Datasource",function(){return wr}),a.d(m,"QueryCtrl",function(){return Cr}),a.d(m,"ConfigCtrl",function(){return kr}),a.d(m,"AnnotationsQueryCtrl",function(){return Er});var f={};a.r(f),a.d(f,"PostgresDatasource",function(){return Dr}),a.d(f,"Datasource",function(){return Dr}),a.d(f,"QueryCtrl",function(){return Rr}),a.d(f,"ConfigCtrl",function(){return Lr}),a.d(f,"AnnotationsQueryCtrl",function(){return Ur});var g={};a.r(g),a.d(g,"Datasource",function(){return rn}),a.d(g,"QueryCtrl",function(){return sn}),a.d(g,"ConfigCtrl",function(){return on}),a.d(g,"AnnotationsQueryCtrl",function(){return ln});var v={};a.r(v),a.d(v,"MssqlDatasource",function(){return cn}),a.d(v,"Datasource",function(){return cn}),a.d(v,"QueryCtrl",function(){return pn}),a.d(v,"ConfigCtrl",function(){return dn}),a.d(v,"AnnotationsQueryCtrl",function(){return fn});var y={};a.r(y),a.d(y,"TestDataDatasource",function(){return gn}),a.d(y,"Datasource",function(){return gn}),a.d(y,"QueryCtrl",function(){return vn}),a.d(y,"AnnotationsQueryCtrl",function(){return yn});var b={};a.r(b),a.d(b,"Datasource",function(){return Tn}),a.d(b,"QueryCtrl",function(){return Pn}),a.d(b,"ConfigCtrl",function(){return Dn}),a.d(b,"AnnotationsQueryCtrl",function(){return $n});var S={};a.r(S),a.d(S,"TextPanelCtrl",function(){return An}),a.d(S,"PanelCtrl",function(){return An});var x={};a.r(x),a.d(x,"GraphCtrl",function(){return ai}),a.d(x,"PanelCtrl",function(){return ai});var w={};a.r(w),a.d(w,"DashListCtrl",function(){return ri}),a.d(w,"PanelCtrl",function(){return ri});var T={};a.r(T),a.d(T,"PluginListCtrl",function(){return ni}),a.d(T,"PanelCtrl",function(){return ni});var C={};a.r(C),a.d(C,"AlertListPanel",function(){return ii}),a.d(C,"PanelCtrl",function(){return ii});var k={};a.r(k),a.d(k,"PanelCtrl",function(){return Ui});var _={};a.r(_),a.d(_,"TablePanelCtrl",function(){return Gi}),a.d(_,"PanelCtrl",function(){return Gi});var E={};a.r(E),a.d(E,"SingleStatCtrl",function(){return Ki}),a.d(E,"PanelCtrl",function(){return Ki}),a.d(E,"getColorForValue",function(){return Ji});var M={};a.r(M),a.d(M,"GettingStartedPanelCtrl",function(){return Xi}),a.d(M,"PanelCtrl",function(){return Xi});var P=a(11),D=a.n(P),$=a(2),A=a.n($),I=a(10),O=a.n(I),F=a(5),q=function(){function e(e,t){this.datasourceSrv=t,this.annotationDefaults={name:"",datasource:null,iconColor:"rgba(255, 96, 96, 1)",enable:!0,showIn:0,hide:!1},this.showOptions=[{text:"All Panels",value:0},{text:"Specific Panels",value:1}],e.ctrl=this,this.mode="list",this.datasources=t.getAnnotationSources(),this.annotations=e.dashboard.annotations.list,this.reset(),this.onColorChange=this.onColorChange.bind(this)}return e.$inject=["$scope","datasourceSrv"],e.prototype.datasourceChanged=function(){var e=this;return this.datasourceSrv.get(this.currentAnnotation.datasource).then(function(t){e.currentDatasource=t})},e.prototype.edit=function(e){this.currentAnnotation=e,this.currentAnnotation.showIn=this.currentAnnotation.showIn||0,this.currentIsNew=!1,this.datasourceChanged(),this.mode="edit",O()(".tooltip.in").remove()},e.prototype.reset=function(){this.currentAnnotation=D.a.copy(this.annotationDefaults),this.currentAnnotation.datasource=this.datasources[0].name,this.currentIsNew=!0,this.datasourceChanged()},e.prototype.update=function(){this.reset(),this.mode="list"},e.prototype.setupNew=function(){this.mode="new",this.reset()},e.prototype.backToList=function(){this.mode="list"},e.prototype.move=function(e,t){A.a.move(this.annotations,e,e+t)},e.prototype.add=function(){this.annotations.push(this.currentAnnotation),this.reset(),this.mode="list"},e.prototype.removeAnnotation=function(e){var t=A.a.indexOf(this.annotations,e);this.annotations.splice(t,1)},e.prototype.onColorChange=function(e){this.currentAnnotation.iconColor=e},e}();function N(e,t){var a=A.a.partition(e,"regionId"),r=a[0],n=a[1],i=function(e,t){var a=A.a.filter(e,function(e){return e.regionId}),r=A.a.groupBy(a,"regionId");return r=A.a.compact(A.a.map(r,function(e){var a=A.a.head(e);return e&&e.length>1?(a.timeEnd=e[1].time,a.isRegion=!0,a):e&&e.length?(a.time&&a.timeEnd||(function(e){return e.id&&e.id===e.regionId}(a)?a.timeEnd=t.to.valueOf()-1:(a.timeEnd=a.time,a.time=t.from.valueOf()+1),a.isRegion=!0),a):void 0}))}(r,t.range);return e=A.a.concat(i,n)}function R(e){return"panel-alert"===e.eventType}F.a.controller("AnnotationsEditorCtrl",q);var L=function(){function e(e,t,a,r,n){this.$rootScope=e,this.$q=t,this.datasourceSrv=a,this.backendSrv=r,this.timeSrv=n,e.onAppEvent("refresh",this.clearCache.bind(this),e),e.onAppEvent("dashboard-initialized",this.clearCache.bind(this),e)}return e.$inject=["$rootScope","$q","datasourceSrv","backendSrv","timeSrv"],e.prototype.clearCache=function(){this.globalAnnotationsPromise=null,this.alertStatesPromise=null},e.prototype.getAnnotations=function(e){var t=this;return this.$q.all([this.getGlobalAnnotations(e),this.getAlertStates(e)]).then(function(t){var a=A.a.flattenDeep(t[0]);return{annotations:a=N(a=function(e){var t=[],a=A.a.partition(e,"id"),r=A.a.groupBy(a[0],"id");return t=A.a.map(r,function(e){return e.length>1&&!A.a.every(e,R)?A.a.find(e,function(e){return"panel-alert"!==e.eventType}):A.a.head(e)}),t=A.a.concat(t,a[1])}(a=A.a.filter(a,function(t){return!t.panelId||"dashboard"!==t.source.type||t.panelId===e.panel.id})),e),alertState:A.a.find(t[1],{panelId:e.panel.id})}}).catch(function(e){return!e.message&&e.data&&e.data.message&&(e.message=e.data.message),console.log("AnnotationSrv.query error",e),t.$rootScope.appEvent("alert-error",["Annotation Query Failed",e.message||e]),[]})},e.prototype.getAlertStates=function(e){return e.dashboard.id?e.panel&&!e.panel.alert?this.$q.when([]):"now"!==e.range.raw.to?this.$q.when([]):this.alertStatesPromise?this.alertStatesPromise:(this.alertStatesPromise=this.backendSrv.get("/api/alerts/states-for-dashboard",{dashboardId:e.dashboard.id}),this.alertStatesPromise):this.$q.when([])},e.prototype.getGlobalAnnotations=function(e){var t=this,a=e.dashboard;if(this.globalAnnotationsPromise)return this.globalAnnotationsPromise;for(var r=this.timeSrv.timeRange(),n=[],i=function(e){return e.enable?e.snapshotData?{value:s.translateQueryResult(e,e.snapshotData)}:void n.push(s.datasourceSrv.get(e.datasource).then(function(t){return t.annotationQuery({range:r,rangeRaw:r.raw,annotation:e,dashboard:a})}).then(function(r){return a.snapshot&&(e.snapshotData=D.a.copy(r)),t.translateQueryResult(e,r)})):"continue"},s=this,o=0,l=a.annotations.list;o<l.length;o++){var u=i(l[o]);if("object"==typeof u)return u.value}return this.globalAnnotationsPromise=this.$q.all(n),this.globalAnnotationsPromise},e.prototype.saveAnnotationEvent=function(e){return this.globalAnnotationsPromise=null,this.backendSrv.post("/api/annotations",e)},e.prototype.updateAnnotationEvent=function(e){return this.globalAnnotationsPromise=null,this.backendSrv.put("/api/annotations/"+e.id,e)},e.prototype.deleteAnnotationEvent=function(e){this.globalAnnotationsPromise=null;var t="/api/annotations/"+e.id;return e.isRegion&&(t="/api/annotations/region/"+e.regionId),this.backendSrv.delete(t)},e.prototype.translateQueryResult=function(e,t){e.snapshotData&&delete(e=D.a.copy(e)).snapshotData;for(var a=0,r=t;a<r.length;a++){r[a].source=e}return t},e}();F.a.service("annotationsSrv",L);var V=a(4),U=a.n(V),j=a(153),B=function(){function e(e){this.annotationsSrv=e,this.event.panelId=this.panelCtrl.panel.id,this.event.dashboardId=this.panelCtrl.dashboard.id,this.event.time=Q(this.event.time),this.event.isRegion&&(this.event.timeEnd=Q(this.event.timeEnd)),this.timeFormated=this.panelCtrl.dashboard.formatDate(this.event.time)}return e.$inject=["annotationsSrv"],e.prototype.save=function(){var e=this;if(this.form.$valid){var t=A.a.cloneDeep(this.event);t.time=t.time.valueOf(),t.timeEnd=0,t.isRegion&&(t.timeEnd=this.event.timeEnd.valueOf(),t.timeEnd<t.time)?console.log("invalid time"):t.id?this.annotationsSrv.updateAnnotationEvent(t).then(function(){e.panelCtrl.refresh(),e.close()}).catch(function(){e.panelCtrl.refresh(),e.close()}):this.annotationsSrv.saveAnnotationEvent(t).then(function(){e.panelCtrl.refresh(),e.close()}).catch(function(){e.panelCtrl.refresh(),e.close()})}},e.prototype.delete=function(){var e=this;return this.annotationsSrv.deleteAnnotationEvent(this.event).then(function(){e.panelCtrl.refresh(),e.close()}).catch(function(){e.panelCtrl.refresh(),e.close()})},e}();function Q(e){if(e&&A.a.isNumber(e)){var t=Number(e);return U()(t)}return e}j.d.directive("eventEditor",function(){return{restrict:"E",controller:B,bindToController:!0,controllerAs:"ctrl",templateUrl:"public/app/features/annotations/partials/event_editor.html",scope:{panelCtrl:"=",event:"=",close:"&"}}});var H=a(133),z=a.n(H),Y=function(){return function(){}}(),G=a(85),W=function(){function e(e){this.panelCtrl=e}return e.prototype.editorClosed=function(){this.event=null,this.editorOpen=!1,this.panelCtrl.render()},e.prototype.editorOpened=function(){this.editorOpen=!0},e.prototype.updateTime=function(e){this.event||(this.event=new Y,this.event.dashboardId=this.panelCtrl.dashboard.id,this.event.panelId=this.panelCtrl.panel.id),this.event.time=U()(e.from),this.event.isRegion=!1,e.to&&(this.event.timeEnd=U()(e.to),this.event.isRegion=!0),this.panelCtrl.render()},e.prototype.editEvent=function(e,t){this.event=e,this.panelCtrl.render()},e.prototype.addFlotEvents=function(e,t){if(this.event||0!==e.length){var a={$__alerting:{color:G.a,position:"BOTTOM",markerSize:5},$__ok:{color:G.d,position:"BOTTOM",markerSize:5},$__no_data:{color:G.c,position:"BOTTOM",markerSize:5},$__editing:{color:G.b,position:"BOTTOM",markerSize:5}};if(this.event)e=this.event.isRegion?[{isRegion:!0,min:this.event.time.valueOf(),timeEnd:this.event.timeEnd.valueOf(),text:this.event.text,eventType:"$__editing",editModel:this.event}]:[{min:this.event.time.valueOf(),text:this.event.text,editModel:this.event,eventType:"$__editing"}];else for(var r=0;r<e.length;r++){var n=e[r];n.min=n.time,n.max=n.time,n.eventType=n.source.name,n.newState?n.eventType="$__"+n.newState:a[n.source.name]||(a[n.source.name]={color:n.source.iconColor,position:"BOTTOM",markerSize:5})}!function(e,t){var a,r=t.grid.markings,n=G.b;A.a.each(e,function(e){a=function(e,t){var a=z()(e);return a.isValid()?(a.setAlpha(t),a.toRgbString()):e}(a=e.source&&e.source.iconColor||n,G.e),r.push({xaxis:{from:e.min,to:e.timeEnd},color:a})})}(function(e){return A.a.filter(e,"isRegion")}(e),t);t.grid.eventSectionHeight=7,t.xaxis.eventSectionHeight=20,t.events={levels:A.a.keys(a).length+1,data:e,types:a,manager:this}}},e}();var K=a(287);function J(e,t,a,r){function n(t){try{return e(t)}catch(e){return console.log("Could not sanitize annotation string, html escaping instead"),A.a.escape(t)}}return{restrict:"E",scope:{event:"=",onEdit:"&"},link:function(e,a){var i=e.event,s=i.title,o=i.text,l=t.getCurrent(),u='<div class="graph-annotation">',c="";if(i.alertId){var h=K.a.getStateDisplayModel(i.newState);c=h.stateClass,s='<i class="icon-gf '+h.iconClass+'"></i> '+h.text,o=K.a.getAlertAnnotationInfo(i),i.text&&(o=o+"<br />"+i.text)}else s&&(o=s+"<br />"+(A.a.isString(o)?o:""),s="");var p='<div class="graph-annotation__header">';i.login&&(p+='<div class="graph-annotation__user" bs-tooltip="\'Created by '+i.login+'\'"><img src="'+i.avatarUrl+'" /></div>'),p+='\n          <span class="graph-annotation__title '+c+'">'+n(s)+'</span>\n          <span class="graph-annotation__time">'+l.formatDate(i.min)+"</span>\n      ",i.id&&l.meta.canEdit&&(p+='\n          <span class="pointer graph-annotation__edit-icon" ng-click="onEdit()">\n            <i class="fa fa-pencil-square"></i>\n          </span>\n        '),u+=p+="</div>",u+='<div class="graph-annotation__body">',o&&(u+="<div>"+n(o.replace(/\n/g,"<br>"))+"</div>");var d=i.tags;d&&d.length&&(e.tags=d,u+='<span class="label label-tag small" ng-repeat="tag in tags" tag-color-from-name="tag">{{tag}}</span><br/>'),u+="</div>",u+="</div>",O()(u).appendTo(a),r(a.contents())(e)}}}F.a.directive("annotationTooltip",J);var X=a(288),Z=/\$(\w+)|\[\[([\s\S]+?)(?::(\w+))?\]\]|\${(\w+)(?::(\w+))?}/g,ee=function(e){return Z.lastIndex=0,Z.exec(e)},te={};function ae(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var a=e[e.length-1],r=e.slice(0,-1).join(" ").match(Z);return!!(null!==r&&r.find(function(e){var t=ee(e);return null!==t&&t.indexOf(a)>-1}))}var re=a(8),ne=function(){function e(e,t,a,r){e.variableTypes=te,e.ctrl={},e.namePattern=/^(?!__).*$/,e._=A.a,e.optionsLimit=20,e.refreshOptions=[{value:0,text:"Never"},{value:1,text:"On Dashboard Load"},{value:2,text:"On Time Range Change"}],e.sortOptions=[{value:0,text:"Disabled"},{value:1,text:"Alphabetical (asc)"},{value:2,text:"Alphabetical (desc)"},{value:3,text:"Numerical (asc)"},{value:4,text:"Numerical (desc)"},{value:5,text:"Alphabetical (case-insensitive, asc)"},{value:6,text:"Alphabetical (case-insensitive, desc)"}],e.hideOptions=[{value:0,text:""},{value:1,text:"Label"},{value:2,text:"Variable"}],e.init=function(){e.mode="list",e.variables=a.variables,e.reset(),e.$watch("mode",function(t){"new"===t&&e.reset()})},e.setMode=function(t){e.mode=t},e.add=function(){e.isValid()&&(a.addVariable(e.current),e.update())},e.isValid=function(){if(!e.ctrl.form.$valid)return!1;if(!e.current.name.match(/^\w+$/))return re.a.emit("alert-warning",["Validation","Only word and digit characters are allowed in variable names"]),!1;var t=A.a.find(e.variables,{name:e.current.name});return t&&t!==e.current?(re.a.emit("alert-warning",["Validation","Variable with the same name already exists"]),!1):"query"!==e.current.type||!e.current.query.match(new RegExp("\\$"+e.current.name+"(/| |$)"))||(re.a.emit("alert-warning",["Validation","Query cannot contain a reference to itself. Variable: $"+e.current.name]),!1)},e.validate=function(){e.infoText="","adhoc"===e.current.type&&null!==e.current.datasource&&(e.infoText="Adhoc filters are applied automatically to all queries that target this datasource",t.get(e.current.datasource).then(function(t){t.getTagKeys||(e.infoText="This datasource does not support adhoc filters yet.")}))},e.runQuery=function(){return e.optionsLimit=20,a.updateOptions(e.current).catch(function(e){e.data&&e.data.message&&(e.message=e.data.message),re.a.emit("alert-error",["Templating","Template variables could not be initialized: "+e.message])})},e.edit=function(t){e.current=t,e.currentIsNew=!1,e.mode="edit",e.validate()},e.duplicate=function(t){var r=A.a.cloneDeep(t.getSaveModel());e.current=a.createVariableFromModel(r),e.current.name="copy_of_"+t.name,a.addVariable(e.current)},e.update=function(){e.isValid()&&e.runQuery().then(function(){e.reset(),e.mode="list",r.updateTemplateData()})},e.reset=function(){e.currentIsNew=!0,e.current=a.createVariableFromModel({type:"query"}),e.datasources=A.a.filter(t.getMetricSources(),function(e){return!e.meta.mixed&&null!==e.value}),e.datasourceTypes=A()(e.datasources).uniqBy("meta.id").map(function(e){return{text:e.meta.name,value:e.meta.id}}).value()},e.typeChanged=function(){var t=e.current;e.current=a.createVariableFromModel({type:e.current.type}),e.current.name=t.name,e.current.hide=t.hide,e.current.label=t.label;var r=A.a.indexOf(this.variables,t);-1!==r&&(this.variables[r]=e.current),e.validate()},e.removeVariable=function(e){a.removeVariable(e)},e.showMoreOptions=function(){e.optionsLimit+=20}}return e.$inject=["$scope","datasourceSrv","variableSrv","templateSrv"],e}();F.a.controller("VariableEditorCtrl",ne);var ie=a(115);function se(e){return e.replace(/([\!\*\+\-\=<>\s\&\|\(\)\[\]\{\}\^\~\?\:\\/"])/g,"\\$1")}var oe=new(function(){function e(){this.regex=Z,this.index={},this.grafanaVariables={},this.builtIns={},this.builtIns.__interval={text:"1s",value:"1s"},this.builtIns.__interval_ms={text:"100",value:"100"}}return e.prototype.init=function(e){this.variables=e,this.updateTemplateData()},e.prototype.updateTemplateData=function(){this.index=this.variables.reduce(function(e,t){return t.current&&(t.current.isNone||function(e){return e||""===e}(t.current.value))&&(e[t.name]=t),e},{})},e.prototype.variableInitialized=function(e){this.index[e.name]=e},e.prototype.getAdhocFilters=function(e){var t=[];if(this.variables)for(var a=0;a<this.variables.length;a++){var r=this.variables[a];"adhoc"===r.type&&(null===r.datasource||r.datasource===e?t=t.concat(r.filters):0===r.datasource.indexOf("$")&&this.replace(r.datasource)===e&&(t=t.concat(r.filters)))}return t},e.prototype.luceneFormat=function(e){return"string"==typeof e?se(e):e instanceof Array&&0===e.length?"__empty__":"("+A.a.map(e,function(e){return'"'+se(e)+'"'}).join(" OR ")+")"},e.prototype.formatValue=function(e,t,a){if(a=a||{},"function"==typeof t)return t(e,a,this.formatValue);switch(t){case"regex":if("string"==typeof e)return ie.a.regexEscape(e);var r=A.a.map(e,ie.a.regexEscape);return 1===r.length?r[0]:"("+r.join("|")+")";case"lucene":return this.luceneFormat(e);case"pipe":return"string"==typeof e?e:e.join("|");case"distributed":return"string"==typeof e?e:this.distributeVariable(e,a.name);case"csv":return A.a.isArray(e)?e.join(","):e;default:return A.a.isArray(e)?"{"+e.join(",")+"}":e}},e.prototype.setGrafanaVariable=function(e,t){this.grafanaVariables[e]=t},e.prototype.getVariableName=function(e){this.regex.lastIndex=0;var t=this.regex.exec(e);return t?t[1]||t[2]:null},e.prototype.variableExists=function(e){var t=this.getVariableName(e);return t&&void 0!==this.index[t]},e.prototype.highlightVariablesAsHtml=function(e){var t=this;return e&&A.a.isString(e)?(e=A.a.escape(e),this.regex.lastIndex=0,e.replace(this.regex,function(e,a,r,n,i){return t.index[a||r||i]||t.builtIns[a||r||i]?'<span class="template-variable">'+e+"</span>":e})):e},e.prototype.getAllValue=function(e){if(e.allValue)return e.allValue;for(var t=[],a=1;a<e.options.length;a++)t.push(e.options[a].value);return t},e.prototype.replace=function(e,t,a){var r,n,i,s,o=this;return e?(this.regex.lastIndex=0,e.replace(this.regex,function(e,l,u,c,h,p){return r=o.index[l||u||h],s=c||p||a,t&&(i=t[l||u||h])?o.formatValue(i.value,s,r):r?(n=o.grafanaVariables[r.current.value])?o.formatValue(n,s,r):(i=r.current.value,o.isAllValue(i)&&(i=o.getAllValue(r),r.allValue)?o.replace(i):o.formatValue(i,s,r)):e})):e},e.prototype.isAllValue=function(e){return"$__all"===e||Array.isArray(e)&&"$__all"===e[0]},e.prototype.replaceWithText=function(e,t){var a,r=this;return e?(this.regex.lastIndex=0,e.replace(this.regex,function(e,n,i,s,o){if(t){var l=t[n||i||o];if(l)return l.text}return(a=r.index[n||i||o])?r.grafanaVariables[a.current.value]||a.current.text:e})):e},e.prototype.fillVariableValuesForUrl=function(e,t){A.a.each(this.variables,function(a){if(t&&void 0!==t[a.name]){if(t[a.name].skipUrlSync)return;e["var-"+a.name]=t[a.name].value}else{if(a.skipUrlSync)return;e["var-"+a.name]=a.getValueForUrl()}})},e.prototype.distributeVariable=function(e,t){return(e=A.a.map(e,function(e,a){return 0!==a?t+"="+e:e})).join(",")},e}()),le=function(){function e(){}return e.prototype._linkTo=function(e,t){t<=0&&e.inputEdges.push(this),t>=0&&e.outputEdges.push(this),e.edges.push(this)},e.prototype.link=function(e,t){if(!e)throw Error("inputNode is required");if(!t)throw Error("outputNode is required");return this.unlink(),this.inputNode=e,this.outputNode=t,this._linkTo(e,1),this._linkTo(t,-1),this},e.prototype.unlink=function(){var e,t=this.inputNode,a=this.outputNode;t&&a&&((e=t.edges.indexOf(this))>-1&&t.edges.splice(e,1),(e=a.edges.indexOf(this))>-1&&a.edges.splice(e,1),(e=t.outputEdges.indexOf(this))>-1&&t.outputEdges.splice(e,1),(e=a.inputEdges.indexOf(this))>-1&&a.inputEdges.splice(e,1),this.inputNode=null,this.outputNode=null)},e}(),ue=function(){function e(e){this.name=e,this.edges=[],this.inputEdges=[],this.outputEdges=[]}return e.prototype.getEdgeFrom=function(e){return e?"object"==typeof e?this.inputEdges.find(function(t){return t.inputNode.name===e.name}):this.inputEdges.find(function(t){return t.inputNode.name===e}):null},e.prototype.getEdgeTo=function(e){return e?"object"==typeof e?this.outputEdges.find(function(t){return t.outputNode.name===e.name}):this.outputEdges.find(function(t){return t.outputNode.name===e}):null},e.prototype.getOptimizedInputEdges=function(){var e=this,t=[];return this.inputEdges.forEach(function(a){a.inputNode.inputEdges.map(function(e){return e.inputNode}).forEach(function(a){var r=a.getEdgeTo(e.name);r&&t.push(r)})}),this.inputEdges.filter(function(e){return-1===t.indexOf(e)})},e}(),ce=function(){function e(){this.nodes={}}return e.prototype.createNode=function(e){var t=new ue(e);return this.nodes[e]=t,t},e.prototype.createNodes=function(e){var t=this,a=[];return e.forEach(function(e){a.push(t.createNode(e))}),a},e.prototype.link=function(e,t){var a=this,r=[],n=[],i=[],s=[];r=e instanceof Array?e:[e],n=t instanceof Array?t:[t];for(var o=0;o<r.length;o++){if("string"==typeof(u=r[o])){var l=this.getNode(u);if(!l)throw Error("cannot link input node named "+u+" since it doesn't exist in graph");i.push(l)}else i.push(u)}for(o=0;o<n.length;o++){var u;if("string"==typeof(u=n[o])){var c=this.getNode(u);if(!c)throw Error("cannot link output node named "+u+" since it doesn't exist in graph");s.push(c)}else s.push(u)}var h=[];return i.forEach(function(e){s.forEach(function(t){h.push(a.createEdge().link(e,t))})}),h},e.prototype.createEdge=function(){return new le},e.prototype.getNode=function(e){return this.nodes[e]},e}(),he=function(){function e(e,t,a,r,n){this.$rootScope=e,this.$q=t,this.$location=a,this.$injector=r,this.templateSrv=n,e.$on("refresh",this.onDashboardRefresh.bind(this),e),e.$on("template-variable-value-updated",this.updateUrlParamsWithCurrentVariables.bind(this),e)}return e.$inject=["$rootScope","$q","$location","$injector","templateSrv"],e.prototype.init=function(e){var t=this;this.dashboard=e,this.variables=e.templating.list=e.templating.list.map(this.createVariableFromModel.bind(this)),this.templateSrv.init(this.variables);for(var a=0,r=this.variables;a<r.length;a++){r[a].initLock=this.$q.defer()}var n=this.$location.search();return this.$q.all(this.variables.map(function(e){return t.processVariable(e,n)})).then(function(){t.templateSrv.updateTemplateData()})},e.prototype.onDashboardRefresh=function(e,t){var a=this;if(t&&t.fromVariableValueUpdated)return Promise.resolve({});var r=this.variables.filter(function(e){return 2===e.refresh}).map(function(e){var t=e.options.slice();return e.updateOptions().then(function(){D.a.toJson(t)!==D.a.toJson(e.options)&&a.$rootScope.$emit("template-variable-value-updated")})});return this.$q.all(r)},e.prototype.processVariable=function(e,t){for(var a=this,r=[],n=0,i=this.variables;n<i.length;n++){var s=i[n];e.dependsOn(s)&&r.push(s.initLock.promise)}return this.$q.all(r).then(function(){var a=t["var-"+e.name];return void 0!==a?e.setValueFromUrl(a).then(e.initLock.resolve):1===e.refresh||2===e.refresh?e.updateOptions().then(e.initLock.resolve):void e.initLock.resolve()}).finally(function(){a.templateSrv.variableInitialized(e),delete e.initLock})},e.prototype.createVariableFromModel=function(e){var t=te[e.type].ctor;if(!t)throw{message:"Unable to find variable constructor for "+e.type};return this.$injector.instantiate(t,{model:e})},e.prototype.addVariable=function(e){this.variables.push(e),this.templateSrv.updateTemplateData(),this.dashboard.updateSubmenuVisibility()},e.prototype.removeVariable=function(e){var t=A.a.indexOf(this.variables,e);this.variables.splice(t,1),this.templateSrv.updateTemplateData(),this.dashboard.updateSubmenuVisibility()},e.prototype.updateOptions=function(e){return e.updateOptions()},e.prototype.variableUpdated=function(e,t){var a=this;if(e.initLock)return this.$q.when();var r=this.createGraph().getNode(e.name),n=[];return r&&(n=r.getOptimizedInputEdges().map(function(e){return a.updateOptions(a.variables.find(function(t){return t.name===e.inputNode.name}))})),this.$q.all(n).then(function(){t&&(a.$rootScope.$emit("template-variable-value-updated"),a.$rootScope.$broadcast("refresh",{fromVariableValueUpdated:!0}))})},e.prototype.selectOptionsForCurrentValue=function(e){var t,a,r,n,i=[];for(t=0;t<e.options.length;t++)if((n=e.options[t]).selected=!1,A.a.isArray(e.current.value))for(a=0;a<e.current.value.length;a++)r=e.current.value[a],n.value===r&&(n.selected=!0,i.push(n));else n.value===e.current.value&&(n.selected=!0,i.push(n));return i},e.prototype.validateVariableSelectionState=function(e){if(e.current||(e.current={}),A.a.isArray(e.current.value)){var t=this.selectOptionsForCurrentValue(e);return t=0===t.length?e.options[0]:{value:A.a.map(t,function(e){return e.value}),text:A.a.map(t,function(e){return e.text}).join(" + ")},e.setValue(t)}var a=A.a.find(e.options,{text:e.current.text});return a?e.setValue(a):e.options.length?e.setValue(e.options[0]):Promise.resolve()},e.prototype.setOptionFromUrl=function(e,t){var a=this.$q.when();return e.refresh&&(a=e.updateOptions()),a.then(function(){var a=A.a.find(e.options,function(e){return e.text===t||e.value===t}),r=t,n=t;if(!a&&A.a.isArray(t)){r=[];for(var i=function(a){var n=A.a.find(e.options,function(e){return e.value===t[a]});n&&r.push(n.text)},s=0;s<t.length;s++)i(s)}return a=a||{text:r,value:n},e.setValue(a)})},e.prototype.setOptionAsCurrent=function(e,t){return e.current=A.a.cloneDeep(t),A.a.isArray(e.current.text)&&(e.current.text=e.current.text.join(" + ")),this.selectOptionsForCurrentValue(e),this.variableUpdated(e)},e.prototype.updateUrlParamsWithCurrentVariables=function(){var e=this.$location.search();A.a.each(e,function(t,a){0===a.indexOf("var-")&&delete e[a]}),this.templateSrv.fillVariableValuesForUrl(e),this.$location.search(e)},e.prototype.setAdhocFilter=function(e){var t=A.a.find(this.variables,{type:"adhoc",datasource:e.datasource});t||(t=this.createVariableFromModel({name:"Filters",type:"adhoc",datasource:e.datasource}),this.addVariable(t));var a=t.filters,r=A.a.find(a,{key:e.key,value:e.value});r||(r={key:e.key,value:e.value},a.push(r)),r.operator=e.operator,this.variableUpdated(t,!0)},e.prototype.createGraph=function(){var e=this,t=new ce;return this.variables.forEach(function(e){t.createNode(e.name)}),this.variables.forEach(function(a){e.variables.forEach(function(e){a!==e&&a.dependsOn(e)&&t.link(a.name,e.name)})}),t},e}();F.a.service("variableSrv",he);var pe=function(){function e(e,t,a,r){this.model=e,this.timeSrv=t,this.templateSrv=a,this.variableSrv=r,this.defaults={type:"interval",name:"",hide:0,label:"",refresh:2,options:[],current:{},query:"1m,10m,30m,1h,6h,12h,1d,7d,14d,30d",auto:!1,auto_min:"10s",auto_count:30,skipUrlSync:!1},Object(X.a)(this,e,this.defaults),this.refresh=2}return e.$inject=["model","timeSrv","templateSrv","variableSrv"],e.prototype.getSaveModel=function(){return Object(X.a)(this.model,this,this.defaults),this.model},e.prototype.setValue=function(e){return this.updateAutoValue(),this.variableSrv.setOptionAsCurrent(this,e)},e.prototype.updateAutoValue=function(){if(this.auto){this.options.length&&"auto"!==this.options[0].text&&this.options.unshift({text:"auto",value:"$__auto_interval_"+this.name});var e=ie.a.calculateInterval(this.timeSrv.timeRange(),this.auto_count,this.auto_min);this.templateSrv.setGrafanaVariable("$__auto_interval_"+this.name,e.interval),this.templateSrv.setGrafanaVariable("$__auto_interval",e.interval)}},e.prototype.updateOptions=function(){return this.options=A.a.map(this.query.match(/(["'])(.*?)\1|\w+/g),function(e){return{text:(e=e.replace(/["']+/g,"")).trim(),value:e.trim()}}),this.updateAutoValue(),this.variableSrv.validateVariableSelectionState(this)},e.prototype.dependsOn=function(e){return!1},e.prototype.setValueFromUrl=function(e){return this.updateAutoValue(),this.variableSrv.setOptionFromUrl(this,e)},e.prototype.getValueForUrl=function(){return this.current.value},e}();te.interval={name:"Interval",ctor:pe,description:"Define a timespan interval (ex 1m, 1h, 1d)"};var de=function(){function e(e,t,a,r,n){this.model=e,this.datasourceSrv=t,this.templateSrv=a,this.variableSrv=r,this.timeSrv=n,this.defaults={type:"query",label:null,query:"",regex:"",sort:0,datasource:null,refresh:0,hide:0,name:"",multi:!1,includeAll:!1,allValue:null,options:[],current:{},tags:[],useTags:!1,tagsQuery:"",tagValuesQuery:"",skipUrlSync:!1},Object(X.a)(this,e,this.defaults)}return e.$inject=["model","datasourceSrv","templateSrv","variableSrv","timeSrv"],e.prototype.getSaveModel=function(){return Object(X.a)(this.model,this,this.defaults),0!==this.refresh&&(this.model.options=[]),this.model},e.prototype.setValue=function(e){return this.variableSrv.setOptionAsCurrent(this,e)},e.prototype.setValueFromUrl=function(e){return this.variableSrv.setOptionFromUrl(this,e)},e.prototype.getValueForUrl=function(){return"All"===this.current.text?"All":this.current.value},e.prototype.updateOptions=function(){return this.datasourceSrv.get(this.datasource).then(this.updateOptionsFromMetricFindQuery.bind(this)).then(this.updateTags.bind(this)).then(this.variableSrv.validateVariableSelectionState.bind(this.variableSrv,this))},e.prototype.updateTags=function(e){var t=this;return this.useTags?this.metricFindQuery(e,this.tagsQuery).then(function(a){t.tags=[];for(var r=0;r<a.length;r++)t.tags.push(a[r].text);return e}):(delete this.tags,e)},e.prototype.getValuesForTag=function(e){var t=this;return this.datasourceSrv.get(this.datasource).then(function(a){var r=t.tagValuesQuery.replace("$tag",e);return t.metricFindQuery(a,r).then(function(e){return A.a.map(e,function(e){return e.text})})})},e.prototype.updateOptionsFromMetricFindQuery=function(e){var t=this;return this.metricFindQuery(e,this.query).then(function(a){return t.options=t.metricNamesToVariableValues(a),t.includeAll&&t.addAllOption(),t.options.length||t.options.push({text:"None",value:"",isNone:!0}),e})},e.prototype.metricFindQuery=function(e,t){var a={range:void 0,variable:this};return 2===this.refresh&&(a.range=this.timeSrv.timeRange()),e.metricFindQuery(t,a)},e.prototype.addAllOption=function(){this.options.unshift({text:"All",value:"$__all"})},e.prototype.metricNamesToVariableValues=function(e){var t,a,r,n;for(a=[],this.regex&&(t=ie.a.stringToJsRegex(this.templateSrv.replace(this.regex,{},"regex"))),r=0;r<e.length;r++){var i=e[r],s=void 0===i.text||null===i.text?i.value:i.text,o=void 0===i.value||null===i.value?i.text:i.value;if(A.a.isNumber(o)&&(o=o.toString()),A.a.isNumber(s)&&(s=s.toString()),t){if(!(n=t.exec(o)))continue;n.length>1&&(o=n[1],s=n[1])}a.push({text:s,value:o})}return a=A.a.uniqBy(a,"value"),this.sortVariableValues(a,this.sort)},e.prototype.sortVariableValues=function(e,t){if(0===t)return e;var a=Math.ceil(t/2),r=t%2==0;return 1===a?e=A.a.sortBy(e,"text"):2===a?e=A.a.sortBy(e,function(e){var t=e.text.match(/.*?(\d+).*/);return!t||t.length<2?-1:parseInt(t[1],10)}):3===a&&(e=A.a.sortBy(e,function(e){return A.a.toLower(e.text)})),r&&(e=e.reverse()),e},e.prototype.dependsOn=function(e){return ae(this.query,this.datasource,this.regex,e.name)},e}();te.query={name:"Query",ctor:de,description:"Variable values are fetched from a datasource query",supportsMulti:!0};var me=function(){function e(e,t,a,r){this.model=e,this.datasourceSrv=t,this.variableSrv=a,this.templateSrv=r,this.defaults={type:"datasource",name:"",hide:0,label:"",current:{},regex:"",options:[],query:"",refresh:1,skipUrlSync:!1},Object(X.a)(this,e,this.defaults),this.refresh=1}return e.$inject=["model","datasourceSrv","variableSrv","templateSrv"],e.prototype.getSaveModel=function(){return Object(X.a)(this.model,this,this.defaults),this.model.options=[],this.model},e.prototype.setValue=function(e){return this.variableSrv.setOptionAsCurrent(this,e)},e.prototype.updateOptions=function(){var e,t=[],a=this.datasourceSrv.getMetricSources({skipVariables:!0});this.regex&&(e=this.templateSrv.replace(this.regex,null,"regex"),e=ie.a.stringToJsRegex(e));for(var r=0;r<a.length;r++){var n=a[r];n.meta.id===this.query&&(e&&!e.exec(n.name)||t.push({text:n.name,value:n.name}))}return 0===t.length&&t.push({text:"No data sources found",value:""}),this.options=t,this.variableSrv.validateVariableSelectionState(this)},e.prototype.dependsOn=function(e){return!!this.regex&&ae(this.regex,e.name)},e.prototype.setValueFromUrl=function(e){return this.variableSrv.setOptionFromUrl(this,e)},e.prototype.getValueForUrl=function(){return this.current.value},e}();te.datasource={name:"Datasource",ctor:me,description:"Enabled you to dynamically switch the datasource for multiple panels"};var fe=function(){function e(e,t){this.model=e,this.variableSrv=t,this.defaults={type:"custom",name:"",label:"",hide:0,options:[],current:{},query:"",includeAll:!1,multi:!1,allValue:null,skipUrlSync:!1},Object(X.a)(this,e,this.defaults)}return e.$inject=["model","variableSrv"],e.prototype.setValue=function(e){return this.variableSrv.setOptionAsCurrent(this,e)},e.prototype.getSaveModel=function(){return Object(X.a)(this.model,this,this.defaults),this.model},e.prototype.updateOptions=function(){return this.options=A.a.map(this.query.split(/[,]+/),function(e){return{text:e.trim(),value:e.trim()}}),this.includeAll&&this.addAllOption(),this.variableSrv.validateVariableSelectionState(this)},e.prototype.addAllOption=function(){this.options.unshift({text:"All",value:"$__all"})},e.prototype.dependsOn=function(e){return!1},e.prototype.setValueFromUrl=function(e){return this.variableSrv.setOptionFromUrl(this,e)},e.prototype.getValueForUrl=function(){return"All"===this.current.text?"All":this.current.value},e}();te.custom={name:"Custom",ctor:fe,description:"Define variable values manually",supportsMulti:!0};var ge=function(){function e(e,t){this.model=e,this.variableSrv=t,this.defaults={type:"constant",name:"",hide:2,label:"",query:"",current:{},options:[],skipUrlSync:!1},Object(X.a)(this,e,this.defaults)}return e.$inject=["model","variableSrv"],e.prototype.getSaveModel=function(){return Object(X.a)(this.model,this,this.defaults),this.model},e.prototype.setValue=function(e){this.variableSrv.setOptionAsCurrent(this,e)},e.prototype.updateOptions=function(){return this.options=[{text:this.query.trim(),value:this.query.trim()}],this.setValue(this.options[0]),Promise.resolve()},e.prototype.dependsOn=function(e){return!1},e.prototype.setValueFromUrl=function(e){return this.variableSrv.setOptionFromUrl(this,e)},e.prototype.getValueForUrl=function(){return this.current.value},e}();te.constant={name:"Constant",ctor:ge,description:"Define a hidden constant variable, useful for metric prefixes in dashboards you want to share"};var ve=function(){function e(e){this.model=e,this.defaults={type:"adhoc",name:"",label:"",hide:0,datasource:null,filters:[],skipUrlSync:!1},Object(X.a)(this,e,this.defaults)}return e.$inject=["model"],e.prototype.setValue=function(e){return Promise.resolve()},e.prototype.getSaveModel=function(){return Object(X.a)(this.model,this,this.defaults),this.model},e.prototype.updateOptions=function(){return Promise.resolve()},e.prototype.dependsOn=function(e){return!1},e.prototype.setValueFromUrl=function(e){var t=this;return A.a.isArray(e)||(e=[e]),this.filters=e.map(function(e){var a=e.split("|").map(function(e){return t.unescapeDelimiter(e)});return{key:a[0],operator:a[1],value:a[2]}}),Promise.resolve()},e.prototype.getValueForUrl=function(){var e=this;return this.filters.map(function(t){return[t.key,t.operator,t.value].map(function(t){return e.escapeDelimiter(t)}).join("|")})},e.prototype.escapeDelimiter=function(e){return e.replace(/\|/g,"__gfp__")},e.prototype.unescapeDelimiter=function(e){return e.replace(/__gfp__/g,"|")},e.prototype.setFilters=function(e){this.filters=e},e}();te.adhoc={name:"Ad hoc filters",ctor:ve,description:"Add key/value filters on the fly"};var ye=function(){function e(e,t){this.model=e,this.variableSrv=t,this.defaults={type:"textbox",name:"",hide:2,label:"",query:"",current:{},options:[],skipUrlSync:!1},Object(X.a)(this,e,this.defaults)}return e.$inject=["model","variableSrv"],e.prototype.getSaveModel=function(){return Object(X.a)(this.model,this,this.defaults),this.model},e.prototype.setValue=function(e){this.variableSrv.setOptionAsCurrent(this,e)},e.prototype.updateOptions=function(){return this.options=[{text:this.query.trim(),value:this.query.trim()}],this.current=this.options[0],Promise.resolve()},e.prototype.dependsOn=function(e){return!1},e.prototype.setValueFromUrl=function(e){return this.query=e,this.variableSrv.setOptionFromUrl(this,e)},e.prototype.getValueForUrl=function(){return this.current.value},e}();te.textbox={name:"Text box",ctor:ye,description:"Define a textbox variable, where users can enter any arbitrary string"},F.a.factory("templateSrv",function(){return oe});var be=a(1223),Se=a.n(be),xe=function(){function e(e,t,a,r,n,i){this.$scope=e,this.$rootScope=t,this.backendSrv=a,this.$sce=r,this.$routeParams=n,this.pluginId=n.pluginId,this.preUpdateHook=function(){return Promise.resolve()},this.postUpdateHook=function(){return Promise.resolve()},this.init()}return e.$inject=["$scope","$rootScope","backendSrv","$sce","$routeParams","navModelSrv"],e.prototype.setNavModel=function(e){var t="readme";(this.navModel={main:{img:e.info.logos.large,subTitle:e.info.author.name,url:"",text:e.name,breadcrumbs:[{title:"Plugins",url:"plugins"}],children:[{icon:"fa fa-fw fa-file-text-o",id:"readme",text:"Readme",url:"plugins/"+this.model.id+"/edit?tab=readme"}]}},"app"===e.type)&&(this.navModel.main.children.push({icon:"gicon gicon-cog",id:"config",text:"Config",url:"plugins/"+this.model.id+"/edit?tab=config"}),A.a.find(e.includes,{type:"dashboard"})&&this.navModel.main.children.push({icon:"gicon gicon-dashboard",id:"dashboards",text:"Dashboards",url:"plugins/"+this.model.id+"/edit?tab=dashboards"}),t="config");this.tab=this.$routeParams.tab||t;for(var a=0,r=this.navModel.main.children;a<r.length;a++){var n=r[a];n.id===this.tab&&(n.active=!0)}},e.prototype.init=function(){var e=this;return this.backendSrv.get("/api/plugins/"+this.pluginId+"/settings").then(function(t){return e.model=t,e.pluginIcon=e.getPluginIcon(e.model.type),e.model.dependencies.plugins.forEach(function(t){t.icon=e.getPluginIcon(t.type)}),e.includes=A.a.map(t.includes,function(t){return t.icon=e.getPluginIcon(t.type),t}),e.setNavModel(e.model),e.initReadme()})},e.prototype.initReadme=function(){var e=this;return this.backendSrv.get("/api/plugins/"+this.pluginId+"/markdown/readme").then(function(t){var a=new Se.a({linkify:!0});e.readmeHtml=e.$sce.trustAsHtml(a.render(t))})},e.prototype.getPluginIcon=function(e){switch(e){case"datasource":return"icon-gf icon-gf-datasources";case"panel":return"icon-gf icon-gf-panel";case"app":return"icon-gf icon-gf-apps";case"page":return"icon-gf icon-gf-endpoint-tiny";case"dashboard":return"icon-gf icon-gf-dashboard";default:return"icon-gf icon-gf-apps"}},e.prototype.update=function(){var e=this;this.preUpdateHook().then(function(){var t=A.a.extend({enabled:e.model.enabled,pinned:e.model.pinned,jsonData:e.model.jsonData,secureJsonData:e.model.secureJsonData},{});return e.backendSrv.post("/api/plugins/"+e.pluginId+"/settings",t)}).then(this.postUpdateHook).then(function(e){window.location.href=window.location.href})},e.prototype.importDashboards=function(){return Promise.resolve()},e.prototype.setPreUpdateHook=function(e){this.preUpdateHook=e},e.prototype.setPostUpdateHook=function(e){this.postUpdateHook=e},e.prototype.updateAvailable=function(){var e=this.$scope.$new(!0);e.plugin=this.model,this.$rootScope.appEvent("show-modal",{src:"public/app/features/plugins/partials/update_instructions.html",scope:e})},e.prototype.enable=function(){this.model.enabled=!0,this.model.pinned=!0,this.update()},e.prototype.disable=function(){this.model.enabled=!1,this.model.pinned=!1,this.update()},e}();D.a.module("grafana.controllers").controller("PluginEditCtrl",xe);var we={},Te=function(){function e(e,t,a,r){this.backendSrv=e,this.$routeParams=t,this.$rootScope=a,this.navModelSrv=r,this.pluginId=t.pluginId,we[this.pluginId]?this.initPage(we[this.pluginId]):this.loadPluginInfo()}return e.$inject=["backendSrv","$routeParams","$rootScope","navModelSrv"],e.prototype.initPage=function(e){if(this.appModel=e,this.page=A.a.find(e.includes,{slug:this.$routeParams.slug}),we[this.pluginId]=e,!this.page)return this.$rootScope.appEvent("alert-error",["App Page Not Found",""]),void(this.navModel=this.navModelSrv.getNotFoundNav());var t=this.navModelSrv.getNav("plugin-page-"+e.id);this.navModel={main:{img:e.info.logos.large,subTitle:e.name,url:"",text:this.page.name,breadcrumbs:[{title:e.name,url:t.main.url}]}}},e.prototype.loadPluginInfo=function(){var e=this;this.backendSrv.get("/api/plugins/"+this.pluginId+"/settings").then(function(t){e.initPage(t)})},e}();D.a.module("grafana.controllers").controller("AppPageCtrl",Te);var Ce=function(){function e(e,t,a){var r=this;this.backendSrv=t,this.$rootScope=a,this.dashboards=[],t.get("/api/plugins/"+this.plugin.id+"/dashboards").then(function(e){r.dashboards=e}),re.a.on("dashboard-list-import-all",this.importAll.bind(this),e)}return e.$inject=["$scope","backendSrv","$rootScope"],e.prototype.importAll=function(e){return this.importNext(0).then(function(){e.resolve("All dashboards imported")}).catch(function(t){e.reject(t)})},e.prototype.importNext=function(e){var t=this;return this.import(this.dashboards[e],!0).then(function(){return e+1<t.dashboards.length?new Promise(function(a){setTimeout(function(){t.importNext(e+1).then(function(){a()})},500)}):Promise.resolve()})},e.prototype.import=function(e,t){var a=this,r={pluginId:this.plugin.id,path:e.path,overwrite:t,inputs:[]};return this.datasource&&r.inputs.push({name:"*",type:"datasource",pluginId:this.datasource.type,value:this.datasource.name}),this.backendSrv.post("/api/dashboards/import",r).then(function(t){a.$rootScope.appEvent("alert-success",["Dashboard Imported",e.title]),A.a.extend(e,t)})},e.prototype.remove=function(e){var t=this;this.backendSrv.delete("/api/dashboards/"+e.importedUri).then(function(){t.$rootScope.appEvent("alert-success",["Dashboard Deleted",e.title]),e.imported=!1})},e}();F.a.directive("dashboardImportList",function(){return{restrict:"E",templateUrl:"public/app/features/plugins/import_list/import_list.html",controller:Ce,bindToController:!0,controllerAs:"ctrl",scope:{plugin:"=",datasource:"="}}});var ke=a(9),_e=a(74),Ee=a(38);function Me(e,t,a){var r="New",n="Type: "+t.name;e.id&&(r=e.name);var i={img:t.info.logos.large,id:"ds-edit-"+t.id,subTitle:n,url:"",text:r,breadcrumbs:[{title:"Data Sources",url:"datasources"}],children:[{active:"datasource-settings"===a,icon:"fa fa-fw fa-sliders",id:"datasource-settings",text:"Settings",url:"datasources/edit/"+e.id}]};return void 0!==A.a.find(t.includes,{type:"dashboard"})&&e.id&&i.children.push({active:"datasource-dashboards"===a,icon:"fa fa-fw fa-th-large",id:"datasource-dashboards",text:"Dashboards",url:"datasources/edit/"+e.id+"/dashboards"}),{main:i,node:A.a.find(i.children,{active:!0})}}var Pe=[],De={name:"",type:"graphite",url:"",access:"proxy",jsonData:{},secureJsonFields:{},secureJsonData:{}},$e=!1,Ae=function(){function e(e,t,a,r,n){var i=this;this.$q=e,this.backendSrv=t,this.$routeParams=a,this.$location=r,this.datasourceSrv=n;var s=_e.b.getState();this.navModel=Object(Ee.a)(s.navIndex,"datasources"),this.datasources=[],this.loadDatasourceTypes().then(function(){i.$routeParams.id?i.getDatasourceById(i.$routeParams.id):i.initNewDatasourceModel()})}return e.$inject=["$q","backendSrv","$routeParams","$location","datasourceSrv"],e.prototype.initNewDatasourceModel=function(){this.isNew=!0,this.current=A.a.cloneDeep(De),this.$location.search().gettingstarted&&(this.gettingStarted=!0,this.current.isDefault=!0),this.typeChanged()},e.prototype.loadDatasourceTypes=function(){var e=this;return Pe.length>0?(this.types=Pe,this.$q.when(null)):this.backendSrv.get("/api/plugins",{enabled:1,type:"datasource"}).then(function(t){Pe=t,e.types=t})},e.prototype.getDatasourceById=function(e){var t=this;this.backendSrv.get("/api/datasources/"+e).then(function(e){return t.isNew=!1,t.current=e,$e&&($e=!1,t.testDatasource()),t.typeChanged()})},e.prototype.userChangedType=function(){this.current=A.a.defaults({id:this.current.id,name:this.current.name,isDefault:this.current.isDefault,type:this.current.type},A.a.cloneDeep(De)),this.typeChanged()},e.prototype.updateNav=function(){this.navModel=Me(this.current,this.datasourceMeta,"datasource-settings")},e.prototype.typeChanged=function(){var e=this;return this.backendSrv.get("/api/plugins/"+this.current.type+"/settings").then(function(t){e.datasourceMeta=t,e.updateNav()})},e.prototype.updateFrontendSettings=function(){var e=this;return this.backendSrv.get("/api/frontend/settings").then(function(t){ke.a.datasources=t.datasources,ke.a.defaultDatasource=t.defaultDatasource,e.datasourceSrv.init()})},e.prototype.testDatasource=function(){var e=this;this.datasourceSrv.get(this.current.name).then(function(t){t.testDatasource&&(e.testing={done:!1,status:"error"},e.backendSrv.withNoBackendCache(function(){return t.testDatasource().then(function(t){e.testing.message=t.message,e.testing.status=t.status}).catch(function(t){t.statusText?e.testing.message="HTTP Error "+t.statusText:e.testing.message=t.message})}).finally(function(){e.testing.done=!0}))})},e.prototype.saveChanges=function(){var e=this;if(this.editForm.$valid&&!this.current.readOnly)return this.current.id?this.backendSrv.put("/api/datasources/"+this.current.id,this.current).then(function(t){e.current=t.datasource,e.updateNav(),e.updateFrontendSettings().then(function(){e.testDatasource()})}):this.backendSrv.post("/api/datasources",this.current).then(function(t){e.current=t.datasource,e.updateFrontendSettings(),$e=!0,e.$location.path("datasources/edit/"+t.id)})},e.prototype.confirmDelete=function(){var e=this;this.backendSrv.delete("/api/datasources/"+this.current.id).then(function(){e.$location.path("datasources")})},e.prototype.delete=function(e){var t=this;j.b.emit("confirm-modal",{title:"Delete",text:"Are you sure you want to delete this datasource?",yesText:"Delete",icon:"fa-trash",onConfirm:function(){t.confirmDelete()}})},e}();j.d.controller("DataSourceEditCtrl",Ae),j.d.directive("datasourceHttpSettings",function(){return{scope:{current:"=",suggestUrl:"@",noDirectAccess:"@"},templateUrl:"public/app/features/plugins/partials/ds_http_settings.html",link:{pre:function(e,t,a){e.showAccessOption="true"!==e.noDirectAccess,e.showAccessHelp=!1,e.toggleAccessHelp=function(){e.showAccessHelp=!e.showAccessHelp},e.getSuggestUrls=function(){return[e.suggestUrl]}}}}});var Ie=function(){function e(e,t){this.backendSrv=e,this.$routeParams=t;var a=_e.b.getState();this.navModel=Object(Ee.a)(a.navIndex,"datasources"),this.$routeParams.id&&this.getDatasourceById(this.$routeParams.id)}return e.$inject=["backendSrv","$routeParams"],e.prototype.getDatasourceById=function(e){var t=this;this.backendSrv.get("/api/datasources/"+e).then(function(e){t.current=e}).then(this.getPluginInfo.bind(this))},e.prototype.updateNav=function(){this.navModel=Me(this.current,this.datasourceMeta,"datasource-dashboards")},e.prototype.getPluginInfo=function(){var e=this;return this.backendSrv.get("/api/plugins/"+this.current.type+"/settings").then(function(t){e.datasourceMeta=t,e.updateNav()})},e}();j.d.controller("DataSourceDashboardsCtrl",Ie);var Oe=a(1227),Fe=a.n(Oe),qe=a(76),Ne=a(33),Re=a(41),Le=function(){function e(e,t){var a=this;this.$injector=t,this.$location=t.get("$location"),this.$scope=e,this.$timeout=t.get("$timeout"),this.editorTabIndex=0,this.events=this.panel.events,this.timing={};var r=ke.a.panels[this.panel.type];r&&(this.pluginId=r.id,this.pluginName=r.name),e.$on("refresh",function(){return a.refresh()}),e.$on("component-did-mount",function(){return a.panelDidMount()}),e.$on("$destroy",function(){a.events.emit("panel-teardown"),a.events.removeAllListeners()})}return e.prototype.init=function(){this.events.emit("panel-initialized"),this.publishAppEvent("panel-initialized",{scope:this.$scope})},e.prototype.panelDidMount=function(){this.events.emit("component-did-mount")},e.prototype.renderingCompleted=function(){j.e.renderingCompleted(this.panel.id,this.timing)},e.prototype.refresh=function(){this.events.emit("refresh",null)},e.prototype.publishAppEvent=function(e,t){this.$scope.$root.appEvent(e,t)},e.prototype.changeView=function(e,t){this.publishAppEvent("panel-change-view",{fullscreen:e,edit:t,panelId:this.panel.id})},e.prototype.viewPanel=function(){this.changeView(!0,!1)},e.prototype.editPanel=function(){this.changeView(!0,!0)},e.prototype.exitFullscreen=function(){this.changeView(!1,!1)},e.prototype.initEditMode=function(){var e=this;this.editorTabs=[],this.addEditorTab("General","public/app/partials/panelgeneral.html"),this.editModeInitiated=!0,this.events.emit("init-edit-mode",null);var t=(this.$injector.get("$routeParams").tab||"").toLowerCase();t&&this.editorTabs.forEach(function(a,r){a.title.toLowerCase()===t&&(e.editorTabIndex=r)})},e.prototype.changeTab=function(e){this.editorTabIndex=e;var t=this.$injector.get("$route");t.current.params.tab=this.editorTabs[e].title.toLowerCase(),t.updateParams()},e.prototype.addEditorTab=function(e,t,a){var r={title:e,directiveFn:t};A.a.isString(t)&&(r.directiveFn=function(){return{templateUrl:t}}),a?this.editorTabs.splice(a,0,r):this.editorTabs.push(r)},e.prototype.getMenu=function(){var e=[];e.push({text:"View",click:"ctrl.viewPanel();",icon:"fa fa-fw fa-eye",shortcut:"v"}),this.dashboard.meta.canEdit&&e.push({text:"Edit",click:"ctrl.editPanel();",role:"Editor",icon:"fa fa-fw fa-edit",shortcut:"e"}),e.push({text:"Share",click:"ctrl.sharePanel();",icon:"fa fa-fw fa-share",shortcut:"p s"}),e.push.apply(e,this.getAdditionalMenuItems());var t=this.getExtendedMenu();return e.push({text:"More ...",click:"",icon:"fa fa-fw fa-cube",submenu:t}),this.dashboard.meta.canEdit&&(e.push({divider:!0,role:"Editor"}),e.push({text:"Remove",click:"ctrl.removePanel();",role:"Editor",icon:"fa fa-fw fa-trash",shortcut:"p r"})),e},e.prototype.getExtendedMenu=function(){var e=[];return!this.fullscreen&&this.dashboard.meta.canEdit&&(e.push({text:"Duplicate",click:"ctrl.duplicate()",role:"Editor",shortcut:"p d"}),e.push({text:"Copy",click:"ctrl.copyPanel()",role:"Editor"})),e.push({text:"Panel JSON",click:"ctrl.editPanelJson(); dismiss();"}),this.events.emit("init-panel-actions",e),e},e.prototype.getAdditionalMenuItems=function(){return[]},e.prototype.otherPanelInFullscreenMode=function(){return this.dashboard.meta.fullscreen&&!this.fullscreen},e.prototype.calculatePanelHeight=function(){if(this.fullscreen){var e=O()(window).height(),t=Math.floor(.4*e),a=Math.floor(.8*e);this.containerHeight=this.editMode?t:a}else this.containerHeight=this.panel.gridPos.h*Ne.c+(this.panel.gridPos.h-1)*Ne.d;this.panel.soloMode&&(this.containerHeight=O()(window).height()),this.height=this.containerHeight-29},e.prototype.render=function(e){this.timing.renderStart=(new Date).getTime(),this.events.emit("render",e)},e.prototype.duplicate=function(){var e=this;this.dashboard.duplicatePanel(this.panel),this.$timeout(function(){e.$scope.$root.$broadcast("render")})},e.prototype.removePanel=function(){this.publishAppEvent("panel-remove",{panelId:this.panel.id})},e.prototype.editPanelJson=function(){var e=this.$scope.$root.$new();e.object=this.panel.getSaveModel(),e.updateHandler=this.replacePanel.bind(this),e.enableCopy=!0,this.publishAppEvent("show-modal",{src:"public/app/partials/edit_json.html",scope:e})},e.prototype.copyPanel=function(){Re.a.set(Ne.f,JSON.stringify(this.panel.getSaveModel())),j.b.emit("alert-success",["Panel copied. Open Add Panel to paste"])},e.prototype.replacePanel=function(e,t){var a=this.dashboard,r=A.a.findIndex(a.panels,function(e){return e.id===t.id}),n=a.panels.splice(r,1);this.dashboard.events.emit("panel-removed",n),(e=new qe.a(e)).id=t.id,a.panels.splice(r,0,e),a.sortPanelsByGridPos(),a.events.emit("panel-added",e)},e.prototype.sharePanel=function(){var e=this.$scope.$new();e.panel=this.panel,e.dashboard=this.dashboard,this.publishAppEvent("show-modal",{src:"public/app/features/dashboard/partials/shareModal.html",scope:e})},e.prototype.getInfoMode=function(){return this.error?"error":this.panel.description?"info":this.panel.links&&this.panel.links.length?"links":""},e.prototype.getInfoContent=function(e){var t=this.panel.description;"tooltip"===e.mode&&(t=this.error||this.panel.description);var a=this.$injector.get("linkSrv"),r=this.$injector.get("$sanitize"),n=this.$injector.get("templateSrv").replace(t,this.panel.scopedVars),i='<div class="markdown-html">';if(i+=(new Se.a).render(n),this.panel.links&&this.panel.links.length>0){i+="<ul>";for(var s=0,o=this.panel.links;s<o.length;s++){var l=o[s],u=a.getPanelLinkAnchorInfo(l,this.panel.scopedVars);i+='<li><a class="panel-menu-link" href="'+u.href+'" target="'+u.target+'">'+u.title+"</a></li>"}i+="</ul>"}return r(i+="</div>")},e.prototype.openInspector=function(){var e=this.$scope.$new();e.panel=this.panel,e.dashboard=this.dashboard,e.panelInfoHtml=this.getInfoContent({mode:"inspector"}),e.inspector=O.a.extend(!0,{},this.inspector),this.publishAppEvent("show-modal",{src:"public/app/features/dashboard/partials/inspector.html",scope:e})},e}(),Ve=a(3),Ue=a(285),je=a(204),Be=a(289),Qe=function(){function e(e,t,a,r){this.$sce=t,this.backendSrv=r,this.panelCtrl=e.ctrl,e.ctrl=this,this.panel=this.panelCtrl.panel,this.dashboard=this.panelCtrl.dashboard,this.datasources=a.getMetricSources(),this.panelDsValue=this.panelCtrl.panel.datasource;for(var n=0,i=this.datasources;n<i.length;n++){var s=i[n];s.value===this.panelDsValue&&(this.datasourceInstance=s)}this.addQueryDropdown={text:"Add Query",value:null,fake:!0},this.panelCtrl.nextRefId=this.dashboard.getNextQueryLetter(this.panel),this.updateDatasourceOptions()}return e.$inject=["$scope","$sce","datasourceSrv","backendSrv"],e.prototype.updateDatasourceOptions=function(){this.datasourceInstance&&(this.hasQueryHelp=this.datasourceInstance.meta.hasQueryHelp,this.queryOptions=this.datasourceInstance.meta.queryOptions)},e.prototype.getOptions=function(e){return Promise.resolve(this.datasources.filter(function(t){return e||!t.meta.builtIn}).map(function(e){return{value:e.value,text:e.name,datasource:e}}))},e.prototype.datasourceChanged=function(e){e&&(this.datasourceInstance=e.datasource,this.panelCtrl.setDatasource(e.datasource),this.updateDatasourceOptions())},e.prototype.addMixedQuery=function(e){e&&(this.panelCtrl.addQuery({isNew:!0,datasource:e.datasource.name}),this.addQueryDropdown={text:"Add Query",value:null,fake:!0})},e.prototype.addQuery=function(){this.panelCtrl.addQuery({isNew:!0})},e.prototype.toggleHelp=function(){var e=this;this.optionsOpen=!1,this.queryTroubleshooterOpen=!1,this.helpOpen=!this.helpOpen,this.backendSrv.get("/api/plugins/"+this.datasourceInstance.meta.id+"/markdown/query_help").then(function(t){var a=new Se.a;e.helpHtml=e.$sce.trustAsHtml(a.render(t))})},e.prototype.toggleOptions=function(){this.helpOpen=!1,this.queryTroubleshooterOpen=!1,this.optionsOpen=!this.optionsOpen},e.prototype.toggleQueryTroubleshooter=function(){this.helpOpen=!1,this.optionsOpen=!1,this.queryTroubleshooterOpen=!this.queryTroubleshooterOpen},e}();function He(){return{restrict:"E",scope:!0,templateUrl:"public/app/features/panel/partials/metrics_tab.html",controller:Qe}}var ze=function(e){function t(t,a){var r=e.call(this,t,a)||this;return r.editorTabIndex=1,r.$q=a.get("$q"),r.contextSrv=a.get("contextSrv"),r.datasourceSrv=a.get("datasourceSrv"),r.timeSrv=a.get("timeSrv"),r.templateSrv=a.get("templateSrv"),r.scope=t,r.panel.datasource=r.panel.datasource||null,r.panel.targets||(r.panel.targets=[{}]),r.events.on("refresh",r.onMetricsPanelRefresh.bind(r)),r.events.on("init-edit-mode",r.onInitMetricsPanelEditMode.bind(r)),r.events.on("panel-teardown",r.onPanelTearDown.bind(r)),r}return Ve.c(t,e),t.prototype.onPanelTearDown=function(){this.dataSubscription&&(this.dataSubscription.unsubscribe(),this.dataSubscription=null)},t.prototype.onInitMetricsPanelEditMode=function(){this.addEditorTab("Metrics",He),this.addEditorTab("Time range","public/app/features/panel/partials/panelTime.html")},t.prototype.onMetricsPanelRefresh=function(){var e=this;if(!this.otherPanelInFullscreenMode()){if(this.panel.snapshotData){this.updateTimeRange();var t=this.panel.snapshotData;return A.a.isArray(t)||(t=t.data),this.$timeout(function(){e.events.emit("data-snapshot-load",t)})}this.dataStream||(delete this.error,this.loading=!0,this.setTimeQueryStart(),this.datasourceSrv.get(this.panel.datasource).then(this.updateTimeRange.bind(this)).then(this.issueQueries.bind(this)).then(this.handleQueryResult.bind(this)).catch(function(t){t.cancelled?console.log("Panel request cancelled",t):(e.loading=!1,e.error=t.message||"Request Error",e.inspector={error:t},t.data&&(t.data.message&&(e.error=t.data.message),t.data.error&&(e.error=t.data.error)),e.events.emit("data-error",t),console.log("Panel data error:",t))}))}},t.prototype.setTimeQueryStart=function(){this.timing.queryStart=(new Date).getTime()},t.prototype.setTimeQueryEnd=function(){this.timing.queryEnd=(new Date).getTime()},t.prototype.updateTimeRange=function(e){return this.datasource=e||this.datasource,this.range=this.timeSrv.timeRange(),this.applyPanelTimeOverrides(),this.panel.maxDataPoints?this.resolution=this.panel.maxDataPoints:this.resolution=Math.ceil(O()(window).width()*(this.panel.gridPos.w/24)),this.calculateInterval(),this.datasource},t.prototype.calculateInterval=function(){var e=this.panel.interval;e?e=this.templateSrv.replace(e,this.panel.scopedVars):this.datasource&&this.datasource.interval&&(e=this.datasource.interval);var t=ie.a.calculateInterval(this.range,this.resolution,e);this.interval=t.interval,this.intervalMs=t.intervalMs},t.prototype.applyPanelTimeOverrides=function(){if(this.timeInfo="",this.panel.timeFrom){var e=this.templateSrv.replace(this.panel.timeFrom,this.panel.scopedVars),t=Ue.a(e);if(t.invalid)return void(this.timeInfo="invalid time override");if(A.a.isString(this.range.raw.from)){var a=je.parse(t.from);this.timeInfo=t.display,this.range.from=a,this.range.to=je.parse(t.to),this.range.raw.from=t.from,this.range.raw.to=t.to}}if(this.panel.timeShift){var r=this.templateSrv.replace(this.panel.timeShift,this.panel.scopedVars);if(Ue.a(r).invalid)return void(this.timeInfo="invalid timeshift");var n="-"+r;this.timeInfo+=" timeshift "+n,this.range.from=je.parseDateMath(n,this.range.from,!1),this.range.to=je.parseDateMath(n,this.range.to,!0),this.range.raw={from:this.range.from,to:this.range.to}}this.panel.hideTimeOverride&&(this.timeInfo="")},t.prototype.issueQueries=function(e){if(this.datasource=e,!this.panel.targets||0===this.panel.targets.length)return this.$q.when([]);var t=Object.assign({},this.panel.scopedVars,{__interval:{text:this.interval,value:this.interval},__interval_ms:{text:this.intervalMs,value:this.intervalMs}}),a={timezone:this.dashboard.getTimezone(),panelId:this.panel.id,dashboardId:this.dashboard.id,range:this.range,rangeRaw:this.range.raw,interval:this.interval,intervalMs:this.intervalMs,targets:this.panel.targets,maxDataPoints:this.resolution,scopedVars:t,cacheTimeout:this.panel.cacheTimeout};return e.query(a)},t.prototype.handleQueryResult=function(e){this.setTimeQueryEnd(),this.loading=!1,e&&e.subscribe?this.handleDataStream(e):(this.dashboard.snapshot&&(this.panel.snapshotData=e.data),e&&e.data||(console.log("Data source query result invalid, missing data field:",e),e={data:[]}),this.events.emit("data-received",e.data))},t.prototype.handleDataStream=function(e){var t=this;this.dataStream?console.log("two stream observables!"):(this.dataStream=e,this.dataSubscription=e.subscribe({next:function(e){console.log("dataSubject next!"),e.range&&(t.range=e.range),t.events.emit("data-received",e.data)},error:function(e){t.events.emit("data-error",e),console.log("panel: observer got error")},complete:function(){console.log("panel: observer got complete"),t.dataStream=null}}))},t.prototype.setDatasource=function(e){var t=this;e.meta.mixed?A.a.each(this.panel.targets,function(e){e.datasource=t.panel.datasource,e.datasource||(e.datasource=ke.a.defaultDatasource)}):this.datasource&&this.datasource.meta.mixed&&A.a.each(this.panel.targets,function(e){delete e.datasource}),this.panel.datasource=e.value,this.datasourceName=e.name,this.datasource=null,this.refresh()},t.prototype.getAdditionalMenuItems=function(){var e=[];return ke.a.exploreEnabled&&this.contextSrv.isEditor&&this.datasource&&(this.datasource.meta.explore||"mixed"===this.datasource.meta.id)&&e.push({text:"Explore",click:"ctrl.explore();",icon:"fa fa-fw fa-rocket",shortcut:"x"}),e},t.prototype.explore=function(){return Ve.b(this,void 0,void 0,function(){var e,t=this;return Ve.d(this,function(a){switch(a.label){case 0:return[4,Object(Be.b)(this.panel,this.panel.targets,this.datasource,this.datasourceSrv,this.timeSrv)];case 1:return(e=a.sent())&&this.$timeout(function(){return t.$location.url(e)}),[2]}})})},t.prototype.addQuery=function(e){e.refId=this.dashboard.getNextQueryLetter(this.panel),this.panel.targets.push(e),this.nextRefId=this.dashboard.getNextQueryLetter(this.panel)},t.prototype.removeQuery=function(e){var t=A.a.indexOf(this.panel.targets,e);this.panel.targets.splice(t,1),this.nextRefId=this.dashboard.getNextQueryLetter(this.panel),this.refresh()},t.prototype.moveQuery=function(e,t){var a=A.a.indexOf(this.panel.targets,e);A.a.move(this.panel.targets,a,a+t)},t}(Le),Ye=function(){function e(e,t){this.$scope=e,this.$injector=t,this.panel=this.panelCtrl.panel,this.isLastQuery=A.a.indexOf(this.panel.targets,this.target)===this.panel.targets.length-1}return e.prototype.refresh=function(){this.panelCtrl.refresh()},e}(),Ge=function(){function e(){}return e.alertToGraphThresholds=function(e){for(var t=0;t<e.alert.conditions.length;t++){var a=e.alert.conditions[t];if("query"===a.type){var r=a.evaluator,n=e.thresholds=[];switch(r.type){case"gt":var i=r.params[0];n.push({value:i,op:"gt"});break;case"lt":i=r.params[0];n.push({value:i,op:"lt"});break;case"outside_range":(s=r.params[0])>(o=r.params[1])?(n.push({value:s,op:"gt"}),n.push({value:o,op:"lt"})):(n.push({value:s,op:"lt"}),n.push({value:o,op:"gt"}));break;case"within_range":var s,o;(s=r.params[0])>(o=r.params[1])?(n.push({value:s,op:"lt"}),n.push({value:o,op:"gt"})):(n.push({value:s,op:"gt"}),n.push({value:o,op:"lt"}))}break}}for(var l=0,u=e.thresholds;l<u.length;l++){var c=u[l];c.fill=!0,c.line=!0,c.colorMode="critical"}return!0},e}(),We=a(196),Ke=function(){function e(e,t,a,r,n,i){this.$scope=e,this.backendSrv=t,this.dashboardSrv=a,this.uiSegmentSrv=r,this.$q=n,this.datasourceSrv=i,this.panelCtrl=e.ctrl,this.panel=this.panelCtrl.panel,this.$scope.ctrl=this,this.subTabIndex=0,this.evalFunctions=K.a.evalFunctions,this.evalOperators=K.a.evalOperators,this.conditionTypes=K.a.conditionTypes,this.noDataModes=K.a.noDataModes,this.executionErrorModes=K.a.executionErrorModes,this.appSubUrl=ke.a.appSubUrl}return e.$inject=["$scope","backendSrv","dashboardSrv","uiSegmentSrv","$q","datasourceSrv"],e.prototype.$onInit=function(){var e=this;this.addNotificationSegment=this.uiSegmentSrv.newPlusButton();var t=this.graphThresholdChanged.bind(this);return this.panelCtrl.events.on("threshold-changed",t),this.$scope.$on("$destroy",function(){e.panelCtrl.events.off("threshold-changed",t),e.panelCtrl.editingThresholds=!1,e.panelCtrl.render()}),this.notifications=[],this.alertNotifications=[],this.alertHistory=[],this.backendSrv.get("/api/alert-notifications").then(function(t){e.notifications=t,e.initModel(),e.validateModel()})},e.prototype.getAlertHistory=function(){var e=this;this.backendSrv.get("/api/annotations?dashboardId="+this.panelCtrl.dashboard.id+"&panelId="+this.panel.id+"&limit=50&type=alert").then(function(t){e.alertHistory=A.a.map(t,function(t){return t.time=e.dashboardSrv.getCurrent().formatDate(t.time,"MMM D, YYYY HH:mm:ss"),t.stateModel=K.a.getStateDisplayModel(t.newState),t.info=K.a.getAlertAnnotationInfo(t),t})})},e.prototype.getNotificationIcon=function(e){switch(e){case"email":return"fa fa-envelope";case"slack":return"fa fa-slack";case"victorops":return"fa fa-pagelines";case"webhook":return"fa fa-cubes";case"pagerduty":return"fa fa-bullhorn";case"opsgenie":return"fa fa-bell";case"hipchat":return"fa fa-mail-forward";case"pushover":return"fa fa-mobile";case"kafka":return"fa fa-random";case"teams":return"fa fa-windows"}return"fa fa-bell"},e.prototype.getNotifications=function(){var e=this;return Promise.resolve(this.notifications.map(function(t){return e.uiSegmentSrv.newSegment(t.name)}))},e.prototype.changeTabIndex=function(e){this.subTabIndex=e,2===this.subTabIndex&&this.getAlertHistory()},e.prototype.notificationAdded=function(){var e=A.a.find(this.notifications,{name:this.addNotificationSegment.value});e&&(this.alertNotifications.push({name:e.name,iconClass:this.getNotificationIcon(e.type),isDefault:!1}),this.alert.notifications.push({id:e.id}),this.addNotificationSegment.value=this.uiSegmentSrv.newPlusButton().value,this.addNotificationSegment.html=this.uiSegmentSrv.newPlusButton().html)},e.prototype.removeNotification=function(e){this.alert.notifications.splice(e,1),this.alertNotifications.splice(e,1)},e.prototype.initModel=function(){var e=this,t=this.alert=this.panel.alert;if(t){t.conditions=t.conditions||[],0===t.conditions.length&&t.conditions.push(this.buildDefaultCondition()),t.noDataState=t.noDataState||ke.a.alertingNoDataOrNullValues,t.executionErrorState=t.executionErrorState||ke.a.alertingErrorOrTimeout,t.frequency=t.frequency||"60s",t.handler=t.handler||1,t.notifications=t.notifications||[];var a=this.panel.title+" alert";t.name=t.name||a,this.conditionModels=A.a.reduce(t.conditions,function(t,a){return t.push(e.buildConditionModel(a)),t},[]),Ge.alertToGraphThresholds(this.panel);for(var r=0,n=t.notifications;r<n.length;r++){var i=n[r],s=A.a.find(this.notifications,{id:i.id});s&&!1===s.isDefault&&(s.iconClass=this.getNotificationIcon(s.type),this.alertNotifications.push(s))}for(var o=0,l=this.notifications;o<l.length;o++){var u=l[o];u.isDefault&&(u.iconClass=this.getNotificationIcon(u.type),u.bgColor="#00678b",this.alertNotifications.push(u))}this.panelCtrl.editingThresholds=!0,this.panelCtrl.render()}},e.prototype.graphThresholdChanged=function(e){for(var t=0,a=this.alert.conditions;t<a.length;t++){var r=a[t];if("query"===r.type){r.evaluator.params[e.handleIndex]=e.threshold.value,this.evaluatorParamsChanged();break}}},e.prototype.buildDefaultCondition=function(){return{type:"query",query:{params:["A","5m","now"]},reducer:{type:"avg",params:[]},evaluator:{type:"gt",params:[null]},operator:{type:"and"}}},e.prototype.validateModel=function(){var e=this;if(this.alert)for(var t,a=null,r=0,n=this.alert.conditions;r<n.length;r++){var i=n[r];if("query"===i.type){for(var s=0,o=this.panel.targets;s<o.length;s++){var l=o[s];if(t||(t=l),i.query.params[0]===l.refId){a=l;break}}a||(t?(i.query.params[0]=t.refId,a=t):this.error="Could not find any metric queries");var u=a.datasource||this.panel.datasource;this.datasourceSrv.get(u).then(function(t){t.meta.alerting?t.targetContainsTemplate(a)?e.error="Template variables are not supported in alert queries":e.error="":e.error="The datasource does not support alerting queries"})}}},e.prototype.buildConditionModel=function(e){var t={source:e,type:e.type};return t.queryPart=new We.a(e.query,K.a.alertQueryDef),t.reducerPart=K.a.createReducerPart(e.reducer),t.evaluator=e.evaluator,t.operator=e.operator,t},e.prototype.handleQueryPartEvent=function(e,t){var a=this;switch(t.name){case"action-remove-part":break;case"get-part-actions":return this.$q.when([]);case"part-param-changed":this.validateModel();case"get-param-options":var r=this.panel.targets.map(function(e){return a.uiSegmentSrv.newSegment({value:e.refId})});return this.$q.when(r)}},e.prototype.handleReducerPartEvent=function(e,t){switch(t.name){case"action":e.source.reducer.type=t.action.value,e.reducerPart=K.a.createReducerPart(e.source.reducer);break;case"get-part-actions":for(var a=[],r=0,n=K.a.reducerTypes;r<n.length;r++){var i=n[r];i.value!==e.source.reducer.type&&a.push(i)}return this.$q.when(a)}},e.prototype.addCondition=function(e){var t=this.buildDefaultCondition();this.alert.conditions.push(t),this.conditionModels.push(this.buildConditionModel(t))},e.prototype.removeCondition=function(e){this.alert.conditions.splice(e,1),this.conditionModels.splice(e,1)},e.prototype.delete=function(){var e=this;re.a.emit("confirm-modal",{title:"Delete Alert",text:"Are you sure you want to delete this alert rule?",text2:"You need to save dashboard for the delete to take effect",icon:"fa-trash",yesText:"Delete",onConfirm:function(){delete e.panel.alert,e.alert=null,e.panel.thresholds=[],e.conditionModels=[],e.panelCtrl.alertState=null,e.panelCtrl.render()}})},e.prototype.enable=function(){this.panel.alert={},this.initModel()},e.prototype.evaluatorParamsChanged=function(){Ge.alertToGraphThresholds(this.panel),this.panelCtrl.render()},e.prototype.evaluatorTypeChanged=function(e){switch(e.type){case"lt":case"gt":e.params=[e.params[0]];break;case"within_range":case"outside_range":e.params=[e.params[0],e.params[1]];break;case"no_value":e.params=[]}this.evaluatorParamsChanged()},e.prototype.clearHistory=function(){var e=this;re.a.emit("confirm-modal",{title:"Delete Alert History",text:"Are you sure you want to remove all history & annotations for this alert?",icon:"fa-trash",yesText:"Yes",onConfirm:function(){e.backendSrv.post("/api/annotations/mass-delete",{dashboardId:e.panelCtrl.dashboard.id,panelId:e.panel.id}).then(function(t){e.alertHistory=[],e.panelCtrl.refresh()})}})},e.prototype.test=function(){var e=this;this.testing=!0,this.testResult=!1;var t={dashboard:this.dashboardSrv.getCurrent().getSaveModelClone(),panelId:this.panelCtrl.panel.id};return this.backendSrv.post("/api/alerts/test",t).then(function(t){e.testResult=t,e.testing=!1})},e}();function Je(){return{restrict:"E",scope:!0,templateUrl:"public/app/features/alerting/partials/alert_tab.html",controller:Ke}}var Xe=a(555),Ze=a.n(Xe),et=a(15),tt=a(1226),at=a(291),rt=a(0),nt=a.n(rt),it=a(12),st=a.n(it),ot=a(154),lt=a(1239),ut=a(554),ct=a(1228),ht="YYYY-MM-DDTHH:mm:ssZ",pt=1,dt=0,mt=";",ft="\r\n",gt='"',vt="grafana_data_export.csv";function yt(e){return e?e.split(gt).join(gt+gt):e}var bt=new DOMParser;function St(e){if(!e)return e;var t=/&[^;]+;/g;function a(e){return bt.parseFromString(e,"text/html").body.textContent}return e.replace(t,a).replace(t,a)}function xt(e){return e?"sep="+mt+ft:""}function wt(e,t){void 0===t&&(t=!0);for(var a="",r=0;r<e.length;r+=1)Object($.isBoolean)(e[r])||Object(ct.isNullOrUndefined)(e[r])?a+=e[r]:Object($.isNumber)(e[r])?a+=e[r].toLocaleString():a+=""+gt+yt(Object($.unescape)(St(e[r])))+gt,r<e.length-1&&(a+=mt);return t?a+ft:a}function Tt(e,t,a){void 0===t&&(t=ht),void 0===a&&(a=!1);for(var r=xt(a)+wt(["Series","Time","Value"]),n=0;n<e.length;n+=1)for(var i=0;i<e[n].datapoints.length;i+=1)r+=wt([e[n].alias,U()(e[n].datapoints[i][pt]).format(t),e[n].datapoints[i][dt]],i<e[n].datapoints.length-1||n<e.length-1);return r}function Ct(e,t,a){void 0===t&&(t=ht),void 0===a&&(a=!1),Pt(Tt(e,t,a),vt)}function kt(e,t,a){void 0===t&&(t=ht),void 0===a&&(a=!1);var r=xt(a)+wt(["Time"].concat(e.map(function(e){return e.alias})));e=function(e){for(var t=[],a=0;a<e.length;a++)for(var r=e[a].datapoints,n=0;n<r.length;n++)t.push(r[n][pt]);t=Object($.sortedUniq)(t.sort());for(var a=0;a<e.length;a++){for(var r=e[a].datapoints,i=r.map(function(e){return e[pt]}),s=[],o=void 0,n=0;n<t.length;n++)-1!==(o=Object($.sortedIndexOf)(i,t[n]))?s.push(r[o]):s.push([null,t[n]]);e[a].datapoints=s}return e}(e);for(var n=function(a){var n=U()(e[0].datapoints[a][pt]).format(t);r+=wt([n].concat(e.map(function(e){return e.datapoints[a][dt]})),a<e[0].datapoints.length-1)},i=0;i<e[0].datapoints.length;i+=1)n(i);return r}function _t(e,t,a){void 0===t&&(t=ht),void 0===a&&(a=!1),Pt(kt(e,t,a),vt)}function Et(e,t){void 0===t&&(t=!1);var a=xt(t);a+=wt(e.columns.map(function(e){return e.title||e.text}));for(var r=0;r<e.rows.length;r+=1)a+=wt(e.rows[r],r<e.rows.length-1);return a}function Mt(e,t){void 0===t&&(t=!1),Pt(Et(e,t),vt)}function Pt(e,t){var a=new Blob([e],{type:"text/csv;charset=utf-8;header=present;"});Object(ut.saveAs)(a,t)}function Dt(e,t){var a=(t=t||{}).delimiter||".",r=t.maxDepth||3,n=1,i={};return function e(s,o){Object.keys(s).forEach(function(l){var u=s[l],c=t.safe&&Array.isArray(u),h="[object Object]"===Object.prototype.toString.call(u),p=o?o+a+l:l;if(t.maxDepth||(r=n+1),!c&&h&&Object.keys(u).length&&n<r)return++n,e(u,p);i[p]=u})}(e,null),i}var $t=a(284),At=a(286),It=/^(\d+)(?:\.(\d+))?(?:\.(\d+))?(?:-([0-9A-Za-z\.]+))?/,Ot=function(){function e(e){var t=It.exec(e);t&&(this.major=Number(t[1]),this.minor=Number(t[2]||0),this.patch=Number(t[3]||0),this.meta=t[4])}return e.prototype.isGtOrEq=function(t){var a=new e(t);return!(this.major<a.major||this.minor<a.minor||this.patch<a.patch)},e.prototype.isValid=function(){return A.a.isNumber(this.major)},e}();function Ft(e,t){return new Ot(e).isGtOrEq(t)}var qt={};function Nt(e){e.params=e.params||[],e.defaultParams=e.defaultParams||[],qt[e.name]=e,e.shortName&&(qt[e.shortName]=e)}var Rt=[{name:"other",type:"value_or_series",optional:!0,multiple:!0}];function Lt(e,t){return!e.version||Ft(t,e.version)}Nt({name:"scaleToSeconds",category:"Transform",params:[{name:"seconds",type:"int"}],defaultParams:[1]}),Nt({name:"perSecond",category:"Transform",params:[{name:"max value",type:"int",optional:!0}],defaultParams:[]}),Nt({name:"holtWintersForecast",category:"Calculate"}),Nt({name:"holtWintersConfidenceBands",category:"Calculate",params:[{name:"delta",type:"int"}],defaultParams:[3]}),Nt({name:"holtWintersAberration",category:"Calculate",params:[{name:"delta",type:"int"}],defaultParams:[3]}),Nt({name:"nPercentile",category:"Calculate",params:[{name:"Nth percentile",type:"int"}],defaultParams:[95]}),Nt({name:"diffSeries",params:Rt,defaultParams:["#A"],category:"Combine"}),Nt({name:"stddevSeries",params:Rt,defaultParams:[""],category:"Combine"}),Nt({name:"divideSeries",params:Rt,defaultParams:["#A"],category:"Combine"}),Nt({name:"multiplySeries",params:Rt,defaultParams:["#A"],category:"Combine"}),Nt({name:"asPercent",params:Rt,defaultParams:["#A"],category:"Combine"}),Nt({name:"group",params:Rt,defaultParams:["#A","#B"],category:"Combine"}),Nt({name:"sumSeries",shortName:"sum",category:"Combine",params:Rt,defaultParams:[""]}),Nt({name:"averageSeries",shortName:"avg",category:"Combine",params:Rt,defaultParams:[""]}),Nt({name:"rangeOfSeries",category:"Combine"}),Nt({name:"percentileOfSeries",category:"Combine",params:[{name:"n",type:"int"},{name:"interpolate",type:"boolean",options:["true","false"]}],defaultParams:[95,"false"]}),Nt({name:"sumSeriesWithWildcards",category:"Combine",params:[{name:"node",type:"int",multiple:!0}],defaultParams:[3]}),Nt({name:"maxSeries",shortName:"max",category:"Combine"}),Nt({name:"minSeries",shortName:"min",category:"Combine"}),Nt({name:"averageSeriesWithWildcards",category:"Combine",params:[{name:"node",type:"int",multiple:!0}],defaultParams:[3]}),Nt({name:"alias",category:"Alias",params:[{name:"alias",type:"string"}],defaultParams:["alias"]}),Nt({name:"aliasSub",category:"Alias",params:[{name:"search",type:"string"},{name:"replace",type:"string"}],defaultParams:["","\\1"]}),Nt({name:"consolidateBy",category:"Special",params:[{name:"function",type:"string",options:["sum","average","min","max"]}],defaultParams:["max"]}),Nt({name:"cumulative",category:"Special",params:[],defaultParams:[]}),Nt({name:"groupByNode",category:"Combine",params:[{name:"node",type:"int",options:[0,1,2,3,4,5,6,7,8,9,10,12]},{name:"function",type:"string",options:["sum","avg","maxSeries"]}],defaultParams:[3,"sum"]}),Nt({name:"aliasByNode",category:"Alias",params:[{name:"node",type:"int",options:[0,1,2,3,4,5,6,7,8,9,10,12],multiple:!0}],defaultParams:[3]}),Nt({name:"substr",category:"Special",params:[{name:"start",type:"int",options:[-6,-5,-4,-3,-2,-1,0,1,2,3,4,5,6,7,8,9,10,12]},{name:"stop",type:"int",options:[-6,-5,-4,-3,-2,-1,0,1,2,3,4,5,6,7,8,9,10,12]}],defaultParams:[0,0]}),Nt({name:"sortByName",category:"Sorting",params:[{name:"natural",type:"boolean",options:["true","false"],optional:!0}],defaultParams:["false"]}),Nt({name:"sortByMaxima",category:"Sorting"}),Nt({name:"sortByMinima",category:"Sorting"}),Nt({name:"sortByTotal",category:"Sorting"}),Nt({name:"aliasByMetric",category:"Alias"}),Nt({name:"randomWalk",fake:!0,category:"Special",params:[{name:"name",type:"string"}],defaultParams:["randomWalk"]}),Nt({name:"countSeries",category:"Combine"}),Nt({name:"constantLine",category:"Special",params:[{name:"value",type:"int"}],defaultParams:[10]}),Nt({name:"cactiStyle",category:"Special"}),Nt({name:"keepLastValue",category:"Transform",params:[{name:"n",type:"int"}],defaultParams:[100]}),Nt({name:"changed",category:"Special",params:[],defaultParams:[]}),Nt({name:"scale",category:"Transform",params:[{name:"factor",type:"int"}],defaultParams:[1]}),Nt({name:"offset",category:"Transform",params:[{name:"amount",type:"int"}],defaultParams:[10]}),Nt({name:"transformNull",category:"Transform",params:[{name:"amount",type:"int"}],defaultParams:[0]}),Nt({name:"integral",category:"Transform"}),Nt({name:"derivative",category:"Transform"}),Nt({name:"nonNegativeDerivative",category:"Transform",params:[{name:"max value or 0",type:"int",optional:!0}],defaultParams:[""]}),Nt({name:"timeShift",category:"Transform",params:[{name:"amount",type:"select",options:["1h","6h","12h","1d","2d","7d","14d","30d"]}],defaultParams:["1d"]}),Nt({name:"timeStack",category:"Transform",params:[{name:"timeShiftUnit",type:"select",options:["1h","6h","12h","1d","2d","7d","14d","30d"]},{name:"timeShiftStart",type:"int"},{name:"timeShiftEnd",type:"int"}],defaultParams:["1d",0,7]}),Nt({name:"summarize",category:"Transform",params:[{name:"interval",type:"string"},{name:"func",type:"select",options:["sum","avg","min","max","last"]},{name:"alignToFrom",type:"boolean",optional:!0,options:["false","true"]}],defaultParams:["1h","sum","false"]}),Nt({name:"smartSummarize",category:"Transform",params:[{name:"interval",type:"string"},{name:"func",type:"select",options:["sum","avg","min","max","last"]}],defaultParams:["1h","sum"]}),Nt({name:"absolute",category:"Transform"}),Nt({name:"hitcount",category:"Transform",params:[{name:"interval",type:"string"}],defaultParams:["10s"]}),Nt({name:"log",category:"Transform",params:[{name:"base",type:"int"}],defaultParams:["10"]}),Nt({name:"averageAbove",category:"Filter Series",params:[{name:"n",type:"int"}],defaultParams:[25]}),Nt({name:"averageBelow",category:"Filter Series",params:[{name:"n",type:"int"}],defaultParams:[25]}),Nt({name:"currentAbove",category:"Filter Series",params:[{name:"n",type:"int"}],defaultParams:[25]}),Nt({name:"currentBelow",category:"Filter Series",params:[{name:"n",type:"int"}],defaultParams:[25]}),Nt({name:"maximumAbove",category:"Filter Series",params:[{name:"value",type:"int"}],defaultParams:[0]}),Nt({name:"maximumBelow",category:"Filter Series",params:[{name:"value",type:"int"}],defaultParams:[0]}),Nt({name:"minimumAbove",category:"Filter Series",params:[{name:"value",type:"int"}],defaultParams:[0]}),Nt({name:"minimumBelow",category:"Filter Series",params:[{name:"value",type:"int"}],defaultParams:[0]}),Nt({name:"limit",category:"Filter Series",params:[{name:"n",type:"int"}],defaultParams:[5]}),Nt({name:"mostDeviant",category:"Filter Series",params:[{name:"n",type:"int"}],defaultParams:[10]}),Nt({name:"exclude",category:"Filter Series",params:[{name:"exclude",type:"string"}],defaultParams:["exclude"]}),Nt({name:"highestCurrent",category:"Filter Series",params:[{name:"count",type:"int"}],defaultParams:[5]}),Nt({name:"highestMax",category:"Filter Series",params:[{name:"count",type:"int"}],defaultParams:[5]}),Nt({name:"lowestCurrent",category:"Filter Series",params:[{name:"count",type:"int"}],defaultParams:[5]}),Nt({name:"movingAverage",category:"Calculate",params:[{name:"windowSize",type:"int_or_interval",options:["5","7","10","5min","10min","30min","1hour"]}],defaultParams:[10]}),Nt({name:"movingMedian",category:"Calculate",params:[{name:"windowSize",type:"int_or_interval",options:["5","7","10","5min","10min","30min","1hour"]}],defaultParams:["5"]}),Nt({name:"stdev",category:"Calculate",params:[{name:"n",type:"int"},{name:"tolerance",type:"int"}],defaultParams:[5,.1]}),Nt({name:"highestAverage",category:"Filter Series",params:[{name:"count",type:"int"}],defaultParams:[5]}),Nt({name:"lowestAverage",category:"Filter Series",params:[{name:"count",type:"int"}],defaultParams:[5]}),Nt({name:"removeAbovePercentile",category:"Filter Data",params:[{name:"n",type:"int"}],defaultParams:[5]}),Nt({name:"removeAboveValue",category:"Filter Data",params:[{name:"n",type:"int"}],defaultParams:[5]}),Nt({name:"removeBelowPercentile",category:"Filter Data",params:[{name:"n",type:"int"}],defaultParams:[5]}),Nt({name:"removeBelowValue",category:"Filter Data",params:[{name:"n",type:"int"}],defaultParams:[5]}),Nt({name:"useSeriesAbove",category:"Filter Series",params:[{name:"value",type:"int"},{name:"search",type:"string"},{name:"replace",type:"string"}],defaultParams:[0,"search","replace"]}),Nt({name:"aggregateLine",category:"Calculate",params:[{name:"func",type:"select",options:["sum","avg","min","max","last"]}],defaultParams:["avg"],version:"1.0"}),Nt({name:"averageOutsidePercentile",category:"Filter Series",params:[{name:"n",type:"int"}],defaultParams:[95],version:"1.0"}),Nt({name:"delay",category:"Transform",params:[{name:"steps",type:"int"}],defaultParams:[1],version:"1.0"}),Nt({name:"exponentialMovingAverage",category:"Calculate",params:[{name:"windowSize",type:"int_or_interval",options:["5","7","10","5min","10min","30min","1hour"]}],defaultParams:[10],version:"1.0"}),Nt({name:"fallbackSeries",category:"Special",params:[{name:"fallback",type:"string"}],defaultParams:["constantLine(0)"],version:"1.0"}),Nt({name:"grep",category:"Filter Series",params:[{name:"grep",type:"string"}],defaultParams:["grep"],version:"1.0"}),Nt({name:"groupByNodes",category:"Combine",params:[{name:"function",type:"string",options:["sum","avg","maxSeries"]},{name:"node",type:"int",options:[0,1,2,3,4,5,6,7,8,9,10,12],multiple:!0}],defaultParams:["sum",3],version:"1.0"}),Nt({name:"integralByInterval",category:"Transform",params:[{name:"intervalUnit",type:"select",options:["1h","6h","12h","1d","2d","7d","14d","30d"]}],defaultParams:["1d"],version:"1.0"}),Nt({name:"interpolate",category:"Transform",params:[{name:"limit",type:"int",optional:!0}],defaultParams:[],version:"1.0"}),Nt({name:"invert",category:"Transform",version:"1.0"}),Nt({name:"isNonNull",category:"Combine",version:"1.0"}),Nt({name:"linearRegression",category:"Calculate",params:[{name:"startSourceAt",type:"select",options:["-1h","-6h","-12h","-1d","-2d","-7d","-14d","-30d"],optional:!0},{name:"endSourceAt",type:"select",options:["-1h","-6h","-12h","-1d","-2d","-7d","-14d","-30d"],optional:!0}],defaultParams:[],version:"1.0"}),Nt({name:"mapSeries",shortName:"map",params:[{name:"node",type:"int"}],defaultParams:[3],category:"Combine",version:"1.0"}),Nt({name:"movingMin",category:"Calculate",params:[{name:"windowSize",type:"int_or_interval",options:["5","7","10","5min","10min","30min","1hour"]}],defaultParams:[10],version:"1.0"}),Nt({name:"movingMax",category:"Calculate",params:[{name:"windowSize",type:"int_or_interval",options:["5","7","10","5min","10min","30min","1hour"]}],defaultParams:[10],version:"1.0"}),Nt({name:"movingSum",category:"Calculate",params:[{name:"windowSize",type:"int_or_interval",options:["5","7","10","5min","10min","30min","1hour"]}],defaultParams:[10],version:"1.0"}),Nt({name:"multiplySeriesWithWildcards",category:"Combine",params:[{name:"position",type:"int",options:[0,1,2,3,4,5,6,7,8,9,10,12],multiple:!0}],defaultParams:[2],version:"1.0"}),Nt({name:"offsetToZero",category:"Transform",version:"1.0"}),Nt({name:"pow",category:"Transform",params:[{name:"factor",type:"int"}],defaultParams:[10],version:"1.0"}),Nt({name:"powSeries",category:"Transform",params:Rt,defaultParams:[""],version:"1.0"}),Nt({name:"reduceSeries",shortName:"reduce",params:[{name:"function",type:"string",options:["asPercent","diffSeries","divideSeries"]},{name:"reduceNode",type:"int",options:[0,1,2,3,4,5,6,7,8,9,10,11,12,13]},{name:"reduceMatchers",type:"string",multiple:!0}],defaultParams:["asPercent",2,"used_bytes"],category:"Combine",version:"1.0"}),Nt({name:"removeBetweenPercentile",category:"Filter Series",params:[{name:"n",type:"int"}],defaultParams:[95],version:"1.0"}),Nt({name:"removeEmptySeries",category:"Filter Series",version:"1.0"}),Nt({name:"squareRoot",category:"Transform",version:"1.0"}),Nt({name:"timeSlice",category:"Transform",params:[{name:"startSliceAt",type:"select",options:["-1h","-6h","-12h","-1d","-2d","-7d","-14d","-30d"]},{name:"endSliceAt",type:"select",options:["-1h","-6h","-12h","-1d","-2d","-7d","-14d","-30d"],optional:!0}],defaultParams:["-1h"],version:"1.0"}),Nt({name:"weightedAverage",category:"Combine",params:[{name:"other",type:"value_or_series",optional:!0},{name:"node",type:"int",options:[0,1,2,3,4,5,6,7,8,9,10,12]}],defaultParams:["#A",4],version:"1.0"}),Nt({name:"seriesByTag",category:"Special",params:[{name:"tagExpression",type:"string",multiple:!0}],version:"1.1"}),Nt({name:"groupByTags",category:"Combine",params:[{name:"function",type:"string",options:["sum","avg","maxSeries"]},{name:"tag",type:"string",multiple:!0}],defaultParams:["sum","tag"],version:"1.1"}),Nt({name:"aliasByTags",category:"Alias",params:[{name:"tag",type:"string",multiple:!0}],defaultParams:["tag"],version:"1.1"});var Vt=function(){function e(e,t){this.def=e,this.params=[],t&&t.withDefaultParams&&(this.params=e.defaultParams.slice(0)),this.updateText()}return e.prototype.render=function(e){for(var t=this,a=this.def.name+"(",r=A.a.map(this.params,function(e,a){var r;return a<t.def.params.length?r=t.def.params[a].type:A.a.get(A.a.last(t.def.params),"multiple")&&(r=A.a.get(A.a.last(t.def.params),"type")),A.a.includes(["value_or_series","boolean","int","float","node"],r)?e:A.a.includes(["int_or_interval","node_or_tag"],r)&&A.a.isFinite(+e)?A.a.toString(+e):"'"+e+"'"});""===r[r.length-1];)r.pop();return e&&r.unshift(e),a+r.join(", ")+")"},e.prototype._hasMultipleParamsInString=function(e,t){return-1!==e.indexOf(",")&&(!(!this.def.params[t+1]||!this.def.params[t+1].optional)||!!(t+1>=this.def.params.length&&A.a.get(A.a.last(this.def.params),"multiple")))},e.prototype.updateParam=function(e,t){var a=this;this._hasMultipleParamsInString(e,t)?A.a.each(e.split(","),function(e,r){a.updateParam(e.trim(),t+r)}):(""===e&&(t>=this.def.params.length||this.def.params[t].optional)?this.params.splice(t,1):this.params[t]=e,this.updateText())},e.prototype.updateText=function(){if(0!==this.params.length){var e=this.def.name+"(";e+=this.params.join(", "),e+=")",this.text=e}else this.text=this.def.name+"()"},e}();function Ut(e,t){if(!(t||qt)[e])throw{message:"Method not found "+e};return(t||qt)[e]}var jt={createFuncInstance:function(e,t,a){return A.a.isString(e)&&(e=Ut(e,a)),new Vt(e,t)},getFuncDef:Ut,getFuncDefs:function(e,t){var a={};return A.a.forEach(t||qt,function(t){Lt(t,e)&&(a[t.name]=A.a.assign({},t,{params:A.a.filter(t.params,function(t){return Lt(t,e)})}))}),a},parseFuncDefs:function(e){var t={};return A.a.forEach(e||{},function(e,a){if("Graph"!==e.group){var r=e.description;r&&(r=r.replace(/:py:func:`(.+)( <[^>]*>)?`/g,"``$1``").replace(/.. seealso:: /g,"See also: ").replace(/.. code-block *:: *none/g,".. code-block::"));var n={name:e.name,description:r,category:e.group,params:[],defaultParams:[],fake:!1};/^seriesLists?$/.test(A.a.get(e,"params[0].type",""))?e.params[0].multiple?e.params[0].required=!1:e.params.shift():n.fake=!0,A.a.forEach(e.params,function(e){var t={name:e.name,type:"string",optional:!e.required,multiple:!!e.multiple,options:void 0};void 0!==e.default?n.defaultParams.push(A.a.toString(e.default)):e.suggestions?n.defaultParams.push(A.a.toString(e.suggestions[0])):n.defaultParams.push(""),"boolean"===e.type?(t.type="boolean",t.options=["true","false"]):"integer"===e.type?t.type="int":"float"===e.type?t.type="float":"node"===e.type?(t.type="node",t.options=["0","1","2","3","4","5","6","7","8","9","10","11","12"]):"nodeOrTag"===e.type?(t.type="node_or_tag",t.options=["name","0","1","2","3","4","5","6","7","8","9","10","11","12"]):"intOrInterval"===e.type?t.type="int_or_interval":"seriesList"===e.type&&(t.type="value_or_series"),e.options?t.options=A.a.map(e.options,A.a.toString):e.suggestions&&(t.options=A.a.map(e.suggestions,A.a.toString)),n.params.push(t)}),t[a]=n}}),t}};function Bt(e,t,a,r){var n=this;this.basicAuth=e.basicAuth,this.url=e.url,this.name=e.name,this.graphiteVersion=e.jsonData.graphiteVersion||"0.9",this.supportsTags=function(e){return Ft(e,"1.1")}(this.graphiteVersion),this.cacheTimeout=e.cacheTimeout,this.withCredentials=e.withCredentials,this.render_method=e.render_method||"POST",this.funcDefs=null,this.funcDefsPromise=null,this.getQueryOptionsInfo=function(){return{maxDataPoints:!0,cacheTimeout:!0,links:[{text:"Help",url:"http://docs.grafana.org/features/datasources/graphite/#using-graphite-in-grafana"}]}},this.query=function(e){var a={from:this.translateTime(e.rangeRaw.from,!1),until:this.translateTime(e.rangeRaw.to,!0),targets:e.targets,format:e.format,cacheTimeout:e.cacheTimeout||this.cacheTimeout,maxDataPoints:e.maxDataPoints},r=this.buildGraphiteParams(a,e.scopedVars);if(0===r.length)return t.when({data:[]});var n={method:"POST",url:"/render",data:r.join("&"),headers:{"Content-Type":"application/x-www-form-urlencoded"}};return this.addTracingHeaders(n,e),e.panelId&&(n.requestId=this.name+".panelId."+e.panelId),this.doGraphiteRequest(n).then(this.convertDataPointsToMs)},this.addTracingHeaders=function(e,t){!this.url.match(/^http/)&&(e.headers["X-Dashboard-Id"]=t.dashboardId,e.headers["X-Panel-Id"]=t.panelId)},this.convertDataPointsToMs=function(e){if(!e||!e.data)return[];for(var t=0;t<e.data.length;t++)for(var a=e.data[t],r=0;r<a.datapoints.length;r++)a.datapoints[r][1]*=1e3;return e},this.parseTags=function(e){var t=[];return 1===(t=e.split(",")).length&&""===(t=e.split(" "))[0]&&(t=[]),t},this.annotationQuery=function(e){var t=this;if(e.annotation.target){var a=r.replace(e.annotation.target,{},"glob"),n={rangeRaw:e.rangeRaw,targets:[{target:a}],format:"json",maxDataPoints:100};return this.query(n).then(function(t){for(var a=[],r=0;r<t.data.length;r++)for(var n=t.data[r],i=0;i<n.datapoints.length;i++){var s=n.datapoints[i];s[0]&&a.push({annotation:e.annotation,time:s[1],title:n.target})}return a})}var i=r.replace(e.annotation.tags);return this.events({range:e.rangeRaw,tags:i}).then(function(a){for(var r=[],n=0;n<a.data.length;n++){var i=a.data[n],s=i.tags;A.a.isString(i.tags)&&(s=t.parseTags(i.tags)),r.push({annotation:e.annotation,time:1e3*i.when,title:i.what,tags:s,text:i.data})}return r})},this.events=function(e){try{var a="";return e.tags&&(a="&tags="+e.tags),this.doGraphiteRequest({method:"GET",url:"/events/get_data?from="+this.translateTime(e.range.from,!1)+"&until="+this.translateTime(e.range.to,!0)+a})}catch(e){return t.reject(e)}},this.targetContainsTemplate=function(e){return r.variableExists(e.target)},this.translateTime=function(e,t){if(A.a.isString(e)){if("now"===e)return"now";if(e.indexOf("now-")>=0&&-1===e.indexOf("/"))return e=(e=(e=e.substring(3)).replace("m","min")).replace("M","mon");e=je.parse(e,t)}return t?e.get("s")&&e.add(1,"m"):!1===t&&e.get("s")&&e.subtract(1,"m"),e.unix()},this.metricFindQuery=function(e,t){var a=t||{},n=r.replace(e),i=n.match(/^tag_values\(([^,]+)((, *[^,]+)*)\)$/);if(i){for(var s=[],o=(l=/, *([^,]+)/g).exec(i[2]);null!==o;)s.push(o[1]),o=l.exec(i[2]);return a.limit=1e4,this.getTagValuesAutoComplete(s,i[1],void 0,a)}if(i=n.match(/^tags\(([^,]*)((, *[^,]+)*)\)$/)){s=[];if(i[1]){s.push(i[1]);var l;for(o=(l=/, *([^,]+)/g).exec(i[2]);null!==o;)s.push(o[1]),o=l.exec(i[2])}return a.limit=1e4,this.getTagsAutoComplete(s,void 0,a)}var u={method:"GET",url:"/metrics/find",params:{query:n},requestId:a.requestId};return a.range&&(u.params.from=this.translateTime(a.range.from,!1),u.params.until=this.translateTime(a.range.to,!0)),this.doGraphiteRequest(u).then(function(e){return A.a.map(e.data,function(e){return{text:e.text,expandable:!!e.expandable}})})},this.getTags=function(e){var t=e||{},a={method:"GET",url:"/tags",requestId:t.requestId};return t.range&&(a.params.from=this.translateTime(t.range.from,!1),a.params.until=this.translateTime(t.range.to,!0)),this.doGraphiteRequest(a).then(function(e){return A.a.map(e.data,function(e){return{text:e.tag,id:e.id}})})},this.getTagValues=function(e,t){var a=t||{},n={method:"GET",url:"/tags/"+r.replace(e),requestId:a.requestId};return a.range&&(n.params.from=this.translateTime(a.range.from,!1),n.params.until=this.translateTime(a.range.to,!0)),this.doGraphiteRequest(n).then(function(e){return e.data&&e.data.values?A.a.map(e.data.values,function(e){return{text:e.value,id:e.id}}):[]})},this.getTagsAutoComplete=function(e,t,a){var i=a||{},s={method:"GET",url:"/tags/autoComplete/tags",params:{expr:A.a.map(e,function(e){return r.replace((e||"").trim())})},requestId:i.requestId};return t&&(s.params.tagPrefix=t),i.limit&&(s.params.limit=i.limit),i.range&&(s.params.from=n.translateTime(i.range.from,!1),s.params.until=n.translateTime(i.range.to,!0)),n.doGraphiteRequest(s).then(function(e){return e.data?A.a.map(e.data,function(e){return{text:e}}):[]})},this.getTagValuesAutoComplete=function(e,t,a,i){var s=i||{},o={method:"GET",url:"/tags/autoComplete/values",params:{expr:A.a.map(e,function(e){return r.replace((e||"").trim())}),tag:r.replace((t||"").trim())},requestId:s.requestId};return a&&(o.params.valuePrefix=a),s.limit&&(o.params.limit=s.limit),s.range&&(o.params.from=n.translateTime(s.range.from,!1),o.params.until=n.translateTime(s.range.to,!0)),n.doGraphiteRequest(o).then(function(e){return e.data?A.a.map(e.data,function(e){return{text:e}}):[]})},this.getVersion=function(e){var t={method:"GET",url:"/version",requestId:(e||{}).requestId};return this.doGraphiteRequest(t).then(function(e){return e.data&&new Ot(e.data).isValid()?e.data:""}).catch(function(){return""})},this.createFuncInstance=function(e,t){return jt.createFuncInstance(e,t,this.funcDefs)},this.getFuncDef=function(e){return jt.getFuncDef(e,this.funcDefs)},this.waitForFuncDefsLoaded=function(){return this.getFuncDefs()},this.getFuncDefs=function(){var e=this;if(null!==this.funcDefsPromise)return this.funcDefsPromise;if(!function(e){return Ft(e,"1.1")}(this.graphiteVersion))return this.funcDefs=jt.getFuncDefs(this.graphiteVersion),this.funcDefsPromise=Promise.resolve(this.funcDefs),this.funcDefsPromise;return this.funcDefsPromise=this.doGraphiteRequest({method:"GET",url:"/functions"}).then(function(t){return 200!==t.status||"object"!=typeof t.data?e.funcDefs=jt.getFuncDefs(e.graphiteVersion):e.funcDefs=jt.parseFuncDefs(t.data),e.funcDefs}).catch(function(t){return console.log("Fetching graphite functions error",t),e.funcDefs=jt.getFuncDefs(e.graphiteVersion),e.funcDefs}),this.funcDefsPromise},this.testDatasource=function(){return this.query({panelId:3,rangeRaw:{from:"now-1h",to:"now"},targets:[{target:"constantLine(100)"}],maxDataPoints:300}).then(function(){return{status:"success",message:"Data source is working"}})},this.doGraphiteRequest=function(e){return(this.basicAuth||this.withCredentials)&&(e.withCredentials=!0),this.basicAuth&&(e.headers=e.headers||{},e.headers.Authorization=this.basicAuth),e.url=this.url+e.url,e.inspect={type:"graphite"},a.datasourceRequest(e)},this._seriesRefLetters="ABCDEFGHIJKLMNOPQRSTUVWXYZ",this.buildGraphiteParams=function(e,t){var a,n,i,s=["from","until","rawData","format","maxDataPoints","cacheTimeout"],o=[],l={},u=/\#([A-Z])/g,c=/'(\d+)m'/gi,h=!1;function p(e){return e.replace("m","min").replace("M","mon")}for(e.format="json",i=0;i<e.targets.length;i++)(a=e.targets[i]).target&&(a.refId||(a.refId=this._seriesRefLetters[i]),n=(n=r.replace(a.target,t)).replace(c,p),l[a.refId]=n);function d(e,t){return l[t]||e}for(i=0;i<e.targets.length;i++)(a=e.targets[i]).target&&(n=(n=l[a.refId]).replace(u,d),l[a.refId]=n,a.hide||(h=!0,o.push("target="+encodeURIComponent(n))));return A.a.each(e,function(e,t){-1!==A.a.indexOf(s,t)&&e&&o.push(t+"="+encodeURIComponent(e))}),h?o:[]}}var Qt=a(1225),Ht=a.n(Qt),zt=a(88),Yt=a.n(zt);function Gt(e){return{link:function(t,a){var r,n=this,i=t.ctrl,s=O()('<input type="text" class="gf-form-input" spellcheck="false" style="display:none"></input>'),o=O()('<a class="gf-form-label query-part dropdown-toggle" tabindex="1" gf-dropdown="functionMenu" data-toggle="dropdown"><i class="fa fa-plus"></i></a>');s.appendTo(a),o.appendTo(a),i.datasource.getFuncDefs().then(function(r){var n=A.a.map(r,"name").sort();t.functionMenu=function(e){var t={};return A.a.forEach(e,function(e){e.category&&(t[e.category]||(t[e.category]=[]),t[e.category].push({text:e.name,click:"ctrl.addFunction('"+e.name+"')"}))}),A.a.sortBy(A.a.map(t,function(e,t){return{text:t,submenu:A.a.sortBy(e,"text")}}),"text")}(r),s.attr("data-provide","typeahead"),s.typeahead({source:n,minLength:1,items:10,updater:function(e){var a=i.datasource.getFuncDef(e);return a||(e=e.toLowerCase(),a=A.a.find(n,function(t){return 0===t.toLowerCase().indexOf(e)}))?(t.$apply(function(){i.addFunction(a)}),s.trigger("blur"),""):""}}),o.click(function(){o.hide(),s.show(),s.focus()}),s.keyup(function(){a.toggleClass("open",""===s.val())}),s.blur(function(){setTimeout(function(){s.val(""),s.hide(),o.show(),a.removeClass("open")},200)}),e(a.contents())(t)});var l=function(){r&&(r.destroy(),r=null)};O()(a).on("mouseenter","ul.dropdown-menu li",function(){var e;l();try{e=i.datasource.getFuncDef(O()("a",n).text())}catch(e){}if(e&&e.description){var t=e.description;t.length>500&&(t=t.substring(0,497)+"...");var a=document.createElement("div");a.innerHTML="<h4>"+e.name+"</h4>"+Ht()(t),r=new Yt.a({target:n,content:a,classes:"drop-popover",openOn:"always",tetherOptions:{attachment:"bottom left",targetAttachment:"bottom right"}})}}).on("mouseout","ul.dropdown-menu li",function(){l()}),t.$on("$destroy",l)}}}function Wt(e,t,a){var r='<input type="text" style="display:none" class="input-small tight-form-func-param"></input>';return{restrict:"A",link:function(n,i){var s=O()('<a ng-click="">{{func.def.name}}</a><span>(</span>'),o=O()('\n    <div class="tight-form-func-controls">\n      <span class="pointer fa fa-arrow-left"></span>\n      <span class="pointer fa fa-question-circle"></span>\n      <span class="pointer fa fa-remove" ></span>\n      <span class="pointer fa fa-arrow-right"></span>\n    </div>'),l=n.ctrl,u=n.func,c=!1,h=0,p=null;function d(e){var t=O()(this),a=t.prev(".comma"),r=t.next();r.val(u.params[e]),a.removeClass("query-part__last"),t.hide(),r.show(),r.focus(),r.select();var n=r.data("typeahead");n&&(r.val(""),n.lookup())}function m(e){return e<u.def.params.length?u.def.params[e]:A.a.last(u.def.params).multiple?A.a.assign({},A.a.last(u.def.params),{optional:!0}):{}}function f(e,a){var r=O()(e);clearTimeout(p),p=null;var i=r.prev(),s=i.prev(".comma"),o=r.val();(""!==o||m(a).optional)&&(u.updateParam(o,a),i.html(o?t.highlightVariablesAsHtml(o):"&nbsp;")),h!==u.params.length&&(c||(c=!0,setTimeout(function(){x(),c=!1},200))),n.$apply(function(){l.targetChanged()}),i.hasClass("query-part__last")&&""===o?s.addClass("query-part__last"):i.removeClass("query-part__last"),r.hide(),i.show()}function g(e){var t=this;p=setTimeout(function(){f(t,e)},200)}function v(e,t){13===t.which&&O()(this).blur()}function y(){this.style.width=8*(3+this.value.length)+"px"}function b(){var e=i.closest(".tight-form");if(i.hasClass("show-function-controls"))return i.removeClass("show-function-controls"),e.removeClass("has-open-function"),void o.hide();i.addClass("show-function-controls"),e.addClass("has-open-function"),o.show()}function S(){o.appendTo(i),s.appendTo(i);for(var a=A.a.clone(u.def.params),l=A.a.last(u.def.params);u.params.length>=a.length&&l&&l.multiple;)a.push(A.a.assign({},l,{optional:!0}));A.a.each(a,function(e,a){if(e.optional&&u.params.length<a)return!1;var n=t.highlightVariablesAsHtml(u.params[a]),s=a>=u.params.length-1&&e.optional&&!n;s&&e.multiple&&(n="+"),a>0&&O()('<span class="comma'+(s?" query-part__last":"")+'">, </span>').appendTo(i);var o=O()('<a ng-click="" class="graphite-func-param-link'+(s?" query-part__last":"")+'">'+(n||"&nbsp;")+"</a>"),l=O()(r);return l.attr("placeholder",e.name),h++,o.appendTo(i),l.appendTo(i),l.blur(A.a.partial(g,a)),l.keyup(y),l.keypress(A.a.partial(v,a)),o.click(A.a.partial(d,a)),e.options&&function(e,t){e.attr("data-provide","typeahead");var a=m(t).options;"int"===m(t).type&&(a=A.a.map(a,function(e){return e.toString()})),e.typeahead({source:a,minLength:0,items:20,updater:function(a){return e.val(a),f(e[0],t),a}}),e.data("typeahead").lookup=function(){return this.query=this.$element.val()||"",this.process(this.source)}}(l,a),!0}),O()("<span>)</span>").appendTo(i),e(i.contents())(n)}function x(){i.children().remove(),S(),n.func.added&&(n.func.added=!1,setTimeout(function(){i.find(".graphite-func-param-link").first().click()},10)),s.click(b),o.click(function(e){var t=O()(e.target);if(t.hasClass("fa-remove"))return b(),void n.$apply(function(){l.removeFunction(n.func)});if(t.hasClass("fa-arrow-left"))n.$apply(function(){A.a.move(l.queryModel.functions,n.$index,n.$index-1),l.targetChanged()});else if(t.hasClass("fa-arrow-right"))n.$apply(function(){A.a.move(l.queryModel.functions,n.$index,n.$index+1),l.targetChanged()});else if(t.hasClass("fa-question-circle")){var r=l.datasource.getFuncDef(u.def.name);r&&r.description?a.show({element:e.target,position:"bottom left",classNames:"drop-popover drop-function-def",template:'\n                  <div style="overflow:auto;max-height:30rem;">\n                    <h4> '+r.name+" </h4>\n                    "+Ht()(r.description)+"\n                  </div>",openOn:"click"}):window.open("http://graphite.readthedocs.org/en/latest/functions.html#graphite.render.functions."+u.def.name,"_blank")}})}x()}}}D.a.module("grafana.directives").directive("graphiteAddFunc",Gt),D.a.module("grafana.directives").directive("graphiteFuncEditor",Wt);for(var Kt=[170,170,181,181,186,186,192,214,216,246,248,705,710,721,736,740,748,748,750,750,880,884,886,887,890,893,902,902,904,906,908,908,910,929,931,1013,1015,1153,1162,1319,1329,1366,1369,1369,1377,1415,1488,1514,1520,1522,1568,1610,1646,1647,1649,1747,1749,1749,1765,1766,1774,1775,1786,1788,1791,1791,1808,1808,1810,1839,1869,1957,1969,1969,1994,2026,2036,2037,2042,2042,2048,2069,2074,2074,2084,2084,2088,2088,2112,2136,2308,2361,2365,2365,2384,2384,2392,2401,2417,2423,2425,2431,2437,2444,2447,2448,2451,2472,2474,2480,2482,2482,2486,2489,2493,2493,2510,2510,2524,2525,2527,2529,2544,2545,2565,2570,2575,2576,2579,2600,2602,2608,2610,2611,2613,2614,2616,2617,2649,2652,2654,2654,2674,2676,2693,2701,2703,2705,2707,2728,2730,2736,2738,2739,2741,2745,2749,2749,2768,2768,2784,2785,2821,2828,2831,2832,2835,2856,2858,2864,2866,2867,2869,2873,2877,2877,2908,2909,2911,2913,2929,2929,2947,2947,2949,2954,2958,2960,2962,2965,2969,2970,2972,2972,2974,2975,2979,2980,2984,2986,2990,3001,3024,3024,3077,3084,3086,3088,3090,3112,3114,3123,3125,3129,3133,3133,3160,3161,3168,3169,3205,3212,3214,3216,3218,3240,3242,3251,3253,3257,3261,3261,3294,3294,3296,3297,3313,3314,3333,3340,3342,3344,3346,3386,3389,3389,3406,3406,3424,3425,3450,3455,3461,3478,3482,3505,3507,3515,3517,3517,3520,3526,3585,3632,3634,3635,3648,3654,3713,3714,3716,3716,3719,3720,3722,3722,3725,3725,3732,3735,3737,3743,3745,3747,3749,3749,3751,3751,3754,3755,3757,3760,3762,3763,3773,3773,3776,3780,3782,3782,3804,3805,3840,3840,3904,3911,3913,3948,3976,3980,4096,4138,4159,4159,4176,4181,4186,4189,4193,4193,4197,4198,4206,4208,4213,4225,4238,4238,4256,4293,4304,4346,4348,4348,4352,4680,4682,4685,4688,4694,4696,4696,4698,4701,4704,4744,4746,4749,4752,4784,4786,4789,4792,4798,4800,4800,4802,4805,4808,4822,4824,4880,4882,4885,4888,4954,4992,5007,5024,5108,5121,5740,5743,5759,5761,5786,5792,5866,5870,5872,5888,5900,5902,5905,5920,5937,5952,5969,5984,5996,5998,6e3,6016,6067,6103,6103,6108,6108,6176,6263,6272,6312,6314,6314,6320,6389,6400,6428,6480,6509,6512,6516,6528,6571,6593,6599,6656,6678,6688,6740,6823,6823,6917,6963,6981,6987,7043,7072,7086,7087,7104,7141,7168,7203,7245,7247,7258,7293,7401,7404,7406,7409,7424,7615,7680,7957,7960,7965,7968,8005,8008,8013,8016,8023,8025,8025,8027,8027,8029,8029,8031,8061,8064,8116,8118,8124,8126,8126,8130,8132,8134,8140,8144,8147,8150,8155,8160,8172,8178,8180,8182,8188,8305,8305,8319,8319,8336,8348,8450,8450,8455,8455,8458,8467,8469,8469,8473,8477,8484,8484,8486,8486,8488,8488,8490,8493,8495,8505,8508,8511,8517,8521,8526,8526,8544,8584,11264,11310,11312,11358,11360,11492,11499,11502,11520,11557,11568,11621,11631,11631,11648,11670,11680,11686,11688,11694,11696,11702,11704,11710,11712,11718,11720,11726,11728,11734,11736,11742,11823,11823,12293,12295,12321,12329,12337,12341,12344,12348,12353,12438,12445,12447,12449,12538,12540,12543,12549,12589,12593,12686,12704,12730,12784,12799,13312,13312,19893,19893,19968,19968,40907,40907,40960,42124,42192,42237,42240,42508,42512,42527,42538,42539,42560,42606,42623,42647,42656,42735,42775,42783,42786,42888,42891,42894,42896,42897,42912,42921,43002,43009,43011,43013,43015,43018,43020,43042,43072,43123,43138,43187,43250,43255,43259,43259,43274,43301,43312,43334,43360,43388,43396,43442,43471,43471,43520,43560,43584,43586,43588,43595,43616,43638,43642,43642,43648,43695,43697,43697,43701,43702,43705,43709,43712,43712,43714,43714,43739,43741,43777,43782,43785,43790,43793,43798,43808,43814,43816,43822,43968,44002,44032,44032,55203,55203,55216,55238,55243,55291,63744,64045,64048,64109,64112,64217,64256,64262,64275,64279,64285,64285,64287,64296,64298,64310,64312,64316,64318,64318,64320,64321,64323,64324,64326,64433,64467,64829,64848,64911,64914,64967,65008,65019,65136,65140,65142,65276,65313,65338,65345,65370,65382,65470,65474,65479,65482,65487,65490,65495,65498,65500,65536,65547,65549,65574,65576,65594,65596,65597,65599,65613,65616,65629,65664,65786,65856,65908,66176,66204,66208,66256,66304,66334,66352,66378,66432,66461,66464,66499,66504,66511,66513,66517,66560,66717,67584,67589,67592,67592,67594,67637,67639,67640,67644,67644,67647,67669,67840,67861,67872,67897,68096,68096,68112,68115,68117,68119,68121,68147,68192,68220,68352,68405,68416,68437,68448,68466,68608,68680,69635,69687,69763,69807,73728,74606,74752,74850,77824,78894,92160,92728,110592,110593,119808,119892,119894,119964,119966,119967,119970,119970,119973,119974,119977,119980,119982,119993,119995,119995,119997,120003,120005,120069,120071,120074,120077,120084,120086,120092,120094,120121,120123,120126,120128,120132,120134,120134,120138,120144,120146,120485,120488,120512,120514,120538,120540,120570,120572,120596,120598,120628,120630,120654,120656,120686,120688,120712,120714,120744,120746,120770,120772,120779,131072,131072,173782,173782,173824,173824,177972,177972,177984,177984,178205,178205,194560,195101],Jt=[],Xt=0;Xt<128;Xt++)Jt[Xt]=Xt>=48&&Xt<=57||36===Xt||126===Xt||124===Xt||Xt>=65&&Xt<=90||95===Xt||45===Xt||42===Xt||58===Xt||91===Xt||93===Xt||63===Xt||37===Xt||35===Xt||61===Xt||Xt>=97&&Xt<=122;var Zt=Jt;function ea(e){this.input=e,this.char=1,this.from=1}function ta(e){this.expression=e,this.lexer=new ea(e),this.tokens=this.lexer.tokenize(),this.index=0}ea.prototype={peek:function(e){return this.input.charAt(e||0)},skip:function(e){e=e||1,this.char+=e,this.input=this.input.slice(e)},tokenize:function(){for(var e=[],t=this.next();t;)e.push(t),t=this.next();return e},next:function(){if(this.from=this.char,/\s/.test(this.peek())){for(;/\s/.test(this.peek());)this.from+=1,this.skip();if(""===this.peek())return null}var e=this.scanStringLiteral();return e||((e=this.scanPunctuator()||this.scanNumericLiteral()||this.scanIdentifier()||this.scanTemplateSequence())?(this.skip(e.value.length),e):null)},scanTemplateSequence:function(){return"["===this.peek()&&"["===this.peek(1)?{type:"templateStart",value:"[[",pos:this.char}:"]"===this.peek()&&"]"===this.peek(1)?{type:"templateEnd",value:"[[",pos:this.char}:null},scanIdentifier:function(){var e,t,a="",r=0;function n(e){for(var t=0;t<Kt.length;){if(e<Kt[t++])return!1;if(e<=Kt[t++])return!0}return!1}function i(e){return/^[0-9a-fA-F]$/.test(e)}var s=A.a.bind(function(){if(r+=1,"u"!==this.peek(r))return null;var e=this.peek(r+1),t=this.peek(r+2),a=this.peek(r+3),s=this.peek(r+4);return i(e)&&i(t)&&i(a)&&i(s)&&n(parseInt(e+t+a+s,16))?(r+=5,"\\u"+e+t+a+s):null},this),o=A.a.bind(function(){var e=this.peek(r),t=e.charCodeAt(0);return"*"===e?(r+=1,e):92===t?s():t<128?Jt[t]?(r+=1,e):null:n(t)?(r+=1,e):null},this),l=A.a.bind(function(){var e=this.peek(r),t=e.charCodeAt(0);return 92===t?s():t<128?Zt[t]?(r+=1,e):null:n(t)?(r+=1,e):null},this);if(null===(t=o()))return null;for(a=t;null!==(t=l());)a+=t;switch(a){case"true":case"false":e="bool";break;default:e="identifier"}return{type:e,value:a,pos:this.char}},scanNumericLiteral:function(){var e,t=0,a="",r=this.input.length,n=this.peek(t);function i(e){return/^[0-9]$/.test(e)}function s(e){return/^[0-7]$/.test(e)}function o(e){return/^[0-9a-fA-F]$/.test(e)}function l(e){return"$"===e||"_"===e||"\\"===e||e>="a"&&e<="z"||e>="A"&&e<="Z"}if("-"===n&&(a+=n,t+=1,n=this.peek(t)),"."!==n&&!i(n))return null;if("."!==n){if(a+=this.peek(t),t+=1,n=this.peek(t),"0"===a){if("x"===n||"X"===n){for(t+=1,a+=n;t<r&&o(n=this.peek(t));)a+=n,t+=1;return a.length<=2?{type:"number",value:a,isMalformed:!0,pos:this.char}:t<r&&l(n=this.peek(t))?null:{type:"number",value:a,base:16,isMalformed:!1,pos:this.char}}if(s(n)){for(t+=1,a+=n,e=!1;t<r;){if(i(n=this.peek(t))&&(e=!0),!s(n)){if(!this.isPunctuator(n))return null;break}a+=n,t+=1}return t<r&&l(n=this.peek(t))?null:{type:"number",value:a,base:8,isMalformed:e}}i(n)&&(t+=1,a+=n)}for(;t<r&&i(n=this.peek(t));)a+=n,t+=1}if("."===n)for(a+=n,t+=1;t<r&&i(n=this.peek(t));)a+=n,t+=1;if("e"===n||"E"===n){if(a+=n,t+=1,"+"!==(n=this.peek(t))&&"-"!==n||(a+=this.peek(t),t+=1),!i(n=this.peek(t)))return null;for(a+=n,t+=1;t<r&&i(n=this.peek(t));)a+=n,t+=1}return t<r&&(n=this.peek(t),!this.isPunctuator(n))?null:{type:"number",value:a,base:10,pos:this.char,isMalformed:!isFinite(+a)}},isPunctuator:function(e){switch(e){case".":case"(":case")":case",":case"{":case"}":return!0}return!1},scanPunctuator:function(){var e=this.peek();return this.isPunctuator(e)?{type:e,value:e,pos:this.char}:null},scanStringLiteral:function(){var e=this.peek();if('"'!==e&&"'"!==e)return null;var t="";for(this.skip();this.peek()!==e;){if(""===this.peek())return{type:"string",value:t,isUnclosed:!0,quote:e,pos:this.char};t+=this.peek(),this.skip(1)}return this.skip(),{type:"string",value:t,isUnclosed:!1,quote:e,pos:this.char}}},ta.prototype={getAst:function(){return this.start()},start:function(){try{return this.functionCall()||this.metricExpression()}catch(e){return{type:"error",message:e.message,pos:e.pos}}},curlyBraceSegment:function(){if(this.match("identifier","{")||this.match("{")){for(var e="";!this.match("")&&!this.match("}");)e+=this.consumeToken().value;return this.match("}")||this.errorMark("Expected closing '}'"),e+=this.consumeToken().value,this.match("identifier")&&(e+=this.consumeToken().value),{type:"segment",value:e}}return null},metricSegment:function(){var e=this.curlyBraceSegment();if(e)return e;if(this.match("identifier")||this.match("number")){var t=this.consumeToken().value.split(".");return 2===t.length&&(this.tokens.splice(this.index,0,{type:"."}),this.tokens.splice(this.index+1,0,{type:"number",value:t[1]})),{type:"segment",value:t[0]}}this.match("templateStart")||this.errorMark("Expected metric identifier"),this.consumeToken(),this.match("identifier")||this.errorMark("Expected identifier after templateStart");var a={type:"template",value:this.consumeToken().value};return this.match("templateEnd")||this.errorMark("Expected templateEnd"),this.consumeToken(),a},metricExpression:function(){if(!(this.match("templateStart")||this.match("identifier")||this.match("number")||this.match("{")))return null;var e={type:"metric",segments:[]};for(e.segments.push(this.metricSegment());this.match(".");){this.consumeToken();var t=this.metricSegment();t||this.errorMark("Expected metric identifier"),e.segments.push(t)}return e},functionCall:function(){if(!this.match("identifier","("))return null;var e={type:"function",name:this.consumeToken().value};return this.consumeToken(),e.params=this.functionParameters(),this.match(")")||this.errorMark("Expected closing parenthesis"),this.consumeToken(),e},boolExpression:function(){return this.match("bool")?{type:"bool",value:"true"===this.consumeToken().value}:null},functionParameters:function(){if(this.match(")")||this.match(""))return[];var e=this.functionCall()||this.numericLiteral()||this.seriesRefExpression()||this.boolExpression()||this.metricExpression()||this.stringLiteral();return this.match(",")?(this.consumeToken(),[e].concat(this.functionParameters())):[e]},seriesRefExpression:function(){return this.match("identifier")&&this.tokens[this.index].value.match(/\#[A-Z]/)?{type:"series-ref",value:this.consumeToken().value}:null},numericLiteral:function(){return this.match("number")?{type:"number",value:parseFloat(this.consumeToken().value)}:null},stringLiteral:function(){if(!this.match("string"))return null;var e=this.consumeToken();if(e.isUnclosed)throw{message:"Unclosed string parameter",pos:e.pos};return{type:"string",value:e.value}},errorMark:function(e){var t=this.tokens[this.index];throw{message:e+" instead found "+(t?t.type:"end of string"),pos:t?t.pos:this.lexer.char}},consumeToken:function(){return this.index++,this.tokens[this.index-1]},matchToken:function(e,t){var a=this.tokens[this.index+t];return void 0===a&&""===e||a&&a.type===e},match:function(e,t){return this.matchToken(e,0)&&(!t||this.matchToken(t,1))}};var aa=function(){function e(e,t,a,r){this.datasource=e,this.target=t,this.parseTarget(),this.removeTagValue="-- remove tag --"}return e.$inject=["datasource","target","templateSrv","scopedVars"],e.prototype.parseTarget=function(){if(this.functions=[],this.segments=[],this.tags=[],this.error=null,!this.target.textEditor){var e=new ta(this.target.target).getAst();if(null!==e){if("error"===e.type)return this.error=e.message+" at position: "+e.pos,void(this.target.textEditor=!0);try{this.parseTargetRecursive(e,null)}catch(e){console.log("error parsing target:",e.message),this.error=e.message,this.target.textEditor=!0}this.checkOtherSegmentsIndex=this.segments.length-1,this.checkForSeriesByTag()}else this.checkOtherSegmentsIndex=0}},e.prototype.checkForSeriesByTag=function(){var e=A.a.find(this.functions,function(e){return"seriesByTag"===e.def.name});if(e){this.seriesByTagUsed=!0,e.hidden=!0;var t=this.splitSeriesByTagParams(e);this.tags=t}},e.prototype.getSegmentPathUpTo=function(e){var t=this.segments.slice(0,e);return A.a.reduce(t,function(e,t){return e?e+"."+t.value:t.value},"")},e.prototype.parseTargetRecursive=function(e,t){var a=this;if(null===e)return null;switch(e.type){case"function":var r=this.datasource.createFuncInstance(e.name,{withDefaultParams:!1});A.a.each(e.params,function(e){a.parseTargetRecursive(e,r)}),r.updateText(),this.functions.push(r);break;case"series-ref":this.segments.length>0?this.addFunctionParameter(t,e.value):this.segments.push(e);break;case"bool":case"string":case"number":this.addFunctionParameter(t,e.value);break;case"metric":this.segments.length>0?this.addFunctionParameter(t,A.a.join(A.a.map(e.segments,"value"),".")):this.segments=e.segments}},e.prototype.updateSegmentValue=function(e,t){this.segments[t].value=e.value},e.prototype.addSelectMetricSegment=function(){this.segments.push({value:"select metric"})},e.prototype.addFunction=function(e){this.functions.push(e),this.moveAliasFuncLast()},e.prototype.moveAliasFuncLast=function(){var e=A.a.find(this.functions,function(e){return e.def.name.startsWith("alias")});e&&(this.functions=A.a.without(this.functions,e),this.functions.push(e))},e.prototype.addFunctionParameter=function(e,t){if(e.params.length>=e.def.params.length&&!A.a.get(A.a.last(e.def.params),"multiple",!1))throw{message:"too many parameters for function "+e.def.name};e.params.push(t)},e.prototype.removeFunction=function(e){this.functions=A.a.without(this.functions,e)},e.prototype.updateModelTarget=function(e){if(!this.target.textEditor){var t=this.getSegmentPathUpTo(this.segments.length).replace(/\.select metric$/,"");this.target.target=A.a.reduce(this.functions,ra,t)}this.updateRenderedTarget(this.target,e);for(var a=0,r=e||[];a<r.length;a++){var n=r[a];n.refId!==this.target.refId&&this.updateRenderedTarget(n,e)}},e.prototype.updateRenderedTarget=function(e,t){var a=A.a.keyBy(t,"refId");delete a[e.refId];var r=/\#([A-Z])/g,n=e.target;for(A.a.each(a,function(e,t){!function(e,t){var a=0;A.a.each(e,function(e,n){if(n!==t){var i=r.exec(e.target),s=i&&i.length?i.length-1:0;a+=s}}),e[t].refCount=a}(a,t)});n.match(r);){var i=n.replace(r,function(e,t){var r=a[t];return r?(0===r.refCount&&delete a[t],r.refCount--,r.target):e});if(i===n)break;n=i}delete e.targetFull,e.target!==n&&(e.targetFull=n)},e.prototype.splitSeriesByTagParams=function(e){var t=/([^\!=~]+)(\!?=~?)(.*)/;return A.a.flatten(A.a.map(e.params,function(e){var a=t.exec(e);if(a){var r=a.slice(1);if(3===r.length)return{key:r[0],operator:r[1],value:r[2]}}return[]}))},e.prototype.getSeriesByTagFuncIndex=function(){return A.a.findIndex(this.functions,function(e){return"seriesByTag"===e.def.name})},e.prototype.getSeriesByTagFunc=function(){var e=this.getSeriesByTagFuncIndex();return e>=0?this.functions[e]:void 0},e.prototype.addTag=function(e){var t=na(e);this.getSeriesByTagFunc().params.push(t),this.tags.push(e)},e.prototype.removeTag=function(e){this.getSeriesByTagFunc().params.splice(e,1),this.tags.splice(e,1)},e.prototype.updateTag=function(e,t){if(this.error=null,e.key!==this.removeTagValue){var a=na(e);this.getSeriesByTagFunc().params[t]=a,this.tags[t]=e}else this.removeTag(t)},e.prototype.renderTagExpressions=function(e){return void 0===e&&(e=-1),A.a.compact(A.a.map(this.tags,function(t,a){if(a!==e)return t.key+t.operator+t.value}))},e}();function ra(e,t){return t.render(e)}function na(e){return e.key+e.operator+e.value}var ia=["=","!=","=~","!=~"],sa="tag: ",oa=function(e){function t(t,a,r,n,i){var s=e.call(this,t,a)||this;return s.uiSegmentSrv=r,s.templateSrv=n,s.supportsTags=s.datasource.supportsTags,s.paused=!1,s.target.target=s.target.target||"",s.datasource.waitForFuncDefsLoaded().then(function(){s.queryModel=new aa(s.datasource,s.target,n),s.buildSegments()}),s.removeTagValue="-- remove tag --",s}return t.$inject=["$scope","$injector","uiSegmentSrv","templateSrv","$timeout"],Ve.c(t,e),t.prototype.parseTarget=function(){this.queryModel.parseTarget(),this.buildSegments()},t.prototype.toggleEditorMode=function(){this.target.textEditor=!this.target.textEditor,this.parseTarget()},t.prototype.buildSegments=function(){var e=this;this.segments=A.a.map(this.queryModel.segments,function(t){return e.uiSegmentSrv.newSegment(t)});var t=this.queryModel.checkOtherSegmentsIndex||0;this.checkOtherSegments(t),this.queryModel.seriesByTagUsed&&this.fixTagSegments()},t.prototype.addSelectMetricSegment=function(){this.queryModel.addSelectMetricSegment(),this.segments.push(this.uiSegmentSrv.newSelectMetric())},t.prototype.checkOtherSegments=function(e){var t=this;if(1!==this.queryModel.segments.length||"series-ref"!==this.queryModel.segments[0].type){if(0!==e){var a=this.queryModel.getSegmentPathUpTo(e+1);return""===a?Promise.resolve():this.datasource.metricFindQuery(a).then(function(r){if(0===r.length)""!==a&&(t.queryModel.segments=t.queryModel.segments.splice(0,e),t.segments=t.segments.splice(0,e),t.addSelectMetricSegment());else if(r[0].expandable){if(t.segments.length!==e)return t.checkOtherSegments(e+1);t.addSelectMetricSegment()}}).catch(function(e){re.a.emit("alert-error",["Error",e])})}this.addSelectMetricSegment()}},t.prototype.setSegmentFocus=function(e){A.a.each(this.segments,function(t,a){t.focus=e===a})},t.prototype.getAltSegments=function(e,t){var a=this,r=t&&t.length>0?"*"+t+"*":"*";e>0&&(r=this.queryModel.getSegmentPathUpTo(e)+"."+r);var n={range:this.panelCtrl.range,requestId:"get-alt-segments"};return this.datasource.metricFindQuery(r,n).then(function(r){var n=A.a.map(r,function(e){return a.uiSegmentSrv.newSegment({value:e.text,expandable:e.expandable})});return e>0&&0===n.length?n:(0===e&&A.a.eachRight(a.panelCtrl.panel.targets,function(e){e.refId!==a.queryModel.target.refId&&n.unshift(a.uiSegmentSrv.newSegment({type:"series-ref",value:"#"+e.refId,expandable:!1}))}),A.a.eachRight(a.templateSrv.variables,function(e){n.unshift(a.uiSegmentSrv.newSegment({type:"template",value:"$"+e.name,expandable:!0}))}),n.unshift(a.uiSegmentSrv.newSegment("*")),a.supportsTags&&0===e?(a.removeTaggedEntry(n),a.addAltTagSegments(t,n)):n)}).catch(function(e){return[]})},t.prototype.addAltTagSegments=function(e,t){return this.getTagsAsSegments(e).then(function(e){return e=A.a.map(e,function(e){return e.value=sa+e.value,e}),t.concat.apply(t,e)})},t.prototype.removeTaggedEntry=function(e){e=A.a.remove(e,function(e){return"_tagged"===e.value})},t.prototype.segmentValueChanged=function(e,t){var a=this;if(this.error=null,this.queryModel.updateSegmentValue(e,t),this.queryModel.functions.length>0&&this.queryModel.functions[0].def.fake&&(this.queryModel.functions=[]),"tag"===e.type){var r=function(e){return e.replace(sa,"")}(e.value);return this.pause(),void this.addSeriesByTagFunc(r)}if(e.expandable)return this.checkOtherSegments(t+1).then(function(){a.setSegmentFocus(t+1),a.targetChanged()});this.spliceSegments(t+1),this.setSegmentFocus(t+1),this.targetChanged()},t.prototype.spliceSegments=function(e){this.segments=this.segments.splice(0,e),this.queryModel.segments=this.queryModel.segments.splice(0,e)},t.prototype.emptySegments=function(){this.queryModel.segments=[],this.segments=[]},t.prototype.targetTextChanged=function(){this.updateModelTarget(),this.refresh()},t.prototype.updateModelTarget=function(){this.queryModel.updateModelTarget(this.panelCtrl.panel.targets)},t.prototype.targetChanged=function(){if(!this.queryModel.error){var e=this.queryModel.target.target;this.updateModelTarget(),this.queryModel.target===e||this.paused||this.panelCtrl.refresh()}},t.prototype.addFunction=function(e){var t=this.datasource.createFuncInstance(e,{withDefaultParams:!0});t.added=!0,this.queryModel.addFunction(t),this.smartlyHandleNewAliasByNode(t),1===this.segments.length&&this.segments[0].fake&&this.emptySegments(),!t.params.length&&t.added&&this.targetChanged(),"seriesByTag"===t.def.name&&this.parseTarget()},t.prototype.removeFunction=function(e){this.queryModel.removeFunction(e),this.targetChanged()},t.prototype.addSeriesByTagFunc=function(e){var t=this.datasource.createFuncInstance("seriesByTag",{withDefaultParams:!1}),a=e+"=";t.params=[a],this.queryModel.addFunction(t),t.added=!0,this.emptySegments(),this.targetChanged(),this.parseTarget()},t.prototype.smartlyHandleNewAliasByNode=function(e){if("aliasByNode"===e.def.name)for(var t=0;t<this.segments.length;t++)if(this.segments[t].value.indexOf("*")>=0)return e.params[0]=t,e.added=!1,void this.targetChanged()},t.prototype.getAllTags=function(){var e=this;return this.datasource.getTags().then(function(t){var a=A.a.map(t,"text");return a.splice(0,0,e.removeTagValue),la(a)})},t.prototype.getTags=function(e,t){var a=this,r=this.queryModel.renderTagExpressions(e);return this.datasource.getTagsAutoComplete(r,t).then(function(e){var t=A.a.map(e,"text");return t.splice(0,0,a.removeTagValue),la(t)})},t.prototype.getTagsAsSegments=function(e){var t=this,a=this.queryModel.renderTagExpressions();return this.datasource.getTagsAutoComplete(a,e).then(function(e){return A.a.map(e,function(e){return t.uiSegmentSrv.newSegment({value:e.text,type:"tag",expandable:!1})})})},t.prototype.getTagOperators=function(){return la(ia)},t.prototype.getAllTagValues=function(e){var t=e.key;return this.datasource.getTagValues(t).then(function(e){return la(A.a.map(e,"text"))})},t.prototype.getTagValues=function(e,t,a){var r=this,n=this.queryModel.renderTagExpressions(t),i=e.key;return this.datasource.getTagValuesAutoComplete(n,i,a).then(function(e){var t=A.a.map(e,"text");return A.a.eachRight(r.templateSrv.variables,function(e){t.push("${"+e.name+":regex}")}),la(t)})},t.prototype.tagChanged=function(e,t){this.queryModel.updateTag(e,t),this.targetChanged()},t.prototype.addNewTag=function(e){var t={key:e.value,operator:"=",value:""};this.queryModel.addTag(t),this.targetChanged(),this.fixTagSegments()},t.prototype.removeTag=function(e){this.queryModel.removeTag(e),this.targetChanged()},t.prototype.fixTagSegments=function(){this.addTagSegments=[this.uiSegmentSrv.newPlusButton()]},t.prototype.showDelimiter=function(e){return e!==this.queryModel.tags.length-1},t.prototype.pause=function(){this.paused=!0},t.prototype.unpause=function(){this.paused=!1,this.panelCtrl.refresh()},t.templateUrl="partials/query.editor.html",t}(Ye);function la(e){return A.a.map(e,function(e){return{text:e,value:e}})}var ua=function(){function e(e,t){this.graphiteVersions=[{name:"0.9.x",value:"0.9"},{name:"1.0.x",value:"1.0"},{name:"1.1.x",value:"1.1"}],this.datasourceSrv=t,this.current.jsonData=this.current.jsonData||{},this.current.jsonData.graphiteVersion=this.current.jsonData.graphiteVersion||"0.9",this.autoDetectGraphiteVersion()}return e.$inject=["$scope","datasourceSrv"],e.prototype.autoDetectGraphiteVersion=function(){var e=this;this.current.id&&this.datasourceSrv.loadDatasource(this.current.name).then(function(e){return e.getVersion()}).then(function(t){e.graphiteVersions.push({name:t,value:t}),e.current.jsonData.graphiteVersion=t})},e.templateUrl="public/app/plugins/datasource/graphite/partials/config.html",e}(),ca=function(){function e(){}return e.templateUrl="partials/annotations.editor.html",e}(),ha=function(){return function(){return{templateUrl:"public/app/plugins/datasource/cloudwatch/partials/query.parameter.html",controller:"CloudWatchQueryParameterCtrl",restrict:"E",scope:{target:"=",datasource:"=",onChange:"&"}}}}(),pa=function(){function e(e,t,a,r,n){e.init=function(){var t=e.target;t.namespace=t.namespace||"",t.metricName=t.metricName||"",t.statistics=t.statistics||["Average"],t.dimensions=t.dimensions||{},t.period=t.period||"",t.region=t.region||"default",t.id=t.id||"",t.expression=t.expression||"",t.returnData=t.returnData||!1,t.highResolution=t.highResolution||!1,e.regionSegment=a.getSegmentForValue(e.target.region,"select region"),e.namespaceSegment=a.getSegmentForValue(e.target.namespace,"select namespace"),e.metricSegment=a.getSegmentForValue(e.target.metricName,"select metric"),e.dimSegments=A.a.reduce(e.target.dimensions,function(e,t,r){return e.push(a.newKey(r)),e.push(a.newOperator("=")),e.push(a.newKeyValue(t)),e},[]),e.statSegments=A.a.map(e.target.statistics,function(e){return a.getSegmentForValue(e)}),e.ensurePlusButton(e.statSegments),e.ensurePlusButton(e.dimSegments),e.removeDimSegment=a.newSegment({fake:!0,value:"-- remove dimension --"}),e.removeStatSegment=a.newSegment({fake:!0,value:"-- remove stat --"}),A.a.isEmpty(e.target.region)&&(e.target.region="default"),e.onChange||(e.onChange=function(){})},e.getStatSegments=function(){return n.when(A.a.flatten([D.a.copy(e.removeStatSegment),A.a.map(e.datasource.standardStatistics,function(e){return a.getSegmentForValue(e)}),a.getSegmentForValue("pNN.NN")]))},e.statSegmentChanged=function(t,a){t.value===e.removeStatSegment.value?e.statSegments.splice(a,1):t.type="value",e.target.statistics=A.a.reduce(e.statSegments,function(e,t){return t.fake||e.push(t.value),e},[]),e.ensurePlusButton(e.statSegments),e.onChange()},e.ensurePlusButton=function(e){var t=e.length,r=e[Math.max(t-1,0)];r&&"plus-button"===r.type||e.push(a.newPlusButton())},e.getDimSegments=function(t,a){if("operator"===t.type)return n.when([]);var r=e.target,i=n.when([]);if("key"===t.type||"plus-button"===t.type)i=e.datasource.getDimensionKeys(e.target.namespace,e.target.region);else if("value"===t.type){var s=e.dimSegments[a-2].value;i=e.datasource.getDimensionValues(r.region,r.namespace,r.metricName,s,r.dimensions)}return i.then(e.transformToSegments(!0)).then(function(a){return"key"===t.type&&a.splice(0,0,D.a.copy(e.removeDimSegment)),a})},e.dimSegmentChanged=function(t,r){e.dimSegments[r]=t,t.value===e.removeDimSegment.value?e.dimSegments.splice(r,3):"plus-button"===t.type&&(e.dimSegments.push(a.newOperator("=")),e.dimSegments.push(a.newFake("select dimension value","value","query-segment-value")),t.type="key",t.cssClass="query-segment-key"),e.syncDimSegmentsWithModel(),e.ensurePlusButton(e.dimSegments),e.onChange()},e.syncDimSegmentsWithModel=function(){for(var t={},a=e.dimSegments.length,r=0;r<a-2;r+=3){var n=e.dimSegments[r],i=e.dimSegments[r+2];i.fake||(t[n.value]=i.value)}e.target.dimensions=t},e.getRegions=function(){return e.datasource.metricFindQuery("regions()").then(function(e){return e.unshift({text:"default"}),e}).then(e.transformToSegments(!0))},e.getNamespaces=function(){return e.datasource.metricFindQuery("namespaces()").then(e.transformToSegments(!0))},e.getMetrics=function(){return e.datasource.metricFindQuery("metrics("+e.target.namespace+","+e.target.region+")").then(e.transformToSegments(!0))},e.regionChanged=function(){e.target.region=e.regionSegment.value,e.onChange()},e.namespaceChanged=function(){e.target.namespace=e.namespaceSegment.value,e.onChange()},e.metricChanged=function(){e.target.metricName=e.metricSegment.value,e.onChange()},e.transformToSegments=function(e){return function(r){var n=A.a.map(r,function(e){return a.newSegment({value:e.text,expandable:e.expandable})});return e&&A.a.each(t.variables,function(e){n.unshift(a.newSegment({type:"template",value:"$"+e.name,expandable:!0}))}),n}},e.init()}return e.$inject=["$scope","templateSrv","uiSegmentSrv","datasourceSrv","$q"],e}();D.a.module("grafana.controllers").directive("cloudwatchQueryParameter",ha),D.a.module("grafana.controllers").controller("CloudWatchQueryParameterCtrl",pa);var da=function(){function e(e,t,a,r,n){this.$q=t,this.backendSrv=a,this.templateSrv=r,this.timeSrv=n,this.type="cloudwatch",this.name=e.name,this.proxyUrl=e.url,this.defaultRegion=e.jsonData.defaultRegion,this.instanceSettings=e,this.standardStatistics=["Average","Maximum","Minimum","Sum","SampleCount"]}return e.$inject=["instanceSettings","$q","backendSrv","templateSrv","timeSrv"],e.prototype.query=function(e){var t=this;(e=D.a.copy(e)).targets=this.expandTemplateVariable(e.targets,e.scopedVars,this.templateSrv);var a=A.a.filter(e.targets,function(e){return(""!==e.id||!0!==e.hide)&&(!!e.region&&!!e.namespace&&!!e.metricName&&!A.a.isEmpty(e.statistics)||e.expression.length>0)}).map(function(a){if(a.region=t.templateSrv.replace(t.getActualRegion(a.region),e.scopedVars),a.namespace=t.templateSrv.replace(a.namespace,e.scopedVars),a.metricName=t.templateSrv.replace(a.metricName,e.scopedVars),a.dimensions=t.convertDimensionFormat(a.dimensions,e.scopedVars),a.period=String(t.getPeriod(a,e)),a.id=t.templateSrv.replace(a.id,e.scopedVars),a.expression=t.templateSrv.replace(a.expression,e.scopedVars),a.returnData=void 0===a.hide||!a.hide,a.statistics.some(function(e){if(0===e.indexOf("p")){var t=/^p\d{2}(?:\.\d{1,2})?$/.exec(e);return!t||t[0]!==e}return!1}))throw{message:"Invalid extended statistics"};return A.a.extend({refId:a.refId,intervalMs:e.intervalMs,maxDataPoints:e.maxDataPoints,datasourceId:t.instanceSettings.id,type:"timeSeriesQuery"},a)});if(A.a.isEmpty(a)){var r=this.$q.defer();return r.resolve({data:[]}),r.promise}var n={from:e.range.from.valueOf().toString(),to:e.range.to.valueOf().toString(),queries:a};return this.performTimeSeriesQuery(n)},e.prototype.getPeriod=function(e,t,a){var r,n=this.convertToCloudWatchTime(t.range.from,!1),i=this.convertToCloudWatchTime(t.range.to,!0);a=Math.round((a||Date.now())/1e3);var s=i-n,o=60;return e.period?r=/^\d+$/.test(e.period)?parseInt(e.period,10):ie.a.interval_to_seconds(this.templateSrv.replace(e.period,t.scopedVars)):o=r=a-n<=1296e3?"AWS/EC2"===e.namespace?300:60:a-n<=5443200?300:3600,r<1&&(r=1),!e.highResolution&&s/r>=1440&&(r=Math.ceil(s/1440/o)*o),r},e.prototype.performTimeSeriesQuery=function(e){return this.awsRequest("/api/tsdb/query",e).then(function(e){var t=[];return e.results&&A.a.forEach(e.results,function(e){A.a.forEach(e.series,function(a){var r={target:a.name,datapoints:a.points};e.meta.unit&&(r.unit=e.meta.unit),t.push(r)})}),{data:t}})},e.prototype.transformSuggestDataFromTable=function(e){return A.a.map(e.results.metricFindQuery.tables[0].rows,function(e){return{text:e[0],value:e[1]}})},e.prototype.doMetricQueryRequest=function(e,t){var a=this,r=this.timeSrv.timeRange();return this.awsRequest("/api/tsdb/query",{from:r.from.valueOf().toString(),to:r.to.valueOf().toString(),queries:[A.a.extend({refId:"metricFindQuery",intervalMs:1,maxDataPoints:1,datasourceId:this.instanceSettings.id,type:"metricFindQuery",subtype:e},t)]}).then(function(e){return a.transformSuggestDataFromTable(e)})},e.prototype.getRegions=function(){return this.doMetricQueryRequest("regions",null)},e.prototype.getNamespaces=function(){return this.doMetricQueryRequest("namespaces",null)},e.prototype.getMetrics=function(e,t){return this.doMetricQueryRequest("metrics",{region:this.templateSrv.replace(this.getActualRegion(t)),namespace:this.templateSrv.replace(e)})},e.prototype.getDimensionKeys=function(e,t){return this.doMetricQueryRequest("dimension_keys",{region:this.templateSrv.replace(this.getActualRegion(t)),namespace:this.templateSrv.replace(e)})},e.prototype.getDimensionValues=function(e,t,a,r,n){return this.doMetricQueryRequest("dimension_values",{region:this.templateSrv.replace(this.getActualRegion(e)),namespace:this.templateSrv.replace(t),metricName:this.templateSrv.replace(a),dimensionKey:this.templateSrv.replace(r),dimensions:this.convertDimensionFormat(n,{})})},e.prototype.getEbsVolumeIds=function(e,t){return this.doMetricQueryRequest("ebs_volume_ids",{region:this.templateSrv.replace(this.getActualRegion(e)),instanceId:this.templateSrv.replace(t)})},e.prototype.getEc2InstanceAttribute=function(e,t,a){return this.doMetricQueryRequest("ec2_instance_attribute",{region:this.templateSrv.replace(this.getActualRegion(e)),attributeName:this.templateSrv.replace(t),filters:a})},e.prototype.metricFindQuery=function(e){var t,a,r,n;if(e.match(/^regions\(\)/))return this.getRegions();if(e.match(/^namespaces\(\)/))return this.getNamespaces();var i=e.match(/^metrics\(([^\)]+?)(,\s?([^,]+?))?\)/);if(i)return a=i[1],t=i[3],this.getMetrics(a,t);var s=e.match(/^dimension_keys\(([^\)]+?)(,\s?([^,]+?))?\)/);if(s)return a=s[1],t=s[3],this.getDimensionKeys(a,t);var o=e.match(/^dimension_values\(([^,]+?),\s?([^,]+?),\s?([^,]+?),\s?([^,]+?)(,\s?(.+))?\)/);if(o){t=o[1],a=o[2],r=o[3];var l=o[4];return n={},o[6]&&(n=JSON.parse(this.templateSrv.replace(o[6]))),this.getDimensionValues(t,a,r,l,n)}var u=e.match(/^ebs_volume_ids\(([^,]+?),\s?([^,]+?)\)/);if(u){t=u[1];var c=u[2];return this.getEbsVolumeIds(t,c)}var h=e.match(/^ec2_instance_attribute\(([^,]+?),\s?([^,]+?),\s?(.+?)\)/);if(h){t=h[1];var p=h[2];return n=JSON.parse(this.templateSrv.replace(h[3])),this.getEc2InstanceAttribute(t,p,n)}return this.$q.when([])},e.prototype.annotationQuery=function(e){var t=this,a=e.annotation,r=A.a.map(a.statistics,function(e){return t.templateSrv.replace(e)}),n=a.prefixMatching?"":"300",i=a.period||n;i=parseInt(i,10);var s={prefixMatching:a.prefixMatching,region:this.templateSrv.replace(this.getActualRegion(a.region)),namespace:this.templateSrv.replace(a.namespace),metricName:this.templateSrv.replace(a.metricName),dimensions:this.convertDimensionFormat(a.dimensions,{}),statistics:r,period:i,actionPrefix:a.actionPrefix||"",alarmNamePrefix:a.alarmNamePrefix||""};return this.awsRequest("/api/tsdb/query",{from:e.range.from.valueOf().toString(),to:e.range.to.valueOf().toString(),queries:[A.a.extend({refId:"annotationQuery",intervalMs:1,maxDataPoints:1,datasourceId:this.instanceSettings.id,type:"annotationQuery"},s)]}).then(function(e){return A.a.map(e.results.annotationQuery.tables[0].rows,function(e){return{annotation:a,time:Date.parse(e[0]),title:e[1],tags:[e[2]],text:e[3]}})})},e.prototype.targetContainsTemplate=function(e){var t=this;return this.templateSrv.variableExists(e.region)||this.templateSrv.variableExists(e.namespace)||this.templateSrv.variableExists(e.metricName)||A.a.find(e.dimensions,function(e,a){return t.templateSrv.variableExists(a)||t.templateSrv.variableExists(e)})},e.prototype.testDatasource=function(){var e=this.defaultRegion;return this.getDimensionValues(e,"AWS/Billing","EstimatedCharges","ServiceName",{}).then(function(){return{status:"success",message:"Data source is working"}},function(e){return{status:"error",message:e.message}})},e.prototype.awsRequest=function(e,t){var a={method:"POST",url:e,data:t};return this.backendSrv.datasourceRequest(a).then(function(e){return e.data})},e.prototype.getDefaultRegion=function(){return this.defaultRegion},e.prototype.getActualRegion=function(e){return"default"===e||A.a.isEmpty(e)?this.getDefaultRegion():e},e.prototype.getExpandedVariables=function(e,t,a,r){var n=A.a.find(a.options,{selected:!0,text:"All"}),i=A.a.filter(a.options,function(e){return n?"All"!==e.text:e.selected}),s=A.a.isArray(a.current.value)?a.current.value.map(function(e){return{text:e,value:e}}):[a.current];return(i.some(function(e){return e.value===s[0].value})||"$__all"===s[0].value?i:s).map(function(n){var i=D.a.copy(e),s={};return s[a.name]=n,i.refId=e.refId+"_"+n.value,i.dimensions[t]=r.replace(i.dimensions[t],s),a.multi&&e.id?i.id=e.id+window.btoa(n.value).replace(/=/g,"0"):i.id=e.id,i})},e.prototype.expandTemplateVariable=function(e,t,a){var r=this;return A.a.chain(e).map(function(e){var n=A.a.findKey(e.dimensions,function(e){return a.variableExists(e)&&!A.a.has(t,a.getVariableName(e))});if(n){var i=A.a.find(a.variables,function(t){return ae(e.dimensions[n],t.name)&&t.multi}),s=A.a.find(a.variables,function(t){return ae(e.dimensions[n],t.name)});return r.getExpandedVariables(e,n,i||s,a)}return[e]}).flatten().value()},e.prototype.convertToCloudWatchTime=function(e,t){return A.a.isString(e)&&(e=je.parse(e,t)),Math.round(e.valueOf()/1e3)},e.prototype.convertDimensionFormat=function(e,t){var a=this,r={};return A.a.each(e,function(e,n){r[a.templateSrv.replace(n,t)]=a.templateSrv.replace(e,t)}),r},e}(),ma=function(e){function t(t,a){var r=e.call(this,t,a)||this;return r.aliasSyntax="{{metric}} {{stat}} {{namespace}} {{region}} {{<dimension name>}}",r}return t.$inject=["$scope","$injector"],Ve.c(t,e),t.templateUrl="partials/query.editor.html",t}(Ye),fa=function(){function e(e){this.accessKeyExist=!1,this.secretKeyExist=!1,this.authTypes=[{name:"Access & secret key",value:"keys"},{name:"Credentials file",value:"credentials"},{name:"ARN",value:"arn"}],this.indexPatternTypes=[{name:"No pattern",value:void 0},{name:"Hourly",value:"Hourly",example:"[logstash-]YYYY.MM.DD.HH"},{name:"Daily",value:"Daily",example:"[logstash-]YYYY.MM.DD"},{name:"Weekly",value:"Weekly",example:"[logstash-]GGGG.WW"},{name:"Monthly",value:"Monthly",example:"[logstash-]YYYY.MM"},{name:"Yearly",value:"Yearly",example:"[logstash-]YYYY"}],this.current.jsonData.timeField=this.current.jsonData.timeField||"@timestamp",this.current.jsonData.authType=this.current.jsonData.authType||"credentials",this.accessKeyExist=this.current.secureJsonFields.accessKey,this.secretKeyExist=this.current.secureJsonFields.secretKey}return e.$inject=["$scope"],e.prototype.resetAccessKey=function(){this.accessKeyExist=!1},e.prototype.resetSecretKey=function(){this.secretKeyExist=!1},e.templateUrl="partials/config.html",e}(),ga=function(){function e(){}return e.templateUrl="partials/annotations.editor.html",e}(),va=[{text:"Count",value:"count",requiresField:!1},{text:"Average",value:"avg",requiresField:!0,supportsInlineScript:!0,supportsMissing:!0},{text:"Sum",value:"sum",requiresField:!0,supportsInlineScript:!0,supportsMissing:!0},{text:"Max",value:"max",requiresField:!0,supportsInlineScript:!0,supportsMissing:!0},{text:"Min",value:"min",requiresField:!0,supportsInlineScript:!0,supportsMissing:!0},{text:"Extended Stats",value:"extended_stats",requiresField:!0,supportsMissing:!0,supportsInlineScript:!0},{text:"Percentiles",value:"percentiles",requiresField:!0,supportsMissing:!0,supportsInlineScript:!0},{text:"Unique Count",value:"cardinality",requiresField:!0,supportsMissing:!0},{text:"Moving Average",value:"moving_avg",requiresField:!1,isPipelineAgg:!0,minVersion:2},{text:"Derivative",value:"derivative",requiresField:!1,isPipelineAgg:!0,minVersion:2},{text:"Raw Document",value:"raw_document",requiresField:!1}],ya=[{text:"Terms",value:"terms",requiresField:!0},{text:"Filters",value:"filters"},{text:"Geo Hash Grid",value:"geohash_grid",requiresField:!0},{text:"Date Histogram",value:"date_histogram",requiresField:!0},{text:"Histogram",value:"histogram",requiresField:!0}],ba=[{text:"Doc Count",value:"_count"},{text:"Term value",value:"_term"}],Sa=[{text:"Top",value:"desc"},{text:"Bottom",value:"asc"}],xa=[{text:"No limit",value:"0"},{text:"1",value:"1"},{text:"2",value:"2"},{text:"3",value:"3"},{text:"5",value:"5"},{text:"10",value:"10"},{text:"15",value:"15"},{text:"20",value:"20"}],wa=[{text:"Avg",value:"avg"},{text:"Min",value:"min"},{text:"Max",value:"max"},{text:"Sum",value:"sum"},{text:"Count",value:"count"},{text:"Std Dev",value:"std_deviation"},{text:"Std Dev Upper",value:"std_deviation_bounds_upper"},{text:"Std Dev Lower",value:"std_deviation_bounds_lower"}],Ta=[{text:"auto",value:"auto"},{text:"10s",value:"10s"},{text:"1m",value:"1m"},{text:"5m",value:"5m"},{text:"10m",value:"10m"},{text:"20m",value:"20m"},{text:"1h",value:"1h"},{text:"1d",value:"1d"}],Ca=[{text:"Simple",value:"simple"},{text:"Linear",value:"linear"},{text:"Exponentially Weighted",value:"ewma"},{text:"Holt Linear",value:"holt"},{text:"Holt Winters",value:"holt_winters"}],ka={moving_avg:[{text:"window",default:5},{text:"model",default:"simple"},{text:"predict",default:void 0},{text:"minimize",default:!1}],derivative:[{text:"unit",default:void 0}]},_a={simple:[],linear:[],ewma:[{text:"Alpha",value:"alpha",default:void 0}],holt:[{text:"Alpha",value:"alpha",default:void 0},{text:"Beta",value:"beta",default:void 0}],holt_winters:[{text:"Alpha",value:"alpha",default:void 0},{text:"Beta",value:"beta",default:void 0},{text:"Gamma",value:"gamma",default:void 0},{text:"Period",value:"period",default:void 0},{text:"Pad",value:"pad",default:void 0,isCheckbox:!0}]};function Ea(e){return A.a.filter(va,function(t){return!t.minVersion||t.minVersion<=e})}function Ma(e){if(e){var t=ka[e];return null!==t&&void 0!==t}return!1}function Pa(e,t){var a=[];return t?(A.a.each(_a[e],function(e){e.isCheckbox||a.push(e)}),a):_a[e]}function Da(e){return A.a.find(va,{value:e.type}).text+" "+e.field}var $a=function(){function e(e){this.timeField=e.timeField,this.esVersion=e.esVersion}return e.prototype.getRangeFilter=function(){var e={};return e[this.timeField]={gte:"$timeFrom",lte:"$timeTo",format:"epoch_millis"},e},e.prototype.buildTermsAgg=function(e,t,a){var r,n,i;if(t.terms={field:e.field},!e.settings)return t;if(t.terms.size=0===parseInt(e.settings.size,10)?500:parseInt(e.settings.size,10),void 0!==e.settings.orderBy&&(t.terms.order={},t.terms.order[e.settings.orderBy]=e.settings.order,r=parseInt(e.settings.orderBy,10),!isNaN(r)))for(i=0;i<a.metrics.length;i++)if((n=a.metrics[i]).id===e.settings.orderBy){t.aggs={},t.aggs[n.id]={},t.aggs[n.id][n.type]={field:n.field};break}return void 0!==e.settings.min_doc_count&&(t.terms.min_doc_count=parseInt(e.settings.min_doc_count,10)),e.settings.missing&&(t.terms.missing=e.settings.missing),t},e.prototype.getDateHistogramAgg=function(e){var t={},a=e.settings||{};return t.interval=a.interval,t.field=this.timeField,t.min_doc_count=a.min_doc_count||0,t.extended_bounds={min:"$timeFrom",max:"$timeTo"},t.format="epoch_millis","auto"===t.interval&&(t.interval="$__interval"),a.missing&&(t.missing=a.missing),t},e.prototype.getHistogramAgg=function(e){var t={},a=e.settings||{};return t.interval=a.interval,t.field=e.field,t.min_doc_count=a.min_doc_count||0,a.missing&&(t.missing=a.missing),t},e.prototype.getFiltersAgg=function(e){for(var t={},a=0;a<e.settings.filters.length;a++){var r=e.settings.filters[a].query,n=e.settings.filters[a].label;t[n=""===n||void 0===n?r:n]={query_string:{query:r,analyze_wildcard:!0}}}return t},e.prototype.documentQuery=function(e,t){return e.size=t,e.sort={},e.sort[this.timeField]={order:"desc",unmapped_type:"boolean"},this.esVersion<5&&(e.fields=["*","_source"]),e.script_fields={},this.esVersion<5?e.fielddata_fields=[this.timeField]:e.docvalue_fields=[this.timeField],e},e.prototype.addAdhocFilters=function(e,t){var a,r,n,i;if(t)for(a=0;a<t.length;a++)switch((n={})[(r=t[a]).key]=r.value,(i={})[r.key]={query:r.value},r.operator){case"=":e.query.bool.must||(e.query.bool.must=[]),e.query.bool.must.push({match_phrase:i});break;case"!=":e.query.bool.must_not||(e.query.bool.must_not=[]),e.query.bool.must_not.push({match_phrase:i});break;case"<":n[r.key]={lt:r.value},e.query.bool.filter.push({range:n});break;case">":n[r.key]={gt:r.value},e.query.bool.filter.push({range:n});break;case"=~":e.query.bool.filter.push({regexp:n});break;case"!~":e.query.bool.filter.push({bool:{must_not:{regexp:n}}})}},e.prototype.build=function(e,t,a){var r,n,i;e.metrics=e.metrics||[{type:"count",id:"1"}],e.bucketAggs=e.bucketAggs||[{type:"date_histogram",id:"2",settings:{interval:"auto"}}],e.timeField=this.timeField;var s={size:0,query:{bool:{filter:[{range:this.getRangeFilter()},{query_string:{analyze_wildcard:!0,query:a}}]}}};if(this.addAdhocFilters(s,t),0===e.bucketAggs.length){if(!(i=e.metrics[0])||"raw_document"!==i.type)throw{message:"Invalid query"};var o=i.settings&&i.settings.size||500;return this.documentQuery(s,o)}for(n=s,r=0;r<e.bucketAggs.length;r++){var l=e.bucketAggs[r],u={};switch(l.type){case"date_histogram":u.date_histogram=this.getDateHistogramAgg(l);break;case"histogram":u.histogram=this.getHistogramAgg(l);break;case"filters":u.filters={filters:this.getFiltersAgg(l)};break;case"terms":this.buildTermsAgg(l,u,e);break;case"geohash_grid":u.geohash_grid={field:l.field,precision:l.settings.precision}}n.aggs=n.aggs||{},n.aggs[l.id]=u,n=u}for(n.aggs={},r=0;r<e.metrics.length;r++)if("count"!==(i=e.metrics[r]).type){var c={},h=null;if(Ma(i.type)){if(!i.pipelineAgg||!/^\d*$/.test(i.pipelineAgg))continue;h={buckets_path:i.pipelineAgg}}else h={field:i.field};for(var p in i.settings)i.settings.hasOwnProperty(p)&&null!==i.settings[p]&&(h[p]=i.settings[p]);c[i.type]=h,n.aggs[i.id]=c}return s},e.prototype.getTermsQuery=function(e){var t={size:0,query:{bool:{filter:[{range:this.getRangeFilter()}]}}};e.query&&t.query.bool.filter.push({query_string:{analyze_wildcard:!0,query:e.query}});var a=500;return e.size&&(a=e.size),t.aggs={1:{terms:{field:e.field,size:a,order:{_term:"asc"}}}},t},e}(),Aa={Hourly:{startOf:"hour",amount:"hours"},Daily:{startOf:"day",amount:"days"},Weekly:{startOf:"isoWeek",amount:"weeks"},Monthly:{startOf:"month",amount:"months"},Yearly:{startOf:"year",amount:"years"}},Ia=function(){function e(e,t){this.pattern=e,this.interval=t}return e.prototype.getIndexForToday=function(){return this.interval?U.a.utc().format(this.pattern):this.pattern},e.prototype.getIndexList=function(e,t){if(!this.interval)return this.pattern;for(var a=Aa[this.interval],r=U()(e).utc().startOf(a.startOf),n=U()(t).utc().startOf(a.startOf).valueOf(),i=[];r.valueOf()<=n;)i.push(r.format(this.pattern)),r.add(1,a.amount);return i},e}(),Oa=function(){function e(e,t){this.targets=e,this.response=t,this.targets=e,this.response=t}return e.prototype.processMetrics=function(e,t,a,r){var n,i,s,o,l,u;for(i=0;i<t.metrics.length;i++)if(!(n=t.metrics[i]).hide)switch(n.type){case"count":for(o={datapoints:[],metric:"count",props:r},s=0;s<e.buckets.length;s++)u=(l=e.buckets[s]).doc_count,o.datapoints.push([u,l.key]);a.push(o);break;case"percentiles":if(0===e.buckets.length)break;var c=e.buckets[0][n.id].values;for(var h in c){for(o={datapoints:[],metric:"p"+h,props:r,field:n.field},s=0;s<e.buckets.length;s++){var p=(l=e.buckets[s])[n.id].values;o.datapoints.push([p[h],l.key])}a.push(o)}break;case"extended_stats":for(var d in n.meta)if(n.meta[d]){for(o={datapoints:[],metric:d,props:r,field:n.field},s=0;s<e.buckets.length;s++){var m=(l=e.buckets[s])[n.id];m.std_deviation_bounds_upper=m.std_deviation_bounds.upper,m.std_deviation_bounds_lower=m.std_deviation_bounds.lower,o.datapoints.push([m[d],l.key])}a.push(o)}break;default:for(o={datapoints:[],metric:n.type,field:n.field,props:r},s=0;s<e.buckets.length;s++)void 0!==(u=(l=e.buckets[s])[n.id])&&(u.normalized_value?o.datapoints.push([u.normalized_value,l.key]):o.datapoints.push([u.value,l.key]));a.push(o)}},e.prototype.processAggregationDocs=function(e,t,a,r,n){if(0===r.columns.length){for(var i=0,s=A.a.keys(n);i<s.length;i++){var o=s[i];r.addColumn({text:o,filterable:!0})}r.addColumn({text:t.field,filterable:!0})}for(var l=function(e,t,a){r.addColumn({text:t}),e.push(a)},u=0,c=e.buckets;u<c.length;u++){for(var h=c[u],p=[],d=0,m=A.a.values(n);d<m.length;d++){var f=m[d];p.push(f)}p.push(h.key);for(var g=0,v=a.metrics;g<v.length;g++){var y=v[g];switch(y.type){case"count":l(p,this.getMetricName(y.type),h.doc_count);break;case"extended_stats":for(var b in y.meta)if(y.meta[b]){var S=h[y.id];S.std_deviation_bounds_upper=S.std_deviation_bounds.upper,S.std_deviation_bounds_lower=S.std_deviation_bounds.lower,l(p,this.getMetricName(b),S[b])}break;default:var x=this.getMetricName(y.type);A.a.filter(a.metrics,{type:y.type}).length>1&&(x+=" "+y.field),l(p,x,h[y.id].value)}}r.rows.push(p)}},e.prototype.processBuckets=function(e,t,a,r,n,i){var s,o,l,u,c=t.bucketAggs.length-1;for(u in e)if(o=A.a.find(t.bucketAggs,{id:u}),l=e[u],o)if(i===c)"date_histogram"===o.type?this.processMetrics(l,t,a,n):this.processAggregationDocs(l,o,t,r,n);else for(var h in l.buckets)s=l.buckets[h],n=A.a.clone(n),void 0!==s.key?n[o.field]=s.key:n.filter=h,s.key_as_string&&(n[o.field]=s.key_as_string),this.processBuckets(s,t,a,r,n,i+1)},e.prototype.getMetricName=function(e){var t=A.a.find(va,{value:e});return t||(t=A.a.find(wa,{value:e})),t?t.text:e},e.prototype.getSeriesName=function(e,t,a){var r=this.getMetricName(e.metric);if(t.alias){return t.alias.replace(/\{\{([\s\S]+?)\}\}/g,function(t,a,n){var i=a||n;return 0===i.indexOf("term ")?e.props[i.substring(5)]:void 0!==e.props[i]?e.props[i]:"metric"===i?r:"field"===i?e.field:t})}if(e.field&&Ma(e.metric)){var n=A.a.find(t.metrics,{id:e.field});n?r+=" "+Da(n):r="Unset"}else e.field&&(r+=" "+e.field);if(0===A.a.keys(e.props).length)return r;var i="";for(var s in e.props)i+=e.props[s]+" ";return 1===a?i.trim():i.trim()+" "+r},e.prototype.nameSeries=function(e,t){for(var a=A.a.uniq(A.a.map(e,"metric")).length,r=0;r<e.length;r++){var n=e[r];n.target=this.getSeriesName(n,t,a)}},e.prototype.processHits=function(e,t){var a,r,n,i,s={target:"docs",type:"docs",datapoints:[],total:e.total,filterable:!0};for(i=0;i<e.hits.length;i++){if(n={_id:(r=e.hits[i])._id,_type:r._type,_index:r._index},r._source)for(a in r._source)n[a]=r._source[a];for(a in r.fields)n[a]=r.fields[a];s.datapoints.push(n)}t.push(s)},e.prototype.trimDatapoints=function(e,t){var a=A.a.find(t.bucketAggs,{type:"date_histogram"});if(a&&a.settings&&a.settings.trimEdges){var r=a.settings.trimEdges;for(var n in e){var i=e[n];i.datapoints.length>2*r&&(i.datapoints=i.datapoints.slice(r,i.datapoints.length-r))}}},e.prototype.getErrorFromElasticResponse=function(e,t){var a={};return a.data=JSON.stringify(t,null,4),t.root_cause&&t.root_cause.length>0&&t.root_cause[0].reason?a.message=t.root_cause[0].reason:a.message=t.reason||"Unkown elastic error response",e.$$config&&(a.config=e.$$config),a},e.prototype.getTimeSeries=function(){for(var e=[],t=0;t<this.response.responses.length;t++){var a=this.response.responses[t];if(a.error)throw this.getErrorFromElasticResponse(this.response,a.error);if(a.hits&&a.hits.hits.length>0&&this.processHits(a.hits,e),a.aggregations){var r=a.aggregations,n=this.targets[t],i=[],s=new lt.a;this.processBuckets(r,n,i,s,{},0),this.trimDatapoints(i,n),this.nameSeries(i,n);for(var o=0;o<i.length;o++)e.push(i[o]);s.rows.length>0&&e.push(s)}}return{data:e}},e}(),Fa=function(){function e(e,t,a,r,n){this.$q=t,this.backendSrv=a,this.templateSrv=r,this.timeSrv=n,this.basicAuth=e.basicAuth,this.withCredentials=e.withCredentials,this.url=e.url,this.name=e.name,this.index=e.index,this.timeField=e.jsonData.timeField,this.esVersion=e.jsonData.esVersion,this.indexPattern=new Ia(e.index,e.jsonData.interval),this.interval=e.jsonData.timeInterval,this.maxConcurrentShardRequests=e.jsonData.maxConcurrentShardRequests,this.queryBuilder=new $a({timeField:this.timeField,esVersion:this.esVersion})}return e.$inject=["instanceSettings","$q","backendSrv","templateSrv","timeSrv"],e.prototype.request=function(e,t,a){var r={url:this.url+"/"+t,method:e,data:a};return(this.basicAuth||this.withCredentials)&&(r.withCredentials=!0),this.basicAuth&&(r.headers={Authorization:this.basicAuth}),this.backendSrv.datasourceRequest(r)},e.prototype.get=function(e){var t=this.timeSrv.timeRange(),a=this.indexPattern.getIndexList(t.from.valueOf(),t.to.valueOf());return A.a.isArray(a)&&a.length?this.request("GET",a[0]+e).then(function(e){return e.data.$$config=e.config,e.data}):this.request("GET",this.indexPattern.getIndexForToday()+e).then(function(e){return e.data.$$config=e.config,e.data})},e.prototype.post=function(e,t){return this.request("POST",e,t).then(function(e){return e.data.$$config=e.config,e.data}).catch(function(e){if(e.data&&e.data.error)throw{message:"Elasticsearch error: "+e.data.error.reason,error:e.data.error};throw e})},e.prototype.annotationQuery=function(e){var t=e.annotation,a=t.timeField||"@timestamp",r=t.query||"*",n=t.tagsField||"tags",i=t.textField||null,s={};s[a]={from:e.range.from.valueOf(),to:e.range.to.valueOf(),format:"epoch_millis"};var o={query:{bool:{filter:[{range:s},{query_string:{query:this.templateSrv.replace(r,{},"lucene")}}]}},size:1e4};this.esVersion<5&&(o.fields=[a,"_source"]);var l={search_type:"query_then_fetch",ignore_unavailable:!0};t.index?l.index=t.index:l.index=this.indexPattern.getIndexList(e.range.from,e.range.to);var u=D.a.toJson(l)+"\n"+D.a.toJson(o)+"\n";return this.post("_msearch",u).then(function(e){for(var r=[],s=e.responses[0].hits.hits,o=function(e,t){if(t){for(var a=t.split("."),r=e,n=0;n<a.length;n++)if(!(r=r[a[n]]))return console.log("could not find field in annotation: ",t),"";return r}},l=0;l<s.length;l++){var u=s[l]._source,c=o(u,a);if(void 0!==s[l].fields){var h=s[l].fields;(A.a.isString(h[a])||A.a.isNumber(h[a]))&&(c=h[a])}var p={annotation:t,time:U.a.utc(c).valueOf(),text:o(u,i),tags:o(u,n)};if(t.titleField){var d=o(u,t.titleField);d&&(p.text=d+"\n"+p.text)}"string"==typeof p.tags&&(p.tags=p.tags.split(",")),r.push(p)}return r})},e.prototype.testDatasource=function(){var e=this;return this.timeSrv.setTime({from:"now-1m",to:"now"},!0),this.getFields({type:"date"}).then(function(t){return A.a.find(t,{text:e.timeField})?{status:"success",message:"Index OK. Time field name OK."}:{status:"error",message:"No date field named "+e.timeField+" found"}},function(e){if(console.log(e),e.data&&e.data.error){var t=D.a.toJson(e.data.error);return e.data.error.reason&&(t=e.data.error.reason),{status:"error",message:t}}return{status:"error",message:e.status}})},e.prototype.getQueryHeader=function(e,t,a){var r={search_type:e,ignore_unavailable:!0,index:this.indexPattern.getIndexList(t,a)};return this.esVersion>=56&&(r.max_concurrent_shard_requests=this.maxConcurrentShardRequests),D.a.toJson(r)},e.prototype.query=function(e){for(var t,a="",r=[],n=this.templateSrv.getAdhocFilters(this.name),i=0;i<e.targets.length;i++)if(!(t=e.targets[i]).hide){var s=this.templateSrv.replace(t.query||"*",e.scopedVars,"lucene"),o=this.queryBuilder.build(t,n,s),l=D.a.toJson(o),u=0===o.size&&this.esVersion<5?"count":"query_then_fetch";a+=this.getQueryHeader(u,e.range.from,e.range.to)+"\n",a+=l+"\n",r.push(t)}return 0===r.length?this.$q.when([]):(a=(a=a.replace(/\$timeFrom/g,e.range.from.valueOf())).replace(/\$timeTo/g,e.range.to.valueOf()),a=this.templateSrv.replace(a,e.scopedVars),this.post("_msearch",a).then(function(e){return new Oa(r,e).getTimeSeries()}))},e.prototype.getFields=function(e){return this.get("/_mapping").then(function(t){var a={float:"number",double:"number",integer:"number",long:"number",date:"date",string:"string",text:"string",scaled_float:"number",nested:"nested"};function r(e,t,r){return"_"!==t[0]&&(!r.type||(r.type===e.type||r.type===a[e.type]))}var n=[],i={};function s(t){for(var a in t){var o=t[a];if(A.a.isObject(o.properties)&&(n.push(a),s(o.properties)),A.a.isObject(o.fields)&&(n.push(a),s(o.fields)),A.a.isString(o.type)){var l=n.concat(a).join(".");r(o,a,e)&&(i[l]={text:l,type:o.type})}}n.pop()}for(var o in t){var l=t[o];if(l&&l.mappings){var u=l.mappings;for(var c in u){s(u[c].properties)}}}return A.a.map(i,function(e){return e})})},e.prototype.getTerms=function(e){var t=this.timeSrv.timeRange(),a=this.esVersion>=5?"query_then_fetch":"count",r=this.getQueryHeader(a,t.from,t.to),n=D.a.toJson(this.queryBuilder.getTermsQuery(e));return n=r+"\n"+(n=(n=n.replace(/\$timeFrom/g,t.from.valueOf())).replace(/\$timeTo/g,t.to.valueOf()))+"\n",this.post("_msearch?search_type="+a,n).then(function(e){if(!e.responses[0].aggregations)return[];var t=e.responses[0].aggregations[1].buckets;return A.a.map(t,function(e){return{text:e.key_as_string||e.key,value:e.key}})})},e.prototype.metricFindQuery=function(e){return(e=D.a.fromJson(e))?"fields"===e.find?(e.field=this.templateSrv.replace(e.field,{},"lucene"),this.getFields(e)):"terms"===e.find?(e.field=this.templateSrv.replace(e.field,{},"lucene"),e.query=this.templateSrv.replace(e.query||"*",{},"lucene"),this.getTerms(e)):void 0:this.$q.when([])},e.prototype.getTagKeys=function(){return this.getFields({})},e.prototype.getTagValues=function(e){return this.getTerms({field:e.key,query:"*"})},e.prototype.targetContainsTemplate=function(e){if(this.templateSrv.variableExists(e.query)||this.templateSrv.variableExists(e.alias))return!0;for(var t=0,a=e.bucketAggs;t<a.length;t++){var r=a[t];if(this.templateSrv.variableExists(r.field)||this.objectContainsTemplate(r.settings))return!0}for(var n=0,i=e.metrics;n<i.length;n++){var s=i[n];if(this.templateSrv.variableExists(s.field)||this.objectContainsTemplate(s.settings)||this.objectContainsTemplate(s.meta))return!0}return!1},e.prototype.isPrimitive=function(e){return null===e||void 0===e||!!["string","number","boolean"].some(function(e){return e===typeof!0})},e.prototype.objectContainsTemplate=function(e){if(!e)return!1;for(var t=0,a=Object.keys(e);t<a.length;t++){var r=a[t];if(this.isPrimitive(e[r])){if(this.templateSrv.variableExists(e[r]))return!0}else if(Array.isArray(e[r]))for(var n=0,i=e[r];n<i.length;n++){var s=i[n];if(this.objectContainsTemplate(s))return!0}else if(this.objectContainsTemplate(e[r]))return!0}return!1},e}();var qa=function(){function e(e,t,a,r){var n=e.target.bucketAggs;e.orderByOptions=[],e.getBucketAggTypes=function(){return ya},e.getOrderOptions=function(){return Sa},e.getSizeOptions=function(){return xa},r.onAppEvent("elastic-query-updated",function(){e.validateModel()},e),e.init=function(){e.agg=n[e.index],e.validateModel()},e.onChangeInternal=function(){e.onChange()},e.onTypeChanged=function(){switch(e.agg.settings={},e.showOptions=!1,e.agg.type){case"date_histogram":case"histogram":case"terms":delete e.agg.query,e.agg.field="select field";break;case"filters":delete e.agg.field,e.agg.query="*";break;case"geohash_grid":e.agg.settings.precision=3}e.validateModel(),e.onChange()},e.validateModel=function(){e.index=A.a.indexOf(n,e.agg),e.isFirst=0===e.index,e.bucketAggCount=n.length;var t="",a=e.agg.settings||{};switch(e.agg.type){case"terms":a.order=a.order||"desc",a.size=a.size||"10",a.min_doc_count=a.min_doc_count||1,a.orderBy=a.orderBy||"_term","0"!==a.size&&(t=function(e){return A.a.find(Sa,{value:e}).text}(a.order)+" "+a.size+", "),a.min_doc_count>0&&(t+="Min Doc Count: "+a.min_doc_count+", "),t+="Order by: "+function(e,t){var a=A.a.find(ba,{value:e});if(a)return a.text;var r=A.a.find(t.metrics,{id:e});return r?Da(r):"metric not found"}(a.orderBy,e.target),"0"===a.size&&(t+=" ("+a.order+")");break;case"filters":a.filters=a.filters||[{query:"*"}],(t=A.a.reduce(a.filters,function(e,t,a){return e+="Q"+(a+1)+"  = "+t.query+" "},"")).length>50&&(t=t.substr(0,50)+"..."),t="Filter Queries ("+a.filters.length+")";break;case"date_histogram":a.interval=a.interval||"auto",a.min_doc_count=a.min_doc_count||0,e.agg.field=e.target.timeField,t="Interval: "+a.interval,a.min_doc_count>0&&(t+=", Min Doc Count: "+a.min_doc_count),(void 0===a.trimEdges||a.trimEdges<0)&&(a.trimEdges=0),a.trimEdges&&a.trimEdges>0&&(t+=", Trim edges: "+a.trimEdges);break;case"histogram":a.interval=a.interval||1e3,a.min_doc_count=A.a.defaultTo(a.min_doc_count,1),t="Interval: "+a.interval,a.min_doc_count>0&&(t+=", Min Doc Count: "+a.min_doc_count);break;case"geohash_grid":a.precision=Math.max(Math.min(a.precision,7),1),t="Precision: "+a.precision}return e.settingsLinkText=t,e.agg.settings=a,!0},e.addFiltersQuery=function(){e.agg.settings.filters.push({query:"*"})},e.removeFiltersQuery=function(t){e.agg.settings.filters=A.a.without(e.agg.settings.filters,t)},e.toggleOptions=function(){e.showOptions=!e.showOptions},e.getOrderByOptions=function(){return function(e){var t=[];return A.a.each(e.metrics,function(e){"count"!==e.type&&t.push({text:Da(e),value:e.id})}),ba.concat(t)}(e.target)},e.getFieldsInternal=function(){return"date_histogram"===e.agg.type?e.getFields({$fieldType:"date"}):e.getFields()},e.getIntervalOptions=function(){return a.when(t.transformToSegments(!0,"interval")(Ta))},e.addBucketAgg=function(){var t=n[n.length-1],a=n.length-1;t&&"date_histogram"===t.type&&(a-=1);var r=A.a.reduce(e.target.bucketAggs.concat(e.target.metrics),function(e,t){return parseInt(t.id,10)>e?parseInt(t.id,10):e},0);n.splice(a,0,{type:"terms",field:"select field",id:(r+1).toString(),fake:!0}),e.onChange()},e.removeBucketAgg=function(){n.splice(e.index,1),e.onChange()},e.init()}return e.$inject=["$scope","uiSegmentSrv","$q","$rootScope"],e}(),Na=D.a.module("grafana.directives");Na.directive("elasticBucketAgg",function(){return{templateUrl:"public/app/plugins/datasource/elasticsearch/partials/bucket_agg.html",controller:"ElasticBucketAggCtrl",restrict:"E",scope:{target:"=",index:"=",onChange:"&",getFields:"&"}}}),Na.controller("ElasticBucketAggCtrl",qa);var Ra=function(){function e(e,t,a,r){var n=e.target.metrics;e.metricAggTypes=Ea(e.esVersion),e.extendedStats=wa,e.pipelineAggOptions=[],e.modelSettingsValues={},e.init=function(){e.agg=n[e.index],e.validateModel(),e.updatePipelineAggOptions()},e.updatePipelineAggOptions=function(){e.pipelineAggOptions=function(e){var t=[];return A.a.each(e.metrics,function(e){Ma(e.type)||t.push({text:Da(e),value:e.id})}),t}(e.target)},r.onAppEvent("elastic-query-updated",function(){e.index=A.a.indexOf(n,e.agg),e.updatePipelineAggOptions(),e.validateModel()},e),e.validateModel=function(){if(e.isFirst=0===e.index,e.isSingle=1===n.length,e.settingsLinkText="",e.aggDef=A.a.find(e.metricAggTypes,{value:e.agg.type}),Ma(e.agg.type)){e.agg.pipelineAgg=e.agg.pipelineAgg||"select metric",e.agg.field=e.agg.pipelineAgg;var t=function(e){return Ma(e.type)?ka[e.type]:[]}(e.agg);t.length>0&&(A.a.each(t,function(t){e.agg.settings[t.text]=e.agg.settings[t.text]||t.default}),e.settingsLinkText="Options")}else e.agg.field||(e.agg.field="select field");switch(e.agg.type){case"cardinality":var a=e.agg.settings.precision_threshold||"";e.settingsLinkText="Precision threshold: "+a;break;case"percentiles":e.agg.settings.percents=e.agg.settings.percents||[25,50,75,95,99],e.settingsLinkText="Values: "+e.agg.settings.percents.join(",");break;case"extended_stats":0===A.a.keys(e.agg.meta).length&&(e.agg.meta.std_deviation_bounds_lower=!0,e.agg.meta.std_deviation_bounds_upper=!0);var r=A.a.reduce(e.agg.meta,function(t,a,r){if(a){var n=A.a.find(e.extendedStats,{value:r});t.push(n.text)}return t},[]);e.settingsLinkText="Stats: "+r.join(", ");break;case"moving_avg":e.movingAvgModelTypes=Ca,e.modelSettings=Pa(e.agg.settings.model,!0),e.updateMovingAvgModelSettings();break;case"raw_document":e.agg.settings.size=e.agg.settings.size||500,e.settingsLinkText="Size: "+e.agg.settings.size,e.target.metrics.splice(0,e.target.metrics.length,e.agg),e.target.bucketAggs=[]}if(e.aggDef.supportsInlineScript){var i=e.agg.inlineScript;i?e.agg.settings.script={inline:i}:delete e.agg.settings.script,""===e.settingsLinkText&&(e.settingsLinkText="Options")}},e.toggleOptions=function(){e.showOptions=!e.showOptions,e.updatePipelineAggOptions()},e.onChangeInternal=function(){e.onChange()},e.updateMovingAvgModelSettings=function(){for(var t=[],a=Pa(e.agg.settings.model,!1),r=0;r<a.length;r++)t.push(a[r].value);for(var n in e.agg.settings.settings)null!==e.agg.settings.settings[n]&&-1!==t.indexOf(n)||delete e.agg.settings.settings[n]},e.onChangeClearInternal=function(){delete e.agg.settings.minimize,e.onChange()},e.onTypeChange=function(){e.agg.settings={},e.agg.meta={},e.showOptions=!1,e.updatePipelineAggOptions(),e.onChange()},e.getFieldsInternal=function(){return"cardinality"===e.agg.type?e.getFields():e.getFields({$fieldType:"number"})},e.addMetricAgg=function(){var t=n.length,a=A.a.reduce(e.target.bucketAggs.concat(e.target.metrics),function(e,t){return parseInt(t.id,10)>e?parseInt(t.id,10):e},0);n.splice(t,0,{type:"count",field:"select field",id:(a+1).toString()}),e.onChange()},e.removeMetricAgg=function(){n.splice(e.index,1),e.onChange()},e.toggleShowMetric=function(){e.agg.hide=!e.agg.hide,e.agg.hide||delete e.agg.hide,e.onChange()},e.init()}return e.$inject=["$scope","uiSegmentSrv","$q","$rootScope"],e}(),La=D.a.module("grafana.directives");La.directive("elasticMetricAgg",function(){return{templateUrl:"public/app/plugins/datasource/elasticsearch/partials/metric_agg.html",controller:"ElasticMetricAggCtrl",restrict:"E",scope:{target:"=",index:"=",onChange:"&",getFields:"&",esVersion:"="}}}),La.controller("ElasticMetricAggCtrl",Ra);var Va=function(e){function t(t,a,r,n){var i=e.call(this,t,a)||this;return i.$rootScope=r,i.uiSegmentSrv=n,i.esVersion=i.datasource.esVersion,i.queryUpdated(),i}return t.$inject=["$scope","$injector","$rootScope","uiSegmentSrv"],Ve.c(t,e),t.prototype.getFields=function(e){var t=D.a.toJson({find:"fields",type:e});return this.datasource.metricFindQuery(t).then(this.uiSegmentSrv.transformToSegments(!1)).catch(this.handleQueryError.bind(this))},t.prototype.queryUpdated=function(){var e=D.a.toJson(this.datasource.queryBuilder.build(this.target),!0);this.rawQueryOld&&e!==this.rawQueryOld&&this.refresh(),this.rawQueryOld=e,this.$rootScope.appEvent("elastic-query-updated")},t.prototype.getCollapsedText=function(){var e=this.target.metrics,t=this.target.bucketAggs,a=Ea(this.esVersion),r=ya,n="";return this.target.query&&(n+="Query: "+this.target.query+", "),n+="Metrics: ",A.a.each(e,function(e,t){var r=A.a.find(a,{value:e.type});n+=r.text+"(",r.requiresField&&(n+=e.field),n+="), "}),A.a.each(t,function(e,t){0===t&&(n+=" Group by: ");var a=A.a.find(r,{value:e.type});n+=a.text+"(",a.requiresField&&(n+=e.field),n+="), "}),this.target.alias&&(n+="Alias: "+this.target.alias),n},t.prototype.handleQueryError=function(e){return this.error=e.message||"Failed to issue metric query",[]},t.templateUrl="partials/query.editor.html",t}(Ye),Ua=function(){function e(e){this.indexPatternTypes=[{name:"No pattern",value:void 0},{name:"Hourly",value:"Hourly",example:"[logstash-]YYYY.MM.DD.HH"},{name:"Daily",value:"Daily",example:"[logstash-]YYYY.MM.DD"},{name:"Weekly",value:"Weekly",example:"[logstash-]GGGG.WW"},{name:"Monthly",value:"Monthly",example:"[logstash-]YYYY.MM"},{name:"Yearly",value:"Yearly",example:"[logstash-]YYYY"}],this.esVersions=[{name:"2.x",value:2},{name:"5.x",value:5},{name:"5.6+",value:56}],this.current.jsonData.timeField=this.current.jsonData.timeField||"@timestamp",this.current.jsonData.esVersion=this.current.jsonData.esVersion||5,this.current.jsonData.maxConcurrentShardRequests=this.current.jsonData.maxConcurrentShardRequests||256}return e.$inject=["$scope"],e.prototype.indexPatternTypeChanged=function(){var e=A.a.find(this.indexPatternTypes,{value:this.current.jsonData.interval});this.current.database=e.example||"es-index-name"},e.templateUrl="public/app/plugins/datasource/elasticsearch/partials/config.html",e}(),ja=function(){function e(){}return e.templateUrl="partials/annotations.editor.html",e}(),Ba=function(){function e(e,t,a,r){this.$q=t,this.backendSrv=a,this.templateSrv=r,this.type="opentsdb",this.url=e.url,this.name=e.name,this.withCredentials=e.withCredentials,this.basicAuth=e.basicAuth,e.jsonData=e.jsonData||{},this.tsdbVersion=e.jsonData.tsdbVersion||1,this.tsdbResolution=e.jsonData.tsdbResolution||1,this.tagKeys={},this.aggregatorsPromise=null,this.filterTypesPromise=null}return e.$inject=["instanceSettings","$q","backendSrv","templateSrv"],e.prototype.query=function(e){var t=this,a=this.convertToTSDBTime(e.rangeRaw.from,!1),r=this.convertToTSDBTime(e.rangeRaw.to,!0),n=[];A.a.each(e.targets,function(a){a.metric&&n.push(t.convertTargetToQuery(a,e,t.tsdbVersion))});var i=A.a.compact(n);if(A.a.isEmpty(i)){var s=this.$q.defer();return s.resolve({data:[]}),s.promise}var o={};return A.a.each(i,function(e){e.filters&&e.filters.length>0?A.a.each(e.filters,function(e){o[e.tagk]=!0}):A.a.each(e.tags,function(e,t){o[t]=!0})}),e.targets=A.a.filter(e.targets,function(e){return!0!==e.hide}),this.performTimeSeriesQuery(i,a,r).then(function(a){var r=t.mapMetricsToTargets(a.data,e,t.tsdbVersion);return{data:A.a.map(a.data,function(a,n){return-1===(n=r[n])&&(n=0),t._saveTagKeys(a),t.transformMetricData(a,o,e.targets[n],e,t.tsdbResolution)})}})},e.prototype.annotationQuery=function(e){var t=this.convertToTSDBTime(e.rangeRaw.from,!1),a=this.convertToTSDBTime(e.rangeRaw.to,!0),r=[],n=[];r.push({aggregator:"sum",metric:e.annotation.target});var i=A.a.compact(r);return this.performTimeSeriesQuery(i,t,a).then(function(t){if(t.data[0]){var a=t.data[0].annotations;e.annotation.isGlobal&&(a=t.data[0].globalAnnotations),a&&A.a.each(a,function(t){var a={text:t.description,time:1e3*Math.floor(t.startTime),annotation:e.annotation};n.push(a)})}return n})},e.prototype.targetContainsTemplate=function(e){if(e.filters&&e.filters.length>0)for(var t=0;t<e.filters.length;t++)if(this.templateSrv.variableExists(e.filters[t].filter))return!0;if(e.tags&&Object.keys(e.tags).length>0)for(var a in e.tags)if(this.templateSrv.variableExists(e.tags[a]))return!0;return!1},e.prototype.performTimeSeriesQuery=function(e,t,a){var r=!1;2===this.tsdbResolution&&(r=!0);var n={start:t,queries:e,msResolution:r,globalAnnotations:!0};3===this.tsdbVersion&&(n.showQuery=!0),a&&(n.end=a);var i={method:"POST",url:this.url+"/api/query",data:n};return this._addCredentialOptions(i),this.backendSrv.datasourceRequest(i)},e.prototype.suggestTagKeys=function(e){return this.$q.when(this.tagKeys[e]||[])},e.prototype._saveTagKeys=function(e){var t=Object.keys(e.tags);A.a.each(e.aggregateTags,function(e){t.push(e)}),this.tagKeys[e.metric]=t},e.prototype._performSuggestQuery=function(e,t){return this._get("/api/suggest",{type:t,q:e,max:1e3}).then(function(e){return e.data})},e.prototype._performMetricKeyValueLookup=function(e,t){if(!e||!t)return this.$q.when([]);var a=t.split(",").map(function(e){return e.trim()}),r=a[0],n=r+"=*";a.length>1&&(n+=","+a.splice(1).join(","));var i=e+"{"+n+"}";return this._get("/api/search/lookup",{m:i,limit:3e3}).then(function(e){e=e.data.results;var t=[];return A.a.each(e,function(e){-1===t.indexOf(e.tags[r])&&t.push(e.tags[r])}),t})},e.prototype._performMetricKeyLookup=function(e){return e?this._get("/api/search/lookup",{m:e,limit:1e3}).then(function(e){e=e.data.results;var t=[];return A.a.each(e,function(e){A.a.each(e.tags,function(e,a){-1===t.indexOf(a)&&t.push(a)})}),t}):this.$q.when([])},e.prototype._get=function(e,t){var a={method:"GET",url:this.url+e,params:t};return this._addCredentialOptions(a),this.backendSrv.datasourceRequest(a)},e.prototype._addCredentialOptions=function(e){(this.basicAuth||this.withCredentials)&&(e.withCredentials=!0),this.basicAuth&&(e.headers={Authorization:this.basicAuth})},e.prototype.metricFindQuery=function(e){if(!e)return this.$q.when([]);var t;try{t=this.templateSrv.replace(e,{},"distributed")}catch(e){return this.$q.reject(e)}var a=function(e){return A.a.map(e,function(e){return{text:e}})},r=t.match(/metrics\((.*)\)/);if(r)return this._performSuggestQuery(r[1],"metrics").then(a);var n=t.match(/tag_names\((.*)\)/);if(n)return this._performMetricKeyLookup(n[1]).then(a);var i=t.match(/tag_values\((.*?),\s?(.*)\)/);if(i)return this._performMetricKeyValueLookup(i[1],i[2]).then(a);var s=t.match(/suggest_tagk\((.*)\)/);if(s)return this._performSuggestQuery(s[1],"tagk").then(a);var o=t.match(/suggest_tagv\((.*)\)/);return o?this._performSuggestQuery(o[1],"tagv").then(a):this.$q.when([])},e.prototype.testDatasource=function(){return this._performSuggestQuery("cpu","metrics").then(function(){return{status:"success",message:"Data source is working"}})},e.prototype.getAggregators=function(){return this.aggregatorsPromise?this.aggregatorsPromise:(this.aggregatorsPromise=this._get("/api/aggregators").then(function(e){return e.data&&A.a.isArray(e.data)?e.data.sort():[]}),this.aggregatorsPromise)},e.prototype.getFilterTypes=function(){return this.filterTypesPromise?this.filterTypesPromise:(this.filterTypesPromise=this._get("/api/config/filters").then(function(e){return e.data?Object.keys(e.data).sort():[]}),this.filterTypesPromise)},e.prototype.transformMetricData=function(e,t,a,r,n){var i=this.createMetricLabel(e,a,t,r),s=[];return A.a.each(e.dps,function(e,t){2===n?s.push([e,1*t]):s.push([e,1e3*t])}),{target:i,datapoints:s}},e.prototype.createMetricLabel=function(e,t,a,r){if(t.alias){var n=A.a.clone(r.scopedVars||{});return A.a.each(e.tags,function(e,t){n["tag_"+t]={value:e}}),this.templateSrv.replace(t.alias,n)}var i=e.metric,s=[];return A.a.isEmpty(e.tags)||A.a.each(A.a.toPairs(e.tags),function(e){A.a.has(a,e[0])&&s.push(e[0]+"="+e[1])}),A.a.isEmpty(s)||(i+="{"+s.join(", ")+"}"),i},e.prototype.convertTargetToQuery=function(e,t,a){if(!e.metric||e.hide)return null;var r={metric:this.templateSrv.replace(e.metric,t.scopedVars,"pipe"),aggregator:"avg"};if(e.aggregator&&(r.aggregator=this.templateSrv.replace(e.aggregator)),e.shouldComputeRate&&(r.rate=!0,r.rateOptions={counter:!!e.isCounter},e.counterMax&&e.counterMax.length&&(r.rateOptions.counterMax=parseInt(e.counterMax,10)),e.counterResetValue&&e.counterResetValue.length&&(r.rateOptions.resetValue=parseInt(e.counterResetValue,10)),a>=2&&(r.rateOptions.dropResets=!(r.rateOptions.counterMax||r.rateOptions.ResetValue&&0!==r.rateOptions.ResetValue))),!e.disableDownsampling){var n=this.templateSrv.replace(e.downsampleInterval||t.interval);n.match(/\.[0-9]+s/)&&(n=1e3*parseFloat(n)+"ms"),r.downsample=n+"-"+e.downsampleAggregator,e.downsampleFillPolicy&&"none"!==e.downsampleFillPolicy&&(r.downsample+="-"+e.downsampleFillPolicy)}if(e.filters&&e.filters.length>0){if(r.filters=D.a.copy(e.filters),r.filters)for(var i in r.filters)r.filters[i].filter=this.templateSrv.replace(r.filters[i].filter,t.scopedVars,"pipe")}else if(r.tags=D.a.copy(e.tags),r.tags)for(var s in r.tags)r.tags[s]=this.templateSrv.replace(r.tags[s],t.scopedVars,"pipe");return e.explicitTags&&(r.explicitTags=!0),r},e.prototype.mapMetricsToTargets=function(e,t,a){var r,n,i=this;return A.a.map(e,function(e){return 3===a?e.query.index:A.a.findIndex(t.targets,function(a){return a.filters&&a.filters.length>0?a.metric===e.metric:a.metric===e.metric&&A.a.every(a.tags,function(a,s){return r=i.templateSrv.replace(a,t.scopedVars,"pipe"),n=r.split("|"),A.a.includes(n,e.tags[s])||"*"===r})})})},e.prototype.convertToTSDBTime=function(e,t){return"now"===e?null:(e=je.parse(e,t)).valueOf()},e}(),Qa=function(e){function t(t,a){var r=e.call(this,t,a)||this;return r.errors=r.validateTarget(),r.aggregators=["avg","sum","min","max","dev","zimsum","mimmin","mimmax"],r.fillPolicies=["none","nan","null","zero"],r.filterTypes=["wildcard","iliteral_or","not_iliteral_or","not_literal_or","iwildcard","literal_or","regexp"],r.tsdbVersion=r.datasource.tsdbVersion,r.target.aggregator||(r.target.aggregator="sum"),r.target.downsampleAggregator||(r.target.downsampleAggregator="avg"),r.target.downsampleFillPolicy||(r.target.downsampleFillPolicy="none"),r.datasource.getAggregators().then(function(e){0!==e.length&&(r.aggregators=e)}),r.datasource.getFilterTypes().then(function(e){0!==e.length&&(r.filterTypes=e)}),r.suggestMetrics=function(e,t){r.datasource.metricFindQuery("metrics("+e+")").then(r.getTextValues).then(t)},r.suggestTagKeys=function(e,t){r.datasource.suggestTagKeys(r.target.metric).then(t)},r.suggestTagValues=function(e,t){r.datasource.metricFindQuery("suggest_tagv("+e+")").then(r.getTextValues).then(t)},r}return t.$inject=["$scope","$injector"],Ve.c(t,e),t.prototype.targetBlur=function(){this.errors=this.validateTarget(),this.refresh()},t.prototype.getTextValues=function(e){return A.a.map(e,function(e){return e.text})},t.prototype.addTag=function(){this.target.filters&&this.target.filters.length>0&&(this.errors.tags="Please remove filters to use tags, tags and filters are mutually exclusive."),this.addTagMode?(this.target.tags||(this.target.tags={}),this.errors=this.validateTarget(),this.errors.tags||(this.target.tags[this.target.currentTagKey]=this.target.currentTagValue,this.target.currentTagKey="",this.target.currentTagValue="",this.targetBlur()),this.addTagMode=!1):this.addTagMode=!0},t.prototype.removeTag=function(e){delete this.target.tags[e],this.targetBlur()},t.prototype.editTag=function(e,t){this.removeTag(e),this.target.currentTagKey=e,this.target.currentTagValue=t,this.addTag()},t.prototype.closeAddTagMode=function(){this.addTagMode=!1},t.prototype.addFilter=function(){if(this.target.tags&&A.a.size(this.target.tags)>0&&(this.errors.filters="Please remove tags to use filters, tags and filters are mutually exclusive."),this.addFilterMode){if(this.target.filters||(this.target.filters=[]),this.target.currentFilterType||(this.target.currentFilterType="iliteral_or"),this.target.currentFilterGroupBy||(this.target.currentFilterGroupBy=!1),this.errors=this.validateTarget(),!this.errors.filters){var e={type:this.target.currentFilterType,tagk:this.target.currentFilterKey,filter:this.target.currentFilterValue,groupBy:this.target.currentFilterGroupBy};this.target.filters.push(e),this.target.currentFilterType="literal_or",this.target.currentFilterKey="",this.target.currentFilterValue="",this.target.currentFilterGroupBy=!1,this.targetBlur()}this.addFilterMode=!1}else this.addFilterMode=!0},t.prototype.removeFilter=function(e){this.target.filters.splice(e,1),this.targetBlur()},t.prototype.editFilter=function(e,t){this.removeFilter(t),this.target.currentFilterKey=e.tagk,this.target.currentFilterValue=e.filter,this.target.currentFilterType=e.type,this.target.currentFilterGroupBy=e.groupBy,this.addFilter()},t.prototype.closeAddFilterMode=function(){this.addFilterMode=!1},t.prototype.validateTarget=function(){var e={};if(this.target.shouldDownsample)try{this.target.downsampleInterval?ie.a.describe_interval(this.target.downsampleInterval):e.downsampleInterval="You must supply a downsample interval (e.g. '1m' or '1h')."}catch(t){e.downsampleInterval=t.message}return this.target.tags&&A.a.has(this.target.tags,this.target.currentTagKey)&&(e.tags="Duplicate tag key '"+this.target.currentTagKey+"'."),e},t.templateUrl="partials/query.editor.html",t}(Ye),Ha=function(){function e(e){this.tsdbVersions=[{name:"<=2.1",value:1},{name:"==2.2",value:2},{name:"==2.3",value:3}],this.tsdbResolutions=[{name:"second",value:1},{name:"millisecond",value:2}],this.current.jsonData=this.current.jsonData||{},this.current.jsonData.tsdbVersion=this.current.jsonData.tsdbVersion||1,this.current.jsonData.tsdbResolution=this.current.jsonData.tsdbResolution||1}return e.$inject=["$scope"],e.templateUrl="public/app/plugins/datasource/opentsdb/partials/config.html",e}(),za=function(){function e(){}return e.templateUrl="partials/annotations.editor.html",e}(),Ya=function(){function e(e,t,a){this.backendSrv=e,this.$q=t,this.templateSrv=a}return e.$inject=["backendSrv","$q","templateSrv"],e.prototype.query=function(e){return this.backendSrv.get("/api/tsdb/testdata/random-walk",{from:e.range.from.valueOf(),to:e.range.to.valueOf(),intervalMs:e.intervalMs,maxDataPoints:e.maxDataPoints}).then(function(e){var t=[];return e.results&&A.a.forEach(e.results,function(e){for(var a=0,r=e.series;a<r.length;a++){var n=r[a];t.push({target:n.name,datapoints:n.points})}}),{data:t}})},e.prototype.metricFindQuery=function(e){return this.$q.when({data:[]})},e.prototype.annotationQuery=function(e){var t={from:e.range.from.valueOf(),to:e.range.to.valueOf(),limit:e.annotation.limit,tags:e.annotation.tags,matchAny:e.annotation.matchAny};if("dashboard"===e.annotation.type){if(!e.dashboard.id)return this.$q.when([]);t.dashboardId=e.dashboard.id,delete t.tags}else{if(!A.a.isArray(e.annotation.tags)||0===e.annotation.tags.length)return this.$q.when([]);for(var a=[],r=0,n=t.tags;r<n.length;r++)for(var i=n[r],s=0,o=this.templateSrv.replace(i,{},"pipe").split("|");s<o.length;s++){var l=o[s];a.push(l)}t.tags=a}return this.backendSrv.get("/api/annotations",t)},e}(),Ga=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return Ve.c(t,e),t.templateUrl="partials/query.editor.html",t}(Ye),Wa=function(){function e(){this.types=[{text:"Dashboard",value:"dashboard"},{text:"Tags",value:"tags"}],this.annotation.type=this.annotation.type||"tags",this.annotation.limit=this.annotation.limit||100}return e.templateUrl="partials/annotations.editor.html",e}(),Ka=function(){function e(e){this.series=e.series,this.alias=e.alias,this.annotation=e.annotation}return e.prototype.getTimeSeries=function(){var e,t,a=this,r=[];return 0===this.series.length?r:(A.a.each(this.series,function(n){var i=n.columns.length,s=A.a.map(n.tags,function(e,t){return t+": "+e});for(t=1;t<i;t++){var o=n.name,l=n.columns[t];"value"!==l&&(o=o+"."+l),a.alias?o=a._getSeriesName(n,t):n.tags&&(o=o+" {"+s.join(", ")+"}");var u=[];if(n.values)for(e=0;e<n.values.length;e++)u[e]=[n.values[e][t],n.values[e][0]];r.push({target:o,datapoints:u})}}),r)},e.prototype._getSeriesName=function(e,t){var a=e.name.split(".");return this.alias.replace(/\$(\w+)|\[\[([\s\S]+?)\]\]/g,function(r,n,i){var s=n||i,o=parseInt(s,10);if("m"===s||"measurement"===s)return e.name;if("col"===s)return e.columns[t];if(!isNaN(o))return a[o];if(0!==s.indexOf("tag_"))return r;var l=s.replace("tag_","");return e.tags?e.tags[l]:r})},e.prototype.getAnnotations=function(){var e=this,t=[];return A.a.each(this.series,function(a){var r=null,n=null,i=[],s=null;A.a.each(a.columns,function(t,a){"time"!==t?"sequence_number"!==t&&(t!==e.annotation.titleColumn?A.a.includes((e.annotation.tagsColumn||"").replace(" ","").split(","),t)?i.push(a):t!==e.annotation.textColumn?r||s===a||(r=a):s=a:r=a):n=a}),A.a.each(a.values,function(a){var o={annotation:e.annotation,time:+new Date(a[n]),title:a[r],tags:A.a.flatten(i.filter(function(e){return a[e]}).map(function(e){return a[e].split(",")})),text:a[s]};t.push(o)})}),t},e.prototype.getTable=function(){var e,t,a=new lt.a;return 0===this.series.length?a:(A.a.each(this.series,function(r,n){if(0===n)for(t=0,"time"===r.columns[0]&&(a.columns.push({text:"Time",type:"time"}),t++),A.a.each(A.a.keys(r.tags),function(e){a.columns.push({text:e})});t<r.columns.length;t++)a.columns.push({text:r.columns[t]});if(r.values)for(e=0;e<r.values.length;e++){var i=r.values[e],s=[i[0]];if(r.tags)for(var o in r.tags)r.tags.hasOwnProperty(o)&&s.push(r.tags[o]);for(t=1;t<i.length;t++)s.push(i[t]);a.rows.push(s)}}),a)},e}(),Ja=[],Xa={Aggregations:[],Selectors:[],Transformations:[],Predictors:[],Math:[],Aliasing:[],Fields:[]};function Za(e){var t=Ja[e.type];if(!t)throw{message:"Could not find query part "+e.type};return new We.a(e,t)}function er(e){Ja[e.type]=new We.b(e),e.category.push(Ja[e.type])}var tr=[];function ar(e,t){return"*"===e.params[0]?"*":'"'+e.params[0]+'"'}function rr(e,t){for(var a=0;a<e.length;a++){var r=e[a];if(r.def.category===Xa.Aggregations){if(r.def.type===t.def.type)return;if("count"===r.def.type&&"distinct"===t.def.type)break;if("distinct"===r.def.type){var n=e.length>=a+2;if("count"!==t.def.type&&n)e[a+1].def.category===Xa.Aggregations&&e.splice(a+1,1);else if("count"===t.def.type)return void(n&&"count"===e[a+1].def.type||e.splice(a+1,0,t))}return void(e[a]=t)}if(r.def.category===Xa.Selectors)return void(e[a]=t)}e.splice(1,0,t)}function nr(e,t){var a;for(a=0;a<e.length;a++){var r=e[a];if(r.def.category===Xa.Math||r.def.category===Xa.Aliasing)break}e.splice(a,0,t)}er({type:"field",addStrategy:function(e,t,a){var r=A.a.map(e,function(e){return Za({type:e.def.type,params:A.a.clone(e.params)})});a.selectModels.push(r)},category:Xa.Fields,params:[{type:"field",dynamicLookup:!0}],defaultParams:["value"],renderer:ar}),er({type:"count",addStrategy:rr,category:Xa.Aggregations,params:[],defaultParams:[],renderer:We.c}),er({type:"distinct",addStrategy:rr,category:Xa.Aggregations,params:[],defaultParams:[],renderer:We.c}),er({type:"integral",addStrategy:rr,category:Xa.Aggregations,params:[],defaultParams:[],renderer:We.c}),er({type:"mean",addStrategy:rr,category:Xa.Aggregations,params:[],defaultParams:[],renderer:We.c}),er({type:"median",addStrategy:rr,category:Xa.Aggregations,params:[],defaultParams:[],renderer:We.c}),er({type:"mode",addStrategy:rr,category:Xa.Aggregations,params:[],defaultParams:[],renderer:We.c}),er({type:"sum",addStrategy:rr,category:Xa.Aggregations,params:[],defaultParams:[],renderer:We.c}),er({type:"derivative",addStrategy:nr,category:Xa.Transformations,params:[{name:"duration",type:"interval",options:["1s","10s","1m","5m","10m","15m","1h"]}],defaultParams:["10s"],renderer:We.c}),er({type:"spread",addStrategy:nr,category:Xa.Transformations,params:[],defaultParams:[],renderer:We.c}),er({type:"non_negative_derivative",addStrategy:nr,category:Xa.Transformations,params:[{name:"duration",type:"interval",options:["1s","10s","1m","5m","10m","15m","1h"]}],defaultParams:["10s"],renderer:We.c}),er({type:"difference",addStrategy:nr,category:Xa.Transformations,params:[],defaultParams:[],renderer:We.c}),er({type:"non_negative_difference",addStrategy:nr,category:Xa.Transformations,params:[],defaultParams:[],renderer:We.c}),er({type:"moving_average",addStrategy:nr,category:Xa.Transformations,params:[{name:"window",type:"int",options:[5,10,20,30,40]}],defaultParams:[10],renderer:We.c}),er({type:"cumulative_sum",addStrategy:nr,category:Xa.Transformations,params:[],defaultParams:[],renderer:We.c}),er({type:"stddev",addStrategy:nr,category:Xa.Transformations,params:[],defaultParams:[],renderer:We.c}),er({type:"time",category:tr,params:[{name:"interval",type:"time",options:["$__interval","1s","10s","1m","5m","10m","15m","1h"]}],defaultParams:["$__interval"],renderer:We.c}),er({type:"fill",category:tr,params:[{name:"fill",type:"string",options:["none","null","0","previous","linear"]}],defaultParams:["null"],renderer:We.c}),er({type:"elapsed",addStrategy:nr,category:Xa.Transformations,params:[{name:"duration",type:"interval",options:["1s","10s","1m","5m","10m","15m","1h"]}],defaultParams:["10s"],renderer:We.c}),er({type:"holt_winters",addStrategy:nr,category:Xa.Predictors,params:[{name:"number",type:"int",options:[5,10,20,30,40]},{name:"season",type:"int",options:[0,1,2,5,10]}],defaultParams:[10,2],renderer:We.c}),er({type:"holt_winters_with_fit",addStrategy:nr,category:Xa.Predictors,params:[{name:"number",type:"int",options:[5,10,20,30,40]},{name:"season",type:"int",options:[0,1,2,5,10]}],defaultParams:[10,2],renderer:We.c}),er({type:"bottom",addStrategy:rr,category:Xa.Selectors,params:[{name:"count",type:"int"}],defaultParams:[3],renderer:We.c}),er({type:"first",addStrategy:rr,category:Xa.Selectors,params:[],defaultParams:[],renderer:We.c}),er({type:"last",addStrategy:rr,category:Xa.Selectors,params:[],defaultParams:[],renderer:We.c}),er({type:"max",addStrategy:rr,category:Xa.Selectors,params:[],defaultParams:[],renderer:We.c}),er({type:"min",addStrategy:rr,category:Xa.Selectors,params:[],defaultParams:[],renderer:We.c}),er({type:"percentile",addStrategy:rr,category:Xa.Selectors,params:[{name:"nth",type:"int"}],defaultParams:[95],renderer:We.c}),er({type:"top",addStrategy:rr,category:Xa.Selectors,params:[{name:"count",type:"int"}],defaultParams:[3],renderer:We.c}),er({type:"tag",category:tr,params:[{name:"tag",type:"string",dynamicLookup:!0}],defaultParams:["tag"],renderer:ar}),er({type:"math",addStrategy:function(e,t){var a=e.length;if(a>0){if("math"===e[a-1].def.type)return void(e[a-1]=t);if(a>1&&"math"===e[a-2].def.type)return void(e[a-2]=t);if("alias"===e[a-1].def.type)return void e.splice(a-1,0,t)}e.push(t)},category:Xa.Math,params:[{name:"expr",type:"string"}],defaultParams:[" / 100"],renderer:We.d}),er({type:"alias",addStrategy:function(e,t){var a=e.length;a>0&&"alias"===e[a-1].def.type?e[a-1]=t:e.push(t)},category:Xa.Aliasing,params:[{name:"name",type:"string",quote:"double"}],defaultParams:["alias"],renderMode:"suffix",renderer:function(e,t){return t+' AS "'+e.params[0]+'"'}});var ir={create:Za,getCategories:function(){return Xa},replaceAggregationAdd:rr},sr=function(){function e(e,t,a){this.target=e,this.templateSrv=t,this.scopedVars=a,e.policy=e.policy||"default",e.resultFormat=e.resultFormat||"time_series",e.orderByTime=e.orderByTime||"ASC",e.tags=e.tags||[],e.groupBy=e.groupBy||[{type:"time",params:["$__interval"]},{type:"fill",params:["null"]}],e.select=e.select||[[{type:"field",params:["value"]},{type:"mean",params:[]}]],this.updateProjection()}return e.$inject=["target","templateSrv","scopedVars"],e.prototype.updateProjection=function(){this.selectModels=A.a.map(this.target.select,function(e){return A.a.map(e,ir.create)}),this.groupByParts=A.a.map(this.target.groupBy,ir.create)},e.prototype.updatePersistedParts=function(){this.target.select=A.a.map(this.selectModels,function(e){return A.a.map(e,function(e){return{type:e.def.type,params:e.params}})})},e.prototype.hasGroupByTime=function(){return A.a.find(this.target.groupBy,function(e){return"time"===e.type})},e.prototype.hasFill=function(){return A.a.find(this.target.groupBy,function(e){return"fill"===e.type})},e.prototype.addGroupBy=function(e){var t=e.match(/^(\w+)\((.*)\)$/),a=t[1],r=t[2],n=ir.create({type:a,params:[r]}),i=this.target.groupBy.length;0===i?this.target.groupBy.push(n.part):"time"===a?this.target.groupBy.splice(0,0,n.part):"tag"===a&&"fill"===this.target.groupBy[i-1].type?this.target.groupBy.splice(i-1,0,n.part):this.target.groupBy.push(n.part),this.updateProjection()},e.prototype.removeGroupByPart=function(e,t){var a=ir.getCategories();"time"===e.def.type&&(this.target.groupBy=A.a.filter(this.target.groupBy,function(e){return"fill"!==e.type}),this.target.select=A.a.map(this.target.select,function(e){return A.a.filter(e,function(e){var t=ir.create(e);return t.def.category!==a.Aggregations&&t.def.category!==a.Selectors})})),this.target.groupBy.splice(t,1),this.updateProjection()},e.prototype.removeSelect=function(e){this.target.select.splice(e,1),this.updateProjection()},e.prototype.removeSelectPart=function(e,t){if("field"===t.def.type){if(this.selectModels.length>1){var a=A.a.indexOf(this.selectModels,e);this.selectModels.splice(a,1)}}else{var r=A.a.indexOf(e,t);e.splice(r,1)}this.updatePersistedParts()},e.prototype.addSelectPart=function(e,t){var a=ir.create({type:t});a.def.addStrategy(e,a,this),this.updatePersistedParts()},e.prototype.renderTagCondition=function(e,t,a){var r="",n=e.operator,i=e.value;return t>0&&(r=(e.condition||"AND")+" "),n||(n=/^\/.*\/$/.test(i)?"=~":"="),"=~"!==n&&"!~"!==n?(a&&(i=this.templateSrv.replace(i,this.scopedVars)),">"!==n&&"<"!==n&&(i="'"+i.replace(/\\/g,"\\\\")+"'")):a&&(i=this.templateSrv.replace(i,this.scopedVars,"regex")),r+'"'+e.key+'" '+n+" "+i},e.prototype.getMeasurementAndPolicy=function(e){var t=this.target.policy,a=this.target.measurement||"measurement";return a.match("^/.*/$")?e&&(a=this.templateSrv.replace(a,this.scopedVars,"regex")):a='"'+a+'"',(t="default"!==t?'"'+this.target.policy+'".':"")+a},e.prototype.interpolateQueryStr=function(e,t,a){return t.multi||t.includeAll?"string"==typeof e?ie.a.regexEscape(e):"("+A.a.map(e,ie.a.regexEscape).join("|")+")":e},e.prototype.render=function(e){var t=this,a=this.target;if(a.rawQuery)return e?this.templateSrv.replace(a.query,this.scopedVars,this.interpolateQueryStr):a.query;var r,n,i="SELECT ";for(r=0;r<this.selectModels.length;r++){var s=this.selectModels[r],o="";for(n=0;n<s.length;n++){o=(c=s[n]).render(o)}r>0&&(i+=", "),i+=o}i+=" FROM "+this.getMeasurementAndPolicy(e)+" WHERE ";var l=A.a.map(a.tags,function(a,r){return t.renderTagCondition(a,r,e)});l.length>0&&(i+="("+l.join(" ")+") AND "),i+="$timeFilter";var u="";for(r=0;r<this.groupByParts.length;r++){var c=this.groupByParts[r];r>0&&(u+="fill"===c.def.type?" ":", "),u+=c.render("")}return u.length&&(i+=" GROUP BY "+u),a.fill&&(i+=" fill("+a.fill+")"),"DESC"===a.orderByTime&&(i+=" ORDER BY time DESC"),a.limit&&(i+=" LIMIT "+a.limit),a.slimit&&(i+=" SLIMIT "+a.slimit),i},e.prototype.renderAdhocFilters=function(e){var t=this;return A.a.map(e,function(e,a){return t.renderTagCondition(e,a,!1)}).join(" ")},e}(),or=function(){function e(){}return e.prototype.parse=function(e,t){if(!t||0===t.results.length)return[];var a=t.results[0];if(!a.series)return[];var r=e.toLowerCase(),n=r.indexOf("show field keys")>=0||r.indexOf("show retention policies")>=0,i={};return A.a.each(a.series,function(e){A.a.each(e.values,function(e){A.a.isArray(e)?n?lr(i,e[0]):void 0!==e[1]?lr(i,e[1]):lr(i,e[0]):lr(i,e)})}),A.a.map(i,function(e){return{text:e.toString()}})},e}();function lr(e,t){e[t]=t}var ur,cr=function(){function e(e,t){this.target=e,this.database=t}return e.prototype.buildExploreQuery=function(e,t,a){var r,n,i;if("TAG_KEYS"===e)r="SHOW TAG KEYS",n=this.target.measurement,i=this.target.policy;else if("TAG_VALUES"===e)r="SHOW TAG VALUES",n=this.target.measurement,i=this.target.policy;else if("MEASUREMENTS"===e)r="SHOW MEASUREMENTS",a&&(r+=" WITH MEASUREMENT =~ /"+a+"/");else{if("FIELDS"===e)return n=this.target.measurement,i=this.target.policy,n.match("^/.*/")||(n='"'+n+'"',i&&"default"!==i&&(n=(i='"'+i+'"')+"."+n)),"SHOW FIELD KEYS FROM "+n;if("RETENTION POLICIES"===e)return r='SHOW RETENTION POLICIES on "'+this.database+'"'}if(n&&(n.match("^/.*/")||n.match(/^merge\(.*\)/)||(n='"'+n+'"'),i&&"default"!==i&&(n=(i='"'+i+'"')+"."+n),r+=" FROM "+n),t&&(r+=' WITH KEY = "'+t+'"'),this.target.tags&&this.target.tags.length>0){var s=A.a.reduce(this.target.tags,function(e,a){return a.key===t?e:(e.push(function(e,t){var a="",r=e.operator,n=e.value;return t>0&&(a=(e.condition||"AND")+" "),r||(r=/^\/.*\/$/.test(e.value)?"=~":"="),"=~"!==r&&"!~"!==r&&isNaN(+n)&&(n="'"+n+"'"),a+'"'+e.key+'" '+r+" "+n}(a,e.length)),e)},[]);s.length>0&&(r+=" WHERE "+s.join(" "))}return"MEASUREMENTS"===e&&(r+=" LIMIT 100"),r},e}(),hr=function(){function e(e,t,a,r){this.$q=t,this.backendSrv=a,this.templateSrv=r,this.type="influxdb",this.urls=A.a.map(e.url.split(","),function(e){return e.trim()}),this.username=e.username,this.password=e.password,this.name=e.name,this.database=e.database,this.basicAuth=e.basicAuth,this.withCredentials=e.withCredentials,this.interval=(e.jsonData||{}).timeInterval,this.responseParser=new or}return e.$inject=["instanceSettings","$q","backendSrv","templateSrv"],e.prototype.query=function(e){var t,a,r,n=this,i=this.getTimeFilter(e),s=e.scopedVars,o=A.a.cloneDeep(e.targets),l=[],u=A.a.map(o,function(e){return e.hide?"":(l.push(e),s.interval=s.__interval,(t=new sr(e,n.templateSrv,s)).render(!0))}).reduce(function(e,t){return""!==t&&(e+=";"+t),e});if(""===u)return this.$q.when({data:[]});var c=this.templateSrv.getAdhocFilters(this.name);return c.length>0&&(i+=" AND "+t.renderAdhocFilters(c)),s.timeFilter={value:i},u=this.templateSrv.replace(u,s),this._seriesQuery(u,e).then(function(t){if(!t||!t.results)return[];var i=[];for(a=0;a<t.results.length;a++){var s=t.results[a];if(s&&s.series){var o=l[a],u=o.alias;u&&(u=n.templateSrv.replace(o.alias,e.scopedVars));var c=new Ka({series:t.results[a].series,alias:u});switch(o.resultFormat){case"table":i.push(c.getTable());break;default:var h=c.getTimeSeries();for(r=0;r<h.length;r++)i.push(h[r])}}}return{data:i}})},e.prototype.annotationQuery=function(e){if(!e.annotation.query)return this.$q.reject({message:"Query missing in annotation definition"});var t=this.getTimeFilter({rangeRaw:e.rangeRaw}),a=e.annotation.query.replace("$timeFilter",t);return a=this.templateSrv.replace(a,null,"regex"),this._seriesQuery(a,e).then(function(t){if(!t||!t.results||!t.results[0])throw{message:"No results in response from InfluxDB"};return new Ka({series:t.results[0].series,annotation:e.annotation}).getAnnotations()})},e.prototype.targetContainsTemplate=function(e){for(var t=0,a=e.groupBy;t<a.length;t++)for(var r=0,n=a[t].params;r<n.length;r++){var i=n[r];if(this.templateSrv.variableExists(i))return!0}for(var s in e.tags)if(this.templateSrv.variableExists(e.tags[s].value))return!0;return!1},e.prototype.metricFindQuery=function(e,t){var a=this.templateSrv.replace(e,null,"regex");return this._seriesQuery(a,t).then(A.a.curry(this.responseParser.parse)(e))},e.prototype.getTagKeys=function(e){var t=new cr({measurement:"",tags:[]},this.database).buildExploreQuery("TAG_KEYS");return this.metricFindQuery(t,e)},e.prototype.getTagValues=function(e){var t=new cr({measurement:"",tags:[]},this.database).buildExploreQuery("TAG_VALUES",e.key);return this.metricFindQuery(t,e)},e.prototype._seriesQuery=function(e,t){if(!e)return this.$q.when({results:[]});if(t&&t.range){var a=this.getTimeFilter({rangeRaw:t.range});e=e.replace("$timeFilter",a)}return this._influxRequest("GET","/query",{q:e,epoch:"ms"},t)},e.prototype.serializeParams=function(e){return e?A.a.reduce(e,function(e,t,a){return null===t||void 0===t?e:(e.push(encodeURIComponent(a)+"="+encodeURIComponent(t)),e)},[]).join("&"):""},e.prototype.testDatasource=function(){var e=new cr({measurement:"",tags:[]},this.database).buildExploreQuery("RETENTION POLICIES");return this._seriesQuery(e).then(function(e){var t=A.a.get(e,"results[0].error");return t?{status:"error",message:t}:{status:"success",message:"Data source is working"}}).catch(function(e){return{status:"error",message:e.message}})},e.prototype._influxRequest=function(e,t,a,r){var n=this.urls.shift();this.urls.push(n);var i={};this.username&&(i.u=this.username,i.p=this.password),r&&r.database?i.db=r.database:this.database&&(i.db=this.database),"GET"===e&&(A.a.extend(i,a),a=null);var s={method:e,url:n+t,params:i,data:a,precision:"ms",inspect:{type:"influxdb"},paramSerializer:this.serializeParams};return s.headers=s.headers||{},(this.basicAuth||this.withCredentials)&&(s.withCredentials=!0),this.basicAuth&&(s.headers.Authorization=this.basicAuth),this.backendSrv.datasourceRequest(s).then(function(e){return e.data},function(e){if(0!==e.status||e.status>=300)throw e.data&&e.data.error?{message:"InfluxDB Error: "+e.data.error,data:e.data,config:e.config}:{message:"Network Error: "+e.statusText+"("+e.status+")",data:e.data,config:e.config}})},e.prototype.getTimeFilter=function(e){var t=this.getInfluxTime(e.rangeRaw.from,!1),a=this.getInfluxTime(e.rangeRaw.to,!0),r="ms"===t[t.length-1];return"now()"!==a||r?"time >= "+t+" and time <= "+a:"time >= "+t},e.prototype.getInfluxTime=function(e,t){if(A.a.isString(e)){if("now"===e)return"now()";var a=/^now-(\d+)([d|h|m|s])$/.exec(e);if(a)return"now() - "+parseInt(a[1],10)+a[2];e=je.parse(e,t)}return e.valueOf()+"ms"},e}(),pr=function(e){function t(t,a,r,n,i){var s=e.call(this,t,a)||this;s.templateSrv=r,s.$q=n,s.uiSegmentSrv=i,s.target=s.target,s.queryModel=new sr(s.target,r,s.panel.scopedVars),s.queryBuilder=new cr(s.target,s.datasource.database),s.groupBySegment=s.uiSegmentSrv.newPlusButton(),s.resultFormats=[{text:"Time series",value:"time_series"},{text:"Table",value:"table"}],s.policySegment=i.newSegment(s.target.policy),s.target.measurement?s.measurementSegment=i.newSegment(s.target.measurement):s.measurementSegment=i.newSelectMeasurement(),s.tagSegments=[];for(var o=0,l=s.target.tags;o<l.length;o++){var u=l[o];u.operator||(/^\/.*\/$/.test(u.value)?u.operator="=~":u.operator="="),u.condition&&s.tagSegments.push(i.newCondition(u.condition)),s.tagSegments.push(i.newKey(u.key)),s.tagSegments.push(i.newOperator(u.operator)),s.tagSegments.push(i.newKeyValue(u.value))}return s.fixTagSegments(),s.buildSelectMenu(),s.removeTagFilterSegment=i.newSegment({fake:!0,value:"-- remove tag filter --"}),s}return t.$inject=["$scope","$injector","templateSrv","$q","uiSegmentSrv"],Ve.c(t,e),t.prototype.removeOrderByTime=function(){this.target.orderByTime="ASC"},t.prototype.buildSelectMenu=function(){var e=ir.getCategories();this.selectMenu=A.a.reduce(e,function(e,t,a){var r={text:a,submenu:t.map(function(e){return{text:e.type,value:e.type}})};return e.push(r),e},[])},t.prototype.getGroupByOptions=function(){var e=this,t=this.queryBuilder.buildExploreQuery("TAG_KEYS");return this.datasource.metricFindQuery(t).then(function(t){var a=[];e.queryModel.hasFill()||a.push(e.uiSegmentSrv.newSegment({value:"fill(null)"})),e.target.limit||a.push(e.uiSegmentSrv.newSegment({value:"LIMIT"})),e.target.slimit||a.push(e.uiSegmentSrv.newSegment({value:"SLIMIT"})),"ASC"===e.target.orderByTime&&a.push(e.uiSegmentSrv.newSegment({value:"ORDER BY time DESC"})),e.queryModel.hasGroupByTime()||a.push(e.uiSegmentSrv.newSegment({value:"time($interval)"}));for(var r=0,n=t;r<n.length;r++){var i=n[r];a.push(e.uiSegmentSrv.newSegment({value:"tag("+i.text+")"}))}return a}).catch(this.handleQueryError.bind(this))},t.prototype.groupByAction=function(){switch(this.groupBySegment.value){case"LIMIT":this.target.limit=10;break;case"SLIMIT":this.target.slimit=10;break;case"ORDER BY time DESC":this.target.orderByTime="DESC";break;default:this.queryModel.addGroupBy(this.groupBySegment.value)}var e=this.uiSegmentSrv.newPlusButton();this.groupBySegment.value=e.value,this.groupBySegment.html=e.html,this.panelCtrl.refresh()},t.prototype.addSelectPart=function(e,t,a){this.queryModel.addSelectPart(e,a.value),this.panelCtrl.refresh()},t.prototype.handleSelectPartEvent=function(e,t,a){switch(a.name){case"get-param-options":var r=this.queryBuilder.buildExploreQuery("FIELDS");return this.datasource.metricFindQuery(r).then(this.transformToSegments(!0)).catch(this.handleQueryError.bind(this));case"part-param-changed":this.panelCtrl.refresh();break;case"action":this.queryModel.removeSelectPart(e,t),this.panelCtrl.refresh();break;case"get-part-actions":return this.$q.when([{text:"Remove",value:"remove-part"}])}},t.prototype.handleGroupByPartEvent=function(e,t,a){switch(a.name){case"get-param-options":var r=this.queryBuilder.buildExploreQuery("TAG_KEYS");return this.datasource.metricFindQuery(r).then(this.transformToSegments(!0)).catch(this.handleQueryError.bind(this));case"part-param-changed":this.panelCtrl.refresh();break;case"action":this.queryModel.removeGroupByPart(e,t),this.panelCtrl.refresh();break;case"get-part-actions":return this.$q.when([{text:"Remove",value:"remove-part"}])}},t.prototype.fixTagSegments=function(){var e=this.tagSegments.length,t=this.tagSegments[Math.max(e-1,0)];t&&"plus-button"===t.type||this.tagSegments.push(this.uiSegmentSrv.newPlusButton())},t.prototype.measurementChanged=function(){this.target.measurement=this.measurementSegment.value,this.panelCtrl.refresh()},t.prototype.getPolicySegments=function(){var e=this.queryBuilder.buildExploreQuery("RETENTION POLICIES");return this.datasource.metricFindQuery(e).then(this.transformToSegments(!1)).catch(this.handleQueryError.bind(this))},t.prototype.policyChanged=function(){this.target.policy=this.policySegment.value,this.panelCtrl.refresh()},t.prototype.toggleEditorMode=function(){try{this.target.query=this.queryModel.render(!1)}catch(e){console.log("query render error")}this.target.rawQuery=!this.target.rawQuery},t.prototype.getMeasurements=function(e){var t=this.queryBuilder.buildExploreQuery("MEASUREMENTS",void 0,e);return this.datasource.metricFindQuery(t).then(this.transformToSegments(!0)).catch(this.handleQueryError.bind(this))},t.prototype.handleQueryError=function(e){return this.error=e.message||"Failed to issue metric query",[]},t.prototype.transformToSegments=function(e){var t=this;return function(a){var r=A.a.map(a,function(e){return t.uiSegmentSrv.newSegment({value:e.text,expandable:e.expandable})});if(e)for(var n=0,i=t.templateSrv.variables;n<i.length;n++){var s=i[n];r.unshift(t.uiSegmentSrv.newSegment({type:"value",value:"/^$"+s.name+"$/",expandable:!0}))}return r}},t.prototype.getTagsOrValues=function(e,t){var a,r,n=this;if("condition"===e.type)return this.$q.when([this.uiSegmentSrv.newSegment("AND"),this.uiSegmentSrv.newSegment("OR")]);if("operator"===e.type){var i=this.tagSegments[t+1].value;return/^\/.*\/$/.test(i)?this.$q.when(this.uiSegmentSrv.newOperators(["=~","!~"])):this.$q.when(this.uiSegmentSrv.newOperators(["=","!=","<>","<",">"]))}return"key"===e.type||"plus-button"===e.type?(a=this.queryBuilder.buildExploreQuery("TAG_KEYS"),r=!1):"value"===e.type&&(a=this.queryBuilder.buildExploreQuery("TAG_VALUES",this.tagSegments[t-2].value),r=!0),this.datasource.metricFindQuery(a).then(this.transformToSegments(r)).then(function(t){return"key"===e.type&&t.splice(0,0,D.a.copy(n.removeTagFilterSegment)),t}).catch(this.handleQueryError.bind(this))},t.prototype.getFieldSegments=function(){var e=this.queryBuilder.buildExploreQuery("FIELDS");return this.datasource.metricFindQuery(e).then(this.transformToSegments(!1)).catch(this.handleQueryError)},t.prototype.tagSegmentUpdated=function(e,t){this.tagSegments[t]=e,e.value===this.removeTagFilterSegment.value?(this.tagSegments.splice(t,3),0===this.tagSegments.length?this.tagSegments.push(this.uiSegmentSrv.newPlusButton()):this.tagSegments.length>2&&(this.tagSegments.splice(Math.max(t-1,0),1),"plus-button"!==this.tagSegments[this.tagSegments.length-1].type&&this.tagSegments.push(this.uiSegmentSrv.newPlusButton()))):("plus-button"===e.type&&(t>2&&this.tagSegments.splice(t,0,this.uiSegmentSrv.newCondition("AND")),this.tagSegments.push(this.uiSegmentSrv.newOperator("=")),this.tagSegments.push(this.uiSegmentSrv.newFake("select tag value","value","query-segment-value")),e.type="key",e.cssClass="query-segment-key"),t+1===this.tagSegments.length&&this.tagSegments.push(this.uiSegmentSrv.newPlusButton())),this.rebuildTargetTagConditions()},t.prototype.rebuildTargetTagConditions=function(){var e=this,t=[],a=0,r="";A.a.each(this.tagSegments,function(n,i){"key"===n.type?(0===t.length&&t.push({}),t[a].key=n.value):"value"===n.type?((r=e.getTagValueOperator(n.value,t[a].operator))&&(e.tagSegments[i-1]=e.uiSegmentSrv.newOperator(r),t[a].operator=r),t[a].value=n.value):"condition"===n.type?(t.push({condition:n.value}),a+=1):"operator"===n.type&&(t[a].operator=n.value)}),this.target.tags=t,this.panelCtrl.refresh()},t.prototype.getTagValueOperator=function(e,t){return"=~"!==t&&"!~"!==t&&/^\/.*\/$/.test(e)?"=~":"=~"!==t&&"!~"!==t||!/^(?!\/.*\/$)/.test(e)?null:"="},t.prototype.getCollapsedText=function(){return this.queryModel.render(!1)},t.templateUrl="partials/query.editor.html",t}(Ye),dr=function(){function e(){}return e.templateUrl="partials/config.html",e}(),mr=function(){function e(){}return e.templateUrl="partials/annotations.editor.html",e}();function fr(e,t){var a=e.line,r=e.timestamp,n="EK"+r+t.labels,i=U()(r),s=i.fromNow(),o=i.format("YYYY-MM-DD HH:mm:ss"),l=function(e,t){if(!e||!t)return[];for(var a=new RegExp("(?:"+t+")","g"),r=[],n=a.exec(e);n;)r.push({text:n[0],start:n.index,length:n[0].length}),n=a.exec(e);return r}(a,t.search);return{key:n,logLevel:function(e){var t;if(e)return Object.keys(ur).forEach(function(a){t||new RegExp("\\b"+a+"\\b","i").test(e)&&(t=ur[a])}),t}(a),searchMatches:l,timeFromNow:s,timeLocal:o,entry:a,timestamp:r}}!function(e){e.crit="crit",e.warn="warn",e.err="error",e.error="error",e.info="info",e.debug="debug",e.trace="trace"}(ur||(ur={}));var gr={direction:"BACKWARD",limit:100,regexp:"",query:""},vr=/({\w+="[^"]+"})?\s*(\w[^{]+)?\s*({\w+="[^"]+"})?/;var yr=function(){function e(e,t,a){this.instanceSettings=e,this.backendSrv=t,this.templateSrv=a}return e.$inject=["instanceSettings","backendSrv","templateSrv"],e.prototype._request=function(e,t,a){var r=""+this.instanceSettings.url+e+"?"+(t?function(e){return Object.keys(e).map(function(t){var a=e[t];return encodeURIComponent(t)+"="+encodeURIComponent(a)}).join("&")}(t):""),n=Ve.a({},a,{url:r});return this.backendSrv.datasourceRequest(n)},e.prototype.prepareQueryTarget=function(e,t){var a=this.templateSrv.replace(e.expr),r=this.getTime(t.range.from,!1),n=this.getTime(t.range.to,!0);return Ve.a({},gr,function(e){var t=e.match(vr),a="",r="";return t&&(t[1]&&(a=t[1]),t[2]&&(r=t[2].trim()),t[3]&&(a=t[1]?t[1].slice(0,-1)+","+t[3].slice(1):t[3])),{query:a,regexp:r}}(a),{start:r,end:n})},e.prototype.query=function(e){var t=this,a=e.targets.filter(function(e){return e.expr}).map(function(a){return t.prepareQueryTarget(a,e)});if(0===a.length)return Promise.resolve({data:[]});var r=a.map(function(e){return t._request("/api/prom/query",e)});return Promise.all(r).then(function(e){return{data:function(e,t){var a=e.reduce(function(e,t){return e.concat(t.entries.map(function(e){return fr(e,t)}))},[]);return{rows:A.a.chain(a).sortBy("timestamp").reverse().slice(0,t||a.length).value()}}(e.reduce(function(e,t,r){var n=t.data.streams||[],i=a[r].regexp;return n.forEach(function(e){e.search=i}),e.concat(n)},[]),100)}})},e.prototype.metadataRequest=function(e){var t=e.replace("v1","prom");return this._request(t,{silent:!0}).then(function(e){return{data:{data:e.data.values||[]}}})},e.prototype.getTime=function(e,t){return A.a.isString(e)&&(e=je.parse(e,t)),Math.ceil(1e6*e.valueOf())},e.prototype.testDatasource=function(){return this._request("/api/prom/label").then(function(e){return e&&e.data&&e.data.values&&e.data.values.length>0?{status:"success",message:"Data source connected and labels found."}:{status:"error",message:"Data source connected, but no labels received. Verify that logging is configured properly."}}).catch(function(e){return{status:"error",message:e.message}})},e}(),br=function(){function e(){}return e.templateUrl="partials/config.html",e}(),Sr=function(){function e(e,t){this.$q=e,this.datasourceSrv=t}return e.$inject=["$q","datasourceSrv"],e.prototype.query=function(e){var t=this,a=A.a.groupBy(e.targets,"datasource"),r=A.a.map(a,function(a){var r=a[0].datasource;return"-- Mixed --"===r?t.$q([]):t.datasourceSrv.get(r).then(function(t){var r=D.a.copy(e);return r.targets=a,t.query(r)})});return this.$q.all(r).then(function(e){return{data:A.a.flatten(A.a.map(e,"data"))}})},e}(),xr=function(){function e(e){this.$q=e}return e.prototype.processQueryResult=function(e){var t=[];if(!e.data.results)return{data:t};for(var a in e.data.results){var r=e.data.results[a];if(r.series)for(var n=0,i=r.series;n<i.length;n++){var s=i[n];t.push({target:s.name,datapoints:s.points,refId:r.refId,meta:r.meta})}if(r.tables)for(var o=0,l=r.tables;o<l.length;o++){var u=l[o];u.type="table",u.refId=r.refId,u.meta=r.meta,t.push(u)}}return{data:t}},e.prototype.parseMetricFindQueryResult=function(e,t){if(!t||0===t.data.length||0===t.data.results[e].meta.rowCount)return[];var a=t.data.results[e].tables[0].columns,r=t.data.results[e].tables[0].rows,n=this.findColIndex(a,"__text"),i=this.findColIndex(a,"__value");return 2===a.length&&-1!==n&&-1!==i?this.transformToKeyValueList(r,n,i):this.transformToSimpleList(r)},e.prototype.transformToKeyValueList=function(e,t,a){for(var r=[],n=0;n<e.length;n++)this.containsKey(r,e[n][t])||r.push({text:e[n][t],value:e[n][a]});return r},e.prototype.transformToSimpleList=function(e){for(var t=[],a=0;a<e.length;a++)for(var r=0;r<e[a].length;r++){var n=e[a][r];-1===t.indexOf(n)&&t.push(n)}return A.a.map(t,function(e){return{text:e}})},e.prototype.findColIndex=function(e,t){for(var a=0;a<e.length;a++)if(e[a].text===t)return a;return-1},e.prototype.containsKey=function(e,t){for(var a=0;a<e.length;a++)if(e[a].text===t)return!0;return!1},e.prototype.transformAnnotationResponse=function(e,t){for(var a=t.data.results[e.annotation.name].tables[0],r=-1,n=-1,i=-1,s=0;s<a.columns.length;s++)if("time_sec"===a.columns[s].text||"time"===a.columns[s].text)r=s;else{if("title"===a.columns[s].text)return this.$q.reject({message:"The title column for annotations is deprecated, now only a column named text is returned"});"text"===a.columns[s].text?n=s:"tags"===a.columns[s].text&&(i=s)}if(-1===r)return this.$q.reject({message:"Missing mandatory time column (with time_sec column alias) in annotation query."});var o=[];for(s=0;s<a.rows.length;s++){var l=a.rows[s];o.push({annotation:e.annotation,time:Math.floor(l[r]),text:l[n]?l[n].toString():"",tags:l[i]?l[i].trim().split(/\s*,\s*/):[]})}return o},e}(),wr=function(){function e(e,t,a,r){this.backendSrv=t,this.$q=a,this.templateSrv=r,this.name=e.name,this.id=e.id,this.responseParser=new xr(this.$q),this.interval=(e.jsonData||{}).timeInterval}return e.$inject=["instanceSettings","backendSrv","$q","templateSrv"],e.prototype.interpolateVariable=function(e,t){return"string"==typeof e?t.multi||t.includeAll?"'"+e.replace(/'/g,"''")+"'":e:"number"==typeof e?e:A.a.map(e,function(t){return"number"==typeof e?e:"'"+t.replace(/'/g,"''")+"'"}).join(",")},e.prototype.query=function(e){var t=this,a=A.a.filter(e.targets,function(e){return!0!==e.hide}).map(function(a){return{refId:a.refId,intervalMs:e.intervalMs,maxDataPoints:e.maxDataPoints,datasourceId:t.id,rawSql:t.templateSrv.replace(a.rawSql,e.scopedVars,t.interpolateVariable),format:a.format}});return 0===a.length?this.$q.when({data:[]}):this.backendSrv.datasourceRequest({url:"/api/tsdb/query",method:"POST",data:{from:e.range.from.valueOf().toString(),to:e.range.to.valueOf().toString(),queries:a}}).then(this.responseParser.processQueryResult)},e.prototype.annotationQuery=function(e){var t=this;if(!e.annotation.rawQuery)return this.$q.reject({message:"Query missing in annotation definition"});var a={refId:e.annotation.name,datasourceId:this.id,rawSql:this.templateSrv.replace(e.annotation.rawQuery,e.scopedVars,this.interpolateVariable),format:"table"};return this.backendSrv.datasourceRequest({url:"/api/tsdb/query",method:"POST",data:{from:e.range.from.valueOf().toString(),to:e.range.to.valueOf().toString(),queries:[a]}}).then(function(a){return t.responseParser.transformAnnotationResponse(e,a)})},e.prototype.metricFindQuery=function(e,t){var a=this,r="tempvar";t&&t.variable&&t.variable.name&&(r=t.variable.name);var n={queries:[{refId:r,datasourceId:this.id,rawSql:this.templateSrv.replace(e,{},this.interpolateVariable),format:"table"}]};return t&&t.range&&t.range.from&&(n.from=t.range.from.valueOf().toString()),t&&t.range&&t.range.to&&(n.to=t.range.to.valueOf().toString()),this.backendSrv.datasourceRequest({url:"/api/tsdb/query",method:"POST",data:n}).then(function(e){return a.responseParser.parseMetricFindQueryResult(r,e)})},e.prototype.testDatasource=function(){return this.backendSrv.datasourceRequest({url:"/api/tsdb/query",method:"POST",data:{from:"5m",to:"now",queries:[{refId:"A",intervalMs:1,maxDataPoints:1,datasourceId:this.id,rawSql:"SELECT 1",format:"table"}]}}).then(function(e){return{status:"success",message:"Database Connection OK"}}).catch(function(e){return console.log(e),e.data&&e.data.message?{status:"error",message:e.data.message}:{status:"error",message:e.status}})},e}(),Tr="SELECT\n  UNIX_TIMESTAMP(<time_column>) as time_sec,\n  <value column> as value,\n  <series name column> as metric\nFROM <table name>\nWHERE $__timeFilter(time_column)\nORDER BY <time_column> ASC\n",Cr=function(e){function t(t,a){var r=e.call(this,t,a)||this;return r.target.format=r.target.format||"time_series",r.target.alias="",r.formats=[{text:"Time series",value:"time_series"},{text:"Table",value:"table"}],r.target.rawSql||("table"===r.panelCtrl.panel.type?(r.target.format="table",r.target.rawSql="SELECT 1"):r.target.rawSql=Tr),r.panelCtrl.events.on("data-received",r.onDataReceived.bind(r),t),r.panelCtrl.events.on("data-error",r.onDataError.bind(r),t),r}return t.$inject=["$scope","$injector"],Ve.c(t,e),t.prototype.onDataReceived=function(e){this.lastQueryMeta=null,this.lastQueryError=null;var t=A.a.find(e,{refId:this.target.refId});t&&(this.lastQueryMeta=t.meta)},t.prototype.onDataError=function(e){if(e.data&&e.data.results){var t=e.data.results[this.target.refId];t&&(this.lastQueryMeta=t.meta,this.lastQueryError=t.error)}},t.templateUrl="partials/query.editor.html",t}(Ye),kr=function(){function e(){}return e.templateUrl="partials/config.html",e}(),_r="SELECT\n    UNIX_TIMESTAMP(<time_column>) as time_sec,\n    <text_column> as text,\n    <tags_column> as tags\n  FROM <table name>\n  WHERE $__timeFilter(time_column)\n  ORDER BY <time_column> ASC\n  LIMIT 100\n  ",Er=function(){function e(){this.annotation.rawQuery=this.annotation.rawQuery||_r}return e.templateUrl="partials/annotations.editor.html",e}(),Mr=function(){function e(e){this.$q=e}return e.prototype.processQueryResult=function(e){var t=[];if(!e.data.results)return{data:t};for(var a in e.data.results){var r=e.data.results[a];if(r.series)for(var n=0,i=r.series;n<i.length;n++){var s=i[n];t.push({target:s.name,datapoints:s.points,refId:r.refId,meta:r.meta})}if(r.tables)for(var o=0,l=r.tables;o<l.length;o++){var u=l[o];u.type="table",u.refId=r.refId,u.meta=r.meta,t.push(u)}}return{data:t}},e.prototype.parseMetricFindQueryResult=function(e,t){if(!t||0===t.data.length||0===t.data.results[e].meta.rowCount)return[];var a=t.data.results[e].tables[0].columns,r=t.data.results[e].tables[0].rows,n=this.findColIndex(a,"__text"),i=this.findColIndex(a,"__value");return 2===a.length&&-1!==n&&-1!==i?this.transformToKeyValueList(r,n,i):this.transformToSimpleList(r)},e.prototype.transformToKeyValueList=function(e,t,a){for(var r=[],n=0;n<e.length;n++)this.containsKey(r,e[n][t])||r.push({text:e[n][t],value:e[n][a]});return r},e.prototype.transformToSimpleList=function(e){for(var t=[],a=0;a<e.length;a++)for(var r=0;r<e[a].length;r++){var n=e[a][r];-1===t.indexOf(n)&&t.push(n)}return A.a.map(t,function(e){return{text:e}})},e.prototype.findColIndex=function(e,t){for(var a=0;a<e.length;a++)if(e[a].text===t)return a;return-1},e.prototype.containsKey=function(e,t){for(var a=0;a<e.length;a++)if(e[a].text===t)return!0;return!1},e.prototype.transformAnnotationResponse=function(e,t){for(var a=t.data.results[e.annotation.name].tables[0],r=-1,n=-1,i=-1,s=0;s<a.columns.length;s++)"time"===a.columns[s].text?r=s:"text"===a.columns[s].text?n=s:"tags"===a.columns[s].text&&(i=s);if(-1===r)return this.$q.reject({message:"Missing mandatory time column in annotation query."});var o=[];for(s=0;s<a.rows.length;s++){var l=a.rows[s];o.push({annotation:e.annotation,time:Math.floor(l[r]),title:l[-1],text:l[n],tags:l[i]?l[i].trim().split(/\s*,\s*/):[]})}return o},e}(),Pr=function(){function e(e,t,a){this.target=e,this.templateSrv=t,this.scopedVars=a,e.format=e.format||"time_series",e.timeColumn=e.timeColumn||"time",e.metricColumn=e.metricColumn||"none",e.group=e.group||[],e.where=e.where||[{type:"macro",name:"$__timeFilter",params:[]}],e.select=e.select||[[{type:"column",params:["value"]}]],"rawQuery"in this.target||(e.rawQuery="rawSql"in e),this.interpolateQueryStr=this.interpolateQueryStr.bind(this)}return e.$inject=["target","templateSrv","scopedVars"],e.prototype.unquoteIdentifier=function(e){return'"'===e[0]&&'"'===e[e.length-1]?e.substring(1,e.length-1).replace(/""/g,'"'):e},e.prototype.quoteIdentifier=function(e){return'"'+String(e).replace(/"/g,'""')+'"'},e.prototype.quoteLiteral=function(e){return"'"+String(e).replace(/'/g,"''")+"'"},e.prototype.escapeLiteral=function(e){return String(e).replace(/'/g,"''")},e.prototype.hasTimeGroup=function(){return A.a.find(this.target.group,function(e){return"time"===e.type})},e.prototype.hasMetricColumn=function(){return"none"!==this.target.metricColumn},e.prototype.interpolateQueryStr=function(e,t,a){return t.multi||t.includeAll?"string"==typeof e?this.quoteLiteral(e):A.a.map(e,this.quoteLiteral).join(","):this.escapeLiteral(e)},e.prototype.render=function(e){var t=this.target;return this.target.rawQuery||"table"in this.target?(t.rawQuery||(t.rawSql=this.buildQuery()),e?this.templateSrv.replace(t.rawSql,this.scopedVars,this.interpolateQueryStr):t.rawSql):""},e.prototype.hasUnixEpochTimecolumn=function(){return["int4","int8","float4","float8","numeric"].indexOf(this.target.timeColumnType)>-1},e.prototype.buildTimeColumn=function(e){void 0===e&&(e=!0);var t,a=this.hasTimeGroup(),r="$__timeGroup";if(a){var n=void 0;n=a.params.length>1&&"none"!==a.params[1]?a.params.join(","):a.params[0],this.hasUnixEpochTimecolumn()&&(r="$__unixEpochGroup"),e&&(r+="Alias"),t=r+"("+this.target.timeColumn+","+n+")"}else t=this.target.timeColumn,e&&(t+=' AS "time"');return t},e.prototype.buildMetricColumn=function(){return this.hasMetricColumn()?this.target.metricColumn+" AS metric":""},e.prototype.buildValueColumns=function(){for(var e="",t=0,a=this.target.select;t<a.length;t++){var r=a[t];e+=",\n  "+this.buildValueColumn(r)}return e},e.prototype.buildValueColumn=function(e){var t="";t=A.a.find(e,function(e){return"column"===e.type}).params[0];var a=A.a.find(e,function(e){return"aggregate"===e.type||"percentile"===e.type}),r=A.a.find(e,function(e){return"window"===e.type||"moving_window"===e.type});if(a){var n=a.params[0];switch(a.type){case"aggregate":t="first"===n||"last"===n?n+"("+t+","+this.target.timeColumn+")":n+"("+t+")";break;case"percentile":t=n+"("+a.params[1]+") WITHIN GROUP (ORDER BY "+t+")"}}if(r){var i=[];this.hasMetricColumn()&&i.push("PARTITION BY "+this.target.metricColumn),i.push("ORDER BY "+this.buildTimeColumn(!1));var s=i.join(" "),o=void 0,l=void 0;switch(r.type){case"window":switch(r.params[0]){case"increase":t="(CASE WHEN "+(o=t)+" >= "+(l="lag("+o+") OVER ("+s+")")+" THEN "+o+" - "+l,t+=" WHEN "+l+" IS NULL THEN NULL ELSE "+o+" END)";break;case"rate":var u=this.target.timeColumn;a&&(u="min("+u+")"),t="(CASE WHEN "+(o=t)+" >= "+(l="lag("+o+") OVER ("+s+")")+" THEN "+o+" - "+l,t+=" WHEN "+l+" IS NULL THEN NULL ELSE "+o+" END)",t+="/extract(epoch from "+u+" - lag("+u+") OVER ("+s+"))";break;default:t=r.params[0]+"("+t+") OVER ("+s+")"}break;case"moving_window":t=r.params[0]+"("+t+") OVER ("+s+" ROWS "+r.params[1]+" PRECEDING)"}}var c=A.a.find(e,function(e){return"alias"===e.type});return c&&(t+=" AS "+this.quoteIdentifier(c.params[0])),t},e.prototype.buildWhereClause=function(){var e=this,t="",a=A.a.map(this.target.where,function(t,a){switch(t.type){case"macro":return t.name+"("+e.target.timeColumn+")";case"expression":return t.params.join(" ")}});return a.length>0&&(t="\nWHERE\n  "+a.join(" AND\n  ")),t},e.prototype.buildGroupClause=function(){for(var e="",t="",a=0;a<this.target.group.length;a++){var r=this.target.group[a];a>0&&(t+=", "),"time"===r.type?t+="1":t+=r.params[0]}return t.length&&(e="\nGROUP BY "+t,this.hasMetricColumn()&&(e+=",2")),e},e.prototype.buildQuery=function(){var e="SELECT";return e+="\n  "+this.buildTimeColumn(),this.hasMetricColumn()&&(e+=",\n  "+this.buildMetricColumn()),e+=this.buildValueColumns(),e+="\nFROM "+this.target.table,e+=this.buildWhereClause(),e+=this.buildGroupClause(),e+="\nORDER BY 1",this.hasMetricColumn()&&(e+=",2"),e},e}(),Dr=function(){function e(e,t,a,r,n){var i=this;this.backendSrv=t,this.$q=a,this.templateSrv=r,this.timeSrv=n,this.interpolateVariable=function(e,t){return"string"==typeof e?t.multi||t.includeAll?i.queryModel.quoteLiteral(e):e:"number"==typeof e?e:A.a.map(e,function(e){return i.queryModel.quoteLiteral(e)}).join(",")},this.name=e.name,this.id=e.id,this.jsonData=e.jsonData,this.responseParser=new Mr(this.$q),this.queryModel=new Pr({}),this.interval=(e.jsonData||{}).timeInterval}return e.$inject=["instanceSettings","backendSrv","$q","templateSrv","timeSrv"],e.prototype.query=function(e){var t=this,a=A.a.filter(e.targets,function(e){return!0!==e.hide}).map(function(a){var r=new Pr(a,t.templateSrv,e.scopedVars);return{refId:a.refId,intervalMs:e.intervalMs,maxDataPoints:e.maxDataPoints,datasourceId:t.id,rawSql:r.render(t.interpolateVariable),format:a.format}});return 0===a.length?this.$q.when({data:[]}):this.backendSrv.datasourceRequest({url:"/api/tsdb/query",method:"POST",data:{from:e.range.from.valueOf().toString(),to:e.range.to.valueOf().toString(),queries:a}}).then(this.responseParser.processQueryResult)},e.prototype.annotationQuery=function(e){var t=this;if(!e.annotation.rawQuery)return this.$q.reject({message:"Query missing in annotation definition"});var a={refId:e.annotation.name,datasourceId:this.id,rawSql:this.templateSrv.replace(e.annotation.rawQuery,e.scopedVars,this.interpolateVariable),format:"table"};return this.backendSrv.datasourceRequest({url:"/api/tsdb/query",method:"POST",data:{from:e.range.from.valueOf().toString(),to:e.range.to.valueOf().toString(),queries:[a]}}).then(function(a){return t.responseParser.transformAnnotationResponse(e,a)})},e.prototype.metricFindQuery=function(e,t){var a=this,r="tempvar";t&&t.variable&&t.variable.name&&(r=t.variable.name);var n={refId:r,datasourceId:this.id,rawSql:this.templateSrv.replace(e,{},this.interpolateVariable),format:"table"},i=this.timeSrv.timeRange(),s={queries:[n],from:i.from.valueOf().toString(),to:i.to.valueOf().toString()};return this.backendSrv.datasourceRequest({url:"/api/tsdb/query",method:"POST",data:s}).then(function(e){return a.responseParser.parseMetricFindQueryResult(r,e)})},e.prototype.getVersion=function(){return this.metricFindQuery("SELECT current_setting('server_version_num')::int/100",{})},e.prototype.getTimescaleDBVersion=function(){return this.metricFindQuery("SELECT extversion FROM pg_extension WHERE extname = 'timescaledb'",{})},e.prototype.testDatasource=function(){return this.metricFindQuery("SELECT 1",{}).then(function(e){return{status:"success",message:"Database Connection OK"}}).catch(function(e){return console.log(e),e.data&&e.data.message?{status:"error",message:e.data.message}:{status:"error",message:e.status}})},e}(),$r=function(){function e(e,t){this.target=e,this.queryModel=t}return e.prototype.getOperators=function(e){switch(e){case"float4":case"float8":return["=","!=","<","<=",">",">="];case"text":case"varchar":case"char":return["=","!=","<","<=",">",">=","IN","NOT IN","LIKE","NOT LIKE","~","~*","!~","!~*"];default:return["=","!=","<","<=",">",">=","IN","NOT IN"]}},e.prototype.quoteIdentAsLiteral=function(e){return this.queryModel.quoteLiteral(this.queryModel.unquoteIdentifier(e))},e.prototype.findMetricTable=function(){var e="\nSELECT\n\tquote_ident(table_name) as table_name,\n\t( SELECT\n\t    quote_ident(column_name) as column_name\n\t  FROM information_schema.columns c\n    WHERE\n      c.table_schema = t.table_schema AND\n      c.table_name = t.table_name AND\n      udt_name IN ('timestamptz','timestamp')\n    ORDER BY ordinal_position LIMIT 1\n  ) AS time_column,\n  ( SELECT\n      quote_ident(column_name) AS column_name\n    FROM information_schema.columns c\n    WHERE\n      c.table_schema = t.table_schema AND\n      c.table_name = t.table_name AND\n      udt_name='float8'\n    ORDER BY ordinal_position LIMIT 1\n  ) AS value_column\nFROM information_schema.tables t\nWHERE ";return e+=this.buildSchemaConstraint(),e+=" AND\n  EXISTS\n  ( SELECT 1\n    FROM information_schema.columns c\n    WHERE\n      c.table_schema = t.table_schema AND\n      c.table_name = t.table_name AND\n      udt_name IN ('timestamptz','timestamp')\n  ) AND\n  EXISTS\n  ( SELECT 1\n    FROM information_schema.columns c\n    WHERE\n      c.table_schema = t.table_schema AND\n      c.table_name = t.table_name AND\n      udt_name='float8'\n  )\nLIMIT 1\n;"},e.prototype.buildSchemaConstraint=function(){return"\ntable_schema IN (\n  SELECT\n    CASE WHEN trim(s[i]) = '\"$user\"' THEN user ELSE trim(s[i]) END\n  FROM\n    generate_series(\n      array_lower(string_to_array(current_setting('search_path'),','),1),\n      array_upper(string_to_array(current_setting('search_path'),','),1)\n    ) as i,\n    string_to_array(current_setting('search_path'),',') s\n)"},e.prototype.buildTableConstraint=function(e){var t="";if(e.includes(".")){var a=e.split(".");return t="table_schema = "+this.quoteIdentAsLiteral(a[0]),t+=" AND table_name = "+this.quoteIdentAsLiteral(a[1])}return t=this.buildSchemaConstraint(),t+=" AND table_name = "+this.quoteIdentAsLiteral(e)},e.prototype.buildTableQuery=function(){var e="SELECT quote_ident(table_name) FROM information_schema.tables WHERE ";return e+=this.buildSchemaConstraint(),e+=" ORDER BY table_name"},e.prototype.buildColumnQuery=function(e){var t="SELECT quote_ident(column_name) FROM information_schema.columns WHERE ";switch(t+=this.buildTableConstraint(this.target.table),e){case"time":t+=" AND data_type IN ('timestamp without time zone','timestamp with time zone','bigint','integer','double precision','real')";break;case"metric":t+=" AND data_type IN ('text','character','character varying')";break;case"value":t+=" AND data_type IN ('bigint','integer','double precision','real')",t+=" AND column_name <> "+this.quoteIdentAsLiteral(this.target.timeColumn);break;case"group":t+=" AND data_type IN ('text','character','character varying')"}return t+=" ORDER BY column_name"},e.prototype.buildValueQuery=function(e){var t="SELECT DISTINCT quote_literal("+e+")";return t+=" FROM "+this.target.table,t+=" WHERE $__timeFilter("+this.target.timeColumn+")",t+=" AND "+e+" IS NOT NULL",t+=" ORDER BY 1 LIMIT 100"},e.prototype.buildDatatypeQuery=function(e){var t="SELECT udt_name FROM information_schema.columns WHERE ";return t+=this.buildSchemaConstraint(),t+=" AND table_name = "+this.quoteIdentAsLiteral(this.target.table),t+=" AND column_name = "+this.quoteIdentAsLiteral(e)},e.prototype.buildAggregateQuery=function(){var e="SELECT DISTINCT proname FROM pg_aggregate ";return e+="INNER JOIN pg_proc ON pg_aggregate.aggfnoid = pg_proc.oid ",e+="INNER JOIN pg_type ON pg_type.oid=pg_proc.prorettype ",e+="WHERE pronargs=1 AND typname IN ('float8') AND aggkind='n' ORDER BY 1"},e}(),Ar=function(){return function(e){this.type=e.type,e.label?this.label=e.label:this.label=this.type[0].toUpperCase()+this.type.substring(1)+":",this.style=e.style,"function"===this.style?(this.wrapOpen="(",this.wrapClose=")",this.separator=", "):(this.wrapOpen=" ",this.wrapClose=" ",this.separator=" "),this.params=e.params,this.defaultParams=e.defaultParams}}(),Ir=function(){function e(e,t){if(this.part=e,this.def=t,!this.def)throw{message:"Could not find sql part "+e.type};this.datatype=e.datatype,e.name?(this.name=e.name,this.label=t.label+" "+e.name):(this.name="",this.label=t.label),e.params=e.params||A.a.clone(this.def.defaultParams),this.params=e.params}return e.prototype.updateParam=function(e,t){""===e&&this.def.params[t].optional?this.params.splice(t,1):this.params[t]=e,this.part.params=this.params},e}(),Or=[];function Fr(e){Or[e.type]=new Ar(e)}Fr({type:"column",style:"label",params:[{type:"column",dynamicLookup:!0}],defaultParams:["value"]}),Fr({type:"expression",style:"expression",label:"Expr:",params:[{name:"left",type:"string",dynamicLookup:!0},{name:"op",type:"string",dynamicLookup:!0},{name:"right",type:"string",dynamicLookup:!0}],defaultParams:["value","=","value"]}),Fr({type:"macro",style:"label",label:"Macro:",params:[],defaultParams:[]}),Fr({type:"aggregate",style:"label",params:[{name:"name",type:"string",options:["avg","count","min","max","sum","stddev","variance"]}],defaultParams:["avg"]}),Fr({type:"percentile",label:"Aggregate:",style:"label",params:[{name:"name",type:"string",options:["percentile_cont","percentile_disc"]},{name:"fraction",type:"number",options:["0.5","0.75","0.9","0.95","0.99"]}],defaultParams:["percentile_cont","0.95"]}),Fr({type:"alias",style:"label",params:[{name:"name",type:"string",quote:"double"}],defaultParams:["alias"]}),Fr({type:"time",style:"function",label:"time",params:[{name:"interval",type:"interval",options:["$__interval","1s","10s","1m","5m","10m","15m","1h"]},{name:"fill",type:"string",options:["none","NULL","previous","0"]}],defaultParams:["$__interval","none"]}),Fr({type:"window",style:"label",params:[{name:"function",type:"string",options:["increase","rate","sum"]}],defaultParams:["increase"]}),Fr({type:"moving_window",style:"label",label:"Moving Window:",params:[{name:"function",type:"string",options:["avg"]},{name:"window_size",type:"number",options:["3","5","7","10","20"]}],defaultParams:["avg","5"]});var qr={create:function(e){var t=Or[e.type];return t?new Ir(e,t):null}},Nr="SELECT\n  $__time(time_column),\n  value1\nFROM\n  metric_table\nWHERE\n  $__timeFilter(time_column)\n",Rr=function(e){function t(t,a,r,n,i){var s=e.call(this,t,a)||this;return s.templateSrv=r,s.$q=n,s.uiSegmentSrv=i,s.target=s.target,s.queryModel=new Pr(s.target,r,s.panel.scopedVars),s.metaBuilder=new $r(s.target,s.queryModel),s.updateProjection(),s.formats=[{text:"Time series",value:"time_series"},{text:"Table",value:"table"}],s.target.rawSql||("table"===s.panelCtrl.panel.type?(s.target.format="table",s.target.rawSql="SELECT 1",s.target.rawQuery=!0):(s.target.rawSql=Nr,s.datasource.metricFindQuery(s.metaBuilder.findMetricTable()).then(function(e){if(e.length>0){s.target.table=e[0].text;var t=s.uiSegmentSrv.newSegment(s.target.table);s.tableSegment.html=t.html,s.tableSegment.value=t.value,s.target.timeColumn=e[1].text,t=s.uiSegmentSrv.newSegment(s.target.timeColumn),s.timeColumnSegment.html=t.html,s.timeColumnSegment.value=t.value,s.target.timeColumnType="timestamp",s.target.select=[[{type:"column",params:[e[2].text]}]],s.updateProjection(),s.panelCtrl.refresh()}}))),s.target.table?s.tableSegment=i.newSegment(s.target.table):s.tableSegment=i.newSegment({value:"select table",fake:!0}),s.timeColumnSegment=i.newSegment(s.target.timeColumn),s.metricColumnSegment=i.newSegment(s.target.metricColumn),s.buildSelectMenu(),s.whereAdd=s.uiSegmentSrv.newPlusButton(),s.groupAdd=s.uiSegmentSrv.newPlusButton(),s.panelCtrl.events.on("data-received",s.onDataReceived.bind(s),t),s.panelCtrl.events.on("data-error",s.onDataError.bind(s),t),s}return t.$inject=["$scope","$injector","templateSrv","$q","uiSegmentSrv"],Ve.c(t,e),t.prototype.updateProjection=function(){this.selectParts=A.a.map(this.target.select,function(e){return A.a.map(e,qr.create).filter(function(e){return e})}),this.whereParts=A.a.map(this.target.where,qr.create).filter(function(e){return e}),this.groupParts=A.a.map(this.target.group,qr.create).filter(function(e){return e})},t.prototype.updatePersistedParts=function(){this.target.select=A.a.map(this.selectParts,function(e){return A.a.map(e,function(e){return{type:e.def.type,datatype:e.datatype,params:e.params}})}),this.target.where=A.a.map(this.whereParts,function(e){return{type:e.def.type,datatype:e.datatype,name:e.name,params:e.params}}),this.target.group=A.a.map(this.groupParts,function(e){return{type:e.def.type,datatype:e.datatype,params:e.params}})},t.prototype.buildSelectMenu=function(){this.selectMenu=[];var e={text:"Aggregate Functions",value:"aggregate",submenu:[{text:"Average",value:"avg"},{text:"Count",value:"count"},{text:"Maximum",value:"max"},{text:"Minimum",value:"min"},{text:"Sum",value:"sum"},{text:"Standard deviation",value:"stddev"},{text:"Variance",value:"variance"}]};if(!0===this.datasource.jsonData.timescaledb&&(e.submenu.push({text:"First",value:"first"}),e.submenu.push({text:"Last",value:"last"})),this.selectMenu.push(e),this.datasource.jsonData.postgresVersion>=904){this.selectMenu.push({text:"Ordered-Set Aggregate Functions",value:"percentile",submenu:[{text:"Percentile (continuous)",value:"percentile_cont"},{text:"Percentile (discrete)",value:"percentile_disc"}]})}this.selectMenu.push({text:"Window Functions",value:"window",submenu:[{text:"Increase",value:"increase"},{text:"Rate",value:"rate"},{text:"Sum",value:"sum"},{text:"Moving Average",value:"avg",type:"moving_window"}]}),this.selectMenu.push({text:"Alias",value:"alias"}),this.selectMenu.push({text:"Column",value:"column"})},t.prototype.toggleEditorMode=function(){var e=this;this.target.rawQuery?re.a.emit("confirm-modal",{title:"Warning",text2:"Switching to query builder may overwrite your raw SQL.",icon:"fa-exclamation",yesText:"Switch",onConfirm:function(){e.target.rawQuery=!e.target.rawQuery}}):this.target.rawQuery=!this.target.rawQuery},t.prototype.resetPlusButton=function(e){var t=this.uiSegmentSrv.newPlusButton();e.html=t.html,e.value=t.value},t.prototype.getTableSegments=function(){return this.datasource.metricFindQuery(this.metaBuilder.buildTableQuery()).then(this.transformToSegments({})).catch(this.handleQueryError.bind(this))},t.prototype.tableChanged=function(){var e=this;this.target.table=this.tableSegment.value,this.target.where=[],this.target.group=[],this.updateProjection();var t=this.uiSegmentSrv.newSegment("none");this.metricColumnSegment.html=t.html,this.metricColumnSegment.value=t.value,this.target.metricColumn="none";var a=this.datasource.metricFindQuery(this.metaBuilder.buildColumnQuery("time")).then(function(t){if(t.length>0&&!A.a.find(t,function(t){return t.text===e.target.timeColumn})){var a=e.uiSegmentSrv.newSegment(t[0].text);e.timeColumnSegment.html=a.html,e.timeColumnSegment.value=a.value}return e.timeColumnChanged(!1)}),r=this.datasource.metricFindQuery(this.metaBuilder.buildColumnQuery("value")).then(function(t){t.length>0&&(e.target.select=[[{type:"column",params:[t[0].text]}]],e.updateProjection())});this.$q.all([a,r]).then(function(){e.panelCtrl.refresh()})},t.prototype.getTimeColumnSegments=function(){return this.datasource.metricFindQuery(this.metaBuilder.buildColumnQuery("time")).then(this.transformToSegments({})).catch(this.handleQueryError.bind(this))},t.prototype.timeColumnChanged=function(e){var t=this;return this.target.timeColumn=this.timeColumnSegment.value,this.datasource.metricFindQuery(this.metaBuilder.buildDatatypeQuery(this.target.timeColumn)).then(function(a){if(1===a.length){t.target.timeColumnType!==a[0].text&&(t.target.timeColumnType=a[0].text);var r=void 0;r=t.queryModel.hasUnixEpochTimecolumn()?qr.create({type:"macro",name:"$__unixEpochFilter",params:[]}):qr.create({type:"macro",name:"$__timeFilter",params:[]}),t.whereParts.length>=1&&"macro"===t.whereParts[0].def.type?t.whereParts[0]=r:t.whereParts.splice(0,0,r)}t.updatePersistedParts(),!1!==e&&t.panelCtrl.refresh()})},t.prototype.getMetricColumnSegments=function(){return this.datasource.metricFindQuery(this.metaBuilder.buildColumnQuery("metric")).then(this.transformToSegments({addNone:!0})).catch(this.handleQueryError.bind(this))},t.prototype.metricColumnChanged=function(){this.target.metricColumn=this.metricColumnSegment.value,this.panelCtrl.refresh()},t.prototype.onDataReceived=function(e){this.lastQueryMeta=null,this.lastQueryError=null;var t=A.a.find(e,{refId:this.target.refId});t&&(this.lastQueryMeta=t.meta)},t.prototype.onDataError=function(e){if(e.data&&e.data.results){var t=e.data.results[this.target.refId];t&&(this.lastQueryMeta=t.meta,this.lastQueryError=t.error)}},t.prototype.transformToSegments=function(e){var t=this;return function(a){var r=A.a.map(a,function(e){return t.uiSegmentSrv.newSegment({value:e.text,expandable:e.expandable})});if(e.addTemplateVars)for(var n=0,i=t.templateSrv.variables;n<i.length;n++){var s=i[n],o=void 0;o="$"+s.name,e.templateQuoter&&!1===s.multi&&(o=e.templateQuoter(o)),r.unshift(t.uiSegmentSrv.newSegment({type:"template",value:o,expandable:!0}))}return e.addNone&&r.unshift(t.uiSegmentSrv.newSegment({type:"template",value:"none",expandable:!0})),r}},t.prototype.findAggregateIndex=function(e){return A.a.findIndex(e,function(e){return"aggregate"===e.def.type||"percentile"===e.def.type})},t.prototype.findWindowIndex=function(e){return A.a.findIndex(e,function(e){return"window"===e.def.type||"moving_window"===e.def.type})},t.prototype.addSelectPart=function(e,t,a){var r=t.value;a&&a.type&&(r=a.type);var n=qr.create({type:r});a&&(n.params[0]=a.value);var i=!1;switch(r){case"column":var s=A.a.map(e,function(e){return qr.create({type:e.def.type,params:A.a.clone(e.params)})});this.selectParts.push(s);break;case"percentile":case"aggregate":0===this.target.group.length&&this.addGroup("time","$__interval");var o=this.findAggregateIndex(e);-1!==o?e[o]=n:e.splice(1,0,n),A.a.find(e,function(e){return"alias"===e.def.type})||(i=!0);break;case"moving_window":case"window":var l=this.findWindowIndex(e);if(-1!==l)e[l]=n;else{var u=this.findAggregateIndex(e);-1!==u?e.splice(u+1,0,n):e.splice(1,0,n)}A.a.find(e,function(e){return"alias"===e.def.type})||(i=!0);break;case"alias":i=!0}i&&(n=qr.create({type:"alias",params:[e[0].params[0].replace(/"/g,"")]}),"alias"===e[e.length-1].def.type?e[e.length-1]=n:e.push(n)),this.updatePersistedParts(),this.panelCtrl.refresh()},t.prototype.removeSelectPart=function(e,t){if("column"===t.def.type){if(this.selectParts.length>1){var a=A.a.indexOf(this.selectParts,e);this.selectParts.splice(a,1)}}else{var r=A.a.indexOf(e,t);e.splice(r,1)}this.updatePersistedParts()},t.prototype.handleSelectPartEvent=function(e,t,a){switch(a.name){case"get-param-options":switch(t.def.type){case"aggregate":return this.datasource.metricFindQuery(this.metaBuilder.buildAggregateQuery()).then(this.transformToSegments({})).catch(this.handleQueryError.bind(this));case"column":return this.datasource.metricFindQuery(this.metaBuilder.buildColumnQuery("value")).then(this.transformToSegments({})).catch(this.handleQueryError.bind(this))}case"part-param-changed":this.updatePersistedParts(),this.panelCtrl.refresh();break;case"action":this.removeSelectPart(e,t),this.panelCtrl.refresh();break;case"get-part-actions":return this.$q.when([{text:"Remove",value:"remove-part"}])}},t.prototype.handleGroupPartEvent=function(e,t,a){switch(a.name){case"get-param-options":return this.datasource.metricFindQuery(this.metaBuilder.buildColumnQuery()).then(this.transformToSegments({})).catch(this.handleQueryError.bind(this));case"part-param-changed":this.updatePersistedParts(),this.panelCtrl.refresh();break;case"action":this.removeGroup(e,t),this.panelCtrl.refresh();break;case"get-part-actions":return this.$q.when([{text:"Remove",value:"remove-part"}])}},t.prototype.addGroup=function(e,t){var a=[t];"time"===e&&(a=["$__interval","none"]);var r=qr.create({type:e,params:a});"time"===e?this.groupParts.splice(0,0,r):this.groupParts.push(r);for(var n=0,i=this.selectParts;n<i.length;n++){var s=i[n];if(!s.some(function(e){return"aggregate"===e.def.type})){var o=qr.create({type:"aggregate",params:["avg"]});if(s.splice(1,0,o),!s.some(function(e){return"alias"===e.def.type})){var l=qr.create({type:"alias",params:[s[0].part.params[0]]});s.push(l)}}}this.updatePersistedParts()},t.prototype.removeGroup=function(e,t){"time"===e.def.type&&(this.selectParts=A.a.map(this.selectParts,function(e){return A.a.filter(e,function(e){return"aggregate"!==e.def.type&&"percentile"!==e.def.type})})),this.groupParts.splice(t,1),this.updatePersistedParts()},t.prototype.handleWherePartEvent=function(e,t,a,r){var n=this;switch(a.name){case"get-param-options":switch(a.param.name){case"left":return this.datasource.metricFindQuery(this.metaBuilder.buildColumnQuery()).then(this.transformToSegments({})).catch(this.handleQueryError.bind(this));case"right":return["int4","int8","float4","float8","timestamp","timestamptz"].indexOf(t.datatype)>-1?this.$q.when([]):this.datasource.metricFindQuery(this.metaBuilder.buildValueQuery(t.params[0])).then(this.transformToSegments({addTemplateVars:!0,templateQuoter:function(e){return n.queryModel.quoteLiteral(e)}})).catch(this.handleQueryError.bind(this));case"op":return this.$q.when(this.uiSegmentSrv.newOperators(this.metaBuilder.getOperators(t.datatype)));default:return this.$q.when([])}case"part-param-changed":this.updatePersistedParts(),this.datasource.metricFindQuery(this.metaBuilder.buildDatatypeQuery(t.params[0])).then(function(e){1===e.length&&(t.datatype=e[0].text)}),this.panelCtrl.refresh();break;case"action":e.splice(r,1),this.updatePersistedParts(),this.panelCtrl.refresh();break;case"get-part-actions":return this.$q.when([{text:"Remove",value:"remove-part"}])}},t.prototype.getWhereOptions=function(){var e=[];return this.queryModel.hasUnixEpochTimecolumn()?e.push(this.uiSegmentSrv.newSegment({type:"macro",value:"$__unixEpochFilter"})):e.push(this.uiSegmentSrv.newSegment({type:"macro",value:"$__timeFilter"})),e.push(this.uiSegmentSrv.newSegment({type:"expression",value:"Expression"})),this.$q.when(e)},t.prototype.addWhereAction=function(e,t){switch(this.whereAdd.type){case"macro":var a=qr.create({type:"macro",name:this.whereAdd.value,params:[]});this.whereParts.length>=1&&"macro"===this.whereParts[0].def.type?this.whereParts[0]=a:this.whereParts.splice(0,0,a);break;default:this.whereParts.push(qr.create({type:"expression",params:["value","=","value"]}))}this.updatePersistedParts(),this.resetPlusButton(this.whereAdd),this.panelCtrl.refresh()},t.prototype.getGroupOptions=function(){var e=this;return this.datasource.metricFindQuery(this.metaBuilder.buildColumnQuery("group")).then(function(t){var a=[];e.queryModel.hasTimeGroup()||a.push(e.uiSegmentSrv.newSegment({type:"time",value:"time($__interval,none)"}));for(var r=0,n=t;r<n.length;r++){var i=n[r];a.push(e.uiSegmentSrv.newSegment({type:"column",value:i.text}))}return a}).catch(this.handleQueryError.bind(this))},t.prototype.addGroupAction=function(){this.groupAdd.value,this.addGroup(this.groupAdd.type,this.groupAdd.value),this.resetPlusButton(this.groupAdd),this.panelCtrl.refresh()},t.prototype.handleQueryError=function(e){return this.error=e.message||"Failed to issue metric query",[]},t.templateUrl="partials/query.editor.html",t}(Ye),Lr=function(){function e(e,t){this.postgresVersions=[{name:"9.3",value:903},{name:"9.4",value:904},{name:"9.5",value:905},{name:"9.6",value:906},{name:"10",value:1e3}],this.datasourceSrv=t,this.current.jsonData.sslmode=this.current.jsonData.sslmode||"verify-full",this.current.jsonData.postgresVersion=this.current.jsonData.postgresVersion||903,this.showTimescaleDBHelp=!1,this.autoDetectFeatures()}return e.$inject=["$scope","datasourceSrv"],e.prototype.autoDetectFeatures=function(){var e=this;this.current.id&&this.datasourceSrv.loadDatasource(this.current.name).then(function(t){return t.getVersion().then(function(a){(a=Number(a[0].text))>=906&&t.getTimescaleDBVersion().then(function(t){1===t.length&&(e.current.jsonData.timescaledb=!0)});var r=Math.trunc(a/100),n=a%100,i=String(r);a<1e3&&(i=String(r)+"."+String(n)),A.a.find(e.postgresVersions,function(e){return e.value===a})||e.postgresVersions.push({name:i,value:a}),e.current.jsonData.postgresVersion=a})})},e.prototype.toggleTimescaleDBHelp=function(){this.showTimescaleDBHelp=!this.showTimescaleDBHelp},e.templateUrl="partials/config.html",e}(),Vr="SELECT\n  extract(epoch from time_column) AS time,\n  text_column as text,\n  tags_column as tags\nFROM\n  metric_table\nWHERE\n  $__timeFilter(time_column)\n",Ur=function(){function e(){this.annotation.rawQuery=this.annotation.rawQuery||Vr}return e.templateUrl="partials/annotations.editor.html",e}(),jr=function(){function e(e,t,a){this.datasource=e,this.query=t,this.range=a.timeRange()}return e.prototype.process=function(){var e=this.query.match(/^label_values\((?:(.+),\s*)?([a-zA-Z_][a-zA-Z0-9_]*)\)\s*$/);if(e)return e[1]?this.labelValuesQuery(e[2],e[1]):this.labelValuesQuery(e[2],null);var t=this.query.match(/^metrics\((.+)\)\s*$/);if(t)return this.metricNameQuery(t[1]);var a=this.query.match(/^query_result\((.+)\)\s*$/);return a?this.queryResultQuery(a[1]):this.metricNameAndLabelsQuery(this.query)},e.prototype.labelValuesQuery=function(e,t){var a;if(t){var r=this.datasource.getPrometheusTime(this.range.from,!1),n=this.datasource.getPrometheusTime(this.range.to,!0);return a="/api/v1/series?match[]="+encodeURIComponent(t)+"&start="+r+"&end="+n,this.datasource.metadataRequest(a).then(function(t){var a=A.a.map(t.data.data,function(t){return t[e]||""}).filter(function(e){return""!==e});return A.a.uniq(a).map(function(e){return{text:e,expandable:!0}})})}return a="/api/v1/label/"+e+"/values",this.datasource.metadataRequest(a).then(function(e){return A.a.map(e.data.data,function(e){return{text:e}})})},e.prototype.metricNameQuery=function(e){return this.datasource.metadataRequest("/api/v1/label/__name__/values").then(function(t){return A.a.chain(t.data.data).filter(function(t){return new RegExp(e).test(t)}).map(function(e){return{text:e,expandable:!0}}).value()})},e.prototype.queryResultQuery=function(e){var t=this.datasource.getPrometheusTime(this.range.to,!0);return this.datasource.performInstantQuery({expr:e},t).then(function(e){return A.a.map(e.data.data.result,function(e){var t=e.metric.__name__||"";return delete e.metric.__name__,t+="{"+A.a.map(e.metric,function(e,t){return t+'="'+e+'"'}).join(",")+"}",{text:t+=" "+e.value[1]+" "+1e3*e.value[0],expandable:!0}})})},e.prototype.metricNameAndLabelsQuery=function(e){var t=this.datasource.getPrometheusTime(this.range.from,!1),a=this.datasource.getPrometheusTime(this.range.to,!0),r="/api/v1/series?match[]="+encodeURIComponent(e)+"&start="+t+"&end="+a,n=this;return this.datasource.metadataRequest(r).then(function(e){return A.a.map(e.data.data,function(e){return{text:n.datasource.getOriginalMetricName(e),expandable:!0}})})},e}(),Br=function(){function e(e){this.templateSrv=e}return e.prototype.transform=function(e,t){var a=e.data.data.result;if("table"===t.format)return[this.transformMetricDataToTable(a,t.responseListLength,t.refId)];if("heatmap"===t.format){var r=[];a.sort(Qr);for(var n=0,i=a;n<i.length;n++){var s=i[n];r.push(this.transformMetricData(s,t,t.start,t.end))}return r=this.transformToHistogramOverTime(r)}r=[];for(var o=0,l=a;o<l.length;o++){s=l[o];"matrix"===e.data.data.resultType?r.push(this.transformMetricData(s,t,t.start,t.end)):"vector"===e.data.data.resultType&&r.push(this.transformInstantMetricData(s,t))}return r},e.prototype.transformMetricData=function(e,t,a,r){var n,i=[];n=this.createMetricLabel(e.metric,t);var s=1e3*parseInt(t.step,10),o=1e3*a;if(void 0===e.values)throw new Error("Prometheus heatmap error: data should be a time series");for(var l=0,u=e.values;l<u.length;l++){var c=u[l],h=parseFloat(c[1]);A.a.isNaN(h)&&(h=null);for(var p=1e3*parseFloat(c[0]),d=o;d<p;d+=s)i.push([null,d]);o=p+s,i.push([h,p])}var m=1e3*r;for(d=o;d<=m;d+=s)i.push([null,d]);return{datapoints:i,query:t.query,responseIndex:t.responseIndex,target:n}},e.prototype.transformMetricDataToTable=function(e,t,a){var r,n,i=new lt.a,s={};if(0===e.length)return i;A.a.each(e,function(e){for(var t in e.metric)s.hasOwnProperty(t)||(s[t]=1)});var o=A.a.keys(s).sort();i.columns.push({text:"Time",type:"time"}),A.a.each(o,function(e,t){s[e]=t+1,i.columns.push({text:e,filterable:!e.startsWith("__")})});var l=t>1?"Value #"+a:"Value";return i.columns.push({text:l}),A.a.each(e,function(e){if(e.value&&(e.values=[e.value]),e.values)for(r=0;r<e.values.length;r++){var t=e.values[r],a=[1e3*t[0]];if(e.metric)for(n=0;n<o.length;n++){var s=o[n];e.metric.hasOwnProperty(s)?a.push(e.metric[s]):a.push("")}a.push(parseFloat(t[1])),i.rows.push(a)}}),i},e.prototype.transformInstantMetricData=function(e,t){var a,r=[];return a=this.createMetricLabel(e.metric,t),r.push([parseFloat(e.value[1]),1e3*e.value[0]]),{target:a,datapoints:r,labels:e.metric}},e.prototype.createMetricLabel=function(e,t){var a="";return(a=A.a.isUndefined(t)||A.a.isEmpty(t.legendFormat)?this.getOriginalMetricName(e):this.renderTemplate(this.templateSrv.replace(t.legendFormat),e))&&"{}"!==a||(a=t.query),a},e.prototype.renderTemplate=function(e,t){return e.replace(/\{\{\s*(.+?)\s*\}\}/g,function(e,a){return t[a]?t[a]:a})},e.prototype.getOriginalMetricName=function(e){var t=e.__name__||"";return delete e.__name__,t+"{"+A.a.map(A.a.toPairs(e),function(e){return e[0]+'="'+e[1]+'"'}).join(",")+"}"},e.prototype.transformToHistogramOverTime=function(e){for(var t=e.length-1;t>0;t--){var a=e[t].datapoints,r=e[t-1].datapoints;if(!a||!r)throw new Error("Prometheus heatmap transform error: data should be a time series");for(var n=0;n<a.length;n++){var i=r[n]||[0];a[n][0]-=i[0]}}return e},e}();function Qr(e,t){var a,r;try{a=Hr(e.metric.le),r=Hr(t.metric.le)}catch(e){return console.log(e),0}return a>r?1:a<r?-1:0}function Hr(e){return"+Inf"===e?1/0:Number(e)}var zr="by|without|on|ignoring|group_left|group_right",Yr=[zr,"count|count_values|min|max|avg|sum|stddev|stdvar|bottomk|topk|quantile","true|false|null|__name__|job","abs|absent|ceil|changes|clamp_max|clamp_min|count_scalar|day_of_month|day_of_week|days_in_month|delta|deriv","drop_common_labels|exp|floor|histogram_quantile|holt_winters|hour|idelta|increase|irate|label_replace|ln|log2","log10|minute|month|predict_linear|rate|resets|round|scalar|sort|sort_desc|sqrt|time|vector|year|avg_over_time","min_over_time|max_over_time|sum_over_time|count_over_time|quantile_over_time|stddev_over_time|stdvar_over_time"].join("|").split("|"),Gr=/([A-Za-z:][\w:]*)\b(?![\(\]{=!",])/g,Wr=/{([^{]*)}/g;var Kr=/(\w+)\s*(=|!=|=~|!~)\s*("[^"]*")/g;function Jr(e,t,a,r){var n=[];if(e)for(var i=Kr.exec(e);i;)n.push({key:i[1],operator:i[2],value:i[3]}),i=Kr.exec(e);var s=r||"=";return n.push({key:t,operator:s,value:'"'+a+'"'}),A.a.chain(n).compact().sortBy("key").map(function(e){return""+e.key+e.operator+e.value}).value().join(",")}var Xr=function(e,t,a,r){if(!t||!a)throw new Error("Need label to add to query.");var n;e=e.replace(Gr,function(t,a,r){var i=function(e,t,a,r){var n=e.slice(t).indexOf(a),i=e.slice(t).indexOf(r);return i>-1&&(-1===n||n>i)}(e,r,"{","}"),s=n&&zr.split("|").indexOf(n)>-1;return n=a,i||s||-1!==Yr.indexOf(a)?a:a+"{}"});for(var i=Wr.exec(e),s=[],o=0,l="";i;){var u=e.slice(o,i.index),c=Jr(i[1],t,a,r);o=i.index+i[1].length+2,l=e.slice(i.index+i[0].length),s.push(u,"{",c,"}"),i=Wr.exec(e)}return s.push(l),s.join("")};function Zr(e){return"string"==typeof e?e.replace(/'/g,"\\\\'"):e}function en(e){return"string"==typeof e?Zr(e.replace(/\\/g,"\\\\\\\\").replace(/[$^*{}\[\]+?.()]/g,"\\\\$&")):e}var tn,an,rn=function(){function e(e,t,a,r,n){this.$q=t,this.backendSrv=a,this.templateSrv=r,this.timeSrv=n,this.type="prometheus",this.editorSrc="app/features/prometheus/partials/query.editor.html",this.name=e.name,this.url=e.url,this.directUrl=e.directUrl,this.basicAuth=e.basicAuth,this.withCredentials=e.withCredentials,this.interval=e.jsonData.timeInterval||"15s",this.queryTimeout=e.jsonData.queryTimeout,this.httpMethod=e.jsonData.httpMethod||"GET",this.resultTransformer=new Br(r),this.ruleMappings={}}return e.$inject=["instanceSettings","$q","backendSrv","templateSrv","timeSrv"],e.prototype.init=function(){this.loadRules()},e.prototype._request=function(e,t,a){return"GET"===(a=A.a.defaults(a||{},{url:this.url+e,method:this.httpMethod})).method?A.a.isEmpty(t)||(a.url=a.url+"?"+A.a.map(t,function(e,t){return encodeURIComponent(t)+"="+encodeURIComponent(e)}).join("&")):(a.headers={"Content-Type":"application/x-www-form-urlencoded"},a.transformRequest=function(e){return O.a.param(e)},a.data=t),(this.basicAuth||this.withCredentials)&&(a.withCredentials=!0),this.basicAuth&&(a.headers={Authorization:this.basicAuth}),this.backendSrv.datasourceRequest(a)},e.prototype.metadataRequest=function(e){return this._request(e,null,{method:"GET",silent:!0})},e.prototype.interpolateQueryExpr=function(e,t,a){return t.multi||t.includeAll?"string"==typeof e?en(e):A.a.map(e,en).join("|"):Zr(e)},e.prototype.targetContainsTemplate=function(e){return this.templateSrv.variableExists(e.expr)},e.prototype.query=function(e){for(var t=this,a=this.getPrometheusTime(e.range.from,!1),r=this.getPrometheusTime(e.range.to,!0),n=[],i=[],s=0,o=(e=A.a.clone(e)).targets;s<o.length;s++){var l=o[s];l.expr&&!l.hide&&(i.push(l),n.push(this.createQuery(l,e,a,r)))}if(A.a.isEmpty(n))return this.$q.when({data:[]});var u=A.a.map(n,function(e){return e.instant?t.performInstantQuery(e,r):t.performTimeSeriesQuery(e,e.start,e.end)});return this.$q.all(u).then(function(e){var a=[],r=[];return A.a.each(e,function(s,o){if("error"===s.status)throw Ve.a({index:o},s.error);var l={format:i[o].format,step:n[o].step,legendFormat:i[o].legendFormat,start:n[o].start,end:n[o].end,query:n[o].expr,responseListLength:e.length,responseIndex:o,refId:i[o].refId},u=t.resultTransformer.transform(s,l);if(a=a.concat(u),n[o].hinting){var c=function(e,t){return e.map(function(e,a){var r=e.query,n=e.responseIndex;if(void 0===r||void 0===n)return null;if(r.trim().match(/^\w+_bucket$/))return{index:n,label:l="Time series has buckets, you probably wanted a histogram.",fix:{label:"Fix by adding histogram_quantile().",action:{type:"ADD_HISTOGRAM_QUANTILE",query:r,index:n}}};var i=e.datapoints;if(-1===r.indexOf("rate(")&&i.length>1){var s=!1,o=i.filter(function(e){return null!==e[0]}).every(function(e,t){return 0===t||(s=s||e[0]>i[t-1][0],e[0]>=i[t-1][0])});if(s&&o){var l="Time series is monotonously increasing.",u=void 0;return r.trim().match(/^\w+$/)?u={label:"Fix by adding rate().",action:{type:"ADD_RATE",query:r,index:n}}:l+=" Try applying a rate() function.",{label:l,index:n,fix:u}}}if(t&&t.ruleMappings){var c=t.ruleMappings,h=Object.keys(c).reduce(function(e,t){var a;return r.search(t)>-1?Ve.a({},e,((a={})[t]=c[t],a)):e},{});if(A.a.size(h)>0)return{label:l="Query contains recording rules.",index:n,fix:{label:"Expand rules",action:{type:"EXPAND_RULES",query:r,index:n,mapping:h}}}}return null})}(u,t);r=r.concat(c)}}),{data:a,hints:r}})},e.prototype.createQuery=function(e,t,a,r){var n={hinting:e.hinting,instant:e.instant},i=Math.ceil(r-a),s=ie.a.interval_to_seconds(t.interval),o=ie.a.interval_to_seconds(this.templateSrv.replace(e.interval,t.scopedVars)||t.interval),l=e.intervalFactor||1,u=this.adjustInterval(s,o,i,l),c=Ve.a({},t.scopedVars,this.getRangeScopedVars());s!==u&&(s=u,c=Object.assign({},t.scopedVars,Ve.a({__interval:{text:s+"s",value:s+"s"},__interval_ms:{text:1e3*s,value:1e3*s}},this.getRangeScopedVars()))),n.step=s;var h=e.expr;h=this.templateSrv.getAdhocFilters(this.name).reduce(function(e,t){var a=t.key,r=t.operator,n=t.value;return"=~"!==r&&"!~"!==r||(n=en(n)),Xr(e,a,n,r)},h),n.expr=this.templateSrv.replace(h,c,this.interpolateQueryExpr),n.requestId=t.panelId+e.refId;var p=function(e,t,a){return{end:Math.ceil(t/a)*a,start:Math.floor(e/a)*a}}(a,r,n.step);return n.start=p.start,n.end=p.end,n},e.prototype.adjustInterval=function(e,t,a,r){return 0!==e&&a/r/e>11e3&&(e=Math.ceil(a/r/11e3)),Math.max(e*r,t,1)},e.prototype.performTimeSeriesQuery=function(e,t,a){if(t>a)throw{message:"Invalid time range"};var r={query:e.expr,start:t,end:a,step:e.step};return this.queryTimeout&&(r.timeout=this.queryTimeout),this._request("/api/v1/query_range",r,{requestId:e.requestId})},e.prototype.performInstantQuery=function(e,t){var a={query:e.expr,time:t};return this.queryTimeout&&(a.timeout=this.queryTimeout),this._request("/api/v1/query",a,{requestId:e.requestId})},e.prototype.performSuggestQuery=function(e,t){var a=this;void 0===t&&(t=!1);return t&&this.metricsNameCache&&this.metricsNameCache.expire>Date.now()?this.$q.when(A.a.filter(this.metricsNameCache.data,function(t){return 1!==t.indexOf(e)})):this.metadataRequest("/api/v1/label/__name__/values").then(function(t){return a.metricsNameCache={data:t.data.data,expire:Date.now()+6e4},A.a.filter(t.data.data,function(t){return 1!==t.indexOf(e)})})},e.prototype.metricFindQuery=function(e){if(!e)return this.$q.when([]);var t=Ve.a({__interval:{text:this.interval,value:this.interval},__interval_ms:{text:ie.a.interval_to_ms(this.interval),value:ie.a.interval_to_ms(this.interval)}},this.getRangeScopedVars()),a=this.templateSrv.replace(e,t,this.interpolateQueryExpr);return new jr(this,a,this.timeSrv).process()},e.prototype.getRangeScopedVars=function(){var e=this.timeSrv.timeRange(),t=e.to.diff(e.from),a=Math.round(t/1e3),r=ie.a.secondsToHms(t/1e3);return{__range_ms:{text:t,value:t},__range_s:{text:a,value:a},__range:{text:r,value:r}}},e.prototype.annotationQuery=function(e){var t=e.annotation,a=t.expr||"",r=t.tagKeys||"",n=t.titleFormat||"",i=t.textFormat||"";if(!a)return this.$q.when([]);var s=t.step||"60s",o=this.getPrometheusTime(e.range.from,!1),l=this.getPrometheusTime(e.range.to,!0),u=Ve.a({},e,{interval:"0s"}),c=this.createQuery({expr:a,interval:s},u,o,l),h=this;return this.performTimeSeriesQuery(c,c.start,c.end).then(function(e){var a=[];return r=r.split(","),A.a.each(e.data.data.result,function(e){for(var s=A.a.chain(e.metric).filter(function(e,t){return A.a.includes(r,t)}).value(),o=0,l=e.values;o<l.length;o++){var u=l[o];if("1"===u[1]||t.useValueForTime){var c={annotation:t,title:h.resultTransformer.renderTemplate(n,e.metric),tags:s,text:h.resultTransformer.renderTemplate(i,e.metric)};t.useValueForTime?c.time=Math.floor(parseFloat(u[1])):c.time=1e3*Math.floor(parseFloat(u[0])),a.push(c)}}}),a})},e.prototype.testDatasource=function(){var e=(new Date).getTime();return this.performInstantQuery({expr:"1+1"},e/1e3).then(function(e){return"success"===e.data.status?{status:"success",message:"Data source is working"}:{status:"error",message:e.error}})},e.prototype.getExploreState=function(e){var t=this,a={};if(e&&e.length>0){var r=e.map(function(e){return{query:t.templateSrv.replace(e.expr,{},t.interpolateQueryExpr),format:e.format}});a=Ve.a({},a,{queries:r,datasource:this.name})}return a},e.prototype.loadRules=function(){var e=this;this.metadataRequest("/api/v1/rules").then(function(e){return e.data||e.json()}).then(function(t){var a=A.a.get(t,["data","groups"]);a&&(e.ruleMappings=function(e){return e.reduce(function(e,t){return t.rules.filter(function(e){return"recording"===e.type}).reduce(function(e,t){var a;return Ve.a({},e,((a={})[t.name]=t.query,a))},e)},{})}(a))}).catch(function(e){console.log("Rules API is experimental. Ignore next error."),console.error(e)})},e.prototype.modifyQuery=function(e,t){switch(t.type){case"ADD_FILTER":return Xr(e,t.key,t.value);case"ADD_HISTOGRAM_QUANTILE":return"histogram_quantile(0.95, sum(rate("+e+"[5m])) by (le))";case"ADD_RATE":return"rate("+e+"[5m])";case"EXPAND_RULES":var a=t.mapping;if(a){var r=Object.keys(a),n=new RegExp("(\\s|^)("+r.join("|")+")(\\s|$|\\()","ig");return e.replace(n,function(e,t,r,n){return a[r]})}default:return e}},e.prototype.getPrometheusTime=function(e,t){return A.a.isString(e)&&(e=je.parse(e,t)),Math.ceil(e.valueOf()/1e3)},e.prototype.getTimeRange=function(){var e=this.timeSrv.timeRange();return{start:this.getPrometheusTime(e.from,!1),end:this.getPrometheusTime(e.to,!0)}},e.prototype.getOriginalMetricName=function(e){return this.resultTransformer.getOriginalMetricName(e)},e}(),nn=function(){function e(e,t){this.datasource=e,this.templateSrv=t,this.identifierRegexps=[/\[/,/[a-zA-Z0-9_:]/],this.labelQueryCache={},this.labelNameCache={},this.labelValueCache={},this.templateVariableCompletions=this.templateSrv.variables.map(function(e){return{caption:"$"+e.name,value:"$"+e.name,meta:"variable",score:Number.MAX_VALUE}})}return e.prototype.getCompletions=function(e,t,a,r,n){var i=this,s=function(e,t){return t=t.concat(i.templateVariableCompletions),n(e,t)},o=t.getTokenAt(a.row,a.column);switch(o.type){case"entity.name.tag.label-matcher":return void this.getCompletionsForLabelMatcherName(t,a).then(function(e){s(null,e)});case"string.quoted.label-matcher":return void this.getCompletionsForLabelMatcherValue(t,a).then(function(e){s(null,e)});case"entity.name.tag.label-list-matcher":return void this.getCompletionsForBinaryOperator(t,a).then(function(e){s(null,e)})}if("paren.lparen"===o.type&&"["===o.value){for(var l=[],u=0,c=["s","m","h"];u<c.length;u++)for(var h=c[u],p=0,d=[1,5,10,30];p<d.length;p++){var m=d[p];l.push({caption:m+h,value:"["+m+h,meta:"range vector"})}return l.unshift({caption:"$__interval_ms",value:"[$__interval_ms",meta:"range vector"}),l.unshift({caption:"$__interval",value:"[$__interval",meta:"range vector"}),void s(null,l)}var f=r;return this.datasource.performSuggestQuery(f,!0).then(function(e){s(null,e.map(function(e){var t=e;return"("===r&&(t="("+e),{caption:e,value:t,meta:"metric"}}))})},e.prototype.getCompletionsForLabelMatcherName=function(e,t){var a=this,r=this.findMetricName(e,t.row,t.column);return r?this.labelNameCache[r]?Promise.resolve(this.labelNameCache[r]):this.getLabelNameAndValueForExpression(r,"metricName").then(function(e){var t=a.transformToCompletions(A.a.uniq(A.a.flatten(e.map(function(e){return Object.keys(e)}))),"label name");return a.labelNameCache[r]=t,Promise.resolve(t)}):Promise.resolve(this.transformToCompletions(["__name__","instance","job"],"label name"))},e.prototype.getCompletionsForLabelMatcherValue=function(e,t){var a=this,r=this.findMetricName(e,t.row,t.column);if(!r)return Promise.resolve([]);var n=this.findToken(e,t.row,t.column,"entity.name.tag.label-matcher",null,"paren.lparen.label-matcher");if(!n)return Promise.resolve([]);var i=n.value;return this.labelValueCache[r]&&this.labelValueCache[r][i]?Promise.resolve(this.labelValueCache[r][i]):this.getLabelNameAndValueForExpression(r,"metricName").then(function(e){var t=a.transformToCompletions(A.a.uniq(e.map(function(e){return e[i]})),"label value");return a.labelValueCache[r]=a.labelValueCache[r]||{},a.labelValueCache[r][i]=t,Promise.resolve(t)})},e.prototype.getCompletionsForBinaryOperator=function(e,t){var a,r,n=this,i=this.findToken(e,t.row,t.column,"keyword.control",null,"identifier");if(!i)return Promise.resolve([]);switch(i.value){case"by":case"without":return(a=this.findToken(e,i.row,i.column,"paren.rparen",null,"identifier"))?""===(r=this.findExpressionMatchedParen(e,a.row,a.column))?Promise.resolve([]):this.getLabelNameAndValueForExpression(r,"expression").then(function(e){var t=n.transformToCompletions(A.a.uniq(A.a.flatten(e.map(function(e){return Object.keys(e)}))),"label name");return n.labelNameCache[r]=t,t}):Promise.resolve([]);case"on":case"ignoring":case"group_left":case"group_right":var s=this.findToken(e,i.row,i.column,"keyword.operator.binary",null,"identifier");if(!s)return Promise.resolve([]);if(a=this.findToken(e,s.row,s.column,"paren.rparen",null,"identifier"))return""===(r=this.findExpressionMatchedParen(e,a.row,a.column))?Promise.resolve([]):this.getLabelNameAndValueForExpression(r,"expression").then(function(e){var t=n.transformToCompletions(A.a.uniq(A.a.flatten(e.map(function(e){return Object.keys(e)}))),"label name");return n.labelNameCache[r]=t,t});var o=this.findMetricName(e,s.row,s.column);return this.getLabelNameAndValueForExpression(o,"metricName").then(function(e){var t=n.transformToCompletions(A.a.uniq(A.a.flatten(e.map(function(e){return Object.keys(e)}))),"label name");return n.labelNameCache[o]=t,Promise.resolve(t)})}return Promise.resolve([])},e.prototype.getLabelNameAndValueForExpression=function(e,t){var a=this;if(this.labelQueryCache[e])return Promise.resolve(this.labelQueryCache[e]);var r=e;if("metricName"===t){var n="=~";/[a-zA-Z_:][a-zA-Z0-9_:]*/.test(e)&&(n="="),r="{__name__"+n+'"'+e+'"}'}var i=this.datasource.getTimeRange(),s=i.start,o=i.end,l="/api/v1/series?match[]="+encodeURIComponent(r)+"&start="+s+"&end="+o;return this.datasource.metadataRequest(l).then(function(t){return a.labelQueryCache[e]=t.data.data,t.data.data})},e.prototype.transformToCompletions=function(e,t){return e.map(function(e){return{caption:e,value:e,meta:t,score:Number.MAX_VALUE}})},e.prototype.findMetricName=function(e,t,a){var r="",n=this.findToken(e,t,a,"entity.name.tag.label-matcher","__name__","paren.lparen.label-matcher");if(n){var i=e.getTokens(n.row)[n.index+2];i&&"string.quoted.label-matcher"===i.type&&(r=i.value.slice(1,-1))}else{var s=this.findToken(e,t,a,"identifier",null,null);s&&(e.getTokens(s.row),r=s.value)}return r},e.prototype.findToken=function(e,t,a,r,n,i){for(var s,o,l=t;l>=0;l--){var u=void 0;if(s=e.getTokens(l),l===t)for(u=0,o=0;o<s.length;o++){var c=u+s[o].value.length;if(c>=a)break;u=c}else o=s.length-1,u=A.a.sum(s.map(function(e){return e.value.length}))-s[s.length-1].value.length;for(;o>=0;o--){if(s[o].type===i)return null;if(s[o].type===r&&(!n||s[o].value===n))return s[o].row=l,s[o].column=u,s[o].index=o,s[o];u-=s[o].value.length}}return null},e.prototype.findExpressionMatchedParen=function(e,t,a){for(var r,n,i=1,s=")",o=t;o>=0;o--){if(r=e.getTokens(o),o===t){var l=0;for(n=0;n<r.length&&!((l+=r[n].value.length)>=a);n++);}else n=r.length-1;for(;n>=0;n--)if(s=r[n].value+s,"paren.rparen"===r[n].type)i++;else if("paren.lparen"===r[n].type&&0===--i)return s}return s},e}(),sn=(a(1249),a(1250),function(e){function t(t,a,r){var n=e.call(this,t,a)||this;n.templateSrv=r;var i=n.target;return i.expr=i.expr||"",i.intervalFactor=i.intervalFactor||1,i.format=i.format||n.getDefaultFormat(),n.metric="",n.resolutions=A.a.map([1,2,3,4,5,10],function(e){return{factor:e,label:"1/"+e}}),n.formats=[{text:"Time series",value:"time_series"},{text:"Table",value:"table"},{text:"Heatmap",value:"heatmap"}],n.instant=!1,n.updateLink(),n}return t.$inject=["$scope","$injector","templateSrv"],Ve.c(t,e),t.prototype.getCompleter=function(e){return new nn(this.datasource,this.templateSrv)},t.prototype.getDefaultFormat=function(){return"table"===this.panelCtrl.panel.type?"table":"heatmap"===this.panelCtrl.panel.type?"heatmap":"time_series"},t.prototype.refreshMetricData=function(){A.a.isEqual(this.oldTarget,this.target)||(this.oldTarget=D.a.copy(this.target),this.panelCtrl.refresh(),this.updateLink())},t.prototype.updateLink=function(){var e=this.panelCtrl.range;if(e){var t=Math.ceil((e.to.valueOf()-e.from.valueOf())/1e3),a=e.to.utc().format("YYYY-MM-DD HH:mm"),r={"g0.expr":this.templateSrv.replace(this.target.expr,this.panelCtrl.panel.scopedVars,this.datasource.interpolateQueryExpr),"g0.range_input":t+"s","g0.end_input":a,"g0.step_input":this.target.step,"g0.stacked":this.panelCtrl.panel.stack?1:0,"g0.tab":0},n=A.a.map(r,function(e,t){return t+"="+encodeURIComponent(e)}).join("&");this.linkToPrometheus=this.datasource.directUrl+"/graph?"+n}},t.prototype.getCollapsedText=function(){return this.target.expr},t.templateUrl="partials/query.editor.html",t}(Ye)),on=function(){function e(e){this.current.jsonData.httpMethod=this.current.jsonData.httpMethod||"GET"}return e.$inject=["$scope"],e.templateUrl="public/app/plugins/datasource/prometheus/partials/config.html",e}(),ln=function(){function e(){}return e.templateUrl="partials/annotations.editor.html",e}(),un=function(){function e(e){this.$q=e}return e.prototype.processQueryResult=function(e){var t=[];if(!e.data.results)return{data:t};for(var a in e.data.results){var r=e.data.results[a];if(r.series)for(var n=0,i=r.series;n<i.length;n++){var s=i[n];t.push({target:s.name,datapoints:s.points,refId:r.refId,meta:r.meta})}if(r.tables)for(var o=0,l=r.tables;o<l.length;o++){var u=l[o];u.type="table",u.refId=r.refId,u.meta=r.meta,t.push(u)}}return{data:t}},e.prototype.parseMetricFindQueryResult=function(e,t){if(!t||0===t.data.length||0===t.data.results[e].meta.rowCount)return[];var a=t.data.results[e].tables[0].columns,r=t.data.results[e].tables[0].rows,n=this.findColIndex(a,"__text"),i=this.findColIndex(a,"__value");return 2===a.length&&-1!==n&&-1!==i?this.transformToKeyValueList(r,n,i):this.transformToSimpleList(r)},e.prototype.transformToKeyValueList=function(e,t,a){for(var r=[],n=0;n<e.length;n++)this.containsKey(r,e[n][t])||r.push({text:e[n][t],value:e[n][a]});return r},e.prototype.transformToSimpleList=function(e){for(var t=[],a=0;a<e.length;a++)for(var r=0;r<e[a].length;r++){var n=e[a][r];-1===t.indexOf(n)&&t.push(n)}return A.a.map(t,function(e){return{text:e}})},e.prototype.findColIndex=function(e,t){for(var a=0;a<e.length;a++)if(e[a].text===t)return a;return-1},e.prototype.containsKey=function(e,t){for(var a=0;a<e.length;a++)if(e[a].text===t)return!0;return!1},e.prototype.transformAnnotationResponse=function(e,t){for(var a=t.data.results[e.annotation.name].tables[0],r=-1,n=-1,i=-1,s=0;s<a.columns.length;s++)"time"===a.columns[s].text?r=s:"text"===a.columns[s].text?n=s:"tags"===a.columns[s].text&&(i=s);if(-1===r)return this.$q.reject({message:"Missing mandatory time column (with time column alias) in annotation query."});var o=[];for(s=0;s<a.rows.length;s++){var l=a.rows[s];o.push({annotation:e.annotation,time:Math.floor(l[r]),text:l[n],tags:l[i]?l[i].trim().split(/\s*,\s*/):[]})}return o},e}(),cn=function(){function e(e,t,a,r){this.backendSrv=t,this.$q=a,this.templateSrv=r,this.name=e.name,this.id=e.id,this.responseParser=new un(this.$q),this.interval=(e.jsonData||{}).timeInterval}return e.$inject=["instanceSettings","backendSrv","$q","templateSrv"],e.prototype.interpolateVariable=function(e,t){return"string"==typeof e?t.multi||t.includeAll?"'"+e.replace(/'/g,"''")+"'":e:"number"==typeof e?e:A.a.map(e,function(t){return"number"==typeof e?e:"'"+t.replace(/'/g,"''")+"'"}).join(",")},e.prototype.query=function(e){var t=this,a=A.a.filter(e.targets,function(e){return!0!==e.hide}).map(function(a){return{refId:a.refId,intervalMs:e.intervalMs,maxDataPoints:e.maxDataPoints,datasourceId:t.id,rawSql:t.templateSrv.replace(a.rawSql,e.scopedVars,t.interpolateVariable),format:a.format}});return 0===a.length?this.$q.when({data:[]}):this.backendSrv.datasourceRequest({url:"/api/tsdb/query",method:"POST",data:{from:e.range.from.valueOf().toString(),to:e.range.to.valueOf().toString(),queries:a}}).then(this.responseParser.processQueryResult)},e.prototype.annotationQuery=function(e){var t=this;if(!e.annotation.rawQuery)return this.$q.reject({message:"Query missing in annotation definition"});var a={refId:e.annotation.name,datasourceId:this.id,rawSql:this.templateSrv.replace(e.annotation.rawQuery,e.scopedVars,this.interpolateVariable),format:"table"};return this.backendSrv.datasourceRequest({url:"/api/tsdb/query",method:"POST",data:{from:e.range.from.valueOf().toString(),to:e.range.to.valueOf().toString(),queries:[a]}}).then(function(a){return t.responseParser.transformAnnotationResponse(e,a)})},e.prototype.metricFindQuery=function(e,t){var a=this,r="tempvar";t&&t.variable&&t.variable.name&&(r=t.variable.name);var n={refId:r,datasourceId:this.id,rawSql:this.templateSrv.replace(e,{},this.interpolateVariable),format:"table"};return this.backendSrv.datasourceRequest({url:"/api/tsdb/query",method:"POST",data:{queries:[n]}}).then(function(e){return a.responseParser.parseMetricFindQueryResult(r,e)})},e.prototype.testDatasource=function(){return this.backendSrv.datasourceRequest({url:"/api/tsdb/query",method:"POST",data:{from:"5m",to:"now",queries:[{refId:"A",intervalMs:1,maxDataPoints:1,datasourceId:this.id,rawSql:"SELECT 1",format:"table"}]}}).then(function(e){return{status:"success",message:"Database Connection OK"}}).catch(function(e){return console.log(e),e.data&&e.data.message?{status:"error",message:e.data.message}:{status:"error",message:e.status}})},e}(),hn="SELECT\n  $__timeEpoch(<time_column>),\n  <value column> as value,\n  <series name column> as metric\nFROM\n  <table name>\nWHERE\n  $__timeFilter(time_column)\nORDER BY\n  <time_column> ASC",pn=function(e){function t(t,a){var r=e.call(this,t,a)||this;return r.target.format=r.target.format||"time_series",r.target.alias="",r.formats=[{text:"Time series",value:"time_series"},{text:"Table",value:"table"}],r.target.rawSql||("table"===r.panelCtrl.panel.type?(r.target.format="table",r.target.rawSql="SELECT 1"):r.target.rawSql=hn),r.panelCtrl.events.on("data-received",r.onDataReceived.bind(r),t),r.panelCtrl.events.on("data-error",r.onDataError.bind(r),t),r}return t.$inject=["$scope","$injector"],Ve.c(t,e),t.prototype.onDataReceived=function(e){this.lastQueryMeta=null,this.lastQueryError=null;var t=A.a.find(e,{refId:this.target.refId});t&&(this.lastQueryMeta=t.meta)},t.prototype.onDataError=function(e){if(e.data&&e.data.results){var t=e.data.results[this.target.refId];t&&(this.lastQueryMeta=t.meta,this.lastQueryError=t.error)}},t.templateUrl="partials/query.editor.html",t}(Ye),dn=function(){function e(){}return e.templateUrl="partials/config.html",e}(),mn="SELECT\n    <time_column> as time,\n    <text_column> as text,\n    <tags_column> as tags\n  FROM\n    <table name>\n  WHERE\n    $__timeFilter(time_column)\n  ORDER BY\n    <time_column> ASC",fn=function(){function e(){this.annotation.rawQuery=this.annotation.rawQuery||mn}return e.templateUrl="partials/annotations.editor.html",e}(),gn=function(){function e(e,t,a){this.backendSrv=t,this.$q=a,this.id=e.id}return e.$inject=["instanceSettings","backendSrv","$q"],e.prototype.query=function(e){var t=this,a=A.a.filter(e.targets,function(e){return!0!==e.hide}).map(function(a){return{refId:a.refId,scenarioId:a.scenarioId,intervalMs:e.intervalMs,maxDataPoints:e.maxDataPoints,stringInput:a.stringInput,points:a.points,alias:a.alias,datasourceId:t.id}});return 0===a.length?this.$q.when({data:[]}):this.backendSrv.post("/api/tsdb/query",{from:e.range.from.valueOf().toString(),to:e.range.to.valueOf().toString(),queries:a}).then(function(e){var t=[];return e.results&&A.a.forEach(e.results,function(e){for(var a=0,r=e.series;a<r.length;a++){var n=r[a];t.push({target:n.name,datapoints:n.points})}}),{data:t}})},e.prototype.annotationQuery=function(e){return this.backendSrv.get("/api/annotations",{from:e.range.from.valueOf(),to:e.range.to.valueOf(),limit:e.limit,type:e.type})},e}(),vn=function(e){function t(t,a,r){var n=e.call(this,t,a)||this;return n.backendSrv=r,n.target.scenarioId=n.target.scenarioId||"random_walk",n.scenarioList=[],n.newPointTime=U()(),n.selectedPoint={text:"Select point",value:null},n}return t.$inject=["$scope","$injector","backendSrv"],Ve.c(t,e),t.prototype.getPoints=function(){return A.a.map(this.target.points,function(e,t){return{text:U()(e[1]).format("MMMM Do YYYY, H:mm:ss")+" : "+e[0],value:t}})},t.prototype.pointSelected=function(e){this.selectedPoint=e},t.prototype.deletePoint=function(){this.target.points.splice(this.selectedPoint.value,1),this.selectedPoint={text:"Select point",value:null},this.refresh()},t.prototype.addPoint=function(){this.target.points=this.target.points||[],this.target.points.push([this.newPointValue,this.newPointTime.valueOf()]),this.target.points=A.a.sortBy(this.target.points,function(e){return e[1]}),this.refresh()},t.prototype.$onInit=function(){var e=this;return this.backendSrv.get("/api/tsdb/testdata/scenarios").then(function(t){e.scenarioList=t,e.scenario=A.a.find(e.scenarioList,{id:e.target.scenarioId})})},t.prototype.scenarioChanged=function(){this.scenario=A.a.find(this.scenarioList,{id:this.target.scenarioId}),this.target.stringInput=this.scenario.stringInput,"manual_entry"===this.target.scenarioId?this.target.points=this.target.points||[]:delete this.target.points,this.refresh()},t.templateUrl="partials/query.editor.html",t}(Ye),yn=function(){function e(){}return e.template="<h2>test data</h2>",e}();!function(e){e.METRIC_KIND_UNSPECIFIED="METRIC_KIND_UNSPECIFIED",e.GAUGE="GAUGE",e.DELTA="DELTA",e.CUMULATIVE="CUMULATIVE"}(tn||(tn={})),function(e){e.VALUE_TYPE_UNSPECIFIED="VALUE_TYPE_UNSPECIFIED",e.BOOL="BOOL",e.INT64="INT64",e.DOUBLE="DOUBLE",e.STRING="STRING",e.DISTRIBUTION="DISTRIBUTION",e.MONEY="MONEY"}(an||(an={}));var bn=[{text:"delta",value:"ALIGN_DELTA",valueTypes:[an.INT64,an.DOUBLE,an.MONEY,an.DISTRIBUTION],metricKinds:[tn.CUMULATIVE,tn.DELTA]},{text:"rate",value:"ALIGN_RATE",valueTypes:[an.INT64,an.DOUBLE,an.MONEY],metricKinds:[tn.CUMULATIVE,tn.DELTA]},{text:"interpolate",value:"ALIGN_INTERPOLATE",valueTypes:[an.INT64,an.DOUBLE,an.MONEY],metricKinds:[tn.GAUGE]},{text:"next older",value:"ALIGN_NEXT_OLDER",valueTypes:[an.INT64,an.DOUBLE,an.MONEY,an.DISTRIBUTION,an.STRING,an.VALUE_TYPE_UNSPECIFIED,an.BOOL],metricKinds:[tn.GAUGE]},{text:"min",value:"ALIGN_MIN",valueTypes:[an.INT64,an.DOUBLE,an.MONEY],metricKinds:[tn.GAUGE,tn.DELTA]},{text:"max",value:"ALIGN_MAX",valueTypes:[an.INT64,an.DOUBLE,an.MONEY],metricKinds:[tn.GAUGE,tn.DELTA]},{text:"mean",value:"ALIGN_MEAN",valueTypes:[an.INT64,an.DOUBLE,an.MONEY],metricKinds:[tn.GAUGE,tn.DELTA]},{text:"count",value:"ALIGN_COUNT",valueTypes:[an.INT64,an.DOUBLE,an.MONEY,an.BOOL],metricKinds:[tn.GAUGE,tn.DELTA]},{text:"sum",value:"ALIGN_SUM",valueTypes:[an.INT64,an.DOUBLE,an.MONEY,an.DISTRIBUTION],metricKinds:[tn.GAUGE,tn.DELTA]},{text:"stddev",value:"ALIGN_STDDEV",valueTypes:[an.INT64,an.DOUBLE,an.MONEY],metricKinds:[tn.GAUGE,tn.DELTA]},{text:"count true",value:"ALIGN_COUNT_TRUE",valueTypes:[an.BOOL],metricKinds:[tn.GAUGE]},{text:"count false",value:"ALIGN_COUNT_FALSE",valueTypes:[an.BOOL],metricKinds:[tn.GAUGE]},{text:"fraction true",value:"ALIGN_FRACTION_TRUE",valueTypes:[an.BOOL],metricKinds:[tn.GAUGE]},{text:"percentile 99",value:"ALIGN_PERCENTILE_99",valueTypes:[an.DISTRIBUTION],metricKinds:[tn.GAUGE,tn.DELTA]},{text:"percentile 95",value:"ALIGN_PERCENTILE_95",valueTypes:[an.DISTRIBUTION],metricKinds:[tn.GAUGE,tn.DELTA]},{text:"percentile 50",value:"ALIGN_PERCENTILE_50",valueTypes:[an.DISTRIBUTION],metricKinds:[tn.GAUGE,tn.DELTA]},{text:"percentile 05",value:"ALIGN_PERCENTILE_05",valueTypes:[an.DISTRIBUTION],metricKinds:[tn.GAUGE,tn.DELTA]},{text:"percent change",value:"ALIGN_PERCENT_CHANGE",valueTypes:[an.INT64,an.DOUBLE,an.MONEY],metricKinds:[tn.GAUGE,tn.DELTA]}],Sn=[{text:"none",value:"REDUCE_NONE",valueTypes:[an.INT64,an.DOUBLE,an.MONEY,an.DISTRIBUTION,an.BOOL,an.STRING],metricKinds:[tn.GAUGE,tn.DELTA,tn.CUMULATIVE,tn.METRIC_KIND_UNSPECIFIED]},{text:"mean",value:"REDUCE_MEAN",valueTypes:[an.INT64,an.DOUBLE,an.MONEY],metricKinds:[tn.GAUGE,tn.DELTA]},{text:"min",value:"REDUCE_MIN",valueTypes:[an.INT64,an.DOUBLE,an.MONEY],metricKinds:[tn.GAUGE,tn.DELTA]},{text:"max",value:"REDUCE_MAX",valueTypes:[an.INT64,an.DOUBLE,an.MONEY],metricKinds:[tn.GAUGE,tn.DELTA]},{text:"sum",value:"REDUCE_SUM",valueTypes:[an.INT64,an.DOUBLE,an.MONEY,an.DISTRIBUTION],metricKinds:[tn.GAUGE,tn.DELTA]},{text:"std. dev.",value:"REDUCE_STDDEV",valueTypes:[an.INT64,an.DOUBLE,an.MONEY,an.DISTRIBUTION],metricKinds:[tn.GAUGE,tn.DELTA]},{text:"count",value:"REDUCE_COUNT",valueTypes:[an.INT64,an.DOUBLE,an.MONEY,an.DISTRIBUTION,an.BOOL,an.STRING],metricKinds:[tn.GAUGE,tn.DELTA]},{text:"count true",value:"REDUCE_COUNT_TRUE",valueTypes:[an.BOOL],metricKinds:[tn.GAUGE,tn.DELTA]},{text:"count false",value:"REDUCE_COUNT_FALSE",valueTypes:[an.BOOL],metricKinds:[tn.GAUGE,tn.DELTA]},{text:"99th percentile",value:"REDUCE_PERCENTILE_99",valueTypes:[an.INT64,an.DOUBLE,an.MONEY,an.DISTRIBUTION],metricKinds:[tn.GAUGE,tn.DELTA]},{text:"95th percentile",value:"REDUCE_PERCENTILE_95",valueTypes:[an.INT64,an.DOUBLE,an.MONEY,an.DISTRIBUTION],metricKinds:[tn.GAUGE,tn.DELTA]},{text:"50th percentile",value:"REDUCE_PERCENTILE_50",valueTypes:[an.INT64,an.DOUBLE,an.MONEY,an.DISTRIBUTION],metricKinds:[tn.GAUGE,tn.DELTA]},{text:"5th percentile",value:"REDUCE_PERCENTILE_05",valueTypes:[an.INT64,an.DOUBLE,an.MONEY,an.DISTRIBUTION],metricKinds:[tn.GAUGE,tn.DELTA]}],xn=[{text:"grafana auto",value:"grafana-auto"},{text:"stackdriver auto",value:"stackdriver-auto"},{text:"1m",value:"+60s"},{text:"5m",value:"+300s"},{text:"30m",value:"+1800s"},{text:"1h",value:"+3600s"},{text:"6h",value:"+21600s"},{text:"1d",value:"+86400s"},{text:"1w",value:"+604800s"}],wn={bit:"bits",By:"bytes",s:"s",min:"m",h:"h",d:"d",us:"µs",ms:"ms",ns:"ns",percent:"percent",MiBy:"mbytes","By/s":"Bps",GBy:"decgbytes"},Tn=function(){function e(e,t,a,r){this.backendSrv=t,this.templateSrv=a,this.timeSrv=r,this.baseUrl="/stackdriver/",this.url=e.url,this.doRequest=this.doRequest,this.id=e.id,this.projectName=e.jsonData.defaultProject||""}return e.$inject=["instanceSettings","backendSrv","templateSrv","timeSrv"],e.prototype.getTimeSeries=function(e){return Ve.b(this,void 0,void 0,function(){var t,a=this;return Ve.d(this,function(r){switch(r.label){case 0:return t=e.targets.filter(function(e){return!e.hide&&e.metricType}).map(function(t){return t.hasOwnProperty("aggregation")||(t.aggregation={crossSeriesReducer:"REDUCE_MEAN",groupBys:[]}),{refId:t.refId,intervalMs:e.intervalMs,datasourceId:a.id,metricType:a.templateSrv.replace(t.metricType,e.scopedVars||{}),primaryAggregation:a.templateSrv.replace(t.aggregation.crossSeriesReducer,e.scopedVars||{}),perSeriesAligner:a.templateSrv.replace(t.aggregation.perSeriesAligner,e.scopedVars||{}),alignmentPeriod:a.templateSrv.replace(t.aggregation.alignmentPeriod,e.scopedVars||{}),groupBys:a.interpolateGroupBys(t.aggregation.groupBys,e.scopedVars),view:t.view||"FULL",filters:(t.filters||[]).map(function(t){return a.templateSrv.replace(t,e.scopedVars||{})}),aliasBy:a.templateSrv.replace(t.aliasBy,e.scopedVars||{}),type:"timeSeriesQuery"}}),[4,this.backendSrv.datasourceRequest({url:"/api/tsdb/query",method:"POST",data:{from:e.range.from.valueOf().toString(),to:e.range.to.valueOf().toString(),queries:t}})];case 1:return[2,r.sent().data]}})})},e.prototype.getLabels=function(e,t){return Ve.b(this,void 0,void 0,function(){return Ve.d(this,function(a){switch(a.label){case 0:return[4,this.getTimeSeries({targets:[{refId:t,datasourceId:this.id,metricType:this.templateSrv.replace(e),aggregation:{crossSeriesReducer:"REDUCE_NONE"},view:"HEADERS"}],range:this.timeSrv.timeRange()})];case 1:return[2,a.sent()]}})})},e.prototype.interpolateGroupBys=function(e,t){var a=this,r=[];return(e||[]).forEach(function(e){var n=a.templateSrv.replace(e,t||{},"csv").split(",");Array.isArray(n)?r=r.concat(n):r.push(n)}),r},e.prototype.resolvePanelUnitFromTargets=function(e){var t;return e.length>0&&e.every(function(t){return t.unit===e[0].unit})&&wn.hasOwnProperty(e[0].unit)&&(t=wn[e[0].unit]),t},e.prototype.query=function(e){return Ve.b(this,void 0,void 0,function(){var t,a,r=this;return Ve.d(this,function(n){switch(n.label){case 0:return t=[],[4,this.getTimeSeries(e)];case 1:return(a=n.sent()).results?(Object.values(a.results).forEach(function(a){if(a.series){var n=r.resolvePanelUnitFromTargets(e.targets);a.series.forEach(function(e){var r={target:e.name,datapoints:e.points,refId:a.refId,meta:a.meta};n&&(r=Ve.a({},r,{unit:n})),t.push(r)})}}),[2,{data:t}]):[2,{data:[]}]}})})},e.prototype.annotationQuery=function(e){return Ve.b(this,void 0,void 0,function(){var t,a,r,n=this;return Ve.d(this,function(i){switch(i.label){case 0:return t=e.annotation,a=[{refId:"annotationQuery",datasourceId:this.id,metricType:this.templateSrv.replace(t.target.metricType,e.scopedVars||{}),primaryAggregation:"REDUCE_NONE",perSeriesAligner:"ALIGN_NONE",title:this.templateSrv.replace(t.target.title,e.scopedVars||{}),text:this.templateSrv.replace(t.target.text,e.scopedVars||{}),tags:this.templateSrv.replace(t.target.tags,e.scopedVars||{}),view:"FULL",filters:(t.target.filters||[]).map(function(t){return n.templateSrv.replace(t,e.scopedVars||{})}),type:"annotationQuery"}],[4,this.backendSrv.datasourceRequest({url:"/api/tsdb/query",method:"POST",data:{from:e.range.from.valueOf().toString(),to:e.range.to.valueOf().toString(),queries:a}})];case 1:return r=i.sent().data,[2,r.results.annotationQuery.tables[0].rows.map(function(e){return{annotation:t,time:Date.parse(e[0]),title:e[1],tags:[],text:e[3]}})]}})})},e.prototype.metricFindQuery=function(e){throw new Error("Template variables support is not yet imlemented")},e.prototype.testDatasource=function(){var e="v3/projects/"+this.projectName+"/metricDescriptors";return this.doRequest(""+this.baseUrl+e).then(function(e){return 200===e.status?{status:"success",message:"Successfully queried the Stackdriver API.",title:"Success"}:{status:"error",message:"Returned http status code "+e.status}}).catch(function(e){var t="Stackdriver: ";return t+=e.statusText?e.statusText+": ":"",e.data&&e.data.error&&e.data.error.code?t+=e.data.error.code+". "+e.data.error.message:t+="Cannot connect to Stackdriver API",{status:"error",message:t}})},e.prototype.getProjects=function(){return Ve.b(this,void 0,void 0,function(){return Ve.d(this,function(e){switch(e.label){case 0:return[4,this.doRequest("/cloudresourcemanager/v1/projects")];case 1:return[2,e.sent().data.projects.map(function(e){return{id:e.projectId,name:e.name}})]}})})},e.prototype.getDefaultProject=function(){return Ve.b(this,void 0,void 0,function(){var e,t,a,r=this;return Ve.d(this,function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),[4,this.getProjects()];case 1:if((e=n.sent())&&e.length>0)return[2,e.filter(function(e){return e.id===r.projectName})[0]];throw new Error("No projects found");case 2:return t=n.sent(),a="Projects cannot be fetched: ",a+=t.statusText?t.statusText+": ":"",t&&t.data&&t.data.error&&t.data.error.message?403===t.data.error.code?a+="\n            A list of projects could not be fetched from the Google Cloud Resource Manager API.\n            You might need to enable it first:\n            https://console.developers.google.com/apis/library/cloudresourcemanager.googleapis.com":a+=t.data.error.code+". "+t.data.error.message:a+="Cannot connect to Stackdriver API",re.a.emit("ds-request-error",a),[3,3];case 3:return[2]}})})},e.prototype.getMetricTypes=function(e){return Ve.b(this,void 0,void 0,function(){var t,a,r;return Ve.d(this,function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),t="v3/projects/"+e+"/metricDescriptors",[4,this.doRequest(""+this.baseUrl+t)];case 1:return a=n.sent().data,[2,a.metricDescriptors.map(function(e){var t=e.type.split("/")[0],a=t.split(".")[0];return e.service=t,e.serviceShortName=a,e.displayName=e.displayName||e.type,e})];case 2:return r=n.sent(),console.log(r),[3,3];case 3:return[2]}})})},e.prototype.doRequest=function(e,t){return void 0===t&&(t=1),Ve.b(this,void 0,void 0,function(){var a=this;return Ve.d(this,function(r){return[2,this.backendSrv.datasourceRequest({url:this.url+e,method:"GET"}).catch(function(r){if(t>0)return a.doRequest(e,t-1);throw r})]})})},e}(),Cn=function(){return function(){return{templateUrl:"public/app/plugins/datasource/stackdriver/partials/query.aggregation.html",controller:"StackdriverAggregationCtrl",restrict:"E",scope:{target:"=",alignmentPeriod:"<",refresh:"&"}}}}(),kn=function(){function e(e){this.$scope=e,this.$scope.ctrl=this,this.target=e.target,this.alignmentPeriods=xn,this.aggOptions=Sn,this.alignOptions=bn,this.setAggOptions(),this.setAlignOptions();var t=this;e.$on("metricTypeChanged",function(){t.setAggOptions(),t.setAlignOptions()})}return e.$inject=["$scope"],e.prototype.setAlignOptions=function(){var e=this;this.alignOptions=this.target.valueType?bn.filter(function(t){return-1!==t.valueTypes.indexOf(e.target.valueType)&&-1!==t.metricKinds.indexOf(e.target.metricKind)}):[],this.alignOptions.find(function(t){return t.value===e.target.aggregation.perSeriesAligner})||(this.target.aggregation.perSeriesAligner=this.alignOptions.length>0?this.alignOptions[0].value:"")},e.prototype.setAggOptions=function(){var e=this;this.aggOptions=this.target.metricKind?Sn.filter(function(t){return-1!==t.valueTypes.indexOf(e.target.valueType)&&-1!==t.metricKinds.indexOf(e.target.metricKind)}):[],this.aggOptions.find(function(t){return t.value===e.target.aggregation.crossSeriesReducer})||this.deselectAggregationOption("REDUCE_NONE"),this.target.aggregation.groupBys.length>0&&(this.aggOptions=this.aggOptions.filter(function(e){return"REDUCE_NONE"!==e.value}),this.deselectAggregationOption("REDUCE_NONE"))},e.prototype.formatAlignmentText=function(){var e=this,t=this.alignOptions.find(function(t){return t.value===e.target.aggregation.perSeriesAligner});return ie.a.secondsToHms(this.$scope.alignmentPeriod)+" interval ("+t.text+")"},e.prototype.deselectAggregationOption=function(e){var t=this.aggOptions.find(function(t){return t.value!==e});this.target.aggregation.crossSeriesReducer=t?t.value:""},e}();D.a.module("grafana.controllers").directive("stackdriverAggregation",Cn),D.a.module("grafana.controllers").controller("StackdriverAggregationCtrl",kn);var _n=function(){function e(e,t,a,r){this.uiSegmentSrv=e,this.target=t,this.getFilterKeysFunc=a,this.getFilterValuesFunc=r}return e.prototype.buildSegmentModel=function(){var e=this;this.removeSegment=this.uiSegmentSrv.newSegment({fake:!0,value:"-- remove filter --"}),this.filterSegments=[],this.target.filters.forEach(function(t,a){switch(a%4){case 0:e.filterSegments.push(e.uiSegmentSrv.newKey(t));break;case 1:e.filterSegments.push(e.uiSegmentSrv.newOperator(t));break;case 2:e.filterSegments.push(e.uiSegmentSrv.newKeyValue(t));break;case 3:e.filterSegments.push(e.uiSegmentSrv.newCondition(t))}}),this.ensurePlusButton(this.filterSegments)},e.prototype.getFilters=function(e,t,a){return Ve.b(this,void 0,void 0,function(){var r;return Ve.d(this,function(n){return"condition"===e.type?[2,[this.uiSegmentSrv.newSegment("AND")]]:"operator"===e.type?[2,this.uiSegmentSrv.newOperators(["=","!=","=~","!=~"])]:"key"===e.type||"plus-button"===e.type?a&&e.value&&"-- remove filter --"!==e.value?(this.removeSegment.value="-- remove filter --",[2,Promise.resolve([this.removeSegment])]):[2,this.getFilterKeysFunc(e,"-- remove filter --")]:"value"===e.type&&(r=this.getFilterValuesFunc(t)).length>0?[2,this.getValuesForFilterKey(r)]:[2,[]]})})},e.prototype.getValuesForFilterKey=function(e){var t=this;return e.map(function(e){return t.uiSegmentSrv.newSegment({value:""+e,expandable:!1})})},e.prototype.addNewFilterSegments=function(e,t){t>2&&this.filterSegments.splice(t,0,this.uiSegmentSrv.newCondition("AND")),e.type="key",this.filterSegments.push(this.uiSegmentSrv.newOperator("=")),this.filterSegments.push(this.uiSegmentSrv.newFake("select value","value","query-segment-value"))},e.prototype.removeFilterSegment=function(e){this.filterSegments.splice(e,3),e>2&&"condition"===this.filterSegments[e-1].type&&this.filterSegments.splice(e-1,1),0===e&&this.filterSegments.length>0&&"condition"===this.filterSegments[0].type&&this.filterSegments.splice(0,1)},e.prototype.ensurePlusButton=function(e){var t=e.length,a=e[Math.max(t-1,0)];a&&"plus-button"===a.type||e.push(this.uiSegmentSrv.newPlusButton())},e.prototype.filterSegmentUpdated=function(e,t){return"plus-button"===e.type?this.addNewFilterSegments(e,t):"key"===e.type&&"-- remove filter --"===e.value?(this.removeFilterSegment(t),this.ensurePlusButton(this.filterSegments)):"value"===e.type&&"select value"!==e.value&&this.ensurePlusButton(this.filterSegments),this.filterSegments.filter(function(e){return"plus-button"!==e.type}).map(function(e){return e.value})},e}(),En=function(){return function(){return{templateUrl:"public/app/plugins/datasource/stackdriver/partials/query.filter.html",controller:"StackdriverFilterCtrl",controllerAs:"ctrl",restrict:"E",scope:{target:"=",datasource:"=",refresh:"&",defaultDropdownValue:"<",defaultServiceValue:"<",hideGroupBys:"<"}}}}(),Mn=function(){function e(e,t,a,r){this.$scope=e,this.uiSegmentSrv=t,this.templateSrv=a,this.$rootScope=r,this.defaultRemoveGroupByValue="-- remove group by --",this.resourceTypeValue="resource.type",this.datasource=e.datasource,this.target=e.target,this.metricType=e.defaultDropdownValue,this.service=e.defaultServiceValue,this.metricDescriptors=[],this.metrics=[],this.services=[],this.getCurrentProject().then(this.loadMetricDescriptors.bind(this)).then(this.getLabels.bind(this)),this.initSegments(e.hideGroupBys)}return e.$inject=["$scope","uiSegmentSrv","templateSrv","$rootScope"],e.prototype.initSegments=function(e){var t=this;e||(this.groupBySegments=this.target.aggregation.groupBys.map(function(e){return t.uiSegmentSrv.getSegmentForValue(e)}),this.ensurePlusButton(this.groupBySegments)),this.removeSegment=this.uiSegmentSrv.newSegment({fake:!0,value:"-- remove group by --"}),this.filterSegments=new _n(this.uiSegmentSrv,this.target,this.getFilterKeys.bind(this),this.getFilterValues.bind(this)),this.filterSegments.buildSegmentModel()},e.prototype.getCurrentProject=function(){return Ve.b(this,void 0,void 0,function(){var e;return Ve.d(this,function(t){switch(t.label){case 0:return e=this.target,[4,this.datasource.getDefaultProject()];case 1:return e.project=t.sent(),[2]}})})},e.prototype.loadMetricDescriptors=function(){return Ve.b(this,void 0,void 0,function(){var e;return Ve.d(this,function(t){switch(t.label){case 0:return"default"===this.target.project.id?[3,2]:(e=this,[4,this.datasource.getMetricTypes(this.target.project.id)]);case 1:return e.metricDescriptors=t.sent(),this.services=this.getServicesList(),this.metrics=this.getMetricsList(),[2,this.metricDescriptors];case 2:return[2,[]]}})})},e.prototype.getServicesList=function(){var e=this,t={value:this.$scope.defaultServiceValue,text:this.$scope.defaultServiceValue},a=this.metricDescriptors.map(function(e){return{value:e.service,text:e.serviceShortName}});return a.find(function(t){return t.value===e.target.service})&&(this.service=this.target.service),a.length>0?[t].concat(A.a.uniqBy(a,"value")):[]},e.prototype.getMetricsList=function(){var e,t=this,a=this.metricDescriptors.map(function(e){return{service:e.service,value:e.type,serviceShortName:e.serviceShortName,text:e.displayName,title:e.description}});return(e=this.target.service===this.$scope.defaultServiceValue?a.map(function(e){return Ve.a({},e,{text:e.service+" - "+e.text})}):a.filter(function(e){return e.service===t.target.service})).find(function(e){return e.value===t.target.metricType})?this.metricType=this.target.metricType:e.length>0&&(this.metricType=this.target.metricType=e[0].value),e},e.prototype.getLabels=function(){return Ve.b(this,void 0,void 0,function(){var e=this;return Ve.d(this,function(t){return this.loadLabelsPromise=new Promise(function(t){return Ve.b(e,void 0,void 0,function(){var e,a;return Ve.d(this,function(r){switch(r.label){case 0:return r.trys.push([0,2,,3]),[4,this.datasource.getLabels(this.target.metricType,this.target.refId)];case 1:return e=r.sent(),this.metricLabels=e.results[this.target.refId].meta.metricLabels,this.resourceLabels=e.results[this.target.refId].meta.resourceLabels,this.resourceTypes=e.results[this.target.refId].meta.resourceTypes,t(),[3,3];case 2:return(a=r.sent()).data&&a.data.message?console.log(a.data.message):console.log(a),re.a.emit("alert-error",["Error","Error loading metric labels for "+this.target.metricType]),t(),[3,3];case 3:return[2]}})})}),[2]})})},e.prototype.onServiceChange=function(){var e=this;this.target.service=this.service,this.metrics=this.getMetricsList(),this.setMetricType(),this.getLabels(),this.metrics.find(function(t){return t.value===e.target.metricType})?this.$scope.refresh():this.target.metricType=this.$scope.defaultDropdownValue},e.prototype.onMetricTypeChange=function(){return Ve.b(this,void 0,void 0,function(){return Ve.d(this,function(e){return this.setMetricType(),this.$scope.refresh(),this.getLabels(),[2]})})},e.prototype.setMetricType=function(){var e=this;this.target.metricType=this.metricType;var t=this.metricDescriptors.find(function(t){return t.type===e.target.metricType}),a=t.valueType,r=t.metricKind,n=t.unit;this.target.unit=n,this.target.valueType=a,this.target.metricKind=r,this.$rootScope.$broadcast("metricTypeChanged")},e.prototype.createLabelKeyElements=function(){return Ve.b(this,void 0,void 0,function(){var e,t=this;return Ve.d(this,function(a){switch(a.label){case 0:return[4,this.loadLabelsPromise];case 1:return a.sent(),e=(e=Object.keys(this.metricLabels||{}).map(function(e){return t.uiSegmentSrv.newSegment({value:"metric.label."+e,expandable:!1})})).concat(Object.keys(this.resourceLabels||{}).map(function(e){return t.uiSegmentSrv.newSegment({value:"resource.label."+e,expandable:!1})})),this.resourceTypes&&this.resourceTypes.length>0&&(e=e.concat([this.uiSegmentSrv.newSegment({value:this.resourceTypeValue,expandable:!1})])),[2,e]}})})},e.prototype.getFilterKeys=function(e,t){return Ve.b(this,void 0,void 0,function(){var a,r=this;return Ve.d(this,function(n){switch(n.label){case 0:return[4,this.createLabelKeyElements()];case 1:return a=n.sent(),-1!==this.target.filters.indexOf(this.resourceTypeValue)&&(a=a.filter(function(e){return e.value!==r.resourceTypeValue})),(!e||"plus-button"===e.type)&&0===a.length?[2,[]]:(this.removeSegment.value=t,[2,a.concat([this.removeSegment])])}})})},e.prototype.getGroupBys=function(e){return Ve.b(this,void 0,void 0,function(){var t,a=this;return Ve.d(this,function(r){switch(r.label){case 0:return[4,this.createLabelKeyElements()];case 1:return t=(t=r.sent()).filter(function(e){return-1===a.target.aggregation.groupBys.indexOf(e.value)}),(!e||"plus-button"===e.type)&&0===t.length?[2,[]]:(this.removeSegment.value=this.defaultRemoveGroupByValue,[2,t.concat([this.removeSegment])])}})})},e.prototype.groupByChanged=function(e,t){e.value===this.removeSegment.value?this.groupBySegments.splice(t,1):e.type="value";this.target.aggregation.groupBys=this.groupBySegments.reduce(function(e,t){return t.fake||e.push(t.value),e},[]),this.ensurePlusButton(this.groupBySegments),this.$rootScope.$broadcast("metricTypeChanged"),this.$scope.refresh()},e.prototype.getFilters=function(e,t){return Ve.b(this,void 0,void 0,function(){var a;return Ve.d(this,function(r){return a=this.metricLabels&&0===Object.keys(this.metricLabels).length,[2,this.filterSegments.getFilters(e,t,a)]})})},e.prototype.getFilterValues=function(e){var t=this.templateSrv.replace(this.filterSegments.filterSegments[e-2].value);if(!t||!this.metricLabels||0===Object.keys(this.metricLabels).length)return[];var a=t.substring(t.indexOf(".label.")+7);return t.startsWith("metric.label.")&&this.metricLabels.hasOwnProperty(a)?this.metricLabels[a]:t.startsWith("resource.label.")&&this.resourceLabels.hasOwnProperty(a)?this.resourceLabels[a]:t===this.resourceTypeValue?this.resourceTypes:[]},e.prototype.filterSegmentUpdated=function(e,t){this.target.filters=this.filterSegments.filterSegmentUpdated(e,t),this.$scope.refresh()},e.prototype.ensurePlusButton=function(e){var t=e.length,a=e[Math.max(t-1,0)];a&&"plus-button"===a.type||e.push(this.uiSegmentSrv.newPlusButton())},e}();D.a.module("grafana.controllers").directive("stackdriverFilter",En),D.a.module("grafana.controllers").controller("StackdriverFilterCtrl",Mn);var Pn=function(e){function t(t,a){var r=e.call(this,t,a)||this;return r.defaultDropdownValue="Select Metric",r.defaultServiceValue="All Services",r.defaults={project:{id:"default",name:"loading project..."},metricType:r.defaultDropdownValue,service:r.defaultServiceValue,metric:"",unit:"",aggregation:{crossSeriesReducer:"REDUCE_MEAN",alignmentPeriod:"stackdriver-auto",perSeriesAligner:"ALIGN_MEAN",groupBys:[]},filters:[],showAggregationOptions:!1,aliasBy:"",metricKind:"",valueType:""},A.a.defaultsDeep(r.target,r.defaults),r.panelCtrl.events.on("data-received",r.onDataReceived.bind(r),t),r.panelCtrl.events.on("data-error",r.onDataError.bind(r),t),r}return t.$inject=["$scope","$injector"],Ve.c(t,e),t.prototype.onDataReceived=function(e){this.lastQueryError=null,this.lastQueryMeta=null;var t=A.a.find(e,{refId:this.target.refId});t&&(this.lastQueryMeta=t.meta,this.lastQueryMeta.rawQueryString=decodeURIComponent(this.lastQueryMeta.rawQuery))},t.prototype.onDataError=function(e){if(e.data&&e.data.results){var t=e.data.results[this.target.refId];if(t&&t.error){this.lastQueryMeta=t.meta,this.lastQueryMeta.rawQueryString=decodeURIComponent(this.lastQueryMeta.rawQuery);var a=void 0;try{a=JSON.parse(t.error)}catch(e){this.lastQueryError=t.error}this.lastQueryError=a.error.message}}},t.templateUrl="partials/query.editor.html",t}(Ye),Dn=function(){function e(e){this.validationErrors=[],this.datasourceSrv=e,this.current.jsonData=this.current.jsonData||{},this.current.secureJsonData=this.current.secureJsonData||{},this.current.secureJsonFields=this.current.secureJsonFields||{}}return e.$inject=["datasourceSrv"],e.prototype.save=function(e){this.current.secureJsonData.privateKey=e.private_key,this.current.jsonData.tokenUri=e.token_uri,this.current.jsonData.clientEmail=e.client_email,this.current.jsonData.defaultProject=e.project_id},e.prototype.validateJwt=function(e){return this.resetValidationMessages(),e.private_key&&0!==e.private_key.length||this.validationErrors.push("Private key field missing in JWT file."),e.token_uri&&0!==e.token_uri.length||this.validationErrors.push("Token URI field missing in JWT file."),e.client_email&&0!==e.client_email.length||this.validationErrors.push("Client Email field missing in JWT file."),0===this.validationErrors.length&&(this.inputDataValid=!0,!0)},e.prototype.onUpload=function(e){this.jsonText="",this.validateJwt(e)&&this.save(e)},e.prototype.onPasteJwt=function(e){try{var t=JSON.parse(e.originalEvent.clipboardData.getData("text/plain")||this.jsonText);this.validateJwt(t)&&this.save(t)}catch(e){this.resetValidationMessages(),this.validationErrors.push("Invalid json: "+e.message)}},e.prototype.resetValidationMessages=function(){this.validationErrors=[],this.inputDataValid=!1,this.jsonText="",this.current.jsonData={},this.current.secureJsonData={},this.current.secureJsonFields={}},e.templateUrl="public/app/plugins/datasource/stackdriver/partials/config.html",e}(),$n=function(){function e(){this.defaultDropdownValue="Select Metric",this.defaultServiceValue="All Services",this.defaults={project:{id:"default",name:"loading project..."},metricType:this.defaultDropdownValue,service:this.defaultServiceValue,metric:"",filters:[],metricKind:"",valueType:""},this.annotation.target=this.annotation.target||{},this.annotation.target.refId="annotationQuery",A.a.defaultsDeep(this.annotation.target,this.defaults)}return e.templateUrl="partials/annotations.editor.html",e}(),An=function(e){function t(t,a,r,n){var i=e.call(this,t,a)||this;return i.templateSrv=r,i.$sce=n,i.panelDefaults={mode:"markdown",content:"# title"},A.a.defaults(i.panel,i.panelDefaults),i.events.on("init-edit-mode",i.onInitEditMode.bind(i)),i.events.on("refresh",i.onRefresh.bind(i)),i.events.on("render",i.onRender.bind(i)),t.$watch("ctrl.panel.content",A.a.throttle(function(){i.render()},1e3)),i}return t.$inject=["$scope","$injector","templateSrv","$sce"],Ve.c(t,e),t.prototype.onInitEditMode=function(){this.addEditorTab("Options","public/app/plugins/panel/text/editor.html"),this.editorTabIndex=1,"text"===this.panel.mode&&(this.panel.mode="markdown")},t.prototype.onRefresh=function(){this.render()},t.prototype.onRender=function(){"markdown"===this.panel.mode?this.renderMarkdown(this.panel.content):"html"===this.panel.mode&&this.updateContent(this.panel.content),this.renderingCompleted()},t.prototype.renderText=function(e){e=e.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/\n/g,"<br/>"),this.updateContent(e)},t.prototype.renderMarkdown=function(e){var t=this;this.remarkable||(this.remarkable=new Se.a),this.$scope.$applyAsync(function(){t.updateContent(t.remarkable.render(e))})},t.prototype.updateContent=function(e){try{this.content=this.$sce.trustAsHtml(this.templateSrv.replace(e,this.panel.scopedVars))}catch(t){console.log("Text panel error: ",t),this.content=this.$sce.trustAsHtml(e)}},t.templateUrl="public/app/plugins/panel/text/module.html",t.scrollable=!0,t}(Le);a(1240),a(1242),a(1241),a(1243),a(1244),a(1245),a(1246),a(1247);function In(e,t,a){var r=D.a.element(document).injector(),n=document.createElement("div");n.innerHTML='<annotation-tooltip event="event" on-edit="onEdit()"></annotation-tooltip>',r.invoke(["$compile","$rootScope",function(r,i){var s=a.getOptions().events.manager,o=i.$new(!0);o.event=t,o.onEdit=function(){s.editEvent(t)},r(n)(o),o.$digest(),o.$destroy();var l=new Yt.a({target:e[0],content:n,position:"bottom center",classes:"drop-popover drop-popover--annotation",openOn:"hover",hoverCloseDelay:200,tetherOptions:{constraints:[{to:"window",pin:!0,attachment:"both"}]}});l.open(),l.on("close",function(){setTimeout(function(){l.destroy()})})}])}var On=null;function Fn(e,t,a){var r=a.getOptions().events.manager;r.editorOpen?On=e:(r.editorOpened(),On=e,setTimeout(function(){var e=D.a.element(document).injector(),a=document.createElement("div");a.innerHTML='<event-editor panel-ctrl="panelCtrl" event="event" close="close()"></event-editor>',e.invoke(["$compile","$rootScope",function(e,n){var i,s=n.$new(!0);s.event=t,s.panelCtrl=r.panelCtrl,s.close=function(){i.close()},e(a)(s),s.$digest(),(i=new Yt.a({target:On[0],content:a,position:"bottom center",classes:"drop-popover drop-popover--form",openOn:"click",tetherOptions:{constraints:[{to:"window",pin:!0,attachment:"both"}]}})).open(),r.editorOpened(),i.on("close",function(){setTimeout(function(){r.editorClosed(),s.$destroy(),i.destroy()})})}])},100))}var qn=function(){function e(e,t,a,r,n,i,s,o){this._object=e,this._drawFunc=t,this._clearFunc=a,this._moveFunc=r,this._position={left:n,top:i},this._width=s,this._height=o}return e.$inject=["object","drawFunc","clearFunc","moveFunc","left","top","width","height"],e.prototype.width=function(){return this._width},e.prototype.height=function(){return this._height},e.prototype.position=function(){return this._position},e.prototype.draw=function(){this._drawFunc(this._object)},e.prototype.clear=function(){this._clearFunc(this._object)},e.prototype.getObject=function(){return this._object},e.prototype.moveTo=function(e){this._position=e,this._moveFunc(this._object,this._position)},e}(),Nn=function(){function e(e,t){this._options=e,this._drawableEvent=t,this._hidden=!1}return e.$inject=["options","drawableEvent"],e.prototype.visual=function(){return this._drawableEvent},e.prototype.getOptions=function(){return this._options},e.prototype.getParent=function(){return this._parent},e.prototype.isHidden=function(){return this._hidden},e.prototype.hide=function(){this._hidden=!0},e.prototype.unhide=function(){this._hidden=!1},e}(),Rn=function(){function e(e){this._events=[],this._types=[],this._plot=e,this.eventsEnabled=!1}return e.$inject=["plot"],e.prototype.getEvents=function(){return this._events},e.prototype.setTypes=function(e){return this._types=e},e.prototype.setupEvents=function(e){var t=this,a=A.a.partition(e,"isRegion"),r=a[0];e=a[1],O.a.each(e,function(e,a){var r=new Nn(a,t._buildDiv(a));t._events.push(r)}),O.a.each(r,function(e,a){var r=new Nn(a,t._buildRegDiv(a));t._events.push(r)}),this._events.sort(function(e,t){var a=e.getOptions(),r=t.getOptions();return a.min>r.min?1:a.min<r.min?-1:0})},e.prototype.drawEvents=function(){var e=this;O.a.each(this._events,function(t,a){e._insidePlot(a.getOptions().min)&&!a.isHidden()?a.visual().draw():a.visual().getObject().hide()})},e.prototype.updateEvents=function(){var e,t,a=this,r=this._plot.getPlotOffset(),n=this._plot.getXAxes()[this._plot.getOptions().events.xaxis-1];O.a.each(this._events,function(i,s){t=r.top+a._plot.height()-s.visual().height(),e=n.p2c(s.getOptions().min)+r.left-s.visual().width()/2,s.visual().moveTo({top:t,left:e})})},e.prototype._clearEvents=function(){O.a.each(this._events,function(e,t){t.visual().clear()}),this._events=[]},e.prototype._buildDiv=function(e){var t,a,r,n,i,s,o,l,u=this,c=this._plot.getPlaceholder(),h=this._plot.getPlotOffset(),p=this._plot.getXAxes()[this._plot.getOptions().events.xaxis-1],d=e.eventType;r=null!==this._types&&this._types[d]&&this._types[d].color?this._types[d].color:"#666",n=null!==this._types&&this._types[d]&&this._types[d].markerSize?this._types[d].markerSize:8,i=null===this._types||!this._types[d]||void 0===this._types[d].markerShow||this._types[d].markerShow,l=null===this._types||!this._types[d]||void 0===this._types[d].markerTooltip||this._types[d].markerTooltip,s=null!=this._types&&this._types[d]&&this._types[d].lineStyle?this._types[d].lineStyle.toLowerCase():"dashed",o=null!=this._types&&this._types[d]&&void 0!==this._types[d].lineWidth?this._types[d].lineWidth:1;var m=p.options.eventSectionHeight||0;m/=3,t=h.top+this._plot.height()+m,a=p.p2c(e.min)+h.left;var f=O()('<div class="events_line flot-temp-elem"></div>').css({position:"absolute",opacity:.8,left:a+"px",top:8,width:o+"px",height:this._plot.height()+.8*m,"border-left-width":o+"px","border-left-style":s,"border-left-color":r,color:r}).appendTo(c);if(i){var g=O()('<div class="events_marker"></div>').css({position:"absolute",left:-n-Math.round(o/2)+"px","font-size":0,"line-height":0,width:0,height:0,"border-left":n+"px solid transparent","border-right":n+"px solid transparent"});g.appendTo(f),this._types[d]&&this._types[d].position&&"BOTTOM"===this._types[d].position.toUpperCase()?g.css({top:t-n-8+"px","border-top":"none","border-bottom":n+"px solid "+r}):g.css({top:"0px","border-top":n+"px solid "+r,"border-bottom":"none"}),g.data({event:e});e.editModel&&Fn(g,e.editModel,u._plot);l&&(g.css({cursor:"help"}),g.hover(function(){In(g,O()(this).data("event"),u._plot)},function(){u._plot.clearSelection()}))}return new qn(f,function(e){e.show()},function(e){e.remove()},function(e,t){e.css({top:t.top,left:t.left})},a,t,f.width(),f.height())},e.prototype._buildRegDiv=function(e){var t,a,r,n,i,s,o,l=this,u=this,c=this._plot.getPlaceholder(),h=this._plot.getPlotOffset(),p=this._plot.getXAxes()[this._plot.getOptions().events.xaxis-1],d=e.eventType;s=null!==this._types&&this._types[d]&&this._types[d].color?this._types[d].color:"#666",o=null===this._types||!this._types[d]||void 0===this._types[d].markerTooltip||this._types[d].markerTooltip,r=null!=this._types&&this._types[d]&&void 0!==this._types[d].lineWidth?this._types[d].lineWidth:1,i=null!=this._types&&this._types[d]&&this._types[d].lineStyle?this._types[d].lineStyle.toLowerCase():"dashed";t=h.top+this._plot.height()+2;var m=Math.min(e.min,e.timeEnd),f=Math.max(e.min,e.timeEnd);a=p.p2c(m)+h.left;var g=p.p2c(f)+h.left;n=g-a,A.a.each([a,g],function(e){O()('<div class="events_line flot-temp-elem"></div>').css({position:"absolute",opacity:.8,left:e+"px",top:8,width:r+"px",height:l._plot.height()+2,"border-left-width":r+"px","border-left-style":i,"border-left-color":s,color:s}).appendTo(c)});var v=O()('<div class="events_marker region_marker flot-temp-elem"></div>').css({position:"absolute",opacity:.5,left:a+"px",top:t,width:Math.round(n+r)+"px",height:"0.5rem","border-left-color":s,color:s,"background-color":s});v.appendTo(c),v.data({event:e});e.editModel&&Fn(v,e.editModel,u._plot);return o&&(v.css({cursor:"help"}),v.hover(function(){In(v,O()(this).data("event"),u._plot)},function(){u._plot.clearSelection()})),new qn(v,function(e){e.show()},function(e){e.remove()},function(e,t){e.css({top:t.top,left:t.left})},a,t,v.width(),v.height())},e.prototype._insidePlot=function(e){var t=this._plot.getXAxes()[this._plot.getOptions().events.xaxis-1],a=t.p2c(e);return a>0&&a<t.p2c(t.max)},e}();function Ln(e){var t=this,a=new Rn(e);e.getEvents=function(){return a._events},e.hideEvents=function(){O.a.each(a._events,function(e,t){t.visual().getObject().hide()})},e.showEvents=function(){e.hideEvents(),O.a.each(a._events,function(e,t){t.hide()}),t.eventMarkers.drawEvents()},e.setEvents=function(e){a.eventsEnabled&&a.setupEvents(e)},e.hooks.processOptions.push(function(e,t){null!=t.events.data&&(a.eventsEnabled=!0)}),e.hooks.draw.push(function(e){var t=e.getOptions();a.eventsEnabled&&(a.getEvents().length<1?(a.setTypes(t.events.types),a.setupEvents(t.events.data)):a.updateEvents()),a.drawEvents()})}O.a.plot.plugins.push({init:Ln,options:{events:{data:null,types:null,xaxis:1,position:"BOTTOM"}},name:"events",version:"0.2.5"});var Vn=function(){function e(e){this.panelCtrl=e}return e.prototype.getHandleHtml=function(e,t,a){var r=t.colorMode;return"custom"===t.colorMode&&(r="critical"),'\n    <div class="alert-handle-wrapper alert-handle-wrapper--T'+e+'">\n      <div class="alert-handle-line alert-handle-line--'+r+'">\n      </div>\n      <div class="alert-handle" data-handle-index="'+e+'">\n        <i class="icon-gf icon-gf-'+r+" alert-state-"+r+'"></i>\n        <span class="alert-handle-value">'+a+'<i class="alert-handle-grip"></i></span>\n      </div>\n    </div>'},e.prototype.initDragging=function(e){var t,a=O()(e.currentTarget).parents(".alert-handle-wrapper"),r=O()(e.currentTarget).data("handleIndex"),n=null,i=this.plot,s=this.panelCtrl,o=this.thresholds[r];function l(e){if(null===n)n=e.clientY;else{var r=e.clientY-n;t+=r,n=e.clientY,a.css({top:t+r})}}function u(){var e=i.c2p({left:0,top:t}).y;e=parseInt(e.toFixed(0),10),o.value=e,a.off("mousemove",l),a.off("mouseup",l),a.off("mouseleave",l),s.$scope.$apply(function(){s.render(),s.events.emit("threshold-changed",{threshold:o,handleIndex:r})})}n=null,t=a.position().top,a.on("mousemove",l),a.on("mouseup",u),a.on("mouseleave",u)},e.prototype.cleanUp=function(){this.placeholder.find(".alert-handle-wrapper").remove(),this.needsCleanup=!1},e.prototype.renderHandle=function(e,t){var a=this.thresholds[e],r=a.value,n=r,i=0;if(A.a.isNumber(r)){var s=this.plot.p2c({x:0,y:r});i=Math.round(Math.min(Math.max(s.top,0),this.height)-6)}else n="",i=t;var o=O()(this.getHandleHtml(e,a,n));this.placeholder.append(o),o.toggleClass("alert-handle-wrapper--no-value",""===n),o.css({top:i})},e.prototype.shouldDrawHandles=function(){return!this.hasSecondYAxis&&this.panelCtrl.editingThresholds&&this.panelCtrl.panel.thresholds.length>0},e.prototype.prepare=function(e,t){this.hasSecondYAxis=!1;for(var a=0;a<t.length;a++)if(t[a].yaxis>1){this.hasSecondYAxis=!0;break}if(this.shouldDrawHandles()){var r=this.panelCtrl.panel.thresholds.length>1?"220px":"110px";e.css("margin-right",r)}else this.needsCleanup&&e.css("margin-right","0")},e.prototype.draw=function(e){this.thresholds=this.panelCtrl.panel.thresholds,this.plot=e,this.placeholder=e.getPlaceholder(),this.needsCleanup&&this.cleanUp(),this.shouldDrawHandles()&&(this.height=e.height(),this.thresholds.length>0&&this.renderHandle(0,10),this.thresholds.length>1&&this.renderHandle(1,this.height-30),this.placeholder.off("mousedown",".alert-handle"),this.placeholder.on("mousedown",".alert-handle",this.initDragging.bind(this)),this.needsCleanup=!0)},e.prototype.addFlotOptions=function(e,t){if(t.thresholds&&0!==t.thresholds.length){var a,r,n,i=1/0,s=-1/0;for(a=0;a<t.thresholds.length;a++)if(r=t.thresholds[a],A.a.isNumber(r.value)){var o=void 0;switch(r.op){case"gt":o=i,t.thresholds.length>a+1&&(n=t.thresholds[a+1]).value>r.value&&(s=o=n.value);break;case"lt":o=s,t.thresholds.length>a+1&&(n=t.thresholds[a+1]).value<r.value&&(i=o=n.value)}var l=void 0,u=void 0;switch(r.colorMode){case"critical":l="rgba(234, 112, 112, 0.12)",u="rgba(237, 46, 24, 0.60)";break;case"warning":l="rgba(235, 138, 14, 0.12)",u="rgba(247, 149, 32, 0.60)";break;case"ok":l="rgba(11, 237, 50, 0.090)",u="rgba(6,163,69, 0.60)";break;case"custom":l=r.fillColor,u=r.lineColor}r.fill&&("right"===r.yaxis&&this.hasSecondYAxis?e.grid.markings.push({y2axis:{from:r.value,to:o},color:l}):e.grid.markings.push({yaxis:{from:r.value,to:o},color:l})),r.line&&("right"===r.yaxis&&this.hasSecondYAxis?e.grid.markings.push({y2axis:{from:r.value,to:r.value},color:u}):e.grid.markings.push({yaxis:{from:r.value,to:r.value},color:u}))}}},e}();function Un(e,t,a,r,n){return e.map(function(e){var i=function(e){for(var t=[],a=0;a<e.length;a++)for(var r=e[a].datapoints,n=0;n<r.length;n++)null!==r[n][0]&&t.push(r[n][0]);return t}([e]);if(e.histogram=!0,a[e.alias])e.data=[];else{var s=function(e,t,a,r){for(var n={},i=jn(a,t),s=jn(r,t),o=i,l=0;o<=s;)n[o]=0,o=i+t*l,l++;for(var u=0;u<e.length;u++){var c=jn(e[u],t);n[c]=n[c]+1}var h=A.a.map(n,function(e,t){return[Number(t),e]});return A.a.sortBy(h,function(e){return e[0]})}(i,t,r,n);e.data=s}return e})}function jn(e,t){return Math.floor(e/t)*t}function Bn(e,t){if(!isNaN(t)&&function(e){return 2===e.length&&Qn(e[0])&&Qn(e[1])}(e)){var a=e[0],r=e[1];!function(e,t,a){0!==a&&(e.min-=a,e.max-=a,t.min-=a,t.max-=a)}(a,r,t),function(e,t){e.max===e.min&&(e.min-=.25,e.max+=.25);t.max===t.min&&(t.min-=.25,t.max+=.25)}(a,r);var n=0===a.min||0===r.min||0===a.max||0===r.max,i=Hn(a,r);if(n&&i)a.min=a.max>0?0:a.min,a.max=a.max>0?a.max:0,r.min=r.max>0?0:r.min,r.max=r.max>0?r.max:0;else if(function(e,t){return e.min>=0&&t.max<=0||e.max<=0&&t.min>=0}(a,r))a.min>=0?(a.min=-a.max,r.max=-r.min):(a.max=-a.min,r.min=-r.max);else{var s=function(e,t){var a,r;if(zn(e,t))a=t.min?e.min/t.min:0,r=t.max?e.max/t.max:0;else if(Hn(e,t)){var n=Math.abs(e.min),i=Math.abs(e.max),s=Math.abs(t.min),o=Math.abs(t.max),l=A.a.max([n,i]),u=A.a.min([n,i]),c=A.a.max([s,o]),h=A.a.min([s,o]);a=u?l/u:l,r=h?c/h:c}else e.min>0||t.min>0?(a=e.max/t.max,r=0):(a=0,r=e.min/t.min);return a>r?a:r}(a,r);i?a.min>0?(a.min=a.max/s,r.min=r.max/s):(a.max=a.min/s,r.max=r.min/s):zn(a,r)?(a.min=r.min?r.min*s:a.min,r.min=a.min?a.min/s:r.min,a.max=r.max?r.max*s:a.max,r.max=a.max?a.max/s:r.max):(a.min=a.min>0?r.min*s:a.min,r.min=r.min>0?a.min/s:r.min,a.max=a.max<0?r.max*s:a.max,r.max=r.max<0?a.max/s:r.max)}!function(e,t,a){0!==a&&(e.min+=a,e.max+=a,t.min+=a,t.max+=a)}(a,r,t)}}function Qn(e){return"min"in e&&"max"in e}function Hn(e,t){return e.min>=0&&t.min>=0||e.max<=0&&t.max<=0}function zn(e,t){return e.min<=0&&e.max>=0&&t.min<=0&&t.max>=0}var Yn=function(){function e(e,t,a){var r=this;this.scope=e,this.elem=t,this.timeSrv=a,this.ctrl=e.ctrl,this.dashboard=this.ctrl.dashboard,this.panel=this.ctrl.panel,this.annotations=[],this.panelWidth=0,this.eventManager=new W(this.ctrl),this.thresholdManager=new Vn(this.ctrl),this.tooltip=new function(e,t,a,r){var n=this,i=a.ctrl.panel,s=O()('<div class="graph-tooltip">');this.destroy=function(){s.remove()},this.findHoverIndexFromDataPoints=function(e,t,a){var r,n=t.datapoints.pointsize,i=a*n,s=t.datapoints.points.length;for(r=i;r<s;r+=n)if(!t.lines.steps&&null!=t.datapoints.points[i]&&null==t.datapoints.points[r]||t.datapoints.points[r]>e)return Math.max(r-n,0)/n;return r/n-1},this.findHoverIndexFromData=function(e,t){for(var a,r=0,n=t.data.length-1;;){if(r>n)return Math.max(n,0);if(a=Math.floor((r+n)/2),t.data[a][0]===e)return a;t.data[a][0]<e?r=a+1:n=a-1}},this.renderAndShow=function(e,t,a,r){"time"===r&&(t='<div class="graph-tooltip-time">'+e+"</div>"+t),s.html(t).place_tt(a.pageX+20,a.pageY)},this.getMultiSeriesPlotHoverInfo=function(e,t){var a,r,n,s,o,l,u,c,h,p=[[],[],[]],d=0;for(r=0;r<e.length;r++)!(n=e[r]).data.length||i.legend.hideEmpty&&n.allIsNull?p[0].push({hidden:!0,value:0}):!n.data.length||i.legend.hideZero&&n.allIsZero?p[0].push({hidden:!0,value:0}):n.hideTooltip?p[0].push({hidden:!0,value:0}):(s=this.findHoverIndexFromData(t.x,n),o=t.x-n.data[s][0],l=n.data[s][0],(!c||o>=0&&(o<c||c<0)||o<0&&o>c)&&(c=o,h=l),a=n.stack?"individual"===i.tooltip.value_type?n.data[s][1]:n.stack?d+=n.data[s][1]:n.data[s][1]:n.data[s][1],(n.lines.steps||n.stack)&&(s=this.findHoverIndexFromDataPoints(t.x,n,s)),u=0,n.yaxis&&(u=n.yaxis.n),p[u].push({value:a,hoverIndex:s,color:n.color,label:n.aliasEscaped,time:l,distance:o,index:r}));return(p=p[0].concat(p[1],p[2])).time=h,p},e.mouseleave(function(){if(i.tooltip.shared){var t=e.data().plot;t&&(s.detach(),t.unhighlight())}j.b.emit("graph-hover-clear")}),e.bind("plothover",function(t,a,r){n.show(a,r),a.panelRelY=(a.pageY-e.offset().top)/e.height(),j.b.emit("graph-hover",{pos:a,panel:i})}),e.bind("plotclick",function(e,t,a){j.b.emit("graph-click",{pos:t,panel:i,item:a})}),this.clear=function(e){s.detach(),e.clearCrosshair(),e.unhighlight()},this.show=function(a,o){var l,u,c,h,p,d,m,f,g=e.data().plot,v=g.getData(),y=g.getXAxes()[0].options.mode,b=r(),S=i.tooltip.shared;if(a.panelRelY){var x=g.pointOffset({x:a.x});if(Number.isNaN(x.left)||x.left<0||x.left>e.width())return void n.clear(g);if(a.pageX=e.offset().left+x.left,a.pageY=e.offset().top+e.height()*a.panelRelY,!(a.pageY>=O()(window).scrollTop()&&a.pageY<=O()(window).innerHeight()+O()(window).scrollTop()))return void n.clear(g);if(g.setCrosshair(a),S=!0,t.sharedCrosshairModeOnly())return}if(0!==b.length)if(f=b[0].hasMsResolution?"YYYY-MM-DD HH:mm:ss.SSS":"YYYY-MM-DD HH:mm:ss",S){g.unhighlight();var w=n.getMultiSeriesPlotHoverInfo(v,a);for(m="",c=t.formatDate(w.time,f),2===i.tooltip.sort?w.sort(function(e,t){return t.value-e.value}):1===i.tooltip.sort&&w.sort(function(e,t){return e.value-t.value}),p=0;p<w.length;p++)if(!(h=w[p]).hidden){var T="";o&&h.index===o.seriesIndex&&(T="graph-tooltip-list-item--highlight"),u=(d=b[h.index]).formatValue(h.value),m+='<div class="graph-tooltip-list-item '+T+'"><div class="graph-tooltip-series-name">',m+='<i class="fa fa-minus" style="color:'+h.color+';"></i> '+h.label+":</div>",m+='<div class="graph-tooltip-value">'+u+"</div></div>",g.highlight(h.index,h.hoverIndex)}n.renderAndShow(c,m,a,y)}else o?(d=b[o.seriesIndex],l='<div class="graph-tooltip-list-item"><div class="graph-tooltip-series-name">',l+='<i class="fa fa-minus" style="color:'+o.series.color+';"></i> '+d.aliasEscaped+":</div>",u=i.stack&&"individual"===i.tooltip.value_type?o.datapoint[1]-o.datapoint[2]:o.datapoint[1],u=d.formatValue(u),c=t.formatDate(o.datapoint[0],f),l+='<div class="graph-tooltip-value">'+u+"</div>",n.renderAndShow(c,l,a,y)):s.detach()}}(this.elem,this.ctrl.dashboard,this.scope,function(){return r.sortedSeries}),this.ctrl.events.on("panel-teardown",this.onPanelteardown.bind(this)),this.ctrl.events.on("render",this.onRender.bind(this)),this.ctrl.events.on("legend-rendering-complete",this.onLegendRenderingComplete.bind(this)),j.b.on("graph-hover",this.onGraphHover.bind(this),e),j.b.on("graph-hover-clear",this.onGraphHoverClear.bind(this),e),this.elem.bind("plotselected",this.onPlotSelected.bind(this)),this.elem.bind("plotclick",this.onPlotClick.bind(this)),e.$on("$destroy",this.onScopeDestroy.bind(this))}return e.prototype.onRender=function(e){if(this.data=e||this.data,this.data){this.annotations=this.ctrl.annotations||[],this.buildFlotPairs(this.data);var t=this.elem.height();Object(j.g)(this.data,this.panel,t),this.ctrl.events.emit("render-legend")}},e.prototype.onGraphHover=function(e){this.dashboard.sharedTooltipModeEnabled()&&this.plot&&e.panel.id!==this.panel.id&&!this.ctrl.otherPanelInFullscreenMode()&&this.tooltip.show(e.pos)},e.prototype.onPanelteardown=function(){this.thresholdManager=null,this.plot&&(this.plot.destroy(),this.plot=null)},e.prototype.onLegendRenderingComplete=function(){this.render_panel()},e.prototype.onGraphHoverClear=function(e,t){this.plot&&this.tooltip.clear(this.plot)},e.prototype.onPlotSelected=function(e,t){var a=this;"time"===this.panel.xaxis.mode?(t.ctrlKey||t.metaKey)&&(this.dashboard.meta.canEdit||this.dashboard.meta.canMakeEditable)?setTimeout(function(){a.eventManager.updateTime(t.xaxis)},100):this.scope.$apply(function(){a.timeSrv.setTime({from:U.a.utc(t.xaxis.from),to:U.a.utc(t.xaxis.to)})}):this.plot.clearSelection()},e.prototype.onPlotClick=function(e,t,a){var r=this;"time"===this.panel.xaxis.mode&&((t.ctrlKey||t.metaKey)&&(this.dashboard.meta.canEdit||this.dashboard.meta.canMakeEditable)&&(t.x!==t.x1||setTimeout(function(){r.eventManager.updateTime({from:t.x,to:null})},100)))},e.prototype.onScopeDestroy=function(){this.tooltip.destroy(),this.elem.off(),this.elem.remove()},e.prototype.shouldAbortRender=function(){return!this.data||0===this.panelWidth},e.prototype.drawHook=function(e){this.panel.yaxes[0].label&&this.panel.yaxes[0].show&&O()("<div class='axisLabel left-yaxis-label flot-temp-elem'></div>").text(this.panel.yaxes[0].label).appendTo(this.elem),this.panel.yaxes[1].label&&this.panel.yaxes[1].show&&O()("<div class='axisLabel right-yaxis-label flot-temp-elem'></div>").text(this.panel.yaxes[1].label).appendTo(this.elem),this.ctrl.dataWarning&&O()('<div class="datapoints-warning flot-temp-elem">'+this.ctrl.dataWarning.title+"</div>").appendTo(this.elem),this.thresholdManager.draw(e)},e.prototype.processOffsetHook=function(e,t){var a=this.panel.yaxes[0],r=this.panel.yaxes[1];a.show&&a.label&&(t.left=20),r.show&&r.label&&(t.right=20);for(var n=e.getYAxes(),i=0;i<n.length;i++){var s=n[i],o=this.panel.yaxes[i];s.options.max=null!==s.options.max?s.options.max:o.max,s.options.min=null!==s.options.min?s.options.min:o.min}},e.prototype.processRangeHook=function(e){var t=e.getYAxes(),a=this.panel.yaxis.align||!1;if(t.length>1&&!0===a){var r=this.panel.yaxis.alignLevel||0;Bn(t,parseFloat(r))}},e.prototype.getMinTimeStepOfSeries=function(e){for(var t=Number.MAX_VALUE,a=0;a<e.length;a++)if(e[a].stats.timeStep){if(this.panel.bars){if(e[a].bars&&!1===e[a].bars.show)continue}else if(void 0===e[a].bars||void 0===e[a].bars.show||!e[a].bars.show)continue;e[a].stats.timeStep<t&&(t=e[a].stats.timeStep)}return t},e.prototype.render_panel=function(){if(this.panelWidth=this.elem.width(),!this.shouldAbortRender()){this.thresholdManager.prepare(this.elem,this.data),this.panel.dashes=!!this.panel.lines&&this.panel.dashes;var e=this.buildFlotOptions(this.panel);this.prepareXAxis(e,this.panel),this.configureYAxisOptions(this.data,e),this.thresholdManager.addFlotOptions(e,this.panel),this.eventManager.addFlotEvents(this.annotations,e),this.sortedSeries=this.sortSeries(this.data,this.panel),this.callPlot(e,!0)}},e.prototype.buildFlotPairs=function(e){for(var t=0;t<e.length;t++){var a=e[t];a.data=a.getFlotPairs(a.nullPointMode||this.panel.nullPointMode),this.ctrl.hiddenSeries[a.alias]&&(a.data=[],a.stack=!1)}},e.prototype.prepareXAxis=function(e,t){switch(t.xaxis.mode){case"series":e.series.bars.barWidth=.7,e.series.bars.align="center";for(var a=0;a<this.data.length;a++){var r=this.data[a];r.data=[[a+1,r.stats[t.xaxis.values[0]]]]}this.addXSeriesAxis(e);break;case"histogram":var n=void 0;if(this.data.length){var i=A.a.min(A.a.map(this.data,function(e){return e.stats.min})),s=A.a.max(A.a.map(this.data,function(e){return e.stats.max})),o=t.xaxis.buckets||this.panelWidth/50;n=Object($t.tickStep)(i,s,o),e.series.bars.barWidth=.8*n,this.data=Un(this.data,n,this.ctrl.hiddenSeries,i,s)}else n=0;this.addXHistogramAxis(e,n);break;case"table":e.series.bars.barWidth=.7,e.series.bars.align="center",this.addXTableAxis(e);break;default:e.series.bars.barWidth=this.getMinTimeStepOfSeries(this.data)/1.5,this.addTimeAxis(e)}},e.prototype.callPlot=function(e,t){try{this.plot=O.a.plot(this.elem,this.sortedSeries,e),this.ctrl.renderError&&(delete this.ctrl.error,delete this.ctrl.inspector)}catch(e){console.log("flotcharts error",e),this.ctrl.error=e.message||"Render Error",this.ctrl.renderError=!0,this.ctrl.inspector={error:e}}t&&this.ctrl.renderingCompleted()},e.prototype.buildFlotOptions=function(e){var t="#c8c8c8";!0===ke.a.bootData.user.lightTheme&&(t="#a1a1a1");var a=!!e.stack||null;return{hooks:{draw:[this.drawHook.bind(this)],processOffset:[this.processOffsetHook.bind(this)],processRange:[this.processRangeHook.bind(this)]},legend:{show:!1},series:{stackpercent:!!e.stack&&e.percentage,stack:e.percentage?null:a,lines:{show:e.lines,zero:!1,fill:this.translateFillOption(e.fill),lineWidth:e.dashes?0:e.linewidth,steps:e.steppedLine},dashes:{show:e.dashes,lineWidth:e.linewidth,dashLength:[e.dashLength,e.spaceLength]},bars:{show:e.bars,fill:1,barWidth:1,zero:!1,lineWidth:0},points:{show:e.points,fill:1,fillColor:!1,radius:e.points?e.pointradius:2},shadowSize:0},yaxes:[],xaxis:{},grid:{minBorderMargin:0,markings:[],backgroundColor:null,borderWidth:0,hoverable:!0,clickable:!0,color:t,margin:{left:0,right:0},labelMarginX:0},selection:{mode:"x",color:"#666"},crosshair:{mode:"x"}}},e.prototype.sortSeries=function(e,t){var a=t.legend.sort,r=t.legend.sortDesc,n=null!==a&&void 0!==a,i=null!==r&&void 0!==r,s=t.stack&&n&&i,o=!0===t.legend.sortDesc?-1:1;return s?A.a.sortBy(e,function(e){return e.stats[a]*o}):A.a.sortBy(e,function(e){return e.zindex})},e.prototype.translateFillOption=function(e){return this.panel.percentage&&this.panel.stack&&0===e?.001:e/10},e.prototype.addTimeAxis=function(e){var t=this.panelWidth/100,a=A.a.isUndefined(this.ctrl.range.from)?null:this.ctrl.range.from.valueOf(),r=A.a.isUndefined(this.ctrl.range.to)?null:this.ctrl.range.to.valueOf();e.xaxis={timezone:this.dashboard.getTimezone(),show:this.panel.xaxis.show,mode:"time",min:a,max:r,label:"Datetime",ticks:t,timeformat:this.time_format(t,a,r)}},e.prototype.addXSeriesAxis=function(e){var t=A.a.map(this.data,function(e,t){return[t+1,e.alias]});e.xaxis={timezone:this.dashboard.getTimezone(),show:this.panel.xaxis.show,mode:null,min:0,max:t.length+1,label:"Datetime",ticks:t}},e.prototype.addXHistogramAxis=function(e,t){var a,r,n,i=this.panelWidth/50;if(this.data.length&&t){for(var s=[],o=0,l=this.data;o<l.length;o++)for(var u=0,c=l[o].data;u<c.length;u++){s[c[u][0]]=!0}a=Object.keys(s).map(function(e){return Number(e)}),r=A.a.min(a),n=A.a.max(a);for(var h=t,p=Math.floor((n-r)/h);p>i;)h*=2,p=Math.ceil((n-r)/h);r=Math.floor(r/h)*h,n=Math.ceil(1.01*n/h)*h,a=[];for(var d=r;d<=n;d+=h)a.push(d)}else a=i/2,r=0,n=1;e.xaxis={timezone:this.dashboard.getTimezone(),show:this.panel.xaxis.show,mode:null,min:r,max:n,label:"Histogram",ticks:a},this.configureAxisMode(e.xaxis,"short")},e.prototype.addXTableAxis=function(e){var t=A.a.map(this.data,function(e,t){return A.a.map(e.datapoints,function(a,r){return[t*e.datapoints.length+r+1,a[1]]})});t=A.a.flatten(t,!0),e.xaxis={timezone:this.dashboard.getTimezone(),show:this.panel.xaxis.show,mode:null,min:0,max:t.length+1,label:"Datetime",ticks:t}},e.prototype.configureYAxisOptions=function(e,t){var a={position:"left",show:this.panel.yaxes[0].show,index:1,logBase:this.panel.yaxes[0].logBase||1,min:this.parseNumber(this.panel.yaxes[0].min),max:this.parseNumber(this.panel.yaxes[0].max),tickDecimals:this.panel.yaxes[0].decimals};if(t.yaxes.push(a),A.a.find(e,{yaxis:2})){var r=A.a.clone(a);r.index=2,r.show=this.panel.yaxes[1].show,r.logBase=this.panel.yaxes[1].logBase||1,r.position="right",r.min=this.parseNumber(this.panel.yaxes[1].min),r.max=this.parseNumber(this.panel.yaxes[1].max),r.tickDecimals=this.panel.yaxes[1].decimals,t.yaxes.push(r),this.applyLogScale(t.yaxes[1],e),this.configureAxisMode(t.yaxes[1],this.panel.percentage&&this.panel.stack?"percent":this.panel.yaxes[1].format)}this.applyLogScale(t.yaxes[0],e),this.configureAxisMode(t.yaxes[0],this.panel.percentage&&this.panel.stack?"percent":this.panel.yaxes[0].format)},e.prototype.parseNumber=function(e){return null===e||void 0===e?null:A.a.toNumber(e)},e.prototype.applyLogScale=function(e,t){if(1!==e.logBase){var a,r,n=0===e.min;e.min<Number.MIN_VALUE&&(e.min=null),e.max<Number.MIN_VALUE&&(e.max=null);var i=e.max,s=e.min;for(r=0;r<t.length;r++)(a=t[r]).yaxis===e.index&&((!i||i<a.stats.max)&&(i=a.stats.max),(!s||s>a.stats.logmin)&&(s=a.stats.logmin));e.transform=function(t){return t<Number.MIN_VALUE?null:Math.log(t)/Math.log(e.logBase)},e.inverseTransform=function(t){return Math.pow(e.logBase,t)},i||s?i?s||(s=i*e.inverseTransform(-4)):i=s*e.inverseTransform(4):(i=e.inverseTransform(2),s=e.inverseTransform(-2)),s=e.min?e.inverseTransform(Math.ceil(e.transform(e.min))):e.min=e.inverseTransform(Math.floor(e.transform(s))),i=e.max?e.inverseTransform(Math.floor(e.transform(e.max))):e.max=e.inverseTransform(Math.ceil(e.transform(i))),!s||s<Number.MIN_VALUE||!i||i<Number.MIN_VALUE||(Number.isFinite(s)&&Number.isFinite(i)?(n&&(e.min=.1,s=1),e.ticks=this.generateTicksForLogScaleYAxis(s,i,e.logBase),n&&e.ticks.unshift(.1),e.ticks[e.ticks.length-1]>e.max&&(e.max=e.ticks[e.ticks.length-1])):(e.ticks=[1,2],delete e.min,delete e.max))}},e.prototype.generateTicksForLogScaleYAxis=function(e,t,a){var r,n=[];for(r=e;r<=t;r*=a)n.push(r);var i=Math.ceil(this.ctrl.height/25),s=n.length;if(s>i){var o=Math.ceil(s/i)*a;for(n=[],r=e;r<=t*o;r*=o)n.push(r)}return n},e.prototype.configureAxisMode=function(e,t){e.tickFormatter=function(e,a){if(!ie.a.valueFormats[t])throw new Error("Unit '"+t+"' is not supported");return ie.a.valueFormats[t](e,a.tickDecimals,a.scaledDecimals)}},e.prototype.time_format=function(e,t,a){if(t&&a&&e){var r=a-t,n=r/e/1e3;return n<=45?"%H:%M:%S":n<=7200||r<=86400010?"%H:%M":n<=8e4?"%m/%d %H:%M":n<=2419200||r<=31536e6?"%m/%d":"%Y-%m"}return"%H:%M"},e}();function Gn(e,t,a){return{restrict:"A",template:"",link:function(t,a){return new Yn(t,a,e)}}}j.d.directive("grafanaGraph",Gn);var Wn=a(290),Kn=a.n(Wn);function Jn(e,t,a){e.overrideMenu=[],e.currentOverrides=[],e.override=e.override||{},e.addOverrideOption=function(t,a,r){var n={text:t,propertyName:a,index:e.overrideMenu.lenght,values:r,submenu:A.a.map(r,function(e){return{text:String(e),value:e}})};e.overrideMenu.push(n)},e.setOverride=function(t,a){"color"!==t.propertyName?(e.override[t.propertyName]=a.value,"fillBelowTo"===t.propertyName&&(e.override.lines=!1,e.ctrl.addSeriesOverride({alias:a.value,lines:!1})),e.updateCurrentOverrides(),e.ctrl.render()):e.openColorSelector(e.override.color)},e.colorSelected=function(t){e.override.color=t,e.updateCurrentOverrides(),e.ctrl.render()},e.openColorSelector=function(r){var n={color:r};a.show({element:t.find(".dropdown")[0],position:"top center",openOn:"click",template:'<series-color-picker series="series" onColorChange="colorSelected" />',model:{autoClose:!0,colorSelected:e.colorSelected,series:n},onClose:function(){e.ctrl.render()}})},e.removeOverride=function(t){delete e.override[t.propertyName],e.updateCurrentOverrides(),e.ctrl.refresh()},e.getSeriesNames=function(){return A.a.map(e.ctrl.seriesList,function(e){return e.alias})},e.updateCurrentOverrides=function(){e.currentOverrides=[],A.a.each(e.overrideMenu,function(t){var a=e.override[t.propertyName];A.a.isUndefined(a)||e.currentOverrides.push({name:t.text,propertyName:t.propertyName,value:String(a)})})},e.addOverrideOption("Bars","bars",[!0,!1]),e.addOverrideOption("Lines","lines",[!0,!1]),e.addOverrideOption("Line fill","fill",[0,1,2,3,4,5,6,7,8,9,10]),e.addOverrideOption("Line width","linewidth",[0,1,2,3,4,5,6,7,8,9,10]),e.addOverrideOption("Null point mode","nullPointMode",["connected","null","null as zero"]),e.addOverrideOption("Fill below to","fillBelowTo",e.getSeriesNames()),e.addOverrideOption("Staircase line","steppedLine",[!0,!1]),e.addOverrideOption("Dashes","dashes",[!0,!1]),e.addOverrideOption("Dash Length","dashLength",[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20]),e.addOverrideOption("Dash Space","spaceLength",[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20]),e.addOverrideOption("Points","points",[!0,!1]),e.addOverrideOption("Points Radius","pointradius",[1,2,3,4,5]),e.addOverrideOption("Stack","stack",[!0,!1,"A","B","C","D"]),e.addOverrideOption("Color","color",["change"]),e.addOverrideOption("Y-axis","yaxis",[1,2]),e.addOverrideOption("Z-index","zindex",[-3,-2,-1,0,1,2,3]),e.addOverrideOption("Transform","transform",["negative-Y"]),e.addOverrideOption("Legend","legend",[!0,!1]),e.addOverrideOption("Hide in tooltip","hideTooltip",[!0,!1]),e.updateCurrentOverrides()}D.a.module("grafana.directives").directive("graphLegend",["popoverSrv","$timeout",function(e,t){return{link:function(a,r){var n,i,s,o,l=!0,u=a.ctrl,c=u.panel,h=10,p=r.parent();function d(e){return e.parents("[data-series-index]").data("series-index")}function m(a){if(!O()(a.target).parents(".popover").length){var r=O()(a.currentTarget).find(".fa-minus"),n=d(r),s=i[n];t(function(){e.show({element:r[0],position:"bottom left",targetAttachment:"top left",template:'<series-color-picker series="series" onToggleAxis="toggleAxis" onColorChange="colorSelected"></series-color-picker>',openOn:"hover",model:{series:s,toggleAxis:function(){u.toggleAxis(s)},colorSelected:function(e){u.changeSeriesColor(s,e)}}})})}}function f(e){var t=d(O()(e.currentTarget)),a=i[t],r=o.scroller.scrollTop;u.toggleSeries(a,e),o.scroller.scrollTop=r}function g(e){var t=O()(e.currentTarget).data("stat");if(t!==c.legend.sort&&(c.legend.sortDesc=null),!1===c.legend.sortDesc)return c.legend.sort=null,c.legend.sortDesc=null,void u.render();c.legend.sortDesc=!c.legend.sortDesc,c.legend.sort=t,u.render()}function v(e){if(!c.legend[e])return"";var t='<th class="pointer" data-stat="'+e+'">'+e;c.legend.sort===e&&(t+=' <span class="'+(c.legend.sortDesc?"fa fa-caret-down":"fa fa-caret-up")+'"></span>');return t+"</th>"}function y(e){var t=r.width(),a=function(){var e=[];for(s=0;s<i.length;s++){var t=i[s];if(!t.hideFromLegend(c.legend)){var a='<div class="graph-legend-series';if(2===t.yaxis&&(a+=" graph-legend-series--right-y"),u.hiddenSeries[t.alias]&&(a+=" graph-legend-series-hidden"),a+='" data-series-index="'+s+'">',a+='<div class="graph-legend-icon">',a+='<i class="fa fa-minus pointer" style="color:'+t.color+'"></i>',a+="</div>",a+='<a class="graph-legend-alias pointer" title="'+t.aliasEscaped+'">'+t.aliasEscaped+"</a>",c.legend.values){var r=t.formatValue(t.stats.avg),n=t.formatValue(t.stats.current),o=t.formatValue(t.stats.min),l=t.formatValue(t.stats.max),h=t.formatValue(t.stats.total);c.legend.min&&(a+='<div class="graph-legend-value min">'+o+"</div>"),c.legend.max&&(a+='<div class="graph-legend-value max">'+l+"</div>"),c.legend.avg&&(a+='<div class="graph-legend-value avg">'+r+"</div>"),c.legend.current&&(a+='<div class="graph-legend-value current">'+n+"</div>"),c.legend.total&&(a+='<div class="graph-legend-value total">'+h+"</div>")}a+="</div>",e.push(O()(a))}}return e}();if(c.legend.alignAsTable){var n=O()("<tbody></tbody>");n.append(e),n.append(a),r.append(n),n.wrap('<div class="graph-legend-scroll"></div>')}else r.append('<div class="graph-legend-scroll"></div>'),r.find(".graph-legend-scroll").append(a);!c.legend.rightSide||c.legend.rightSide&&t!==h?function(){var e=r,t=r.find(".graph-legend-scroll");e.find(".baron__track").remove(),e.addClass("baron baron__root"),O()('\n          <div class="baron__track">\n            <div class="baron__bar"></div>\n          </div>\n        ').appendTo(e),t.addClass("baron__scroller");var a={root:e[0],scroller:t[0],bar:".baron__bar",track:".baron__track",barOnCls:"_scrollbar",scrollingCls:"_scrolling"};o?(b(),o=Kn()(a)):o=Kn()(a);t[0].style.marginRight="-"+(t[0].offsetWidth-t[0].clientWidth)+"px",o.scroll()}():b()}function b(){o&&(o.dispose(),o=void 0)}a.$on("$destroy",function(){b()}),u.events.on("render-legend",function(){(n=u.seriesList)&&function(){var e=p.width();if(!u.panel.legend.show)return r.empty(),void(l=!0);l&&(r.on("click",".graph-legend-icon",m),r.on("click",".graph-legend-alias",f),r.on("click","th",g),l=!1);i=n,r.empty();var t,a=c.legend.rightSide&&c.legend.sideWidth?c.legend.sideWidth+"px":"",s=c.legend.rightSide&&c.legend.sideWidth?c.legend.sideWidth-1+"px":"";if(p.css("min-width",a),p.css("width",s),r.toggleClass("graph-legend-table",!0===c.legend.alignAsTable),c.legend.alignAsTable){var o="<tr>";o+='<th colspan="2" style="text-align:left"></th>',c.legend.values&&(o+=v("min"),o+=v("max"),o+=v("avg"),o+=v("current"),o+=v("total")),o+="</tr>",t=O()(o)}c.legend.sort&&(i=A.a.sortBy(i,function(e){var t=e.stats[c.legend.sort];return null===t&&(t=-1/0),t}),c.legend.sortDesc&&(i=i.reverse()));(!c.legend.rightSide||c.legend.rightSide&&e!==h)&&(y(t),r.empty());y(t)}(),u.events.emit("legend-rendering-complete")})}}}]),D.a.module("grafana.controllers").controller("SeriesOverridesCtrl",Jn);var Xn=function(){function e(e){var t=this;this.panel=this.panelCtrl.panel,this.panel.alert&&(this.disabled=!0);var a=e.$on("$destroy",function(){t.panelCtrl.editingThresholds=!1,t.panelCtrl.render(),a()});this.panelCtrl.editingThresholds=!0}return e.$inject=["$scope"],e.prototype.addThreshold=function(){this.panel.thresholds.push({value:void 0,colorMode:"critical",op:"gt",fill:!0,line:!0,yaxis:"left"}),this.panelCtrl.render()},e.prototype.removeThreshold=function(e){this.panel.thresholds.splice(e,1),this.panelCtrl.render()},e.prototype.render=function(){this.panelCtrl.render()},e.prototype.onFillColorChange=function(e){var t=this;return function(a){t.panel.thresholds[e].fillColor=a,t.render()}},e.prototype.onLineColorChange=function(e){var t=this;return function(a){t.panel.thresholds[e].lineColor=a,t.render()}},e}();F.a.directive("graphThresholdForm",function(){return{restrict:"E",template:'\n<div class="gf-form-group">\n  <h5>Thresholds</h5>\n  <p class="muted" ng-show="ctrl.disabled">\n    Visual thresholds options <strong>disabled.</strong>\n    Visit the Alert tab update your thresholds. <br>\n    To re-enable thresholds, the alert rule must be deleted from this panel.\n  </p>\n  <div ng-class="{\'thresholds-form-disabled\': ctrl.disabled}">\n    <div class="gf-form-inline" ng-repeat="threshold in ctrl.panel.thresholds">\n      <div class="gf-form">\n        <label class="gf-form-label">T{{$index+1}}</label>\n      </div>\n\n      <div class="gf-form">\n        <div class="gf-form-select-wrapper">\n          <select class="gf-form-input" ng-model="threshold.op"\n                  ng-options="f for f in [\'gt\', \'lt\']" ng-change="ctrl.render()" ng-disabled="ctrl.disabled"></select>\n        </div>\n        <input type="number" ng-model="threshold.value" class="gf-form-input width-8"\n               ng-change="ctrl.render()" placeholder="value" ng-disabled="ctrl.disabled">\n      </div>\n\n      <div class="gf-form">\n        <label class="gf-form-label">Color</label>\n        <div class="gf-form-select-wrapper">\n          <select class="gf-form-input" ng-model="threshold.colorMode"\n                  ng-options="f for f in [\'custom\', \'critical\', \'warning\', \'ok\']" ng-change="ctrl.render()" ng-disabled="ctrl.disabled">\n          </select>\n        </div>\n      </div>\n\n      <gf-form-switch class="gf-form" label="Fill" checked="threshold.fill"\n                      on-change="ctrl.render()" ng-disabled="ctrl.disabled"></gf-form-switch>\n\n      <div class="gf-form" ng-if="threshold.fill && threshold.colorMode === \'custom\'">\n        <label class="gf-form-label">Fill color</label>\n        <span class="gf-form-label">\n          <color-picker color="threshold.fillColor" onChange="ctrl.onFillColorChange($index)"></color-picker>\n        </span>\n      </div>\n\n      <gf-form-switch class="gf-form" label="Line" checked="threshold.line"\n                      on-change="ctrl.render()" ng-disabled="ctrl.disabled"></gf-form-switch>\n\n      <div class="gf-form" ng-if="threshold.line && threshold.colorMode === \'custom\'">\n        <label class="gf-form-label">Line color</label>\n        <span class="gf-form-label">\n          <color-picker color="threshold.lineColor" onChange="ctrl.onLineColorChange($index)"></color-picker>\n        </span>\n      </div>\n\n      <div class="gf-form">\n        <label class="gf-form-label">Y-Axis</label>\n        <div class="gf-form-select-wrapper">\n          <select class="gf-form-input" ng-model="threshold.yaxis"\n                  ng-init="threshold.yaxis = threshold.yaxis === \'left\' || threshold.yaxis === \'right\' ? threshold.yaxis : \'left\'"\n                  ng-options="f for f in [\'left\', \'right\']" ng-change="ctrl.render()" ng-disabled="ctrl.disabled">\n          </select>\n        </div>\n      </div>\n\n      <div class="gf-form">\n        <label class="gf-form-label">\n          <a class="pointer" ng-click="ctrl.removeThreshold($index)" ng-disabled="ctrl.disabled">\n            <i class="fa fa-trash"></i>\n          </a>\n        </label>\n      </div>\n    </div>\n\n    <div class="gf-form-button-row">\n      <button class="btn btn-inverse" ng-click="ctrl.addThreshold()" ng-disabled="ctrl.disabled">\n        <i class="fa fa-plus"></i>&nbsp;Add Threshold\n      </button>\n    </div>\n  </div>\n</div>\n',controller:Xn,bindToController:!0,controllerAs:"ctrl",scope:{panelCtrl:"="}}});var Zn=function(){function e(e){this.panel=e}return e.prototype.getSeriesList=function(e){var t,a=this;if(!e.dataList||0===e.dataList.length)return[];if(e.dataList&&e.dataList.length>0){t=e.dataList[0];var r=this.getAutoDetectXAxisMode(t);this.panel.xaxis.mode!==r&&(this.panel.xaxis.mode=r,this.setPanelDefaultsForNewXAxisMode())}switch(this.panel.xaxis.mode){case"series":case"time":return e.dataList.map(function(t,r){return a.timeSeriesHandler(t,r,e)});case"histogram":return(this.panel.stack?e.dataList:[{target:"count",datapoints:A.a.concat([],A.a.flatten(A.a.map(e.dataList,"datapoints")))}]).map(function(t,r){return a.timeSeriesHandler(t,r,e)});case"field":return this.customHandler(t)}},e.prototype.getAutoDetectXAxisMode=function(e){switch(e.type){case"docs":case"table":return"field";default:return"series"===this.panel.xaxis.mode?"series":"histogram"===this.panel.xaxis.mode?"histogram":"time"}},e.prototype.setPanelDefaultsForNewXAxisMode=function(){switch(this.panel.xaxis.mode){case"time":this.panel.bars=!1,this.panel.lines=!0,this.panel.points=!1,this.panel.legend.show=!0,this.panel.tooltip.shared=!0,this.panel.xaxis.values=[];break;case"series":this.panel.bars=!0,this.panel.lines=!1,this.panel.points=!1,this.panel.stack=!1,this.panel.legend.show=!1,this.panel.tooltip.shared=!1,this.panel.xaxis.values=["total"];break;case"histogram":this.panel.bars=!0,this.panel.lines=!1,this.panel.points=!1,this.panel.stack=!1,this.panel.legend.show=!1,this.panel.tooltip.shared=!1}},e.prototype.timeSeriesHandler=function(e,t,a){var r=e.datapoints||[],n=e.target,i=t%G.f.length,s=this.panel.aliasColors[n]||G.f[i],o=new ot.a({datapoints:r,alias:n,color:s,unit:e.unit});r&&r.length>0&&(r[r.length-1][1]-a.range.from<-1e4&&(o.isOutsideRange=!0));return o},e.prototype.customHandler=function(e){if(!this.panel.xaxis.name)throw{message:"No field name specified to use for x-axis, check your axes settings"};return[]},e.prototype.validateXAxisSeriesValue=function(){switch(this.panel.xaxis.mode){case"series":if(0===this.panel.xaxis.values.length)return void(this.panel.xaxis.values=["total"]);var e=this.getXAxisValueOptions({});return void(A.a.find(e,{value:this.panel.xaxis.values[0]})||(this.panel.xaxis.values=["total"]))}},e.prototype.getDataFieldNames=function(e,t){if(0===e.length)return[];var a=[],r=e[0],n=[];if("docs"===r.type){if(0===r.datapoints.length)return[];!function e(r){A.a.forEach(r,function(r,i){if(A.a.isObject(r))n.push(i),e(r);else if(!t||A.a.isNumber(r)){var s=n.concat(i).join(".");a.push(s)}}),n.pop()}(r.datapoints[0])}return a},e.prototype.getXAxisValueOptions=function(e){switch(this.panel.xaxis.mode){case"series":return[{text:"Avg",value:"avg"},{text:"Min",value:"min"},{text:"Max",value:"max"},{text:"Total",value:"total"},{text:"Count",value:"count"}]}return[]},e.prototype.pluckDeep=function(e,t){for(var a=t.split("."),r=e,n=0;n<a.length;++n){if(!r[a[n]])return;r=r[a[n]]}return r},e}(),ei=function(){function e(e,t){this.$scope=e,this.$q=t,this.panelCtrl=e.ctrl,this.panel=this.panelCtrl.panel,this.$scope.ctrl=this,this.unitFormats=ie.a.getUnitFormats(),this.logScales={linear:1,"log (base 2)":2,"log (base 10)":10,"log (base 32)":32,"log (base 1024)":1024},this.xAxisModes={Time:"time",Series:"series",Histogram:"histogram"},this.xAxisStatOptions=[{text:"Avg",value:"avg"},{text:"Min",value:"min"},{text:"Max",value:"max"},{text:"Total",value:"total"},{text:"Count",value:"count"},{text:"Current",value:"current"}],"custom"===this.panel.xaxis.mode&&(this.panel.xaxis.name||(this.panel.xaxis.name="specify field"))}return e.$inject=["$scope","$q"],e.prototype.setUnitFormat=function(e,t){e.format=t.value,this.panelCtrl.render()},e.prototype.render=function(){this.panelCtrl.render()},e.prototype.xAxisModeChanged=function(){this.panelCtrl.processor.setPanelDefaultsForNewXAxisMode(),this.panelCtrl.onDataReceived(this.panelCtrl.dataList)},e.prototype.xAxisValueChanged=function(){this.panelCtrl.onDataReceived(this.panelCtrl.dataList)},e.prototype.getDataFieldNames=function(e){var t=this.panelCtrl.processor.getDataFieldNames(this.panelCtrl.dataList,e).map(function(e){return{text:e,value:e}});return this.$q.when(t)},e}();function ti(){return{restrict:"E",scope:!0,templateUrl:"public/app/plugins/panel/graph/axes_editor.html",controller:ei}}var ai=function(e){function t(t,a,r){var n=e.call(this,t,a)||this;return n.annotationsSrv=r,n.hiddenSeries={},n.seriesList=[],n.dataList=[],n.annotations=[],n.colors=[],n.panelDefaults={datasource:null,renderer:"flot",yaxes:[{label:null,show:!0,logBase:1,min:null,max:null,format:"short"},{label:null,show:!0,logBase:1,min:null,max:null,format:"short"}],xaxis:{show:!0,mode:"time",name:null,values:[],buckets:null},yaxis:{align:!1,alignLevel:null},lines:!0,fill:1,linewidth:1,dashes:!1,dashLength:10,spaceLength:10,points:!1,pointradius:5,bars:!1,stack:!1,percentage:!1,legend:{show:!0,values:!1,min:!1,max:!1,current:!1,total:!1,avg:!1},nullPointMode:"null",steppedLine:!1,tooltip:{value_type:"individual",shared:!0,sort:0},timeFrom:null,timeShift:null,targets:[{}],aliasColors:{},seriesOverrides:[],thresholds:[]},A.a.defaults(n.panel,n.panelDefaults),A.a.defaults(n.panel.tooltip,n.panelDefaults.tooltip),A.a.defaults(n.panel.legend,n.panelDefaults.legend),A.a.defaults(n.panel.xaxis,n.panelDefaults.xaxis),n.processor=new Zn(n.panel),n.events.on("render",n.onRender.bind(n)),n.events.on("data-received",n.onDataReceived.bind(n)),n.events.on("data-error",n.onDataError.bind(n)),n.events.on("data-snapshot-load",n.onDataSnapshotLoad.bind(n)),n.events.on("init-edit-mode",n.onInitEditMode.bind(n)),n.events.on("init-panel-actions",n.onInitPanelActions.bind(n)),n}return t.$inject=["$scope","$injector","annotationsSrv"],Ve.c(t,e),t.prototype.onInitEditMode=function(){this.addEditorTab("Axes",ti,2),this.addEditorTab("Legend","public/app/plugins/panel/graph/tab_legend.html",3),this.addEditorTab("Display","public/app/plugins/panel/graph/tab_display.html",4),ke.a.alertingEnabled&&this.addEditorTab("Alert",Je,5),this.subTabIndex=0},t.prototype.onInitPanelActions=function(e){e.push({text:"Export CSV",click:"ctrl.exportCsv()"}),e.push({text:"Toggle legend",click:"ctrl.toggleLegend()"})},t.prototype.issueQueries=function(t){return this.annotationsPromise=this.annotationsSrv.getAnnotations({dashboard:this.dashboard,panel:this.panel,range:this.range}),e.prototype.issueQueries.call(this,t)},t.prototype.zoomOut=function(e){this.publishAppEvent("zoom-out",2)},t.prototype.onDataSnapshotLoad=function(e){this.annotationsPromise=this.annotationsSrv.getAnnotations({dashboard:this.dashboard,panel:this.panel,range:this.range}),this.onDataReceived(e)},t.prototype.onDataError=function(e){this.seriesList=[],this.annotations=[],this.render([])},t.prototype.onDataReceived=function(e){var t=this;if(this.dataList=e,this.seriesList=this.processor.getSeriesList({dataList:e,range:this.range}),this.dataWarning=null,0===this.seriesList.reduce(function(e,t){return e+t.datapoints.length},0))this.dataWarning={title:"No data points",tip:"No datapoints returned from data query"};else for(var a=0,r=this.seriesList;a<r.length;a++){if(r[a].isOutsideRange){this.dataWarning={title:"Data points outside time range",tip:"Can be caused by timezone mismatch or missing time filter in query"};break}}this.annotationsPromise.then(function(e){t.loading=!1,t.alertState=e.alertState,t.annotations=e.annotations,t.render(t.seriesList)},function(){t.loading=!1,t.render(t.seriesList)})},t.prototype.onRender=function(){if(this.seriesList)for(var e=0,t=this.seriesList;e<t.length;e++){var a=t[e];a.applySeriesOverrides(this.panel.seriesOverrides),a.unit&&(this.panel.yaxes[a.yaxis-1].format=a.unit)}},t.prototype.changeSeriesColor=function(e,t){e.setColor(t),this.panel.aliasColors[e.alias]=e.color,this.render()},t.prototype.toggleSeries=function(e,t){t.ctrlKey||t.metaKey||t.shiftKey?this.hiddenSeries[e.alias]?delete this.hiddenSeries[e.alias]:this.hiddenSeries[e.alias]=!0:this.toggleSeriesExclusiveMode(e),this.render()},t.prototype.toggleSeriesExclusiveMode=function(e){var t=this,a=this.hiddenSeries;a[e.alias]&&delete a[e.alias],A.a.every(this.seriesList,function(t){return t.alias===e.alias||a[t.alias]})?A.a.each(this.seriesList,function(e){delete t.hiddenSeries[e.alias]}):A.a.each(this.seriesList,function(a){a.alias!==e.alias&&(t.hiddenSeries[a.alias]=!0)})},t.prototype.toggleAxis=function(e){var t=A.a.find(this.panel.seriesOverrides,{alias:e.alias});t||(t={alias:e.alias},this.panel.seriesOverrides.push(t)),e.yaxis=t.yaxis=2===e.yaxis?1:2,this.render()},t.prototype.addSeriesOverride=function(e){this.panel.seriesOverrides.push(e||{})},t.prototype.removeSeriesOverride=function(e){this.panel.seriesOverrides=A.a.without(this.panel.seriesOverrides,e),this.render()},t.prototype.toggleLegend=function(){this.panel.legend.show=!this.panel.legend.show,this.refresh()},t.prototype.legendValuesOptionChanged=function(){var e=this.panel.legend;e.values=e.min||e.max||e.avg||e.current||e.total,this.render()},t.prototype.exportCsv=function(){var e=this.$scope.$new(!0);e.seriesList=this.seriesList,this.publishAppEvent("show-modal",{templateHtml:'<export-data-modal data="seriesList"></export-data-modal>',scope:e,modalClass:"modal--narrow"})},t.template='\n<div class="graph-panel" ng-class="{\'graph-panel--legend-right\': ctrl.panel.legend.rightSide}">\n  <div class="graph-panel__chart" grafana-graph ng-dblclick="ctrl.zoomOut()">\n  </div>\n\n  <div class="graph-legend">\n    <div class="graph-legend-content" graph-legend></div>\n  </div>\n</div>\n',t}(ze),ri=function(e){function t(t,a,r,n){var i=e.call(this,t,a)||this;return i.backendSrv=r,i.dashboardSrv=n,i.panelDefaults={query:"",limit:10,tags:[],recent:!1,search:!1,starred:!0,headings:!0,folderId:null},A.a.defaults(i.panel,i.panelDefaults),i.panel.tag&&(i.panel.tags=[i.panel.tag],delete i.panel.tag),i.events.on("refresh",i.onRefresh.bind(i)),i.events.on("init-edit-mode",i.onInitEditMode.bind(i)),i.groups=[{list:[],show:!1,header:"Starred dashboards"},{list:[],show:!1,header:"Recently viewed dashboards"},{list:[],show:!1,header:"Search"}],i.panel.mode&&("starred"===i.panel.mode&&(i.panel.starred=!0,i.panel.headings=!1),"recently viewed"===i.panel.mode&&(i.panel.recent=!0,i.panel.starred=!1,i.panel.headings=!1),"search"===i.panel.mode&&(i.panel.search=!0,i.panel.starred=!1,i.panel.headings=!1),delete i.panel.mode),i}return t.$inject=["$scope","$injector","backendSrv","dashboardSrv"],Ve.c(t,e),t.prototype.onInitEditMode=function(){this.editorTabIndex=1,this.modes=["starred","search","recently viewed"],this.addEditorTab("Options","public/app/plugins/panel/dashlist/editor.html")},t.prototype.onRefresh=function(){var e=[];return e.push(this.getRecentDashboards()),e.push(this.getStarred()),e.push(this.getSearch()),Promise.all(e).then(this.renderingCompleted.bind(this))},t.prototype.getSearch=function(){var e=this;if(this.groups[2].show=this.panel.search,!this.panel.search)return Promise.resolve();var t={limit:this.panel.limit,query:this.panel.query,tag:this.panel.tags,folderIds:this.panel.folderId,type:"dash-db"};return this.backendSrv.search(t).then(function(t){e.groups[2].list=t})},t.prototype.getStarred=function(){var e=this;if(this.groups[0].show=this.panel.starred,!this.panel.starred)return Promise.resolve();var t={limit:this.panel.limit,starred:"true"};return this.backendSrv.search(t).then(function(t){e.groups[0].list=t})},t.prototype.starDashboard=function(e,t){this.dashboardSrv.starDashboard(e.id,e.isStarred).then(function(t){e.isStarred=t}),t&&(t.stopPropagation(),t.preventDefault())},t.prototype.getRecentDashboards=function(){var e=this;if(this.groups[1].show=this.panel.recent,!this.panel.recent)return Promise.resolve();var t=A.a.take(At.a.getDashboardOpened(),this.panel.limit);return this.backendSrv.search({dashboardIds:t,limit:this.panel.limit}).then(function(a){e.groups[1].list=t.map(function(e){return A.a.find(a,function(t){return t.id===e})}).filter(function(e){return void 0!==e})})},t.prototype.onFolderChange=function(e){this.panel.folderId=e.id,this.refresh()},t.templateUrl="module.html",t.scrollable=!0,t}(Le),ni=function(e){function t(t,a,r){var n=e.call(this,t,a)||this;return n.backendSrv=r,n.panelDefaults={},A.a.defaults(n.panel,n.panelDefaults),n.events.on("init-edit-mode",n.onInitEditMode.bind(n)),n.pluginList=[],n.viewModel=[{header:"Installed Apps",list:[],type:"app"},{header:"Installed Panels",list:[],type:"panel"},{header:"Installed Datasources",list:[],type:"datasource"}],n.update(),n}return t.$inject=["$scope","$injector","backendSrv"],Ve.c(t,e),t.prototype.onInitEditMode=function(){this.editorTabIndex=1,this.addEditorTab("Options","public/app/plugins/panel/pluginlist/editor.html")},t.prototype.gotoPlugin=function(e,t){t&&t.stopPropagation(),this.$location.url("plugins/"+e.id+"/edit")},t.prototype.updateAvailable=function(e,t){t.stopPropagation(),t.preventDefault();var a=this.$scope.$new(!0);a.plugin=e,this.publishAppEvent("show-modal",{src:"public/app/features/plugins/partials/update_instructions.html",scope:a})},t.prototype.update=function(){var e=this;this.backendSrv.get("api/plugins",{embedded:0,core:0}).then(function(t){e.pluginList=t,e.viewModel[0].list=A.a.filter(t,{type:"app"}),e.viewModel[1].list=A.a.filter(t,{type:"panel"}),e.viewModel[2].list=A.a.filter(t,{type:"datasource"});for(var a=0,r=e.pluginList;a<r.length;a++){var n=r[a];n.hasUpdate?n.state="has-update":n.enabled||(n.state="not-enabled")}})},t.templateUrl="module.html",t.scrollable=!0,t}(Le),ii=function(e){function t(t,a,r){var n=e.call(this,t,a)||this;for(var i in n.backendSrv=r,n.showOptions=[{text:"Current state",value:"current"},{text:"Recent state changes",value:"changes"}],n.sortOrderOptions=[{text:"Alphabetical (asc)",value:1},{text:"Alphabetical (desc)",value:2},{text:"Importance",value:3}],n.stateFilter={},n.currentAlerts=[],n.alertHistory=[],n.panelDefaults={show:"current",limit:10,stateFilter:[],onlyAlertsOnDashboard:!1,sortOrder:1,dashboardFilter:"",nameFilter:"",folderId:null},A.a.defaults(n.panel,n.panelDefaults),n.events.on("init-edit-mode",n.onInitEditMode.bind(n)),n.events.on("refresh",n.onRefresh.bind(n)),n.panel.stateFilter)n.stateFilter[n.panel.stateFilter[i]]=!0;return n}return t.$inject=["$scope","$injector","backendSrv"],Ve.c(t,e),t.prototype.sortResult=function(e){if(3===this.panel.sortOrder)return A.a.sortBy(e,function(e){return K.a.alertStateSortScore[e.state]});var t=A.a.sortBy(e,function(e){return e.name.toLowerCase()});return 2===this.panel.sortOrder&&t.reverse(),t},t.prototype.updateStateFilter=function(){var e=[];for(var t in this.stateFilter)this.stateFilter[t]&&e.push(t);this.panel.stateFilter=e,this.onRefresh()},t.prototype.onRefresh=function(){var e,t=this;"current"===this.panel.show&&(e=this.getCurrentAlertState()),"changes"===this.panel.show&&(e=this.getStateChanges()),e.then(function(){t.renderingCompleted()})},t.prototype.onFolderChange=function(e){this.panel.folderId=e.id,this.refresh()},t.prototype.getStateChanges=function(){var e=this,t={limit:this.panel.limit,type:"alert",newState:this.panel.stateFilter};return this.panel.onlyAlertsOnDashboard&&(t.dashboardId=this.dashboard.id),t.from=1e3*je.parse(this.dashboard.time.from).unix(),t.to=1e3*je.parse(this.dashboard.time.to).unix(),this.backendSrv.get("/api/annotations",t).then(function(t){return e.alertHistory=A.a.map(t,function(t){return t.time=e.dashboard.formatDate(t.time,"MMM D, YYYY HH:mm:ss"),t.stateModel=K.a.getStateDisplayModel(t.newState),t.info=K.a.getAlertAnnotationInfo(t),t}),e.noAlertsMessage=0===e.alertHistory.length?"No alerts in current time range":"",e.alertHistory})},t.prototype.getCurrentAlertState=function(){var e=this,t={state:this.panel.stateFilter};return this.panel.nameFilter&&(t.query=this.panel.nameFilter),this.panel.folderId>=0&&(t.folderId=this.panel.folderId),this.panel.dashboardFilter&&(t.dashboardQuery=this.panel.dashboardFilter),this.panel.onlyAlertsOnDashboard&&(t.dashboardId=this.dashboard.id),this.panel.dashboardTags&&(t.dashboardTag=this.panel.dashboardTags),this.backendSrv.get("/api/alerts",t).then(function(t){return e.currentAlerts=e.sortResult(A.a.map(t,function(e){return e.stateModel=K.a.getStateDisplayModel(e.state),e.newStateDateAgo=U()(e.newStateDate).locale("en").fromNow(!0),e})),e.currentAlerts.length>e.panel.limit&&(e.currentAlerts=e.currentAlerts.slice(0,e.panel.limit)),e.noAlertsMessage=0===e.currentAlerts.length?"No alerts":"",e.currentAlerts})},t.prototype.onInitEditMode=function(){this.addEditorTab("Options","public/app/plugins/panel/alertlist/editor.html")},t.templateUrl="module.html",t.scrollable=!0,t}(Le),si=a(1224),oi=a(1237);function li(e,t,a,r){void 0===r&&(r=0);var n=oi[e.value],i="always"===e.invert||e.invert===(t?"light":"dark"),s=i?a:r,o=i?r:a;return si.scaleSequential(n).domain([s,o])}function ui(e,t,a){var r;return void 0===a&&(a=0),"linear"===e.colorScale?r=si.scaleLinear().domain([a,t]).range([0,1]):"sqrt"===e.colorScale&&(r=si.scalePow().exponent(e.exponent).domain([a,t]).range([0,1])),r}var ci=D.a.module("grafana.directives"),hi=0,pi=0;function di(e,t,a,r,n,i,s){var o=O()(e).find("svg"),l=si.select(o.get(0));if(!(s<=0||0===o.get(0).childNodes.length)){var u=si.scaleLinear().domain([0,r]).range([0,s]),c=function(e,t,a,r){for(var n=t-e,i=Object($t.tickStep)(e,t,3),s=Math.round(n/i),o=[],l=0;l<s;l++){var u=i*l;fi(r,u,i)?o.push(r):(r<u&&o.push(r),fi(a,u,i)?o.push(a):(a<u&&o.push(a),o.push(i*l)))}fi(a,t,i)||o.push(a);return o.push(t),o=A.a.sortBy(A.a.uniq(o))}(0,r,n,i),h=si.axisBottom(u).tickValues(c).tickSize(hi),p=o.find(":first-child"),d=function(e){var t=e.get(0);return t&&t.height&&t.height.baseVal?t.height.baseVal.value:0}(o)+pi,m=function(e){var t=e.get(0);return t&&t.x&&t.x.baseVal?t.x.baseVal.value:0}(p);si.select(o.get(0)).append("g").attr("class","axis").attr("transform","translate("+m+","+d+")").call(h),l.select(".axis").select(".domain").remove()}}function mi(e){O()(e).find("svg").empty()}function fi(e,t,a){return Math.abs(e-t)<.3*a}ci.directive("colorLegend",function(){return{restrict:"E",template:'<div class="heatmap-color-legend"><svg width="16.5rem" height="24px"></svg></div>',link:function(e,t,a){var r=e.ctrl,n=e.ctrl.panel;function i(){var e=O()(t).find("svg"),a=Math.floor(e.outerWidth());if("spectrum"===n.color.mode){var i=li(A.a.find(r.colorSchemes,{value:n.color.colorScheme}),j.c.user.lightTheme,a);!function(e,t){var a=O()(e).find("svg");mi(e);var r=Math.floor(a.outerWidth()),n=a.attr("height");if(r){var i=Math.floor(r/2),s=Math.floor(r/i),o=si.range(0,r,s),l=si.select(a.get(0)),u=l.selectAll(".heatmap-color-legend-rect").data(o);u.enter().append("rect").attr("x",function(e){return e}).attr("y",0).attr("width",s+1).attr("height",n).attr("stroke-width",0).attr("fill",function(e){return t(e)})}}(t,i)}else if("opacity"===n.color.mode){var s=n.color;!function(e,t){var a=O()(e).find("svg");mi(e);var r=si.select(a.get(0)),n=Math.floor(a.outerWidth()),i=a.attr("height");if(n){var s;"linear"===t.colorScale?s=si.scaleLinear().domain([0,n]).range([0,1]):"sqrt"===t.colorScale&&(s=si.scalePow().exponent(t.exponent).domain([0,n]).range([0,1]));var o=si.range(0,n,10),l=r.selectAll(".heatmap-opacity-legend-rect").data(o);l.enter().append("rect").attr("x",function(e){return e}).attr("y",0).attr("width",10).attr("height",i).attr("stroke-width",0).attr("fill",t.cardColor).style("opacity",function(e){return s(e)})}}(t,s)}}i(),r.events.on("render",function(){i()})}}}),ci.directive("heatmapLegend",function(){return{restrict:"E",template:'<div class="heatmap-color-legend"><svg width="100px" height="6px"></svg></div>',link:function(e,t,a){var r=e.ctrl,n=e.ctrl.panel;function i(){if(mi(t),!A.a.isEmpty(r.data)&&!A.a.isEmpty(r.data.cards)){var e=r.data.cardStats.max,a=n.color.max||e,i=n.color.min||0;if("spectrum"===n.color.mode){var s=A.a.find(r.colorSchemes,{value:n.color.colorScheme});!function(e,t,a,r,n,i){var s=O()(e).find("svg"),o=si.select(s.get(0));mi(e);var l=Math.floor(s.outerWidth())-30,u=s.attr("height"),c=1;r-a>l&&(c=Math.floor((r-a)/l));var h=l/(r-a),p=si.range(a,r,c),d=li(t,j.c.user.lightTheme,n,i);o.selectAll(".heatmap-color-legend-rect").data(p).enter().append("rect").attr("x",function(e){return e*h}).attr("y",0).attr("width",c*h+1).attr("height",u).attr("stroke-width",0).attr("fill",function(e){return d(e)}),di(e,d,a,r,n,i,l)}(t,s,0,e,a,i)}else if("opacity"===n.color.mode){var o=n.color;!function(e,t,a,r,n,i){var s=O()(e).find("svg"),o=si.select(s.get(0));mi(e);var l=Math.floor(s.outerWidth())-30,u=s.attr("height"),c=1;r-a>l&&(c=Math.floor((r-a)/l));var h=l/(r-a),p=si.range(a,r,c),d=ui(t,n,i);o.selectAll(".heatmap-opacity-legend-rect").data(p).enter().append("rect").attr("x",function(e){return e*h}).attr("y",0).attr("width",c*h).attr("height",u).attr("stroke-width",0).attr("fill",t.cardColor).style("opacity",function(e){return d(e)}),di(e,d,a,r,n,i,l)}(t,o,0,e,a,i)}}}i(),r.events.on("render",function(){i()})}}});var gi=function(){function e(e,t){e.editor=this,this.panelCtrl=e.ctrl,this.panel=this.panelCtrl.panel,this.unitFormats=ie.a.getUnitFormats(),this.logScales={linear:1,"log (base 2)":2,"log (base 10)":10,"log (base 32)":32,"log (base 1024)":1024},this.dataFormats={"Time series":"timeseries","Time series buckets":"tsbuckets"},this.yBucketBoundModes={Auto:"auto",Upper:"upper",Lower:"lower"}}return e.$inject=["$scope","uiSegmentSrv"],e.prototype.setUnitFormat=function(e){this.panel.yAxis.format=e.value,this.panelCtrl.render()},e}();function vi(){return{restrict:"E",scope:!0,templateUrl:"public/app/plugins/panel/heatmap/partials/axes_editor.html",controller:gi}}var yi=function(){function e(e){e.editor=this,this.panelCtrl=e.ctrl,this.panel=this.panelCtrl.panel,this.panelCtrl.render()}return e.$inject=["$scope"],e}();function bi(){return{restrict:"E",scope:!0,templateUrl:"public/app/plugins/panel/heatmap/partials/display_editor.html",controller:yi}}var Si=0,xi=1;function wi(e,t){var a,r;try{a=Ti(e.label),r=Ti(t.label)}catch(e){return console.log(e.message||e),0}return a>r?1:a<r?-1:0}function Ti(e){if("+Inf"===e||"inf"===e)return 1/0;var t=Number(e);if(isNaN(t))throw new Error("Error parsing histogram label: "+e+" is not a number");return t}function Ci(e){var t=0,a=0,r=[];return A.a.forEach(e,function(e){A.a.forEach(e.buckets,function(n){var i={x:e.x,y:n.y,yBounds:n.bounds,values:n.values,count:n.count};r.push(i),1===r.length&&(t=n.count,a=n.count),t=n.count<t?n.count:t,a=n.count>a?n.count:a})}),{cards:r,cardStats:{min:t,max:a}}}function ki(e,t,a,r){void 0===r&&(r=1);for(var n={},i=function(e){var t=e.datapoints,r=e.label;A.a.forEach(t,function(e){var t=Pi(e[xi],a);!function(e,t,a,r){var n=t[Si];if(null===n||void 0===n||isNaN(n))return;var i=A.a.concat(t,r);e[a]&&e[a].values?(e[a].values.push(n),e[a].points.push(i)):e[a]={x:a,values:[n],points:[i]}}(n,e,t,r)})},s=0,o=e;s<o.length;s++){i(o[s])}return A.a.forEach(n,function(e){e.buckets=1!==r?function(e,t,a){var r=e.values,n=e.points,i={};return A.a.forEach(r,function(e,r){var s=Di(e,t,a),o=s.bottom;_i(i,o,e,n[r],s)}),i}(e,t,r):function(e,t){var a=e.values,r=e.points,n={};return A.a.forEach(a,function(e,a){var i=Mi(e,t),s=i.bottom;_i(n,s,e,r[a],i)}),n}(e,t)}),n}function _i(e,t,a,r,n){var i=1;r.length>3&&(i=parseInt(r[2],10)),e[t]?(e[t].values.push(a),e[t].points.push(r),e[t].count+=i):e[t]={y:t,bounds:n,values:[a],points:[r],count:i}}function Ei(e,t,a){return 1===a?Pi(e,t):function(e,t,a){return Di(e,t,a).bottom}(e,t,a)}function Mi(e,t){return{bottom:Math.floor(e/t)*t,top:(Math.floor(e/t)+1)*t}}function Pi(e,t){return Mi(e,t).bottom}function Di(e,t,a){if(0===e)return{bottom:0,top:0};var r,n,i=$i(e,a);if(1!==t&&t){var s=1/t,o=i-Math.floor(i);o=Math.floor(o/s)*s,n=(r=Math.floor(i)+o)+s}else n=(r=Math.floor(i))+1;return{bottom:Math.pow(a,r),top:Math.pow(a,n)}}function $i(e,t){return Math.log(e)/Math.log(t)}function Ai(e,t,a){return void 0===a&&(a=1),1===a?Math.abs(t-e):$i(Math.max(e,t)/Math.min(e,t),a)}var Ii=function(){function e(e,t){this.scope=t,this.dashboard=t.ctrl.dashboard,this.panelCtrl=t.ctrl,this.panel=t.ctrl.panel,this.heatmapPanel=e,this.mouseOverBucket=!1,this.originalFillColor=null,e.on("mouseleave",this.onMouseLeave.bind(this))}return e.prototype.onMouseLeave=function(){this.destroy()},e.prototype.onMouseMove=function(e){this.panel.tooltip.show&&this.move(e)},e.prototype.add=function(){this.tooltip=si.select("body").append("div").attr("class","heatmap-tooltip graph-tooltip grafana-tooltip")},e.prototype.destroy=function(){this.tooltip&&this.tooltip.remove(),this.tooltip=null},e.prototype.show=function(e,t){if(this.panel.tooltip.show&&t&&!e.panelRelY){var a=this.getBucketIndexes(e,t),r=a.xBucketIndex,n=a.yBucketIndex;if(t.buckets[r]){var i,s;this.tooltip||this.add();var o,l,u=t.buckets[r],c=A.a.find(u.buckets,function(e,t){return e.bounds.bottom===n||t===n.toString()}),h=this.dashboard.formatDate(u.x,"YYYY-MM-DD HH:mm:ss");if(A.a.isNumber(this.panel.tooltipDecimals))o=this.countValueFormatter(this.panel.tooltipDecimals,null),l=this.panelCtrl.tickValueFormatter(this.panelCtrl.decimals,null);else{var p=(this.panelCtrl.decimals||-1)+1;o=this.countValueFormatter(p,this.panelCtrl.scaledDecimals+2),l=this.panelCtrl.tickValueFormatter(p,this.panelCtrl.scaledDecimals+2)}var d='<div class="graph-tooltip-time">'+h+'</div>\n      <div class="heatmap-histogram"></div>';if(c)if(c.bounds){if(t.tsBuckets){var m=function(e){return t.tsBucketsFormatted?t.tsBucketsFormatted[e]:t.tsBuckets[e]};i=m(n),s=n<t.tsBuckets.length-1?m(n+1):""}else{i=l(c.y?c.bounds.bottom:0),s=l(c.bounds.top)}d+="<div>\n          bucket: <b>"+i+" - "+s+"</b> <br>\n          count: <b>"+o(c.count)+"</b> <br>\n        </div>"}else d+="<div>count: <b>"+c.count+"</b><br></div>";else{if(!this.panel.tooltip.showHistogram)return void this.destroy();i=n,s="",0}this.tooltip.html(d),this.panel.tooltip.showHistogram&&this.addHistogram(u),this.move(e)}else this.destroy()}},e.prototype.getBucketIndexes=function(e,t){return{xBucketIndex:this.getXBucketIndex(e.x,t),yBucketIndex:this.getYBucketIndex(e.y,t)}},e.prototype.getXBucketIndex=function(e,t){var a=A.a.find(t.buckets,function(a){return e>a.x&&e-a.x<=t.xBucketSize});return a?a.x:Ei(e,t.xBucketSize,1)},e.prototype.getYBucketIndex=function(e,t){return t.tsBuckets?Math.floor(e):Ei(e,t.yBucketSize,this.panel.yAxis.logBase)},e.prototype.getSharedTooltipPos=function(e){return e.pageX=this.heatmapPanel.offset().left+this.scope.xScale(e.x),e.pageY=this.heatmapPanel.offset().top+this.scope.chartHeight*e.panelRelY,e},e.prototype.addHistogram=function(e){var t,a,r,n=this.scope.ctrl.data.buckets[e.x],i=this.scope.ctrl.data.yBucketSize;this.scope.ctrl.data.tsBuckets?(t=0,a=this.scope.ctrl.data.tsBuckets.length-1,r=this.scope.ctrl.data.tsBuckets.length):(t=this.scope.ctrl.data.yAxis.min,a=this.scope.ctrl.data.yAxis.max,r=this.scope.ctrl.data.yAxis.ticks);var s=A.a.map(n.buckets,function(e){var t=void 0!==e.count?e.count:e.values.length;return[e.bounds.bottom,t]});s=A.a.filter(s,function(e){return e[0]>=t&&e[0]<=a});var o,l=this.scope.yScale.copy().domain([t,a]).range([0,160]);if(1===this.panel.yAxis.logBase)o=Math.floor(160/(a-t)*i*.9);else{var u=i||1;o=Math.floor(160/r/u*.9)}o=Math.max(o,1);var c=A.a.reduce(A.a.map(s,function(e){return e[1]}),function(e,t){return e+t},0),h=si.scaleLinear().domain([0,c]).range([0,40]);this.tooltip.select(".heatmap-histogram").append("svg").attr("width",160).attr("height",40).selectAll(".bar").data(s).enter().append("rect").attr("x",function(e){return l(e[0])}).attr("width",o).attr("y",function(e){return 40-h(e[1])}).attr("height",function(e){return h(e[1])})},e.prototype.move=function(e){if(this.tooltip){var t=O()(this.tooltip.node())[0],a=t.clientWidth,r=t.clientHeight,n=e.pageX+30,i=e.pageY+5;return e.pageX+a+40>window.innerWidth&&(n=e.pageX-a-30),e.pageY-window.pageYOffset+r+20>window.innerHeight&&(i=e.pageY-r-5),this.tooltip.style("left",n+"px").style("top",i+"px")}},e.prototype.countValueFormatter=function(e,t){void 0===t&&(t=null);return function(a){return ie.a.valueFormats.short(a,e,t)}},e}(),Oi=1.2;var Fi=function(){function e(e,t,a,r){this.scope=e,this.elem=t,this.ctrl=r,this.$heatmap=this.elem.find(".heatmap-panel"),this.tooltip=new Ii(this.$heatmap,this.scope),this.selection={active:!1,x1:-1,x2:-1},this.padding={left:0,right:0,top:0,bottom:0},this.margin={left:25,right:15,top:10,bottom:20},this.dataRangeWidingFactor=Oi,this.ctrl.events.on("render",this.onRender.bind(this)),this.ctrl.tickValueFormatter=this.tickValueFormatter.bind(this),j.b.on("graph-hover",this.onGraphHover.bind(this),this.scope),j.b.on("graph-hover-clear",this.onGraphHoverClear.bind(this),this.scope),this.$heatmap.on("mousedown",this.onMouseDown.bind(this)),this.$heatmap.on("mousemove",this.onMouseMove.bind(this)),this.$heatmap.on("mouseleave",this.onMouseLeave.bind(this))}return e.prototype.onGraphHoverClear=function(){this.clearCrosshair()},e.prototype.onGraphHover=function(e){this.drawSharedCrosshair(e.pos)},e.prototype.onRender=function(){this.render(),this.ctrl.renderingCompleted()},e.prototype.setElementHeight=function(){try{var e=this.ctrl.height||this.panel.height||this.ctrl.row.height;return A.a.isString(e)&&(e=parseInt(e.replace("px",""),10)),e-=this.panel.legend.show?28:11,this.$heatmap.css("height",e+"px"),!0}catch(e){return!1}},e.prototype.getYAxisWidth=function(e){var t=e.selectAll(".axis-y text").nodes();return A.a.max(A.a.map(t,function(e){return e.getBBox().width}))},e.prototype.getXAxisHeight=function(e){if(e.select(".axis-x line").empty())return 30;var t=parseFloat(e.select(".axis-x line").attr("y2"));return parseFloat(e.attr("height"))-t},e.prototype.addXAxis=function(){this.scope.xScale=this.xScale=si.scaleTime().domain([this.timeRange.from,this.timeRange.to]).range([0,this.chartWidth]);var e,t=this.chartWidth/100,a=$t.grafanaTimeFormat(t,this.timeRange.from,this.timeRange.to);e="utc"===this.ctrl.dashboard.getTimezone()?si.utcFormat(a):si.timeFormat(a);var r=si.axisBottom(this.xScale).ticks(t).tickFormat(e).tickPadding(10).tickSize(this.chartHeight),n=this.margin.top,i=this.yAxisWidth;this.heatmap.append("g").attr("class","axis axis-x").attr("transform","translate("+i+","+n+")").call(r),this.heatmap.select(".axis-x").select(".domain").remove()},e.prototype.addYAxis=function(){var e=Math.ceil(this.chartHeight/50),t=$t.tickStep(this.data.heatmapStats.min,this.data.heatmapStats.max,e),a=this.wideYAxisRange(this.data.heatmapStats.min,this.data.heatmapStats.max,t),r=a.yMin,n=a.yMax;r=null!==this.panel.yAxis.min?this.panel.yAxis.min:r,n=null!==this.panel.yAxis.max?this.panel.yAxis.max:n,t=$t.tickStep(r,n,e),e=Math.ceil((n-r)/t);var i=$t.getPrecision(t),s=null===this.panel.yAxis.decimals?i:this.panel.yAxis.decimals,o=$t.getFlotTickSize(r,n,e,i),l=$t.getScaledDecimals(s,o);this.ctrl.decimals=s,this.ctrl.scaledDecimals=l,A.a.isEmpty(this.data.buckets)&&(n=1,r=-1,e=3,s=1),this.data.yAxis={min:r,max:n,ticks:e},this.scope.yScale=this.yScale=si.scaleLinear().domain([r,n]).range([this.chartHeight,0]);var u=si.axisLeft(this.yScale).ticks(e).tickFormat(this.tickValueFormatter(s,l)).tickSizeInner(0-this.width).tickSizeOuter(0).tickPadding(5);this.heatmap.append("g").attr("class","axis axis-y").call(u);var c=this.margin.top,h=this.getYAxisWidth(this.heatmap)+5;this.heatmap.select(".axis-y").attr("transform","translate("+h+","+c+")"),this.heatmap.select(".axis-y").select(".domain").remove()},e.prototype.wideYAxisRange=function(e,t,a){var r,n,i=(t*(this.dataRangeWidingFactor-1)-e*(this.dataRangeWidingFactor-1))/2;return 0===a?a=((n=t*this.dataRangeWidingFactor)-(r=e-e*(this.dataRangeWidingFactor-1)))/2:(n=Math.ceil((t+i)/a)*a,r=Math.floor((e-i)/a)*a),e>=0&&r<0&&(r=0),{yMin:r,yMax:n}},e.prototype.addLogYAxis=function(){var e=this.panel.yAxis.logBase,t=this.adjustLogRange(this.data.heatmapStats.minLog,this.data.heatmapStats.max,e),a=t.yMin,r=t.yMax;a=this.panel.yAxis.min&&"0"!==this.panel.yAxis.min?this.adjustLogMin(this.panel.yAxis.min,e):a,r=null!==this.panel.yAxis.max?this.adjustLogMax(this.panel.yAxis.max,e):r,A.a.isEmpty(this.data.buckets)&&(r=Math.pow(e,2),a=1),this.scope.yScale=this.yScale=si.scaleLog().base(this.panel.yAxis.logBase).domain([a,r]).range([this.chartHeight,0]);var n=this.yScale.domain(),i=this.logScaleTickValues(n,e),s=$t.getPrecision(a),o=this.panel.yAxis.decimals||s,l=$t.getFlotTickSize(a,r,i.length,s),u=$t.getScaledDecimals(o,l);this.ctrl.decimals=o,this.ctrl.scaledDecimals=u,this.data.yAxis={min:a,max:r,ticks:i.length};var c=si.axisLeft(this.yScale).tickValues(i).tickFormat(this.tickValueFormatter(o,u)).tickSizeInner(0-this.width).tickSizeOuter(0).tickPadding(5);this.heatmap.append("g").attr("class","axis axis-y").call(c);var h=this.margin.top,p=this.getYAxisWidth(this.heatmap)+5;this.heatmap.select(".axis-y").attr("transform","translate("+p+","+h+")"),a<1&&this.heatmap.select(".axis-y").select(".tick text").text("0"),this.heatmap.select(".axis-y").select(".domain").remove()},e.prototype.addYAxisFromBuckets=function(){var e=this.data.tsBuckets;this.scope.yScale=this.yScale=si.scaleLinear().domain([0,e.length-1]).range([this.chartHeight,0]);var t=A.a.map(e,function(e,t){return t}),a=A.a.max(A.a.map(e,$t.getStringPrecision)),r=null===this.panel.yAxis.decimals?a:this.panel.yAxis.decimals;this.ctrl.decimals=r;var n=this.tickValueFormatter.bind(this);function i(t){var a=e[t];return A.a.isNaN(A.a.toNumber(a))||""===a||(a=n(r)(A.a.toNumber(a))),a}var s=A.a.map(e,function(e,t){return i(t)});this.data.tsBucketsFormatted=s;var o=si.axisLeft(this.yScale).tickValues(t).tickFormat(i).tickSizeInner(0-this.width).tickSizeOuter(0).tickPadding(5);this.heatmap.append("g").attr("class","axis axis-y").call(o);var l=this.margin.top,u=this.getYAxisWidth(this.heatmap)+5;this.heatmap.select(".axis-y").attr("transform","translate("+u+","+l+")"),this.heatmap.select(".axis-y").select(".domain").remove()},e.prototype.adjustLogRange=function(e,t,a){return this.data.heatmapStats.minLog,{yMin:this.data.heatmapStats.minLog>1||!this.data.heatmapStats.minLog?1:this.adjustLogMin(this.data.heatmapStats.minLog,a),yMax:this.adjustLogMax(this.data.heatmapStats.max,a)}},e.prototype.adjustLogMax=function(e,t){return Math.pow(t,Math.ceil($t.logp(e,t)))},e.prototype.adjustLogMin=function(e,t){return Math.pow(t,Math.floor($t.logp(e,t)))},e.prototype.logScaleTickValues=function(e,t){var a=e[0],r=e[1],n=[];if(a<1)for(var i=Math.floor($t.logp(a,t));i<0;i++){var s=Math.pow(t,i);n.push(s)}var o=Math.ceil($t.logp(r,t));for(i=0;i<=o;i++){s=Math.pow(t,i);n.push(s)}return n},e.prototype.tickValueFormatter=function(e,t){void 0===t&&(t=null);var a=this.panel.yAxis.format;return function(r){try{return"none"!==a?ie.a.valueFormats[a](r,e,t):r}catch(e){return console.error(e.message||e),r}}},e.prototype.fixYAxisTickSize=function(){this.heatmap.select(".axis-y").selectAll(".tick line").attr("x2",this.chartWidth)},e.prototype.addAxes=function(){this.chartHeight=this.height-this.margin.top-this.margin.bottom,this.chartTop=this.margin.top,this.chartBottom=this.chartTop+this.chartHeight,"tsbuckets"===this.panel.dataFormat?this.addYAxisFromBuckets():1===this.panel.yAxis.logBase?this.addYAxis():this.addLogYAxis(),this.yAxisWidth=this.getYAxisWidth(this.heatmap)+5,this.chartWidth=this.width-this.yAxisWidth-this.margin.right,this.fixYAxisTickSize(),this.addXAxis(),this.xAxisHeight=this.getXAxisHeight(this.heatmap),this.panel.yAxis.show||this.heatmap.select(".axis-y").selectAll("line").style("opacity",0),this.panel.xAxis.show||this.heatmap.select(".axis-x").selectAll("line").style("opacity",0)},e.prototype.addHeatmapCanvas=function(){var e=this.$heatmap[0];this.width=Math.floor(this.$heatmap.width())-this.padding.right,this.height=Math.floor(this.$heatmap.height())-this.padding.bottom,this.cardPadding=null!==this.panel.cards.cardPadding?this.panel.cards.cardPadding:1,this.cardRound=null!==this.panel.cards.cardRound?this.panel.cards.cardRound:0,this.heatmap&&this.heatmap.remove(),this.heatmap=si.select(e).append("svg").attr("width",this.width).attr("height",this.height)},e.prototype.addHeatmap=function(){var e=this;if(this.addHeatmapCanvas(),this.addAxes(),1!==this.panel.yAxis.logBase&&"tsbuckets"!==this.panel.dataFormat){var t=this.panel.yAxis.logBase,a=this.yScale.domain(),r=this.logScaleTickValues(a,t);this.data.buckets=function(e,t){return A.a.forEach(e,function(e){var a=e.buckets,r={bounds:{bottom:0,top:0},values:[],points:[],count:0},n=a[0]||r,i=a[t]||r,s={y:0,bounds:{bottom:t,top:i.bounds.top||t},values:[],points:[],count:0};s.points=n.points.concat(i.points),s.values=n.values.concat(i.values),s.count=s.values.length,0!==s.count&&(delete a[t],a[0]=s)}),e}(this.data.buckets,A.a.min(r))}var n=this.data.cards,i=this.data.cardStats.max,s=this.panel.color.max||i,o=this.panel.color.min||0,l=A.a.find(this.ctrl.colorSchemes,{value:this.panel.color.colorScheme});this.colorScale=li(l,j.c.user.lightTheme,s,o),this.opacityScale=ui(this.panel.color,s),this.setCardSize();var u=this.heatmap.selectAll(".heatmap-card").data(n);u.append("title"),u=u.enter().append("rect").attr("x",this.getCardX.bind(this)).attr("width",this.getCardWidth.bind(this)).attr("y",this.getCardY.bind(this)).attr("height",this.getCardHeight.bind(this)).attr("rx",this.cardRound).attr("ry",this.cardRound).attr("class","bordered heatmap-card").style("fill",this.getCardColor.bind(this)).style("stroke",this.getCardColor.bind(this)).style("stroke-width",0).style("opacity",this.getCardOpacity.bind(this)),this.$heatmap.find(".heatmap-card").on("mouseenter",function(t){e.tooltip.mouseOverBucket=!0,e.highlightCard(t)}).on("mouseleave",function(t){e.tooltip.mouseOverBucket=!1,e.resetCardHighLight(t)})},e.prototype.highlightCard=function(e){var t=si.select(e.target).style("fill"),a=si.color(t).darker(2),r=si.color(t).brighter(4),n=si.select(e.target);this.tooltip.originalFillColor=t,n.style("fill",a.toString()).style("stroke",r.toString()).style("stroke-width",1)},e.prototype.resetCardHighLight=function(e){si.select(e.target).style("fill",this.tooltip.originalFillColor).style("stroke",this.tooltip.originalFillColor).style("stroke-width",0)},e.prototype.setCardSize=function(){var e=Math.floor(this.xScale(this.data.xBucketSize)-this.xScale(0)),t=Math.floor(this.yScale(this.yScale.invert(0)-this.data.yBucketSize));if(1!==this.panel.yAxis.logBase){var a=this.panel.yAxis.logBase,r=this.data.yBucketSize||1;t=Math.floor((this.yScale(1)-this.yScale(a))/r)}this.cardWidth=e-2*this.cardPadding,this.cardHeight=t?t-2*this.cardPadding:0},e.prototype.getCardX=function(e){return this.xScale(e.x)<0?this.yAxisWidth+this.cardPadding:this.xScale(e.x)+this.yAxisWidth+this.cardPadding},e.prototype.getCardWidth=function(e){var t;if(this.xScale(e.x)<0){var a=this.xScale(e.x)+this.cardWidth;t=a>0?a:0}else t=this.xScale(e.x)+this.cardWidth>this.chartWidth?this.chartWidth-this.xScale(e.x)-this.cardPadding:this.cardWidth;return t=Math.max(t,1)},e.prototype.getCardY=function(e){var t=this.yScale(e.y)+this.chartTop-this.cardHeight-this.cardPadding;return 1!==this.panel.yAxis.logBase&&0===e.y?t=this.chartBottom-this.cardHeight-this.cardPadding:t<this.chartTop&&(t=this.chartTop),t},e.prototype.getCardHeight=function(e){var t=this.yScale(e.y)+this.chartTop-this.cardHeight-this.cardPadding,a=this.cardHeight;return 1!==this.panel.yAxis.logBase&&0===e.y?this.cardHeight:(t<this.chartTop?a=this.yScale(e.y)-this.cardPadding:this.yScale(e.y)>this.chartBottom?a=this.chartBottom-t:t+this.cardHeight>this.chartBottom&&(a=this.chartBottom-t),a=Math.min(a,this.chartHeight),a=Math.max(a,1))},e.prototype.getCardColor=function(e){return"opacity"===this.panel.color.mode?this.panel.color.cardColor:this.colorScale(e.count)},e.prototype.getCardOpacity=function(e){return"opacity"===this.panel.color.mode?this.opacityScale(e.count):1},e.prototype.getEventOffset=function(e){var t=this.$heatmap.offset();return{x:Math.floor(e.clientX-t.left),y:Math.floor(e.clientY-t.top)}},e.prototype.onMouseDown=function(e){var t=this,a=this.getEventOffset(e);this.selection.active=!0,this.selection.x1=a.x,this.mouseUpHandler=function(){t.onMouseUp()},O()(document).one("mouseup",this.mouseUpHandler.bind(this))},e.prototype.onMouseUp=function(){O()(document).unbind("mouseup",this.mouseUpHandler.bind(this)),this.mouseUpHandler=null,this.selection.active=!1;var e=Math.abs(this.selection.x2-this.selection.x1);if(this.selection.x2>=0&&e>2){var t=this.xScale.invert(Math.min(this.selection.x1,this.selection.x2)-this.yAxisWidth),a=this.xScale.invert(Math.max(this.selection.x1,this.selection.x2)-this.yAxisWidth);this.ctrl.timeSrv.setTime({from:U.a.utc(t),to:U.a.utc(a)})}this.clearSelection()},e.prototype.onMouseLeave=function(){j.b.emit("graph-hover-clear"),this.clearCrosshair()},e.prototype.onMouseMove=function(e){if(this.heatmap){var t=this.getEventOffset(e);if(this.selection.active)this.clearCrosshair(),this.tooltip.destroy(),this.selection.x2=this.limitSelection(t.x),this.drawSelection(this.selection.x1,this.selection.x2);else{var a=this.getEventPos(e,t);this.drawCrosshair(t.x),this.tooltip.show(a,this.data),this.emitGraphHoverEvent(a)}}},e.prototype.getEventPos=function(e,t){var a=this.xScale.invert(t.x-this.yAxisWidth).valueOf(),r=this.yScale.invert(t.y-this.chartTop);return{pageX:e.pageX,pageY:e.pageY,x:a,x1:a,y:r,y1:r,panelRelY:null,offset:t}},e.prototype.emitGraphHoverEvent=function(e){e.panelRelY=Math.max(e.offset.y/this.height,.001),j.b.emit("graph-hover",{pos:e,panel:this.panel})},e.prototype.limitSelection=function(e){return e=Math.max(e,this.yAxisWidth),e=Math.min(e,this.chartWidth+this.yAxisWidth)},e.prototype.drawSelection=function(e,t){if(this.heatmap){this.heatmap.selectAll(".heatmap-selection").remove();var a=Math.min(e,t),r=Math.abs(e-t);r>2&&this.heatmap.append("rect").attr("class","heatmap-selection").attr("x",a).attr("width",r).attr("y",this.chartTop).attr("height",this.chartHeight)}},e.prototype.clearSelection=function(){this.selection.x1=-1,this.selection.x2=-1,this.heatmap&&this.heatmap.selectAll(".heatmap-selection").remove()},e.prototype.drawCrosshair=function(e){if(this.heatmap){this.heatmap.selectAll(".heatmap-crosshair").remove();var t=e;t=Math.max(t,this.yAxisWidth),t=Math.min(t,this.chartWidth+this.yAxisWidth),this.heatmap.append("g").attr("class","heatmap-crosshair").attr("transform","translate("+t+",0)").append("line").attr("x1",1).attr("y1",this.chartTop).attr("x2",1).attr("y2",this.chartBottom).attr("stroke-width",1)}},e.prototype.drawSharedCrosshair=function(e){if(this.heatmap&&0!==this.ctrl.dashboard.graphTooltip){var t=this.xScale(e.x)+this.yAxisWidth;this.drawCrosshair(t)}},e.prototype.clearCrosshair=function(){this.heatmap&&this.heatmap.selectAll(".heatmap-crosshair").remove()},e.prototype.render=function(){if(this.data=this.ctrl.data,this.panel=this.ctrl.panel,this.timeRange=this.ctrl.range,this.setElementHeight()&&this.data){if(A.a.isEmpty(this.data.buckets))return this.addHeatmapCanvas(),void this.addAxes();this.addHeatmap(),this.scope.yAxisWidth=this.yAxisWidth,this.scope.xAxisHeight=this.xAxisHeight,this.scope.chartHeight=this.chartHeight,this.scope.chartWidth=this.chartWidth,this.scope.chartTop=this.chartTop}},e}(),qi={heatmap:{},cards:{cardPadding:null,cardRound:null},color:{mode:"spectrum",cardColor:"#b4ff00",colorScale:"sqrt",exponent:.5,colorScheme:"interpolateOranges"},legend:{show:!1},dataFormat:"timeseries",yBucketBound:"auto",xAxis:{show:!0},yAxis:{show:!0,format:"short",decimals:null,logBase:1,splitFactor:null,min:null,max:null},xBucketSize:null,xBucketNumber:null,yBucketSize:null,yBucketNumber:null,tooltip:{show:!0,showHistogram:!1},highlightCards:!0},Ni=["opacity","spectrum"],Ri=["linear","sqrt"],Li=[{name:"Spectral",value:"interpolateSpectral",invert:"always"},{name:"RdYlGn",value:"interpolateRdYlGn",invert:"always"},{name:"Blues",value:"interpolateBlues",invert:"dark"},{name:"Greens",value:"interpolateGreens",invert:"dark"},{name:"Greys",value:"interpolateGreys",invert:"dark"},{name:"Oranges",value:"interpolateOranges",invert:"dark"},{name:"Purples",value:"interpolatePurples",invert:"dark"},{name:"Reds",value:"interpolateReds",invert:"dark"},{name:"Viridis",value:"interpolateViridis",invert:"light"},{name:"Magma",value:"interpolateMagma",invert:"light"},{name:"Inferno",value:"interpolateInferno",invert:"light"},{name:"Plasma",value:"interpolatePlasma",invert:"light"},{name:"Warm",value:"interpolateWarm",invert:"light"},{name:"Cool",value:"interpolateCool",invert:"light"},{name:"Cubehelix",value:"interpolateCubehelixDefault",invert:"light"},{name:"BuGn",value:"interpolateBuGn",invert:"dark"},{name:"BuPu",value:"interpolateBuPu",invert:"dark"},{name:"GnBu",value:"interpolateGnBu",invert:"dark"},{name:"OrRd",value:"interpolateOrRd",invert:"dark"},{name:"PuBuGn",value:"interpolatePuBuGn",invert:"dark"},{name:"PuBu",value:"interpolatePuBu",invert:"dark"},{name:"PuRd",value:"interpolatePuRd",invert:"dark"},{name:"RdPu",value:"interpolateRdPu",invert:"dark"},{name:"YlGnBu",value:"interpolateYlGnBu",invert:"dark"},{name:"YlGn",value:"interpolateYlGn",invert:"dark"},{name:"YlOrBr",value:"interpolateYlOrBr",invert:"dark"},{name:"YlOrRd",value:"interpolateYlOrRd",invert:"dark"}],Vi=["prometheus","elasticsearch"],Ui=function(e){function t(t,a,r){var n=e.call(this,t,a)||this;return n.opacityScales=[],n.colorModes=[],n.colorSchemes=[],n.timeSrv=r,n.selectionActivated=!1,A.a.defaultsDeep(n.panel,qi),n.opacityScales=Ri,n.colorModes=Ni,n.colorSchemes=Li,n.events.on("render",n.onRender.bind(n)),n.events.on("data-received",n.onDataReceived.bind(n)),n.events.on("data-error",n.onDataError.bind(n)),n.events.on("data-snapshot-load",n.onDataReceived.bind(n)),n.events.on("init-edit-mode",n.onInitEditMode.bind(n)),n.onCardColorChange=n.onCardColorChange.bind(n),n}return t.$inject=["$scope","$injector","timeSrv"],Ve.c(t,e),t.prototype.onInitEditMode=function(){this.addEditorTab("Axes",vi,2),this.addEditorTab("Display",bi,3),this.unitFormats=ie.a.getUnitFormats()},t.prototype.zoomOut=function(e){this.publishAppEvent("zoom-out",2)},t.prototype.onRender=function(){this.range&&("tsbuckets"===this.panel.dataFormat?this.convertHistogramToHeatmapData():this.convertTimeSeriesToHeatmapData())},t.prototype.convertTimeSeriesToHeatmapData=function(){var e,t,a,r,n=this.panel.yAxis.logBase,i=this.panel.xBucketNumber||30,s=Math.floor((this.range.to-this.range.from)/i);e=ie.a.interval_regex.test(this.panel.xBucketSize)?ie.a.interval_to_ms(this.panel.xBucketSize):isNaN(Number(this.panel.xBucketSize))||""===this.panel.xBucketSize||null===this.panel.xBucketSize?s:Number(this.panel.xBucketSize),r=this.parseSeries(this.series);var o=this.panel.yBucketNumber||10;1!==n?t=this.panel.yAxis.splitFactor:(t=r.max===r.min?r.max?r.max/10:1:(r.max-r.min)/o,t=this.panel.yBucketSize||t),a=ki(this.series,t,e,n),r.min||r.max||(r={min:-1,max:1,minLog:1},t=1);var l=Ci(a),u=l.cards,c=l.cardStats;this.data={buckets:a,heatmapStats:r,xBucketSize:e,yBucketSize:t,cards:u,cardStats:c}},t.prototype.convertHistogramToHeatmapData=function(){var e,t,a,r=this.getPanelDataSourceType();A.a.includes(Vi,r)||this.series.sort(wi),t=function(e){for(var t={},a=0;a<e.length;a++){var r=e[a],n=a;if(isNaN(n))return t;for(var i=0,s=r.datapoints;i<s.length;i++){var o=s[i],l=o[Si],u=o[xi];if(A.a.isNumber(l)){var c=t[u];c||(c=t[u]={x:u,buckets:{}}),c.buckets[n]={y:n,count:l,bounds:{top:null,bottom:n},values:[],points:[]}}}}return t}(this.series),a=A.a.map(this.series,"label");var n=this.panel.yBucketBound;"prometheus"===r&&"lower"!==n||"upper"===n?a=[""].concat(a):a.push(""),e=function(e,t){void 0===t&&(t=1);var a=1/0;if(0===e.length)return 0;if(1===e.length)return e[0];e=A.a.sortBy(e);for(var r=1;r<e.length;r++){var n=Ai(e[r],e[r-1],t);a=n<a?n:a}return a}(A.a.map(A.a.keys(t),function(e){return Number(e)}));var i=Ci(t),s=i.cards,o=i.cardStats;this.data={buckets:t,xBucketSize:e,yBucketSize:1,tsBuckets:a,cards:s,cardStats:o}},t.prototype.getPanelDataSourceType=function(){return this.datasource.meta&&this.datasource.meta.id?this.datasource.meta.id:"unknown"},t.prototype.onDataReceived=function(e){if(this.series=e.map(this.seriesHandler.bind(this)),this.dataWarning=null,0===A.a.reduce(this.series,function(e,t){return e+t.datapoints.length},0))this.dataWarning={title:"No data points",tip:"No datapoints returned from data query"};else for(var t=0,a=this.series;t<a.length;t++){if(a[t].isOutsideRange){this.dataWarning={title:"Data points outside time range",tip:"Can be caused by timezone mismatch or missing time filter in query"};break}}this.render()},t.prototype.onDataError=function(){this.series=[],this.render()},t.prototype.onCardColorChange=function(e){this.panel.color.cardColor=e,this.render()},t.prototype.seriesHandler=function(e){if(void 0===e.datapoints)throw new Error("Heatmap error: data should be a time series");var t=new ot.a({datapoints:e.datapoints,alias:e.target});t.flotpairs=t.getFlotPairs(this.panel.nullPointMode);var a=e.datapoints||[];a&&a.length>0&&(a[a.length-1][1]-this.range.from<-1e4&&(t.isOutsideRange=!0));return t},t.prototype.parseSeries=function(e){var t=A.a.min(A.a.map(e,function(e){return e.stats.min})),a=A.a.min(A.a.map(e,function(e){return e.stats.logmin}));return{max:A.a.max(A.a.map(e,function(e){return e.stats.max})),min:t,minLog:a}},t.prototype.parseHistogramSeries=function(e){var t=A.a.map(e,function(e){return Number(e.alias)}),a=A.a.min(t),r=A.a.min(t);return{max:A.a.max(t),min:a,minLog:r}},t.prototype.link=function(e,t,a,r){!function(e,t,a,r){new Fi(e,t,a,r)}(e,t,a,r)},t.templateUrl="module.html",t}(ze),ji={};ji.timeseries_to_rows={description:"Time series to rows",getColumns:function(){return[]},transform:function(e,t,a){a.columns=[{text:"Time",type:"date"},{text:"Metric"},{text:"Value"}];for(var r=0;r<e.length;r++)for(var n=e[r],i=0;i<n.datapoints.length;i++){var s=n.datapoints[i];a.rows.push([s[1],n.target,s[0]])}}},ji.timeseries_to_columns={description:"Time series to columns",getColumns:function(){return[]},transform:function(e,t,a){a.columns.push({text:"Time",type:"date"});for(var r={},n=0;n<e.length;n++){var i=e[n];a.columns.push({text:i.target});for(var s=0;s<i.datapoints.length;s++){var o=i.datapoints[s],l=o[1].toString();r[l]?r[l][n]=o[0]:(r[l]={time:o[1]},r[l][n]=o[0])}}for(var u in r){var c=r[u],h=[c.time];for(n=0;n<e.length;n++){var p=c[n];h.push(p)}a.rows.push(h)}}},ji.timeseries_aggregations={description:"Time series aggregations",getColumns:function(){return[{text:"Avg",value:"avg"},{text:"Min",value:"min"},{text:"Max",value:"max"},{text:"Total",value:"total"},{text:"Current",value:"current"},{text:"Count",value:"count"}]},transform:function(e,t,a){var r,n;for(a.columns.push({text:"Metric"}),r=0;r<t.columns.length;r++)a.columns.push({text:t.columns[r].text});for(r=0;r<e.length;r++){var i=new ot.a({datapoints:e[r].datapoints,alias:e[r].target});i.getFlotPairs("connected");var s=[i.alias];for(n=0;n<t.columns.length;n++)s.push(i.stats[t.columns[n].value]);a.rows.push(s)}}},ji.annotations={description:"Annotations",getColumns:function(){return[]},transform:function(e,t,a){if(a.columns.push({text:"Time",type:"date"}),a.columns.push({text:"Title"}),a.columns.push({text:"Text"}),a.columns.push({text:"Tags"}),e&&e.annotations&&0!==e.annotations.length)for(var r=0;r<e.annotations.length;r++){var n=e.annotations[r];a.rows.push([n.time,n.title,n.text,n.tags])}}},ji.table={description:"Table",getColumns:function(e){if(!e||0===e.length)return[];if(1===e.length)return e[0].columns.slice();var t={};return e.reduce(function(e,a){return a.columns.forEach(function(a){var r=a.text;void 0===t[r]&&(t[r]=e.length,e.push(a))}),e},[])},transform:function(e,t,a){if(e&&0!==e.length){var r=A.a.findIndex(e,function(e){return"table"!==e.type});if(r>-1)throw{message:"Result of query #"+String.fromCharCode(65+r)+" is not in table format, try using another transform."};if(1===e.length)return a.columns=e[0].columns.slice(),void(a.rows=e[0].rows.slice());var n={},i=e.reduce(function(e,t){return t.columns.forEach(function(t){var a=t.text;void 0===n[a]&&(n[a]=e.length,e.push(t))}),e},[]),s=e.map(function(e){return e.columns.map(function(e){return n[e.text]})}),o=e.reduce(function(e,t,a){var r=s[a];return t.rows.forEach(function(t){var a=[];r.forEach(function(e,r){a[e]=t[r]}),e.push(a)}),e},[]),l={},u=o.reduce(function(e,t,a){if(!l[a]){for(var r=a+1;r<o.length;){var n=A.a.findIndex(o,function(e){return c(i,t,e)},r);if(!(n>-1))break;for(var s=o[n],u=0;u<i.length;u++)void 0===t[u]&&void 0!==s[u]&&(t[u]=s[u]);l[n]=s,r=n+1}e.push(t)}return e},[]);a.columns=i,a.rows=u}function c(e,t,a){for(var r=!1,n=0;n<e.length;n++)if(void 0!==t[n]&&void 0!==a[n]){if(t[n]!==a[n])return!1}else void 0!==t[n]&&void 0!==a[n]||(r=!0);return r}}},ji.json={description:"JSON Data",getColumns:function(e){if(!e||0===e.length)return[];for(var t={},a=0;a<e.length;a++){var r=e[a];if("docs"===r.type)for(var n=Math.min(r.datapoints.length,100),i=0;i<n;i++){var s=Dt(r.datapoints[i],null);for(var o in s)t[o]=!0}}return A.a.map(t,function(e,t){return{text:t,value:t}})},transform:function(e,t,a){for(var r,n,i,s=0,o=t.columns;s<o.length;s++){var l={text:o[s].text};e.length>0&&e[0].filterable&&(l.filterable=!0),a.columns.push(l)}for(0===a.columns.length&&a.columns.push({text:"JSON"}),r=0;r<e.length;r++){var u=e[r];for(n=0;n<u.datapoints.length;n++){var c=u.datapoints[n],h=[];if(A.a.isObject(c)&&t.columns.length>0){var p=Dt(c,null);for(i=0;i<t.columns.length;i++)h.push(p[t.columns[i].value])}else h.push(JSON.stringify(c));a.rows.push(h)}}}};var Bi=function(){function e(e,t,a){this.$q=t,this.uiSegmentSrv=a,e.editor=this,this.panelCtrl=e.ctrl,this.panel=this.panelCtrl.panel,this.transformers=ji,this.fontSizes=["80%","90%","100%","110%","120%","130%","150%","160%","180%","200%","220%","250%"],this.addColumnSegment=a.newPlusButton(),this.updateTransformHints()}return e.$inject=["$scope","$q","uiSegmentSrv"],e.prototype.updateTransformHints=function(){switch(this.canSetColumns=!1,this.columnsHelpMessage="",this.panel.transform){case"timeseries_aggregations":case"json":this.canSetColumns=!0;break;case"table":this.columnsHelpMessage="Columns and their order are determined by the data query"}},e.prototype.getColumnOptions=function(){var e=this;if(!this.panelCtrl.dataRaw)return this.$q.when([]);var t=this.transformers[this.panel.transform].getColumns(this.panelCtrl.dataRaw),a=A.a.map(t,function(t){return e.uiSegmentSrv.newSegment({value:t.text})});return this.$q.when(a)},e.prototype.addColumn=function(){var e=ji[this.panel.transform].getColumns(this.panelCtrl.dataRaw),t=A.a.find(e,{text:this.addColumnSegment.value});t&&(this.panel.columns.push(t),this.render());var a=this.uiSegmentSrv.newPlusButton();this.addColumnSegment.html=a.html,this.addColumnSegment.value=a.value},e.prototype.transformChanged=function(){this.panel.columns=[],"timeseries_aggregations"===this.panel.transform&&this.panel.columns.push({text:"Avg",value:"avg"}),this.updateTransformHints(),this.render()},e.prototype.render=function(){this.panelCtrl.render()},e.prototype.removeColumn=function(e){this.panel.columns=A.a.without(this.panel.columns,e),this.panelCtrl.render()},e}();function Qi(e,t){return{restrict:"E",scope:!0,templateUrl:"public/app/plugins/panel/table/editor.html",controller:Bi}}var Hi=function(){function e(e){var t=this;e.editor=this,this.activeStyleIndex=0,this.panelCtrl=e.ctrl,this.panel=this.panelCtrl.panel,this.unitFormats=ie.a.getUnitFormats(),this.colorModes=[{text:"Disabled",value:null},{text:"Cell",value:"cell"},{text:"Value",value:"value"},{text:"Row",value:"row"}],this.columnTypes=[{text:"Number",value:"number"},{text:"String",value:"string"},{text:"Date",value:"date"},{text:"Hidden",value:"hidden"}],this.fontSizes=["80%","90%","100%","110%","120%","130%","150%","160%","180%","200%","220%","250%"],this.dateFormats=[{text:"YYYY-MM-DD HH:mm:ss",value:"YYYY-MM-DD HH:mm:ss"},{text:"YYYY-MM-DD HH:mm:ss.SSS",value:"YYYY-MM-DD HH:mm:ss.SSS"},{text:"MM/DD/YY h:mm:ss a",value:"MM/DD/YY h:mm:ss a"},{text:"MMMM D, YYYY LT",value:"MMMM D, YYYY LT"}],this.mappingTypes=[{text:"Value to text",value:1},{text:"Range to text",value:2}],this.getColumnNames=function(){return t.panelCtrl.table?A.a.map(t.panelCtrl.table.columns,function(e){return e.text}):[]},this.onColorChange=this.onColorChange.bind(this)}return e.$inject=["$scope"],e.prototype.render=function(){this.panelCtrl.render()},e.prototype.setUnitFormat=function(e,t){e.unit=t.value,this.panelCtrl.render()},e.prototype.addColumnStyle=function(){var e=this.panel.styles,t=e.length,a=t;t>0&&("/.*/"===e[t-1].pattern&&(a=t-1));e.splice(a,0,{unit:"short",type:"number",alias:"",decimals:2,colors:["rgba(245, 54, 54, 0.9)","rgba(237, 129, 40, 0.89)","rgba(50, 172, 45, 0.97)"],colorMode:null,pattern:"",dateFormat:"YYYY-MM-DD HH:mm:ss",thresholds:[],mappingType:1}),this.activeStyleIndex=a},e.prototype.removeColumnStyle=function(e){this.panel.styles=A.a.without(this.panel.styles,e)},e.prototype.invertColorOrder=function(e){var t=this.panel.styles[e].colors,a=t[0];t[0]=t[2],t[2]=a,this.panelCtrl.render()},e.prototype.onColorChange=function(e,t){var a=this;return function(r){a.panel.styles[e].colors[t]=r,a.render()}},e.prototype.addValueMap=function(e){e.valueMaps||(e.valueMaps=[]),e.valueMaps.push({value:"",text:""}),this.panelCtrl.render()},e.prototype.removeValueMap=function(e,t){e.valueMaps.splice(t,1),this.panelCtrl.render()},e.prototype.addRangeMap=function(e){e.rangeMaps||(e.rangeMaps=[]),e.rangeMaps.push({from:"",to:"",text:""}),this.panelCtrl.render()},e.prototype.removeRangeMap=function(e,t){e.rangeMaps.splice(t,1),this.panelCtrl.render()},e}();function zi(e,t){return{restrict:"E",scope:!0,templateUrl:"public/app/plugins/panel/table/column_options.html",controller:Hi}}var Yi=function(){function e(e,t,a,r,n){this.panel=e,this.table=t,this.isUtc=a,this.sanitize=r,this.templateSrv=n,this.initColumns()}return e.prototype.setTable=function(e){this.table=e,this.initColumns()},e.prototype.initColumns=function(){this.formatters=[],this.colorState={};for(var e=0;e<this.table.columns.length;e++){var t=this.table.columns[e];t.title=t.text;for(var a=0;a<this.panel.styles.length;a++){var r=this.panel.styles[a],n=ie.a.stringToJsRegex(r.pattern);if(t.text.match(n)){t.style=r,r.alias&&(t.title=t.text.replace(n,r.alias));break}}this.formatters[e]=this.createColumnFormatter(t)}},e.prototype.getColorForValue=function(e,t){if(!t.thresholds)return null;for(var a=t.thresholds.length;a>0;a--)if(e>=t.thresholds[a-1])return t.colors[a];return A.a.first(t.colors)},e.prototype.defaultCellFormatter=function(e,t){return null===e||void 0===e||void 0===e?"":(A.a.isArray(e)&&(e=e.join(", ")),t&&t.sanitize?this.sanitize(e):A.a.escape(e))},e.prototype.createColumnFormatter=function(e){var t=this;if(!e.style)return this.defaultCellFormatter;if("hidden"===e.style.type)return function(e){};if("date"===e.style.type)return function(a){if(void 0===a||null===a)return"-";A.a.isArray(a)&&(a=a[0]);var r=U()(a);return t.isUtc&&(r=r.utc()),r.format(e.style.dateFormat)};if("string"===e.style.type)return function(a){A.a.isArray(a)&&(a=a.join(", "));var r=e.style.mappingType||0;if(1===r&&e.style.valueMaps)for(var n=0;n<e.style.valueMaps.length;n++){var i=e.style.valueMaps[n];if(null!==a){if(!A.a.isString(a)&&Number(i.value)===Number(a)||i.value===a)return t.setColorState(a,e.style),t.defaultCellFormatter(i.text,e.style)}else if("null"===i.value)return i.text}if(2===r&&e.style.rangeMaps)for(n=0;n<e.style.rangeMaps.length;n++){i=e.style.rangeMaps[n];if(null!==a){if(Number(i.from)<=Number(a)&&Number(i.to)>=Number(a))return t.setColorState(a,e.style),t.defaultCellFormatter(i.text,e.style)}else if("null"===i.from&&"null"===i.to)return i.text}return null===a||void 0===a?"-":(t.setColorState(a,e.style),t.defaultCellFormatter(a,e.style))};if("number"===e.style.type){var a=ie.a.valueFormats[e.unit||e.style.unit];return function(r){return null===r||void 0===r?"-":A.a.isString(r)||A.a.isArray(r)?t.defaultCellFormatter(r,e.style):(t.setColorState(r,e.style),a(r,e.style.decimals,null))}}return function(a){return t.defaultCellFormatter(a,e.style)}},e.prototype.setColorState=function(e,t){if(t.colorMode&&null!==e&&void 0!==e&&!A.a.isArray(e)){var a=Number(e);isNaN(a)||(this.colorState[t.colorMode]=this.getColorForValue(a,t))}},e.prototype.renderRowVariables=function(e){for(var t={},a=this.table.rows[e],r=0;r<a.length;r++)t["__cell_"+r]={value:a[r]};return t},e.prototype.formatColumnValue=function(e,t){return this.formatters[e]?this.formatters[e](t):t},e.prototype.renderCell=function(e,t,a,r){void 0===r&&(r=!1),a=this.formatColumnValue(e,a);var n=this.table.columns[e],i="",s=[],o="";this.colorState.cell?(i=' style="background-color:'+this.colorState.cell+'"',s.push("table-panel-color-cell"),this.colorState.cell=null):this.colorState.value&&(i=' style="color:'+this.colorState.value+'"',this.colorState.value=null);var l="";if(r&&(l='<div class="table-panel-width-hack">'+this.table.columns[e].title+"</div>"),void 0===a?(i=' style="display:none;"',n.hidden=!0):n.hidden=!1,!0===n.hidden)return"";if(n.style&&n.style.preserveFormat&&s.push("table-panel-cell-pre"),n.style&&n.style.link){var u=this.renderRowVariables(t);u.__cell={value:a};var c=this.templateSrv.replace(n.style.linkUrl,u,encodeURIComponent),h=this.templateSrv.replace(n.style.linkTooltip,u),p=n.style.linkTargetBlank?"_blank":"";s.push("table-panel-cell-link"),l+='\n        <a href="'+c+'" target="'+p+'" data-link-tooltip data-original-title="'+h+'" data-placement="right"'+i+">\n          "+a+"\n        </a>\n      "}else l+=a;return n.filterable&&(s.push("table-panel-cell-filterable"),l+='\n        <a class="table-panel-filter-link" data-link-tooltip data-original-title="Filter out value" data-placement="bottom"\n           data-row="'+t+'" data-column="'+e+'" data-operator="!=">\n          <i class="fa fa-search-minus"></i>\n        </a>\n        <a class="table-panel-filter-link" data-link-tooltip data-original-title="Filter for value" data-placement="bottom"\n           data-row="'+t+'" data-column="'+e+'" data-operator="=">\n          <i class="fa fa-search-plus"></i>\n        </a>'),s.length&&(o=' class="'+s.join(" ")+'"'),l="<td"+o+i+">"+l+"</td>"},e.prototype.render=function(e){for(var t=this.panel.pageSize||100,a=e*t,r=Math.min(a+t,this.table.rows.length),n="",i=[],s="",o=a;o<r;o++){for(var l=this.table.rows[o],u="",c="",h=0;h<this.table.columns.length;h++)u+=this.renderCell(h,o,l[h],o===a);this.colorState.row&&(c=' style="background-color:'+this.colorState.row+'"',i.push("table-panel-color-row"),this.colorState.row=null),i.length&&(s=' class="'+i.join(" ")+'"'),n+="<tr "+s+c+">"+u+"</tr>"}return n},e.prototype.render_values=function(){for(var e=[],t=0;t<this.table.rows.length;t++){for(var a=this.table.rows[t],r=[],n=0;n<this.table.columns.length;n++)r.push(this.formatColumnValue(n,a[n]));e.push(r)}return{columns:this.table.columns,rows:e}},e}(),Gi=function(e){function t(t,a,r,n,i,s){var o=e.call(this,t,a)||this;return o.annotationsSrv=n,o.$sanitize=i,o.variableSrv=s,o.panelDefaults={targets:[{}],transform:"timeseries_to_columns",pageSize:null,showHeader:!0,styles:[{type:"date",pattern:"Time",alias:"Time",dateFormat:"YYYY-MM-DD HH:mm:ss"},{unit:"short",type:"number",alias:"",decimals:2,colors:["rgba(245, 54, 54, 0.9)","rgba(237, 129, 40, 0.89)","rgba(50, 172, 45, 0.97)"],colorMode:null,pattern:"/.*/",thresholds:[]}],columns:[],scroll:!0,fontSize:"100%",sort:{col:0,desc:!0}},o.pageIndex=0,void 0===o.panel.styles&&(o.panel.styles=o.panel.columns,o.panel.columns=o.panel.fields,delete o.panel.columns,delete o.panel.fields),A.a.defaults(o.panel,o.panelDefaults),o.events.on("data-received",o.onDataReceived.bind(o)),o.events.on("data-error",o.onDataError.bind(o)),o.events.on("data-snapshot-load",o.onDataReceived.bind(o)),o.events.on("init-edit-mode",o.onInitEditMode.bind(o)),o.events.on("init-panel-actions",o.onInitPanelActions.bind(o)),o}return t.$inject=["$scope","$injector","templateSrv","annotationsSrv","$sanitize","variableSrv"],Ve.c(t,e),t.prototype.onInitEditMode=function(){this.addEditorTab("Options",Qi,2),this.addEditorTab("Column Styles",zi,3)},t.prototype.onInitPanelActions=function(e){e.push({text:"Export CSV",click:"ctrl.exportCsv()"})},t.prototype.issueQueries=function(t){return this.pageIndex=0,"annotations"===this.panel.transform?(this.setTimeQueryStart(),this.annotationsSrv.getAnnotations({dashboard:this.dashboard,panel:this.panel,range:this.range}).then(function(e){return{data:e}})):e.prototype.issueQueries.call(this,t)},t.prototype.onDataError=function(e){this.dataRaw=[],this.render()},t.prototype.onDataReceived=function(e){this.dataRaw=e,this.pageIndex=0,this.dataRaw&&this.dataRaw.length&&("table"===this.dataRaw[0].type?this.panel.transform="table":"docs"===this.dataRaw[0].type?this.panel.transform="json":"table"!==this.panel.transform&&"json"!==this.panel.transform||(this.panel.transform="timeseries_to_rows")),this.render()},t.prototype.render=function(){return this.table=function(e,t){var a=new lt.a;if(!e||0===e.length)return a;var r=ji[t.transform];if(!r)throw{message:"Transformer "+t.transform+" not found"};return r.transform(e,t,a),a}(this.dataRaw,this.panel),this.table.sort(this.panel.sort),this.renderer=new Yi(this.panel,this.table,this.dashboard.isTimezoneUtc(),this.$sanitize,this.templateSrv),e.prototype.render.call(this,this.table)},t.prototype.toggleColumnSort=function(e,t){this.table.columns[this.panel.sort.col]&&(this.table.columns[this.panel.sort.col].sort=!1),this.panel.sort.col===t?this.panel.sort.desc?this.panel.sort.desc=!1:this.panel.sort.col=null:(this.panel.sort.col=t,this.panel.sort.desc=!0),this.render()},t.prototype.moveQuery=function(t,a){e.prototype.moveQuery.call(this,t,a),e.prototype.refresh.call(this)},t.prototype.exportCsv=function(){var e=this.$scope.$new(!0);e.tableData=this.renderer.render_values(),e.panel="table",this.publishAppEvent("show-modal",{templateHtml:'<export-data-modal panel="panel" data="tableData"></export-data-modal>',scope:e,modalClass:"modal--narrow"})},t.prototype.link=function(e,t,a,r){var n,i=r.panel,s=0;function o(){var e=t.parents(".panel-content"),a=t.find(".table-panel-scroll"),o=t.find("tbody"),l=t.find(".table-panel-footer");t.css({"font-size":i.fontSize}),e.addClass("table-panel-content"),function(e){r.renderer.setTable(n),e.empty(),e.html(r.renderer.render(r.pageIndex))}(o),function(e){e.empty();var t=i.pageSize||100;if(1!==(s=Math.ceil(n.rows.length/t))){for(var a=Math.max(r.pageIndex-3,0),o=Math.min(s,a+9),l=O()("<ul></ul>"),u=a;u<o;u++){var c=u===r.pageIndex?"active":"",h=O()('<li><a class="table-panel-page-link pointer '+c+'">'+(u+1)+"</a></li>");l.append(h)}e.append(l)}}(l),a.css({"max-height":i.scroll?function(){var e=r.height;return s>1&&(e-=26),e-31+"px"}():""})}t.tooltip({selector:"[data-link-tooltip]"}),t.on("click",".table-panel-page-link",function(e){var t=O()(e.currentTarget);r.pageIndex=parseInt(t.text(),10)-1,o()}),t.on("click",".table-panel-filter-link",function(e){var t=O()(e.currentTarget).data(),a={datasource:i.datasource,key:n.columns[t.column].text,value:n.rows[t.row][t.column],operator:t.operator};r.variableSrv.setAdhocFilter(a)});var l=e.$on("$destroy",function(){t.off("click",".table-panel-page-link"),t.off("click",".table-panel-filter-link"),l()});r.events.on("render",function(e){(n=e||n)&&o(),r.renderingCompleted()})},t.templateUrl="module.html",t}(ze),Wi=(a(1248),function(){function e(e,t){this.templateSrv=e,this.timeSrv=t}return e.$inject=["templateSrv","timeSrv"],e.prototype.getLinkUrl=function(e){var t=this.templateSrv.replace(e.url||""),a={};if(e.keepTime){var r=this.timeSrv.timeRangeForUrl();a.from=r.from,a.to=r.to}return e.includeVars&&this.templateSrv.fillVariableValuesForUrl(a),this.addParamsToUrl(t,a)},e.prototype.addParamsToUrl=function(e,t){var a=[];return A.a.each(t,function(e,t){null!==e&&(!0===e?a.push(t):A.a.isArray(e)?A.a.each(e,function(e){a.push(t+"="+encodeURIComponent(e))}):a.push(t+"="+encodeURIComponent(e)))}),0===a.length?e:this.appendToQueryString(e,a.join("&"))},e.prototype.appendToQueryString=function(e,t){if(!A.a.isUndefined(t)&&null!==t&&""!==t){var a=e.indexOf("?");-1!==a?e.length-a>1&&(e+="&"):e+="?",e+=t}return e},e.prototype.getAnchorInfo=function(e){var t={};return t.href=this.getLinkUrl(e),t.title=this.templateSrv.replace(e.title||""),t},e.prototype.getPanelLinkAnchorInfo=function(e,t){var a={};if("absolute"===e.type)a.target=e.targetBlank?"_blank":"_self",a.href=this.templateSrv.replace(e.url||"",t),a.title=this.templateSrv.replace(e.title||"",t);else if(e.url)a.href=e.url,a.title=this.templateSrv.replace(e.title||"",t),a.target=e.targetBlank?"_blank":"";else if(e.dashUri)a.href="dashboard/"+e.dashUri+"?",a.title=this.templateSrv.replace(e.title||"",t),a.target=e.targetBlank?"_blank":"";else{a.title=this.templateSrv.replace(e.title||"",t);var r=ie.a.slugifyForUrl(e.dashboard||"");a.href="dashboard/db/"+r+"?"}var n={};if(e.keepTime){var i=this.timeSrv.timeRangeForUrl();n.from=i.from,n.to=i.to}return e.includeVars&&this.templateSrv.fillVariableValuesForUrl(n,t),a.href=this.addParamsToUrl(a.href,n),e.params&&(a.href=this.appendToQueryString(a.href,this.templateSrv.replace(e.params,t))),a},e}());D.a.module("grafana.services").service("linkSrv",Wi);var Ki=function(e){function t(t,a,r){var n=e.call(this,t,a)||this;return n.linkSrv=r,n.dataType="timeseries",n.valueNameOptions=[{value:"min",text:"Min"},{value:"max",text:"Max"},{value:"avg",text:"Average"},{value:"current",text:"Current"},{value:"total",text:"Total"},{value:"name",text:"Name"},{value:"first",text:"First"},{value:"delta",text:"Delta"},{value:"diff",text:"Difference"},{value:"range",text:"Range"},{value:"last_time",text:"Time of last point"}],n.panelDefaults={links:[],datasource:null,maxDataPoints:100,interval:null,targets:[{}],cacheTimeout:null,format:"none",prefix:"",postfix:"",nullText:null,valueMaps:[{value:"null",op:"=",text:"N/A"}],mappingTypes:[{name:"value to text",value:1},{name:"range to text",value:2}],rangeMaps:[{from:"null",to:"null",text:"N/A"}],mappingType:1,nullPointMode:"connected",valueName:"avg",prefixFontSize:"50%",valueFontSize:"80%",postfixFontSize:"50%",thresholds:"",colorBackground:!1,colorValue:!1,colors:["#299c46","rgba(237, 129, 40, 0.89)","#d44a3a"],sparkline:{show:!1,full:!1,lineColor:"rgb(31, 120, 193)",fillColor:"rgba(31, 118, 189, 0.18)"},gauge:{show:!1,minValue:0,maxValue:100,thresholdMarkers:!0,thresholdLabels:!1},tableColumn:""},A.a.defaults(n.panel,n.panelDefaults),n.events.on("data-received",n.onDataReceived.bind(n)),n.events.on("data-error",n.onDataError.bind(n)),n.events.on("data-snapshot-load",n.onDataReceived.bind(n)),n.events.on("init-edit-mode",n.onInitEditMode.bind(n)),n.onSparklineColorChange=n.onSparklineColorChange.bind(n),n.onSparklineFillChange=n.onSparklineFillChange.bind(n),n}return t.$inject=["$scope","$injector","linkSrv"],Ve.c(t,e),t.prototype.onInitEditMode=function(){this.fontSizes=["20%","30%","50%","70%","80%","100%","110%","120%","150%","170%","200%"],this.addEditorTab("Options","public/app/plugins/panel/singlestat/editor.html",2),this.addEditorTab("Value Mappings","public/app/plugins/panel/singlestat/mappings.html",3),this.unitFormats=ie.a.getUnitFormats()},t.prototype.setUnitFormat=function(e){this.panel.format=e.value,this.refresh()},t.prototype.onDataError=function(e){this.onDataReceived([])},t.prototype.onDataReceived=function(e){var t={};if(e.length>0&&"table"===e[0].type){this.dataType="table";var a=e.map(this.tableHandler.bind(this));this.setTableValues(a,t)}else this.dataType="timeseries",this.series=e.map(this.seriesHandler.bind(this)),this.setValues(t);this.data=t,this.render()},t.prototype.seriesHandler=function(e){var t=new ot.a({datapoints:e.datapoints||[],alias:e.target});return t.flotpairs=t.getFlotPairs(this.panel.nullPointMode),t},t.prototype.tableHandler=function(e){var t=[],a={};return e.columns.forEach(function(e,t){a[t]=e.text}),this.tableColumnOptions=a,A.a.find(e.columns,["text",this.panel.tableColumn])||this.setTableColumnToSensibleDefault(e),e.rows.forEach(function(e){var r={};e.forEach(function(e,t){var n=a[t];r[n]=e}),t.push(r)}),t},t.prototype.setTableColumnToSensibleDefault=function(e){1===e.columns.length?this.panel.tableColumn=e.columns[0].text:this.panel.tableColumn=A.a.find(e.columns,function(e){return"time"!==e.type}).text},t.prototype.setTableValues=function(e,t){if(e&&0!==e.length&&0!==e[0].length&&void 0!==e[0][0][this.panel.tableColumn]){var a=e[0][0];if(t.value=a[this.panel.tableColumn],A.a.isString(t.value))t.valueFormatted=A.a.escape(t.value),t.value=0,t.valueRounded=0;else{var r=this.getDecimalsForValue(t.value),n=ie.a.valueFormats[this.panel.format];t.valueFormatted=n(a[this.panel.tableColumn],r.decimals,r.scaledDecimals),t.valueRounded=ie.a.roundValue(t.value,this.panel.decimals||0)}this.setValueMapping(t)}},t.prototype.canModifyText=function(){return!this.panel.gauge.show},t.prototype.setColoring=function(e){e.background?(this.panel.colorValue=!1,this.panel.colors=["rgba(71, 212, 59, 0.4)","rgba(245, 150, 40, 0.73)","rgba(225, 40, 40, 0.59)"]):(this.panel.colorBackground=!1,this.panel.colors=["rgba(50, 172, 45, 0.97)","rgba(237, 129, 40, 0.89)","rgba(245, 54, 54, 0.9)"]),this.render()},t.prototype.invertColorOrder=function(){var e=this.panel.colors[0];this.panel.colors[0]=this.panel.colors[2],this.panel.colors[2]=e,this.render()},t.prototype.onColorChange=function(e){var t=this;return function(a){t.panel.colors[e]=a,t.render()}},t.prototype.onSparklineColorChange=function(e){this.panel.sparkline.lineColor=e,this.render()},t.prototype.onSparklineFillChange=function(e){this.panel.sparkline.fillColor=e,this.render()},t.prototype.getDecimalsForValue=function(e){if(A.a.isNumber(this.panel.decimals))return{decimals:this.panel.decimals,scaledDecimals:null};var t,a=e/2,r=-Math.floor(Math.log(a)/Math.LN10),n=Math.pow(10,-r),i=a/n;i<1.5?t=1:i<3?(t=2,i>2.25&&(t=2.5,++r)):t=i<7.5?5:10,t*=n,Math.floor(e)===e&&(r=0);var s={};return s.decimals=Math.max(0,r),s.scaledDecimals=s.decimals-Math.floor(Math.log(t)/Math.LN10)+2,s},t.prototype.setValues=function(e){if(e.flotpairs=[],this.series.length>1){var t=new Error;throw t.message="Multiple Series Error",t.data="Metric query returns "+this.series.length+" series. Single Stat Panel expects a single series.\n\nResponse:\n"+JSON.stringify(this.series),t}if(this.series&&this.series.length>0){var a=A.a.last(this.series[0].datapoints),r=A.a.isArray(a)?a[0]:null;if("name"===this.panel.valueName)e.value=0,e.valueRounded=0,e.valueFormatted=this.series[0].alias;else if(A.a.isString(r))e.value=0,e.valueFormatted=A.a.escape(r),e.valueRounded=0;else if("last_time"===this.panel.valueName){var n=ie.a.valueFormats[this.panel.format];e.value=a[1],e.valueRounded=e.value,e.valueFormatted=n(e.value,this.dashboard.isTimezoneUtc())}else{e.value=this.series[0].stats[this.panel.valueName],e.flotpairs=this.series[0].flotpairs;var i=this.getDecimalsForValue(e.value);n=ie.a.valueFormats[this.panel.format];e.valueFormatted=n(e.value,i.decimals,i.scaledDecimals),e.valueRounded=ie.a.roundValue(e.value,i.decimals)}e.scopedVars=A.a.extend({},this.panel.scopedVars),e.scopedVars.__name={value:this.series[0].label}}this.setValueMapping(e)},t.prototype.setValueMapping=function(e){if(1===this.panel.mappingType)for(var t=0;t<this.panel.valueMaps.length;t++){if("null"!==(a=this.panel.valueMaps[t]).value){if(parseFloat(a.value)===e.valueRounded)return void(e.valueFormatted=a.text)}else if(null===e.value||void 0===e.value)return void(e.valueFormatted=a.text)}else if(2===this.panel.mappingType)for(t=0;t<this.panel.rangeMaps.length;t++){var a;if("null"!==(a=this.panel.rangeMaps[t]).from||"null"!==a.to){var r=parseFloat(a.from);if(parseFloat(a.to)>=e.valueRounded&&r<=e.valueRounded)return void(e.valueFormatted=a.text)}else if(null===e.value||void 0===e.value)return void(e.valueFormatted=a.text)}null!==e.value&&void 0!==e.value||(e.valueFormatted="no value")},t.prototype.removeValueMap=function(e){var t=A.a.indexOf(this.panel.valueMaps,e);this.panel.valueMaps.splice(t,1),this.render()},t.prototype.addValueMap=function(){this.panel.valueMaps.push({value:"",op:"=",text:""})},t.prototype.removeRangeMap=function(e){var t=A.a.indexOf(this.panel.rangeMaps,e);this.panel.rangeMaps.splice(t,1),this.render()},t.prototype.addRangeMap=function(){this.panel.rangeMaps.push({from:"",to:"",text:""})},t.prototype.link=function(e,t,a,r){var n,i,s=this.$location,o=this.linkSrv,l=this.$timeout,u=r.panel,c=this.templateSrv,h=t.find(".panel-container");function p(e,t){var a=Ji(n,e);return a?'<span style="color:'+a+'">'+t+"</span>":t}function d(e,t,a){return'<span class="'+e+'" style="font-size:'+t+'">'+(a=c.replace(a,n.scopedVars))+"</span>"}function m(){var e=t.width(),a=t.height(),i=Math.min(e,1.3*a);if(r.invalidGaugeRange=!1,u.gauge.minValue>u.gauge.maxValue)r.invalidGaugeRange=!0;else{var s=O()("<div></div>"),o={top:"10px",margin:"auto",position:"relative",height:.9*a+"px",width:i+"px"};s.css(o);for(var l=[],h=0;h<n.thresholds.length;h++)l.push({value:n.thresholds[h],color:n.colorMap[h]});l.push({value:u.gauge.maxValue,color:n.colorMap[n.colorMap.length-1]});var p=ke.a.bootData.user.lightTheme?"rgb(230,230,230)":"rgb(38,38,38)",d=parseInt(u.valueFontSize,10)/100,m=Math.min(i/5,100)*d,f=u.gauge.thresholdLabels?1.5:1,g=Math.min(i/6,60)/f,v=g/5,y=m/2.5,b={series:{gauges:{gauge:{min:u.gauge.minValue,max:u.gauge.maxValue,background:{color:p},border:{color:null},shadow:{show:!1},width:g},frame:{show:!1},label:{show:!1},layout:{margin:0,thresholdWidth:0},cell:{border:{width:0}},threshold:{values:l,label:{show:u.gauge.thresholdLabels,margin:v+1,font:{size:y}},show:u.gauge.thresholdMarkers,width:v},value:{color:u.colorValue?Ji(n,n.valueRounded):null,formatter:function(){return function(){var e=u.prefix?c.replace(u.prefix,n.scopedVars):"";return e+=n.valueFormatted,e+=u.postfix?c.replace(u.postfix,n.scopedVars):""}()},font:{size:m,family:'"Helvetica Neue", Helvetica, Arial, sans-serif'}},show:!0}}};t.append(s);var S={data:[[0,n.value]]};O.a.plot(s,[S],b)}}function f(){var e=t.width()+20;if(e<30)setTimeout(f,30);else{var a=r.height,i=O()("<div></div>"),s={position:"absolute"};if(u.sparkline.full){s.bottom="5px",s.left="-5px",s.width=e-10+"px";var o=a<=100?5:15*Math.round(a/100)+5;s.height=a-o+"px"}else s.bottom="0px",s.left="-5px",s.width=e-10+"px",s.height=Math.floor(.25*a)+"px";i.css(s);var l={legend:{show:!1},series:{lines:{show:!0,fill:1,zero:!1,lineWidth:1,fillColor:u.sparkline.fillColor}},yaxes:{show:!1},xaxis:{show:!1,mode:"time",min:r.range.from.valueOf(),max:r.range.to.valueOf()},grid:{hoverable:!1,show:!1}};t.append(i);var c={data:n.flotpairs,color:u.sparkline.lineColor};O.a.plot(i,[c],l)}}function g(){if(r.data){(n=r.data).thresholds=u.thresholds.split(",").map(function(e){return Number(e.trim())}),n.colorMap=u.colors;var a=u.gauge.show?"":function(){var e='<div class="singlestat-panel-value-container">';if(u.prefix){var t=u.prefix;u.colorPrefix&&(t=p(n.value,u.prefix)),e+=d("singlestat-panel-prefix",u.prefixFontSize,t)}var a=n.valueFormatted;if(u.colorValue&&(a=p(n.value,a)),e+=d("singlestat-panel-value",u.valueFontSize,a),u.postfix){var r=u.postfix;u.colorPostfix&&(r=p(n.value,u.postfix)),e+=d("singlestat-panel-postfix",u.postfixFontSize,r)}return e+="</div>"}();if(u.colorBackground){var s=Ji(n,n.value);s&&(h.css("background-color",s),e.fullscreen?t.css("background-color",s):t.css("background-color",""))}else h.css("background-color",""),t.css("background-color","");t.html(a),u.sparkline.show&&f(),u.gauge.show&&m(),t.toggleClass("pointer",u.links.length>0),i=u.links.length>0?o.getPanelLinkAnchorInfo(u.links[0],n.scopedVars):null}}t=t.find(".singlestat-panel"),function(){var e=O()('<div id="tooltip" class="">hello</div>"');t.mouseleave(function(){0!==u.links.length&&l(function(){e.detach()})}),t.click(function(t){i&&(O()(t).parents(".panel-header").length>0||("_blank"!==i.target?(0===i.href.indexOf("http")?window.location.href=i.href:l(function(){s.url(i.href)}),e.detach()):window.open(i.href,"_blank")))}),t.mousemove(function(t){i&&(e.text("click to go to: "+i.title),e.place_tt(t.pageX,t.pageY-50))})}(),this.events.on("render",function(){g(),r.renderingCompleted()})},t.templateUrl="module.html",t}(ze);function Ji(e,t){if(!A.a.isFinite(t))return null;for(var a=e.thresholds.length;a>0;a--)if(t>=e.thresholds[a-1])return e.colorMap[a];return A.a.first(e.colorMap)}var Xi=function(e){function t(t,a,r,n,i){var s=e.call(this,t,a)||this;return s.backendSrv=r,s.$q=i,s.stepIndex=0,s.steps=[],s.steps.push({title:"Install Grafana",icon:"icon-gf icon-gf-check",href:"http://docs.grafana.org/",target:"_blank",note:"Review the installation docs",check:function(){return i.when(!0)}}),s.steps.push({title:"Create your first data source",cta:"Add data source",icon:"icon-gf icon-gf-datasources",href:"datasources/new?gettingstarted",check:function(){return i.when(n.getMetricSources().filter(function(e){return!0!==e.meta.builtIn}).length>0)}}),s.steps.push({title:"Create your first dashboard",cta:"New dashboard",icon:"icon-gf icon-gf-dashboard",href:"dashboard/new?gettingstarted",check:function(){return s.backendSrv.search({limit:1}).then(function(e){return e.length>0})}}),s.steps.push({title:"Invite your team",cta:"Add Users",icon:"icon-gf icon-gf-users",href:"org/users?gettingstarted",check:function(){return s.backendSrv.get("/api/org/users").then(function(e){return e.length>1})}}),s.steps.push({title:"Install apps & plugins",cta:"Explore plugin repository",icon:"icon-gf icon-gf-apps",href:"https://grafana.com/plugins?utm_source=grafana_getting_started",check:function(){return s.backendSrv.get("/api/plugins",{embedded:0,core:0}).then(function(e){return e.length>0})}}),s}return t.$inject=["$scope","$injector","backendSrv","datasourceSrv","$q"],Ve.c(t,e),t.prototype.$onInit=function(){var e=this;return this.stepIndex=-1,this.nextStep().then(function(t){e.checksDone=!0})},t.prototype.nextStep=function(){var e=this;if(this.stepIndex===this.steps.length-1)return this.$q.when();this.stepIndex+=1;var t=this.steps[this.stepIndex];return t.check().then(function(a){return a?(t.cssClass="completed",e.nextStep()):(t.cssClass="active",e.$q.when())})},t.prototype.dismiss=function(){this.dashboard.removePanel(this.panel,!1),this.backendSrv.request({method:"PUT",url:"/api/user/helpflags/1",showSuccessAlert:!1}).then(function(e){j.c.user.helpFlags1=e.helpFlags1})},t.templateUrl="public/app/plugins/panel/gettingstarted/module.html",t}(Le),Zi={"app/plugins/datasource/graphite/module":s,"app/plugins/datasource/cloudwatch/module":o,"app/plugins/datasource/elasticsearch/module":l,"app/plugins/datasource/opentsdb/module":u,"app/plugins/datasource/grafana/module":c,"app/plugins/datasource/influxdb/module":h,"app/plugins/datasource/logging/module":p,"app/plugins/datasource/mixed/module":d,"app/plugins/datasource/mysql/module":m,"app/plugins/datasource/postgres/module":f,"app/plugins/datasource/mssql/module":v,"app/plugins/datasource/prometheus/module":g,"app/plugins/datasource/testdata/module":y,"app/plugins/datasource/stackdriver/module":b,"app/plugins/panel/text/module":S,"app/plugins/panel/graph/module":x,"app/plugins/panel/dashlist/module":w,"app/plugins/panel/pluginlist/module":T,"app/plugins/panel/alertlist/module":C,"app/plugins/panel/heatmap/module":k,"app/plugins/panel/table/module":_,"app/plugins/panel/singlestat/module":E,"app/plugins/panel/gettingstarted/module":M},es=a(44),ts=a(1229),as=(a(1230),a(1231),a(1232),a(1233),a(1251),"?_cache="+Date.now());function rs(e,t){Fe.a.registerDynamic(e,[],!0,function(e,a,r){r.exports=t})}Fe.a.registry.set("plugin-loader",Fe.a.newModule({locate:function(e){return e.address+as}})),Fe.a.config({baseURL:"public",defaultExtension:"js",packages:{plugins:{defaultExtension:"js"}},map:{text:"vendor/plugin-text/text.js",css:"vendor/plugin-css/css.js"},meta:{"/*":{esModule:!0,authorization:!0,loader:"plugin-loader"}}}),rs("lodash",A.a),rs("moment",U.a),rs("jquery",O.a),rs("angular",D.a),rs("d3",si),rs("rxjs/Subject",ts.Subject),rs("rxjs/Observable",es.Observable),rs("prismjs",Ze.a),rs("slate",et.default),rs("slate-react",tt.b),rs("slate-plain-serializer",at.a),rs("react",nt.a),rs("react-dom",st.a),rs("vendor/npm/rxjs/Rx",{Subject:ts.Subject,Observable:es.Observable}),rs("app/features/dashboard/impression_store",{impressions:At.a,__esModule:!0}),rs("app/plugins/sdk",r),rs("app/core/utils/datemath",je),rs("app/core/utils/file_export",n),rs("app/core/utils/flatten",i),rs("app/core/utils/kbn",ie.a),rs("app/core/utils/ticks",$t),rs("app/core/config",ke.a),rs("app/core/time_series",ot.a),rs("app/core/time_series2",ot.a),rs("app/core/table_model",lt.a),rs("app/core/app_events",j.b),rs("app/core/core_module",j.d),rs("app/core/core",{coreModule:j.d,appEvents:j.b,contextSrv:j.c,__esModule:!0});for(var ns=0,is=["jquery.flot","jquery.flot.pie","jquery.flot.time","jquery.flot.fillbelow","jquery.flot.crosshair","jquery.flot.stack","jquery.flot.selection","jquery.flot.stackpercent","jquery.flot.events","jquery.flot.gauge"];ns<is.length;ns++){rs(is[ns],{fakeDep:1})}function ss(e){var t=Zi[e];return t?Promise.resolve(t):Fe.a.import(e)}function os(e){ke.a.bootData.user.lightTheme?Fe.a.import(e.light+"!css"):Fe.a.import(e.dark+"!css")}var ls=function(){function e(e,t,a,r){this.$q=e,this.$injector=t,this.$rootScope=a,this.templateSrv=r,this.init()}return e.$inject=["$q","$injector","$rootScope","templateSrv"],e.prototype.init=function(){this.datasources={}},e.prototype.get=function(e){return e?"default"===(e=this.templateSrv.replace(e))?this.get(ke.a.defaultDatasource):this.datasources[e]?this.$q.when(this.datasources[e]):this.loadDatasource(e):this.get(ke.a.defaultDatasource)},e.prototype.loadDatasource=function(e){var t=this,a=ke.a.datasources[e];if(!a)return this.$q.reject({message:"Datasource named "+e+" was not found"});var r=this.$q.defer(),n=a.meta;return ss(n.module).then(function(i){if(t.datasources[e])r.resolve(t.datasources[e]);else{if(!i.Datasource)throw new Error("Plugin module is missing Datasource constructor");var s=t.$injector.instantiate(i.Datasource,{instanceSettings:a});s.meta=n,s.name=e,t.datasources[e]=s,r.resolve(s)}}).catch(function(e){t.$rootScope.appEvent("alert-error",[a.name+" plugin failed",e.toString()])}),r.promise},e.prototype.getAll=function(){return ke.a.datasources},e.prototype.getAnnotationSources=function(){var e=[];return this.addDataSourceVariables(e),A.a.each(ke.a.datasources,function(t){t.meta&&t.meta.annotations&&e.push(t)}),e},e.prototype.getExploreSources=function(){var e=ke.a.datasources,t=Object.keys(e).map(function(t){return e[t]}).filter(function(e){return e.meta&&e.meta.explore});return A.a.sortBy(t,["name"])},e.prototype.getMetricSources=function(e){var t=[];return A.a.each(ke.a.datasources,function(e,a){if(e.meta&&e.meta.metrics){var r={value:a,name:a,meta:e.meta,sort:a};"grafana"===e.meta.id?r.sort=String.fromCharCode(253):"mixed"===e.meta.id&&(r.sort=String.fromCharCode(254)),t.push(r),a===ke.a.defaultDatasource&&(r={value:null,name:"default",meta:e.meta,sort:a},t.push(r))}}),e&&e.skipVariables||this.addDataSourceVariables(t),t.sort(function(e,t){return e.sort.toLowerCase()>t.sort.toLowerCase()?1:e.sort.toLowerCase()<t.sort.toLowerCase()?-1:0}),t},e.prototype.addDataSourceVariables=function(e){for(var t=0;t<this.templateSrv.variables.length;t++){var a=this.templateSrv.variables[t];if("datasource"===a.type){var r=a.current.value;"default"===r&&(r=ke.a.defaultDatasource);var n=ke.a.datasources[r];if(n){var i="$"+a.name;e.push({name:i,value:i,meta:n.meta,sort:i})}}}},e}();F.a.service("datasourceSrv",ls);var us=function(e){function t(t,a){return e.call(this,t,a)||this}return t.$inject=["$scope","$injector"],Ve.c(t,e),t.templateUrl="public/app/plugins/panel/unknown/module.html",t}(Le);function cs(e,t,a,r,n,i){function s(e,t){if(e)return 0===e.indexOf("public")?e:t+"/"+e}function o(e,t){var a={name:"panel-plugin-"+e.panel.type,bindings:{dashboard:"=",panel:"=",row:"="},attrs:{dashboard:"dashboard",panel:"panel",class:"panel-height-helper"}},o=ke.a.panels[e.panel.type],l=Promise.resolve(us);return o&&(l=ss(o.module).then(function(e){return e.PanelCtrl})),l.then(function(e){return a.Component=e,!e||e.registered?a:e.templatePromise?e.templatePromise.then(function(e){return a}):(o&&(e.templateUrl=s(e.templateUrl,o.baseUrl)),e.templatePromise=function(e){if(e.template)return r.when(e.template);var t=i.get(e.templateUrl);return t?r.when(t):n.get(e.templateUrl).then(function(e){return e.data})}(e).then(function(t){return e.templateUrl=null,e.template='<grafana-panel ctrl="ctrl" class="panel-height-helper">'+t+"</grafana-panel>",a}),e.templatePromise)})}function l(t,a,r,n){if(n.notFound)a.empty();else{if(!n.Component)throw{message:"Failed to find exported plugin component for "+n.name};if(!n.Component.registered){var i=r.$normalize(n.name),o=function(e){return e.Component.templateUrl=s(e.Component.templateUrl,e.baseUrl),function(){return{templateUrl:e.Component.templateUrl,template:e.Component.template,restrict:"E",controller:e.Component,controllerAs:"ctrl",bindToController:!0,scope:e.bindings,link:function(e,t,a,r){r.link&&r.link(e,t,a,r),r.init&&r.init()}}}}(n);F.a.directive(i,o),n.Component.registered=!0}!function(t,a,r){var n=D.a.element(document.createElement(r.name));A.a.each(r.attrs,function(e,t){n.attr(t,e)}),e(n)(t),a.empty(),setTimeout(function(){a.append(n),t.$applyAsync(function(){t.$broadcast("component-did-mount"),t.$broadcast("refresh")})})}(t,a,n)}}return{restrict:"E",link:function(e,n,i){(function(e,a){switch(a.type){case"query-ctrl":var n=e.target.datasource||e.ctrl.panel.datasource;return t.get(n).then(function(t){return e.datasource=t,ss(t.meta.module).then(function(e){return{baseUrl:t.meta.baseUrl,name:"query-ctrl-"+t.meta.id,bindings:{target:"=",panelCtrl:"=",datasource:"="},attrs:{target:"target","panel-ctrl":"ctrl.panelCtrl",datasource:"datasource"},Component:e.QueryCtrl}})});case"annotations-query-ctrl":return ss(e.ctrl.currentDatasource.meta.module).then(function(t){return{baseUrl:e.ctrl.currentDatasource.meta.baseUrl,name:"annotations-query-ctrl-"+e.ctrl.currentDatasource.meta.id,bindings:{annotation:"=",datasource:"="},attrs:{annotation:"ctrl.currentAnnotation",datasource:"ctrl.currentDatasource"},Component:t.AnnotationsQueryCtrl}});case"datasource-config-ctrl":var i=e.ctrl.datasourceMeta;return ss(i.module).then(function(e){return e.ConfigCtrl?{baseUrl:i.baseUrl,name:"ds-config-"+i.id,bindings:{meta:"=",current:"="},attrs:{meta:"ctrl.datasourceMeta",current:"ctrl.current"},Component:e.ConfigCtrl}:{notFound:!0}});case"app-config-ctrl":var s=e.ctrl.model;return ss(s.module).then(function(e){return{baseUrl:s.baseUrl,name:"app-config-"+s.id,bindings:{appModel:"=",appEditCtrl:"="},attrs:{"app-model":"ctrl.model","app-edit-ctrl":"ctrl"},Component:e.ConfigCtrl}});case"app-page":var l=e.ctrl.appModel;return ss(l.module).then(function(t){return{baseUrl:l.baseUrl,name:"app-page-"+l.id+"-"+e.ctrl.page.slug,bindings:{appModel:"="},attrs:{"app-model":"ctrl.appModel"},Component:t[e.ctrl.page.component]}});case"panel":return o(e);default:return r.reject({message:"Could not find component type: "+a.type})}})(e,i).then(function(t){l(e,n,i,t)}).catch(function(e){a.appEvent("alert-error",["Plugin Error",e.message||e]),console.log("Plugin component error",e)})}}}F.a.directive("pluginComponent",cs);var hs=function(){function e(e,t,a,r,n,i,s,o,l,u,c){this.$scope=e,this.$rootScope=t,this.keybindingSrv=a,this.timeSrv=r,this.variableSrv=n,this.alertingSrv=i,this.dashboardSrv=s,this.unsavedChangesSrv=o,this.dashboardViewStateSrv=l,this.playlistSrv=u,this.panelLoader=c,e.ctrl=this,this.editTab=0,this.getPanelContainer=this.getPanelContainer.bind(this)}return e.$inject=["$scope","$rootScope","keybindingSrv","timeSrv","variableSrv","alertingSrv","dashboardSrv","unsavedChangesSrv","dashboardViewStateSrv","playlistSrv","panelLoader"],e.prototype.setupDashboard=function(e){try{this.setupDashboardInternal(e)}catch(e){this.onInitFailed(e,"Dashboard init failed",!0)}},e.prototype.setupDashboardInternal=function(e){var t=this,a=this.dashboardSrv.create(e.dashboard,e.meta);this.dashboardSrv.setCurrent(a),this.timeSrv.init(a),this.alertingSrv.init(a,e.alerts),this.variableSrv.init(a).catch(this.onInitFailed.bind(this,"Templating init failed",!1)).finally(function(){t.dashboard=a,t.dashboard.processRepeats(),t.dashboard.updateSubmenuVisibility(),t.dashboard.autoFitPanels(window.innerHeight),t.unsavedChangesSrv.init(a,t.$scope),t.$scope.dashboard=a,t.dashboardViewState=t.dashboardViewStateSrv.create(t.$scope),t.keybindingSrv.setupDashboardBindings(t.$scope,a),t.setWindowTitleAndTheme(),t.$scope.appEvent("dashboard-initialized",a)}).catch(this.onInitFailed.bind(this,"Dashboard init failed",!0))},e.prototype.onInitFailed=function(e,t,a){console.log(e,a),a.data&&a.data.message?a.message=a.data.message:a.message||(a={message:a.toString()}),this.$scope.appEvent("alert-error",[e,a.message]),t&&!this.loadedFallbackDashboard&&(this.loadedFallbackDashboard=!0,this.setupDashboard({dashboard:{title:"Dashboard Init failed"}}))},e.prototype.templateVariableUpdated=function(){this.dashboard.processRepeats()},e.prototype.setWindowTitleAndTheme=function(){window.document.title=ke.a.windowTitlePrefix+this.dashboard.title},e.prototype.showJsonEditor=function(e,t){var a=this.$rootScope.$new();a.object=t.object,a.updateHandler=t.updateHandler,this.$scope.appEvent("show-dash-editor",{src:"public/app/partials/edit_json.html",scope:a})},e.prototype.getDashboard=function(){return this.dashboard},e.prototype.getPanelLoader=function(){return this.panelLoader},e.prototype.timezoneChanged=function(){this.$rootScope.$broadcast("refresh")},e.prototype.getPanelContainer=function(){return this},e.prototype.onRemovingPanel=function(e,t){if((t=t||{}).panelId){var a=this.dashboard.getPanelInfoById(t.panelId);this.removePanel(a.panel,!0)}},e.prototype.removePanel=function(e,t){var a=this;if(!1!==t){var r=void 0,n=void 0;return e.alert&&(r="Panel includes an alert rule, removing panel will also remove alert rule",n="YES"),void this.$scope.appEvent("confirm-modal",{title:"Remove Panel",text:"Are you sure you want to remove this panel?",text2:r,icon:"fa-trash",confirmText:n,yesText:"Remove",onConfirm:function(){a.removePanel(e,!1)}})}this.dashboard.removePanel(e)},e.prototype.init=function(e){this.$scope.onAppEvent("show-json-editor",this.showJsonEditor.bind(this)),this.$scope.onAppEvent("template-variable-value-updated",this.templateVariableUpdated.bind(this)),this.$scope.onAppEvent("panel-remove",this.onRemovingPanel.bind(this)),this.setupDashboard(e)},e}();F.a.controller("DashboardCtrl",hs);var ps=function(){function e(){}return e.prototype.init=function(e,t){this.dashboard=e,this.alerts=t||[]},e}();F.a.service("alertingSrv",ps);var ds=function(){function e(e){this.backendSrv=e}return e.$inject=["backendSrv"],e.prototype.getHistoryList=function(e,t){var a=e&&e.id?e.id:void 0;return a?this.backendSrv.get("api/dashboards/id/"+a+"/versions",t):Promise.resolve([])},e.prototype.calculateDiff=function(e){return this.backendSrv.post("api/dashboards/calculate-diff",e)},e.prototype.restoreDashboard=function(e,t){var a=e&&e.id?e.id:void 0,r="api/dashboards/id/"+a+"/restore";return a&&A.a.isNumber(t)?this.backendSrv.post(r,{version:t}):Promise.resolve({})},e}();F.a.service("historySrv",ds);var ms=a(94),fs=function(){function e(e,t,a,r,n,i){this.$route=e,this.$rootScope=t,this.$location=a,this.$q=r,this.historySrv=n,this.$scope=i,this.appending=!1,this.diff="basic",this.limit=10,this.loading=!1,this.max=2,this.mode="list",this.start=0,this.canCompare=!1,this.$rootScope.onAppEvent("dashboard-saved",this.onDashboardSaved.bind(this),i),this.resetFromSource()}return e.$inject=["$route","$rootScope","$location","$q","historySrv","$scope"],e.prototype.onDashboardSaved=function(){this.resetFromSource()},e.prototype.switchMode=function(e){this.mode=e,"list"===this.mode&&this.reset()},e.prototype.dismiss=function(){this.$rootScope.appEvent("hide-dash-editor")},e.prototype.addToLog=function(){this.start=this.start+this.limit,this.getLog(!0)},e.prototype.revisionSelectionChanged=function(){var e=A.a.filter(this.revisions,{checked:!0}).length;this.canCompare=2===e},e.prototype.formatDate=function(e){return this.dashboard.formatDate(e)},e.prototype.formatBasicDate=function(e){var t="browser"===this.dashboard.timezone?U()():U.a.utc();return("browser"===this.dashboard.timezone?U()(e):U.a.utc(e)).from(t)},e.prototype.getDiff=function(e){var t=this;if(this.diff=e,this.mode="compare",this.delta[this.diff])return this.$q.when(this.delta[this.diff]);var a=A.a.filter(this.revisions,{checked:!0});this.newInfo=a[0],this.baseInfo=a[1],this.isNewLatest=this.newInfo.version===this.dashboard.version,this.loading=!0;var r={new:{dashboardId:this.dashboard.id,version:this.newInfo.version},base:{dashboardId:this.dashboard.id,version:this.baseInfo.version},diffType:e};return this.historySrv.calculateDiff(r).then(function(e){t.delta[t.diff]=e}).catch(function(){t.mode="list"}).finally(function(){t.loading=!1})},e.prototype.getLog=function(e){var t=this;void 0===e&&(e=!1),this.loading=!e,this.appending=e;var a={limit:this.limit,start:this.start};return this.historySrv.getHistoryList(this.dashboard,a).then(function(a){for(var r=0,n=a;r<n.length;r++){var i=n[r];i.createdDateString=t.formatDate(i.created),i.ageString=t.formatBasicDate(i.created),i.checked=!1}t.revisions=e?t.revisions.concat(a):a}).catch(function(e){t.loading=!1}).finally(function(){t.loading=!1,t.appending=!1})},e.prototype.isLastPage=function(){return A.a.find(this.revisions,function(e){return 1===e.version})},e.prototype.reset=function(){this.delta={basic:"",json:""},this.diff="basic",this.mode="list",this.revisions=A.a.map(this.revisions,function(e){return A.a.extend({},e,{checked:!1})}),this.canCompare=!1,this.start=0,this.isNewLatest=!1},e.prototype.resetFromSource=function(){return this.revisions=[],this.getLog().then(this.reset.bind(this))},e.prototype.restore=function(e){this.$rootScope.appEvent("confirm-modal",{title:"Restore version",text:"",text2:"Are you sure you want to restore the dashboard to version "+e+"? All unsaved changes will be lost.",icon:"fa-history",yesText:"Yes, restore to version "+e,onConfirm:this.restoreConfirm.bind(this,e)})},e.prototype.restoreConfirm=function(e){var t=this;return this.loading=!0,this.historySrv.restoreDashboard(this.dashboard,e).then(function(a){t.$location.url(ms.a.stripBaseFromUrl(a.url)).replace(),t.$route.reload(),t.$rootScope.appEvent("alert-success",["Dashboard restored","Restored from version "+e])}).catch(function(){t.mode="list",t.loading=!1})},e}();D.a.module("grafana.directives").directive("gfDashboardHistory",function(){return{restrict:"E",templateUrl:"public/app/features/dashboard/history/history.html",controller:fs,bindToController:!0,controllerAs:"ctrl",scope:{dashboard:"="}}});var gs=function(){function e(e,t,a,r,n,i,s,o,l){this.backendSrv=e,this.dashboardSrv=t,this.datasourceSrv=a,this.$http=r,this.$q=n,this.$timeout=i,this.$routeParams=o,this.$rootScope=l}return e.$inject=["backendSrv","dashboardSrv","datasourceSrv","$http","$q","$timeout","contextSrv","$routeParams","$rootScope"],e.prototype._dashboardLoadFailed=function(e,t){return{meta:{canStar:!1,isSnapshot:t=t||!1,canDelete:!1,canSave:!1,canEdit:!1,dashboardNotFound:!0},dashboard:{title:e}}},e.prototype.loadDashboard=function(e,t,a){var r,n=this;return(r="script"===e?this._loadScriptedDashboard(t):"snapshot"===e?this.backendSrv.get("/api/snapshots/"+t).catch(function(){return n._dashboardLoadFailed("Snapshot not found",!0)}):this.backendSrv.getDashboardByUid(a).then(function(e){if(e.meta.isFolder)throw n.$rootScope.appEvent("alert-error",["Dashboard not found"]),new Error("Dashboard not found");return e}).catch(function(){return n._dashboardLoadFailed("Not found",!0)})).then(function(e){return!0!==e.meta.dashboardNotFound&&At.a.addDashboardImpression(e.dashboard.id),e}),r},e.prototype._loadScriptedDashboard=function(e){var t=this,a="public/dashboards/"+e.replace(/\.(?!js)/,"/")+"?"+(new Date).getTime();return this.$http({url:a,method:"GET"}).then(this._executeScript.bind(this)).then(function(e){return{meta:{fromScript:!0,canDelete:!1,canSave:!1,canStar:!1},dashboard:e.data}},function(e){return console.log("Script dashboard error "+e),t.$rootScope.appEvent("alert-error",["Script Error","Please make sure it exists and returns a valid dashboard"]),t._dashboardLoadFailed("Scripted dashboard")})},e.prototype._executeScript=function(e){var t=this,a={dashboardSrv:this.dashboardSrv,datasourceSrv:this.datasourceSrv,$q:this.$q},r=new Function("ARGS","kbn","dateMath","_","moment","window","document","$","jQuery","services",e.data)(this.$routeParams,ie.a,je,A.a,U.a,window,document,O.a,O.a,a);if(A.a.isFunction(r)){var n=this.$q.defer();return r(function(e){t.$timeout(function(){n.resolve({data:e})})}),n.promise}return{data:r}},e}();D.a.module("grafana.services").service("dashboardLoaderSrv",gs);var vs=function(){function e(e,t,a,r){if(this.$scope=e,this.dashboardSrv=t,this.$location=a,this.playlistSrv=r,j.b.on("save-dashboard",this.saveDashboard.bind(this),e),this.dashboard.meta.isSnapshot){var n=this.dashboard.meta;this.titleTooltip="Created: &nbsp;"+U()(n.created).calendar(),n.expires&&(this.titleTooltip+="<br>Expires: &nbsp;"+U()(n.expires).fromNow()+"<br>")}}return e.$inject=["$scope","dashboardSrv","$location","playlistSrv"],e.prototype.toggleSettings=function(){var e=this.$location.search();e.editview?delete e.editview:e.editview="settings",this.$location.search(e)},e.prototype.toggleViewMode=function(){j.b.emit("toggle-kiosk-mode")},e.prototype.close=function(){var e=this.$location.search();e.editview?delete e.editview:e.fullscreen&&(delete e.fullscreen,delete e.edit),this.$location.search(e)},e.prototype.starDashboard=function(){var e=this;this.dashboardSrv.starDashboard(this.dashboard.id,this.dashboard.meta.isStarred).then(function(t){e.dashboard.meta.isStarred=t})},e.prototype.shareDashboard=function(e){var t=this.$scope.$new();t.tabIndex=e,t.dashboard=this.dashboard,j.b.emit("show-modal",{src:"public/app/features/dashboard/partials/shareModal.html",scope:t})},e.prototype.hideTooltip=function(e){D.a.element(e.currentTarget).tooltip("hide")},e.prototype.saveDashboard=function(){return this.dashboardSrv.saveDashboard()},e.prototype.showSearch=function(){j.b.emit("show-dash-search")},e.prototype.addPanel=function(){j.b.emit("dash-scroll",{animate:!0,evt:0}),this.dashboard.panels.length>0&&"add-panel"===this.dashboard.panels[0].type||this.dashboard.addPanel({type:"add-panel",gridPos:{x:0,y:0,w:12,h:9},title:"Panel Title"})},e.prototype.navItemClicked=function(e,t){e.clickHandler&&(e.clickHandler(),t.preventDefault())},e}();D.a.module("grafana.directives").directive("dashnav",function(){return{restrict:"E",templateUrl:"public/app/features/dashboard/dashnav/dashnav.html",controller:vs,bindToController:!0,controllerAs:"ctrl",transclude:!0,scope:{dashboard:"="}}});var ys=function(){function e(e,t,a){this.$rootScope=e,this.variableSrv=t,this.$location=a,this.annotations=this.dashboard.templating.list,this.variables=this.variableSrv.variables}return e.$inject=["$rootScope","variableSrv","$location"],e.prototype.annotationStateChanged=function(){this.$rootScope.$broadcast("refresh")},e.prototype.variableUpdated=function(e){this.variableSrv.variableUpdated(e,!0)},e.prototype.openEditView=function(e){var t=A.a.extend(this.$location.search(),{editview:e});this.$location.search(t)},e}();D.a.module("grafana.directives").directive("dashboardSubmenu",function(){return{restrict:"E",templateUrl:"public/app/features/dashboard/submenu/submenu.html",controller:ys,bindToController:!0,controllerAs:"ctrl",scope:{dashboard:"="}}});var bs='\n<div class="modal-body">\n\t<div class="modal-header">\n\t\t<h2 class="modal-header-title">\n\t\t\t<i class="fa fa-copy"></i>\n\t\t\t<span class="p-l-1">Save As...</span>\n\t\t</h2>\n\n\t\t<a class="modal-header-close" ng-click="ctrl.dismiss();">\n\t\t\t<i class="fa fa-remove"></i>\n\t\t</a>\n\t</div>\n\n\t<form name="ctrl.saveForm" class="modal-content" novalidate>\n\t\t<div class="p-t-2">\n\t\t\t<div class="gf-form">\n\t\t\t\t<label class="gf-form-label width-7">New name</label>\n\t\t\t\t<input type="text" class="gf-form-input" ng-model="ctrl.clone.title" give-focus="true" required>\n\t\t\t</div>\n      <div class="gf-form">\n        <folder-picker initial-folder-id="ctrl.folderId"\n                       on-change="ctrl.onFolderChange($folder)"\n                       enter-folder-creation="ctrl.onEnterFolderCreation()"\n                       exit-folder-creation="ctrl.onExitFolderCreation()"\n                       enable-create-new="true"\n                       label-class="width-7">\n        </folder-picker>\n      </div>\n\t\t</div>\n\n\t\t<div class="gf-form-button-row text-center">\n\t\t\t<button type="submit" class="btn btn-success" ng-click="ctrl.save()" ng-disabled="!ctrl.isValidFolderSelection">Save</button>\n\t\t\t<a class="btn-text" ng-click="ctrl.dismiss();">Cancel</a>\n\t\t</div>\n\t</form>\n</div>\n',Ss=function(){function e(e){this.dashboardSrv=e,this.isValidFolderSelection=!0;var t=this.dashboardSrv.getCurrent();this.clone=t.getSaveModelClone(),this.clone.id=null,this.clone.uid="",this.clone.title+=" Copy",this.clone.editable=!0,this.clone.hideControls=!1,this.folderId=t.meta.folderId,t.id>0&&this.clone.panels.forEach(function(e){"graph"===e.type&&e.alert&&delete e.thresholds,delete e.alert}),delete this.clone.autoUpdate}return e.$inject=["dashboardSrv"],e.prototype.save=function(){return this.dashboardSrv.save(this.clone,{folderId:this.folderId}).then(this.dismiss)},e.prototype.keyDown=function(e){13===e.keyCode&&this.save()},e.prototype.onFolderChange=function(e){this.folderId=e.id},e.prototype.onEnterFolderCreation=function(){this.isValidFolderSelection=!1},e.prototype.onExitFolderCreation=function(){this.isValidFolderSelection=!0},e}();F.a.directive("saveDashboardAsModal",function(){return{restrict:"E",template:bs,controller:Ss,bindToController:!0,controllerAs:"ctrl",scope:{dismiss:"&"}}});var xs='\n<div class="modal-body">\n  <div class="modal-header">\n    <h2 class="modal-header-title">\n      <i class="fa fa-save"></i>\n      <span class="p-l-1">Save changes</span>\n    </h2>\n\n    <a class="modal-header-close" ng-click="ctrl.dismiss();">\n      <i class="fa fa-remove"></i>\n    </a>\n  </div>\n\n  <form name="ctrl.saveForm" ng-submit="ctrl.save()" class="modal-content" novalidate>\n    <div class="p-t-1">\n      <div class="gf-form-group" ng-if="ctrl.timeChange || ctrl.variableValueChange">\n\t\t    <gf-form-switch class="gf-form"\n\t\t\t    label="Save current time range" ng-if="ctrl.timeChange" label-class="width-12" switch-class="max-width-6"\n\t\t\t    checked="ctrl.saveTimerange" on-change="buildUrl()">\n\t\t    </gf-form-switch>\n\t\t    <gf-form-switch class="gf-form"\n\t\t\t    label="Save current variables" ng-if="ctrl.variableValueChange" label-class="width-12" switch-class="max-width-6"\n\t\t\t    checked="ctrl.saveVariables" on-change="buildUrl()">\n\t\t    </gf-form-switch>\n\t    </div>\n      <div class="gf-form">\n        <label class="gf-form-hint">\n          <input\n            type="text"\n            name="message"\n            class="gf-form-input"\n            placeholder="Add a note to describe your changes &hellip;"\n            give-focus="true"\n            ng-model="ctrl.message"\n            ng-model-options="{allowInvalid: true}"\n            ng-maxlength="this.max"\n            maxlength="64"\n            autocomplete="off" />\n          <small class="gf-form-hint-text muted" ng-cloak>\n            <span ng-class="{\'text-error\': ctrl.saveForm.message.$invalid && ctrl.saveForm.message.$dirty }">\n              {{ctrl.message.length || 0}}\n            </span>\n            / {{ctrl.max}} characters\n          </small>\n        </label>\n      </div>\n    </div>\n\n    <div class="gf-form-button-row text-center">\n      <button\n        id="saveBtn"\n        type="submit"\n        class="btn btn-success"\n        ng-class="{\'btn-success--processing\': ctrl.isSaving}"\n        ng-disabled="ctrl.saveForm.$invalid || ctrl.isSaving"\n      >\n        <span ng-if="!ctrl.isSaving">Save</span>\n        <span ng-if="ctrl.isSaving === true">Saving...</span>\n      </button>\n      <button class="btn btn-inverse" ng-click="ctrl.dismiss();">Cancel</button>\n    </div>\n  </form>\n</div>\n',ws=function(){function e(e){this.dashboardSrv=e,this.saveVariables=!1,this.saveTimerange=!1,this.current=[],this.originalCurrent=[],this.timeChange=!1,this.variableValueChange=!1,this.message="",this.max=64,this.isSaving=!1,this.timeChange=this.dashboardSrv.getCurrent().hasTimeChanged(),this.variableValueChange=this.dashboardSrv.getCurrent().hasVariableValuesChanged()}return e.$inject=["dashboardSrv"],e.prototype.save=function(){if(this.saveForm.$valid){var e={saveVariables:this.saveVariables,saveTimerange:this.saveTimerange,message:this.message},t=this.dashboardSrv.getCurrent().getSaveModelClone(e);return this.isSaving=!0,this.dashboardSrv.save(t,e).then(this.postSave.bind(this,e))}},e.prototype.postSave=function(e){e.saveVariables&&this.dashboardSrv.getCurrent().resetOriginalVariables(),e.saveTimerange&&this.dashboardSrv.getCurrent().resetOriginalTime(),this.dismiss()},e}();F.a.directive("saveDashboardModal",function(){return{restrict:"E",template:xs,controller:ws,bindToController:!0,controllerAs:"ctrl",scope:{dismiss:"&"}}});var Ts='\n<div class="modal-body">\n  <div class="modal-header">\n    <h2 class="modal-header-title">\n      <i class="fa fa-save"></i><span class="p-l-1">Cannot save provisioned dashboard</span>\n    </h2>\n\n    <a class="modal-header-close" ng-click="ctrl.dismiss();">\n      <i class="fa fa-remove"></i>\n    </a>\n  </div>\n\n  <div class="modal-content">\n    <small>\n      This dashboard cannot be saved from Grafana\'s UI since it has been provisioned from another source.\n      Copy the JSON or save it to a file below. Then you can update your dashboard in corresponding provisioning source.<br/>\n      <i>See <a class="external-link" href="http://docs.grafana.org/administration/provisioning/#dashboards" target="_blank">\n      documentation</a> for more information about provisioning.</i>\n    </small>\n    <div class="p-t-2">\n      <div class="gf-form">\n        <code-editor content="ctrl.dashboardJson" data-mode="json" data-max-lines=15></code-editor>\n      </div>\n      <div class="gf-form-button-row">\n        <button class="btn btn-success" clipboard-button="ctrl.getJsonForClipboard()">\n          <i class="fa fa-clipboard"></i>&nbsp;Copy JSON to Clipboard\n        </button>\n        <button class="btn btn-secondary" clipboard-button="ctrl.save()">\n          <i class="fa fa-save"></i>&nbsp;Save JSON to file\n        </button>\n        <a class="btn btn-link" ng-click="ctrl.dismiss();">Cancel</a>\n      </div>\n    </div>\n  </div>\n</div>\n',Cs=function(){function e(e){this.dash=e.getCurrent().getSaveModelClone(),delete this.dash.id,this.dashboardJson=D.a.toJson(this.dash,!0)}return e.$inject=["dashboardSrv"],e.prototype.save=function(){var e=new Blob([D.a.toJson(this.dash,!0)],{type:"application/json;charset=utf-8"});Object(ut.saveAs)(e,this.dash.title+"-"+(new Date).getTime()+".json")},e.prototype.getJsonForClipboard=function(){return this.dashboardJson},e}();function ks(e,t,a,r,n,i,s){e.options={forCurrent:!0,includeTemplateVars:!0,theme:"current"},e.editor={index:e.tabIndex||0},e.init=function(){e.modeSharePanel=!!e.panel,e.tabs=[{title:"Link",src:"shareLink.html"}],e.modeSharePanel?(e.modalTitle="Share Panel",e.tabs.push({title:"Embed",src:"shareEmbed.html"})):e.modalTitle="Share",e.dashboard.meta.isSnapshot||e.tabs.push({title:"Snapshot",src:"shareSnapshot.html"}),e.dashboard.meta.isSnapshot||e.modeSharePanel||e.tabs.push({title:"Export",src:"shareExport.html"}),e.buildUrl()},e.buildUrl=function(){var t=a.absUrl(),r=t.indexOf("?");-1!==r&&(t=t.substring(0,r));var o=D.a.copy(a.search()),l=n.timeRange();o.from=l.from.valueOf(),o.to=l.to.valueOf(),o.orgId=ke.a.bootData.user.orgId,e.options.includeTemplateVars&&i.fillVariableValuesForUrl(o),e.options.forCurrent||(delete o.from,delete o.to),"current"!==e.options.theme&&(o.theme=e.options.theme),e.modeSharePanel?(o.panelId=e.panel.id,o.fullscreen=!0):(delete o.panelId,delete o.fullscreen),e.shareUrl=s.addParamsToUrl(t,o);var u=t.replace(ke.a.appSubUrl+"/dashboard/",ke.a.appSubUrl+"/dashboard-solo/");u=u.replace(ke.a.appSubUrl+"/d/",ke.a.appSubUrl+"/d-solo/"),delete o.fullscreen,delete o.edit,u=s.addParamsToUrl(u,o),e.iframeHtml='<iframe src="'+u+'" width="450" height="200" frameborder="0"></iframe>',e.imageUrl=u.replace(ke.a.appSubUrl+"/dashboard-solo/",ke.a.appSubUrl+"/render/dashboard-solo/"),e.imageUrl=e.imageUrl.replace(ke.a.appSubUrl+"/d-solo/",ke.a.appSubUrl+"/render/d-solo/"),e.imageUrl+="&width=1000&height=500"+e.getLocalTimeZone()},e.getLocalTimeZone=function(){var e="&tz=UTC"+encodeURIComponent(U()().format("Z"));if(!window.Intl)return e;var t=window.Intl.DateTimeFormat();if(!t.resolvedOptions)return e;var a=t.resolvedOptions();return a.timeZone?"&tz="+encodeURIComponent(a.timeZone):e},e.getShareUrl=function(){return e.shareUrl}}F.a.directive("saveProvisionedDashboardModal",function(){return{restrict:"E",template:Ts,controller:Cs,bindToController:!0,controllerAs:"ctrl",scope:{dismiss:"&"}}}),D.a.module("grafana.controllers").controller("ShareModalCtrl",ks);var _s=function(){function e(e,t,a,r,n,i){e.snapshot={name:e.dashboard.title,expires:0,timeoutSeconds:4},e.step=1,e.expireOptions=[{text:"1 Hour",value:3600},{text:"1 Day",value:86400},{text:"7 Days",value:604800},{text:"Never",value:0}],e.accessOptions=[{text:"Anyone with the link",value:1},{text:"Organization users",value:2},{text:"Public on the web",value:3}],e.init=function(){r.get("/api/snapshot/shared-options").then(function(t){e.externalUrl=t.externalSnapshotURL,e.sharingButtonText=t.externalSnapshotName,e.externalEnabled=t.externalEnabled})},e.apiUrl="/api/snapshots",e.createSnapshot=function(r){e.dashboard.snapshot={timestamp:new Date},r||(e.dashboard.snapshot.originalUrl=a.absUrl()),e.loading=!0,e.snapshot.external=r,t.$broadcast("refresh"),n(function(){e.saveSnapshot(r)},1e3*e.snapshot.timeoutSeconds)},e.saveSnapshot=function(t){var n=e.dashboard.getSaveModelClone();e.scrubDashboard(n);var i={dashboard:n,name:n.title,expires:e.snapshot.expires},s=t?e.externalUrl+e.apiUrl:e.apiUrl;r.post(s,i).then(function(r){if(e.loading=!1,t)e.deleteUrl=r.deleteUrl,e.snapshotUrl=r.url,e.saveExternalSnapshotRef(i,r);else{var n=a.url(),s=a.absUrl();"/"!==n&&(s=s.replace(n,"")+"/"),e.snapshotUrl=s+"dashboard/snapshot/"+r.key,e.deleteUrl=s+"api/snapshots-delete/"+r.deleteKey}e.step=2},function(){e.loading=!1})},e.getSnapshotUrl=function(){return e.snapshotUrl},e.scrubDashboard=function(t){if(t.title=e.snapshot.name,t.time=i.timeRange(),A.a.each(t.panels,function(e){e.targets=[],e.links=[],e.datasource=null}),t.annotations.list=A.a.chain(t.annotations.list).filter(function(e){return e.enable}).map(function(e){return{name:e.name,enable:e.enable,iconColor:e.iconColor,snapshotData:e.snapshotData,type:e.type,builtIn:e.builtIn,hide:e.hide}}).value(),A.a.each(t.templating.list,function(e){e.query="",e.options=e.current,e.refresh=!1}),e.modeSharePanel){var a=e.panel.getSaveModel();a.gridPos.w=24,a.gridPos.x=0,a.gridPos.y=0,a.gridPos.h=20,t.panels=[a]}delete e.dashboard.snapshot,e.dashboard.forEachPanel(function(e){delete e.snapshotData}),A.a.each(e.dashboard.annotations.list,function(e){delete e.snapshotData})},e.deleteSnapshot=function(){r.get(e.deleteUrl).then(function(){e.step=3})},e.saveExternalSnapshotRef=function(e,t){e.external=!0,e.key=t.key,e.deleteKey=t.deleteKey,r.post("/api/snapshots/",e)}}return e.$inject=["$scope","$rootScope","$location","backendSrv","$timeout","timeSrv"],e}();D.a.module("grafana.controllers").controller("ShareSnapshotCtrl",_s);var Es=a(292),Ms=function(){function e(e,t,a){this.backendSrv=e,this.$rootScope=t,this.$location=a}return e.$inject=["backendSrv","$rootScope","$location"],e.prototype.create=function(e,t){return new Es.a(e,t)},e.prototype.setCurrent=function(e){this.dash=e},e.prototype.getCurrent=function(){return this.dash},e.prototype.handleSaveDashboardError=function(e,t,a){var r=this;(t=t||{}).overwrite=!0,a.data&&"version-mismatch"===a.data.status&&(a.isHandled=!0,this.$rootScope.appEvent("confirm-modal",{title:"Conflict",text:"Someone else has updated this dashboard.",text2:"Would you still like to save this dashboard?",yesText:"Save & Overwrite",icon:"fa-warning",onConfirm:function(){r.save(e,t)}})),a.data&&"name-exists"===a.data.status&&(a.isHandled=!0,this.$rootScope.appEvent("confirm-modal",{title:"Conflict",text:"A dashboard with the same name in selected folder already exists.",text2:"Would you still like to save this dashboard?",yesText:"Save & Overwrite",icon:"fa-warning",onConfirm:function(){r.save(e,t)}})),a.data&&"plugin-dashboard"===a.data.status&&(a.isHandled=!0,this.$rootScope.appEvent("confirm-modal",{title:"Plugin Dashboard",text:a.data.message,text2:"Your changes will be lost when you update the plugin. Use Save As to create custom version.",yesText:"Overwrite",icon:"fa-warning",altActionText:"Save As",onAltAction:function(){r.showSaveAsModal()},onConfirm:function(){r.save(e,{overwrite:!0})}}))},e.prototype.postSave=function(e,t){this.dash.version=t.version;var a=ms.a.stripBaseFromUrl(t.url);return a!==this.$location.path()&&this.$location.url(a).replace(),this.$rootScope.appEvent("dashboard-saved",this.dash),this.$rootScope.appEvent("alert-success",["Dashboard saved"]),this.dash},e.prototype.save=function(e,t){return(t=t||{}).folderId=t.folderId>=0?t.folderId:this.dash.meta.folderId||e.folderId,this.backendSrv.saveDashboard(e,t).then(this.postSave.bind(this,e)).catch(this.handleSaveDashboardError.bind(this,e,t))},e.prototype.saveDashboard=function(e,t){return t&&this.setCurrent(this.create(t,this.dash.meta)),this.dash.meta.provisioned?this.showDashboardProvisionedModal():this.dash.meta.canSave||!0===e.makeEditable?"New dashboard"===this.dash.title?this.showSaveAsModal():this.dash.version>0?this.showSaveModal():this.save(this.dash.getSaveModelClone(),e):Promise.resolve()},e.prototype.saveJSONDashboard=function(e){return this.save(JSON.parse(e),{})},e.prototype.showDashboardProvisionedModal=function(){this.$rootScope.appEvent("show-modal",{templateHtml:'<save-provisioned-dashboard-modal dismiss="dismiss()"></save-provisioned-dashboard-modal>'})},e.prototype.showSaveAsModal=function(){this.$rootScope.appEvent("show-modal",{templateHtml:'<save-dashboard-as-modal dismiss="dismiss()"></save-dashboard-as-modal>',modalClass:"modal--narrow"})},e.prototype.showSaveModal=function(){this.$rootScope.appEvent("show-modal",{templateHtml:'<save-dashboard-modal dismiss="dismiss()"></save-dashboard-modal>',modalClass:"modal--narrow"})},e.prototype.starDashboard=function(e,t){var a=this;return(t?this.backendSrv.delete("/api/user/stars/dashboard/"+e).then(function(){return!1}):this.backendSrv.post("/api/user/stars/dashboard/"+e).then(function(){return!0})).then(function(t){return a.dash&&a.dash.id===e&&(a.dash.meta.isStarred=t),t})},e}();F.a.service("dashboardSrv",Ms);var Ps=function(){function e(e,t,a,r){this.$location=t,this.$timeout=a,this.$rootScope=r;var n=this;n.state={},n.panelScopes=[],n.$scope=e,n.dashboard=e.dashboard,e.onAppEvent("$routeUpdate",function(){var e=n.getQueryStringState();n.needsSync(e)&&n.update(e,!0)}),e.onAppEvent("panel-change-view",function(e,t){n.update(t)}),e.onAppEvent("panel-initialized",function(e,t){n.registerPanel(t.scope)}),t.replace(),this.update(this.getQueryStringState())}return e.$inject=["$scope","$location","$timeout","$rootScope"],e.prototype.needsSync=function(e){return!1===A.a.isEqual(this.state,e)},e.prototype.getQueryStringState=function(){var e=this.$location.search();return e.panelId=parseInt(e.panelId,10)||null,e.fullscreen=!!e.fullscreen||null,e.edit="true"===e.edit||!0===e.edit||null,e.editview=e.editview||null,e.orgId=ke.a.bootData.user.orgId,e},e.prototype.serializeToUrl=function(){var e=A.a.clone(this.state);return e.fullscreen=!!this.state.fullscreen||null,e.edit=!!this.state.edit||null,e},e.prototype.update=function(e,t){e.toggle&&(delete e.toggle,this.state.fullscreen&&e.fullscreen&&this.state.edit===e.edit&&(e.fullscreen=!e.fullscreen)),this.editStateChanged=(e.edit||!1)!==(this.state.edit||!1),A.a.extend(this.state,e),this.dashboard.meta.fullscreen=this.state.fullscreen,this.state.fullscreen||(this.state.fullscreen=null,this.state.edit=null,this.dashboard.meta.soloMode||(this.state.panelId=null)),(this.state.fullscreen||this.dashboard.meta.soloMode)&&this.state.panelId&&this.toggleCollapsedPanelRow(this.state.panelId),this.state.edit||delete this.state.tab,!0!==t&&this.$location.search(this.serializeToUrl()),this.syncState()},e.prototype.toggleCollapsedPanelRow=function(e){for(var t=0,a=this.dashboard.panels;t<a.length;t++){var r=a[t];if(r.collapsed)for(var n=0,i=r.panels;n<i.length;n++){if(i[n].id===e)return void this.dashboard.toggleRow(r)}}},e.prototype.syncState=function(){if(0!==this.panelScopes.length)if(this.dashboard.meta.fullscreen){var e=this.getPanelScope(this.state.panelId);if(!e)return;if(this.fullscreenPanel){if(this.fullscreenPanel===e&&!1===this.editStateChanged)return;this.leaveFullscreen(!1)}e.ctrl.editModeInitiated||e.ctrl.initEditMode(),e.ctrl.fullscreen||this.enterFullscreen(e)}else this.fullscreenPanel&&this.leaveFullscreen(!0)},e.prototype.getPanelScope=function(e){return A.a.find(this.panelScopes,function(t){return t.ctrl.panel.id===e})},e.prototype.leaveFullscreen=function(e){var t=this,a=t.fullscreenPanel.ctrl;return a.editMode=!1,a.fullscreen=!1,this.dashboard.setViewMode(a.panel,!1,!1),this.$scope.appEvent("panel-fullscreen-exit",{panelId:a.panel.id}),this.$scope.appEvent("dash-scroll",{restore:!0}),!!e&&(this.$timeout(function(){t.oldTimeRange!==a.range?t.$rootScope.$broadcast("refresh"):t.$rootScope.$broadcast("render"),delete t.fullscreenPanel}),!0)},e.prototype.enterFullscreen=function(e){var t=e.ctrl;t.editMode=this.state.edit&&this.dashboard.meta.canEdit,t.fullscreen=!0,this.oldTimeRange=t.range,this.fullscreenPanel=e,this.$scope.appEvent("dash-scroll",{animate:!1,pos:0}),this.dashboard.setViewMode(t.panel,!0,t.editMode),this.$scope.appEvent("panel-fullscreen-enter",{panelId:t.panel.id})},e.prototype.registerPanel=function(e){var t=this;t.panelScopes.push(e),t.dashboard.meta.soloMode||t.state.panelId===e.ctrl.panel.id&&(t.state.edit?e.ctrl.editPanel():e.ctrl.viewPanel());var a=e.$on("$destroy",function(){t.panelScopes=A.a.without(t.panelScopes,e),a()})},e}();function Ds(e,t,a){return{create:function(r){return new Ps(r,e,t,a)}}}D.a.module("grafana.services").factory("dashboardViewStateSrv",Ds);var $s="dash-folder",As="dash-db",Is=function(){function e(e,t){this.$q=e,this.backendSrv=t,this.rootName="general"}return e.$inject=["$q","backendSrv"],e.prototype.validateNewDashboardName=function(e,t){return this.validate(e,t,"A dashboard in this folder with the same name already exists")},e.prototype.validateNewFolderName=function(e){return this.validate(0,e,"A folder or dashboard in the general folder with the same name already exists")},e.prototype.validate=function(e,t,a){var r=(t=(t||"").trim()).toLowerCase();if(0===t.length)return this.$q.reject({type:"REQUIRED",message:"Name is required"});if(0===e&&r===this.rootName)return this.$q.reject({type:"EXISTING",message:"This is a reserved name and cannot be used for a folder."});var n=this.$q.defer(),i=[];return i.push(this.backendSrv.search({type:$s,folderIds:[e],query:t})),i.push(this.backendSrv.search({type:As,folderIds:[e],query:t})),this.$q.all(i).then(function(e){var t=[];e.length>0&&e[0].length>0&&(t=e[0]),e.length>1&&e[1].length>0&&(t=t.concat(e[1]));for(var i=0,s=t;i<s.length;i++){var o=s[i];if(r===o.title.toLowerCase()){n.reject({type:"EXISTING",message:a});break}}n.resolve()}),n.promise},e}();F.a.service("validationSrv",Is);var Os=function(){function e(e,t,a,r,n){var i=this;this.$rootScope=e,this.$timeout=t,this.$location=a,this.timer=r,this.contextSrv=n,this.time={from:"6h",to:"now"},e.$on("zoom-out",this.zoomOut.bind(this)),e.$on("$routeUpdate",this.routeUpdated.bind(this)),document.addEventListener("visibilitychange",function(){i.autoRefreshBlocked&&"visible"===document.visibilityState&&(i.autoRefreshBlocked=!1,i.refreshDashboard())})}return e.$inject=["$rootScope","$timeout","$location","timer","contextSrv"],e.prototype.init=function(e){this.timer.cancelAll(),this.dashboard=e,this.time=e.time,this.refresh=e.refresh,this.initTimeFromUrl(),this.parseTime(),this.timeAtLoad=A.a.cloneDeep(this.time),this.refresh&&this.setAutoRefresh(this.refresh)},e.prototype.parseTime=function(){A.a.isString(this.time.from)&&this.time.from.indexOf("Z")>=0&&(this.time.from=U()(this.time.from).utc()),A.a.isString(this.time.to)&&this.time.to.indexOf("Z")>=0&&(this.time.to=U()(this.time.to).utc())},e.prototype.parseUrlParam=function(e){if(-1!==e.indexOf("now"))return e;if(8===e.length)return U.a.utc(e,"YYYYMMDD");if(15===e.length)return U.a.utc(e,"YYYYMMDDTHHmmss");if(!isNaN(e)){var t=parseInt(e,10);return U.a.utc(t)}return null},e.prototype.initTimeFromUrl=function(){var e=this.$location.search();e.from&&(this.time.from=this.parseUrlParam(e.from)||this.time.from),e.to&&(this.time.to=this.parseUrlParam(e.to)||this.time.to),e.to&&-1===e.to.indexOf("now")&&(this.refresh=!1,this.dashboard.refresh=!1),e.refresh&&(this.refresh=e.refresh||this.refresh)},e.prototype.routeUpdated=function(){var e=this.$location.search(),t=this.timeRangeForUrl();e.from&&e.to?e.from===t.from&&e.to===t.to||(this.initTimeFromUrl(),this.setTime(this.time,!0)):this.timeHasChangedSinceLoad()&&this.setTime(this.timeAtLoad,!0)},e.prototype.timeHasChangedSinceLoad=function(){return this.timeAtLoad&&(this.timeAtLoad.from!==this.time.from||this.timeAtLoad.to!==this.time.to)},e.prototype.setAutoRefresh=function(e){var t=this;if(this.dashboard.refresh=e,this.cancelNextRefresh(),e){var a=ie.a.interval_to_ms(e);this.refreshTimer=this.timer.register(this.$timeout(function(){t.startNextRefreshTimer(a),t.refreshDashboard()},a))}var r=this.$location.search();e?(r.refresh=e,this.$location.search(r)):r.refresh&&(delete r.refresh,this.$location.search(r))},e.prototype.refreshDashboard=function(){this.$rootScope.$broadcast("refresh")},e.prototype.startNextRefreshTimer=function(e){var t=this;this.cancelNextRefresh(),this.refreshTimer=this.timer.register(this.$timeout(function(){t.startNextRefreshTimer(e),t.contextSrv.isGrafanaVisible()?t.refreshDashboard():t.autoRefreshBlocked=!0},e))},e.prototype.cancelNextRefresh=function(){this.timer.cancel(this.refreshTimer)},e.prototype.setTime=function(e,t){if(A.a.extend(this.time,e),U.a.isMoment(e.to)?(this.oldRefresh=this.dashboard.refresh||this.oldRefresh,this.setAutoRefresh(!1)):this.oldRefresh&&this.oldRefresh!==this.dashboard.refresh&&(this.setAutoRefresh(this.oldRefresh),this.oldRefresh=null),!0!==t){var a=this.timeRangeForUrl(),r=this.$location.search();r.from=a.from,r.to=a.to,this.$location.search(r)}this.$rootScope.appEvent("time-range-changed",this.time),this.$timeout(this.refreshDashboard.bind(this),0)},e.prototype.timeRangeForUrl=function(){var e=this.timeRange().raw;return U.a.isMoment(e.from)&&(e.from=e.from.valueOf().toString()),U.a.isMoment(e.to)&&(e.to=e.to.valueOf().toString()),e},e.prototype.timeRange=function(){var e={from:U.a.isMoment(this.time.from)?U()(this.time.from):this.time.from,to:U.a.isMoment(this.time.to)?U()(this.time.to):this.time.to},t=this.dashboard&&this.dashboard.getTimezone();return{from:je.parse(e.from,!1,t),to:je.parse(e.to,!0,t),raw:e}},e.prototype.zoomOut=function(e,t){var a=this.timeRange(),r=a.to.valueOf()-a.from.valueOf(),n=a.to.valueOf()-r/2,i=n+r*t/2,s=n-r*t/2;i>Date.now()&&a.to<=Date.now()&&(s-=i-Date.now(),i=Date.now());this.setTime({from:U.a.utc(s),to:U.a.utc(i)})},e}();F.a.service("timeSrv",Os);var Fs=function(){function e(e,t,a,r,n,i,s,o){var l=this;this.$location=r,this.$timeout=i,this.contextSrv=s,this.$rootScope=o,this.$location=r,this.$window=n,this.current=e,this.originalPath=r.path(),this.scope=t,t.onAppEvent("dashboard-saved",function(){l.original=l.current.getSaveModelClone(),l.originalPath=r.path()}),n.onbeforeunload=function(){if(!l.ignoreChanges())return l.hasChanges()?"There are unsaved changes to this dashboard":void 0},t.$on("$locationChangeStart",function(e,t){return l.originalPath===r.path()||(!!l.ignoreChanges()||(l.hasChanges()&&(e.preventDefault(),l.next=t,l.$timeout(function(){l.open_modal()})),!1))}),a?this.$timeout(function(){l.original=e.getSaveModelClone()},a):this.original=e.getSaveModelClone()}return e.$inject=["dashboard","scope","originalCopyDelay","$location","$window","$timeout","contextSrv","$rootScope"],e.prototype.ignoreChanges=function(){if(!this.original)return!0;if(!this.contextSrv.isEditor)return!0;if(!this.current||!this.current.meta)return!0;var e=this.current.meta;return!e.canSave||e.fromScript||e.fromFile},e.prototype.cleanDashboardFromIgnoredChanges=function(e){var t=new Es.a(e);t.expandRows();var a=t.getSaveModelClone();return a.time=0,a.refresh=0,a.schemaVersion=0,delete a.iteration,a.panels=A.a.filter(a.panels,function(e){return!e.repeatPanelId&&(e.scopedVars=null,e.legend&&(delete e.legend.sort,delete e.legend.sortDesc),!0)}),A.a.each(a.templating.list,function(e){e.current=null,e.options=null,e.filters=null}),a},e.prototype.hasChanges=function(){var e=this.cleanDashboardFromIgnoredChanges(this.current.getSaveModelClone()),t=this.cleanDashboardFromIgnoredChanges(this.original),a=A.a.find(e.nav,{type:"timepicker"}),r=A.a.find(t.nav,{type:"timepicker"});return a&&r&&(a.now=r.now),D.a.toJson(e,!0)!==D.a.toJson(t,!0)},e.prototype.discardChanges=function(){this.original=null,this.gotoNext()},e.prototype.open_modal=function(){this.$rootScope.appEvent("show-modal",{templateHtml:'<unsaved-changes-modal dismiss="dismiss()"></unsaved-changes-modal>',modalClass:"modal--narrow confirm-modal"})},e.prototype.saveChanges=function(){var e=this,t=this,a=this.$rootScope.$on("dashboard-saved",function(){a(),e.$timeout(function(){t.gotoNext()})});this.$rootScope.appEvent("save-dashboard")},e.prototype.gotoNext=function(){var e=this.$location.absUrl().length-this.$location.url().length,t=this.next.substring(e);this.$location.url(t)},e}();function qs(e,t,a,r,n,i,s){this.init=function(t,i){return this.tracker=new Fs(t,i,1e3,a,s,r,n,e),this.tracker}}D.a.module("grafana.services").service("unsavedChangesSrv",qs);var Ns='\n<div class="modal-body">\n  <div class="modal-header">\n    <h2 class="modal-header-title">\n      <i class="fa fa-exclamation"></i>\n      <span class="p-l-1">Unsaved changes</span>\n    </h2>\n\n    <a class="modal-header-close" ng-click="ctrl.dismiss();">\n      <i class="fa fa-remove"></i>\n    </a>\n  </div>\n\n  <div class="modal-content text-center">\n\n    <div class="confirm-modal-text">\n      Do you want to save your changes?\n    </div>\n\n    <div class="confirm-modal-buttons">\n      <button type="button" class="btn btn-success" ng-click="ctrl.save()">Save</button>\n      <button type="button" class="btn btn-danger" ng-click="ctrl.discard()">Discard</button>\n      <button type="button" class="btn btn-inverse" ng-click="ctrl.dismiss()">Cancel</button>\n    </div>\n  </div>\n</div>\n',Rs=function(){function e(e){this.unsavedChangesSrv=e}return e.$inject=["unsavedChangesSrv"],e.prototype.discard=function(){this.dismiss(),this.unsavedChangesSrv.tracker.discardChanges()},e.prototype.save=function(){this.dismiss(),this.unsavedChangesSrv.tracker.saveChanges()},e}();F.a.directive("unsavedChangesModal",function(){return{restrict:"E",template:Ns,controller:Rs,bindToController:!0,controllerAs:"ctrl",scope:{dismiss:"&"}}});var Ls=function(){function e(t,a,r){var n=this;this.$scope=t,this.$rootScope=a,this.timeSrv=r,this.$scope.ctrl=this,a.onAppEvent("shift-time-forward",function(){return n.move(1)},t),a.onAppEvent("shift-time-backward",function(){return n.move(-1)},t),a.onAppEvent("refresh",this.onRefresh.bind(this),t),a.onAppEvent("closeTimepicker",this.openDropdown.bind(this),t),this.panel=this.dashboard.timepicker,A.a.defaults(this.panel,e.defaults),this.firstDayOfWeek=U.a.localeData().firstDayOfWeek(),this.onRefresh()}return e.$inject=["$scope","$rootScope","timeSrv"],e.prototype.onRefresh=function(){var e=D.a.copy(this.timeSrv.timeRange()),t=D.a.copy(e.raw);this.dashboard.isTimezoneUtc()?this.isUtc=!0:(e.from.local(),e.to.local(),U.a.isMoment(t.from)&&t.from.local(),U.a.isMoment(t.to)&&t.to.local(),this.isUtc=!1),this.rangeString=Ue.b(t),this.absolute={fromJs:e.from.toDate(),toJs:e.to.toDate()},this.tooltip=this.dashboard.formatDate(e.from)+" <br>to<br>",this.tooltip+=this.dashboard.formatDate(e.to),this.timeRaw=t,this.isAbsolute=U.a.isMoment(this.timeRaw.to)},e.prototype.zoom=function(e){this.$rootScope.appEvent("zoom-out",2)},e.prototype.move=function(e){var t,a,r=this.timeSrv.timeRange(),n=(r.to.valueOf()-r.from.valueOf())/2;-1===e?(t=r.to.valueOf()-n,a=r.from.valueOf()-n):1===e?(t=r.to.valueOf()+n,a=r.from.valueOf()+n,t>Date.now()&&r.to<Date.now()&&(t=Date.now(),a=r.from.valueOf())):(t=r.to.valueOf(),a=r.from.valueOf()),this.timeSrv.setTime({from:U.a.utc(a),to:U.a.utc(t)})},e.prototype.openDropdown=function(){this.isOpen?this.closeDropdown():(this.onRefresh(),this.editTimeRaw=this.timeRaw,this.timeOptions=Ue.c(this.panel,this.rangeString),this.refresh={value:this.dashboard.refresh,options:A.a.map(this.panel.refresh_intervals,function(e){return{text:e,value:e}})},this.refresh.options.unshift({text:"off"}),this.isOpen=!0,this.$rootScope.appEvent("timepickerOpen"))},e.prototype.closeDropdown=function(){this.isOpen=!1,this.$rootScope.appEvent("timepickerClosed")},e.prototype.applyCustom=function(){this.refresh.value!==this.dashboard.refresh&&this.timeSrv.setAutoRefresh(this.refresh.value),this.timeSrv.setTime(this.editTimeRaw),this.closeDropdown()},e.prototype.absoluteFromChanged=function(){this.editTimeRaw.from=this.getAbsoluteMomentForTimezone(this.absolute.fromJs)},e.prototype.absoluteToChanged=function(){this.editTimeRaw.to=this.getAbsoluteMomentForTimezone(this.absolute.toJs)},e.prototype.getAbsoluteMomentForTimezone=function(e){return this.dashboard.isTimezoneUtc()?U()(e).utc():U()(e)},e.prototype.setRelativeFilter=function(e){var t={from:e.from,to:e.to};this.panel.nowDelay&&"now"===t.to&&(t.to="now-"+this.panel.nowDelay),this.timeSrv.setTime(t),this.closeDropdown()},e.tooltipFormat="MMM D, YYYY HH:mm:ss",e.defaults={time_options:["5m","15m","1h","6h","12h","24h","2d","7d","30d"],refresh_intervals:["5s","10s","30s","1m","5m","15m","30m","1h","2h","1d"]},e}();D.a.module("grafana.directives").directive("gfTimePickerSettings",function(){return{restrict:"E",templateUrl:"public/app/features/dashboard/timepicker/settings.html",controller:Ls,bindToController:!0,controllerAs:"ctrl",scope:{dashboard:"="}}}),D.a.module("grafana.directives").directive("gfTimePicker",function(){return{restrict:"E",templateUrl:"public/app/features/dashboard/timepicker/timepicker.html",controller:Ls,bindToController:!0,controllerAs:"ctrl",scope:{dashboard:"="}}}),D.a.module("grafana.directives").directive("inputDatetime",function(){return{restrict:"A",require:"ngModel",link:function(e,t,a,r){var n="YYYY-MM-DD HH:mm:ss";r.$parsers.push(function(t){return-1!==t.indexOf("now")?je.isValid(t)?(r.$setValidity("error",!0),t):void r.$setValidity("error",!1):(a=e.ctrl.isUtc?U.a.utc(t,n):U()(t,n)).isValid()?(r.$setValidity("error",!0),a):void r.$setValidity("error",!1);var a}),r.$formatters.push(function(e){return U.a.isMoment(e)?e.format(n):e})}}});var Vs='\n<input type="file" id="dashupload" name="dashupload" class="hide" onchange="angular.element(this).scope().file_selected"/>\n<label class="btn btn-success" for="dashupload">\n  <i class="fa fa-upload"></i>\n  {{btnText}}\n</label>\n';function Us(e,t,a){return{restrict:"E",template:Vs,scope:{onUpload:"&",btnText:"@?"},link:function(e,a){e.btnText=D.a.isDefined(e.btnText)?e.btnText:"Upload .json File";var r=window;r.File&&r.FileReader&&r.FileList&&r.Blob?a[0].addEventListener("change",function(t){for(var a=t.target.files,r=0,n=a[r];n;){var i=new FileReader;i.onload=function(t){var a;try{a=JSON.parse(t.target.result)}catch(e){return console.log(e),void re.a.emit("alert-error",["Import failed","JSON -> JS Serialization failed: "+e.message])}e.$apply(function(){e.onUpload({dash:a})})},i.readAsText(n),n=a[r+=1]}},!1):t.set("Oops","Sorry, the HTML5 File APIs are not fully supported in this browser.","error")}}}F.a.directive("dashUpload",Us);var js=function(){function e(e){this.datasourceSrv=e}return e.prototype.makeExportable=function(e){var t=this;e.cleanUpRepeats();var a=e.getSaveModelClone();a.id=null,e.processRepeats();for(var r=[],n={},i={},s=[],o={},l=0,u=a.templating.list;l<u.length;l++){var c=u[l];o[c.name]=c}for(var h=function(e){var a=e.datasource,r=null;a&&0===a.indexOf("$")&&(r=o[a.substring(1)])&&r.current&&(a=r.current.value),s.push(t.datasourceSrv.get(a).then(function(t){if(!t.meta.builtIn&&(n["datasource"+t.meta.id]={type:"datasource",id:t.meta.id,name:t.meta.name,version:t.meta.info.version||"1.0.0"},!r)){var a="DS_"+t.name.replace(" ","_").toUpperCase();i[a]={name:a,label:t.name,description:"",type:"datasource",pluginId:t.meta.id,pluginName:t.meta.name},e.datasource="${"+a+"}"}}))},p=function(e){if(void 0!==e.datasource&&h(e),e.targets)for(var t=0,a=e.targets;t<a.length;t++){var r=a[t];void 0!==r.datasource&&h(r)}var i=ke.a.panels[e.type];i&&(n["panel"+i.id]={type:"panel",id:i.id,name:i.name,version:i.info.version})},d=0,m=a.panels;d<m.length;d++){var f=m[d];if(p(f),void 0!==f.collapsed&&!0===f.collapsed&&f.panels)for(var g=0,v=f.panels;g<v.length;g++){p(v[g])}}for(var y=0,b=a.templating.list;y<b.length;y++){"query"===(c=b[y]).type&&(h(c),c.options=[],c.current={},c.refresh=c.refresh>0?c.refresh:1)}for(var S=0,x=a.annotations.list;S<x.length;S++){var w=x[S];h(w)}return n.grafana={type:"grafana",id:"grafana",name:"Grafana",version:ke.a.buildInfo.version},Promise.all(s).then(function(){A.a.each(i,function(e,t){r.push(e)});for(var e=0,t=a.templating.list;e<t.length;e++){var s=t[e];if("constant"===s.type){var o="VAR_"+s.name.replace(" ","_").toUpperCase();r.push({name:o,type:"constant",label:s.label||s.name,value:s.current.value,description:""}),s.query="${"+o+"}",s.options[0]=s.current={value:s.query,text:s.query}}}var l={};return l.__inputs=r,l.__requires=A.a.sortBy(n,["id"]),A.a.defaults(l,a),l}).catch(function(e){return console.log("Export failed:",e),{error:e}})},e}(),Bs=function(){function e(e,t,a,r){this.dashboardSrv=e,this.$scope=a,this.$rootScope=r,this.exporter=new js(t),this.dash=this.dashboardSrv.getCurrent()}return e.$inject=["dashboardSrv","datasourceSrv","$scope","$rootScope"],e.prototype.saveDashboardAsFile=function(){var e=this;this.shareExternally?this.exporter.makeExportable(this.dash).then(function(t){e.$scope.$apply(function(){e.openSaveAsDialog(t)})}):this.openSaveAsDialog(this.dash.getSaveModelClone())},e.prototype.viewJson=function(){var e=this;this.shareExternally?this.exporter.makeExportable(this.dash).then(function(t){e.$scope.$apply(function(){e.openJsonModal(t)})}):this.openJsonModal(this.dash.getSaveModelClone())},e.prototype.openSaveAsDialog=function(e){var t=new Blob([D.a.toJson(e,!0)],{type:"application/json;charset=utf-8"});Object(ut.saveAs)(t,e.title+"-"+(new Date).getTime()+".json")},e.prototype.openJsonModal=function(e){var t=this.$rootScope.$new();t.object=e,t.enableCopy=!0,this.$rootScope.appEvent("show-modal",{src:"public/app/partials/edit_json.html",scope:t}),this.dismiss()},e}();F.a.directive("dashExportModal",function(){return{restrict:"E",templateUrl:"public/app/features/dashboard/export/export_modal.html",controller:Bs,bindToController:!0,controllerAs:"ctrl",scope:{dismiss:"&"}}});var Qs=function(){function e(){this.asRows=!0,this.dateTimeFormat="YYYY-MM-DDTHH:mm:ssZ",this.excel=!1}return e.prototype.export=function(){"table"===this.panel?Mt(this.data,this.excel):this.asRows?Ct(this.data,this.dateTimeFormat,this.excel):_t(this.data,this.dateTimeFormat,this.excel),this.dismiss()},e.prototype.dismiss=function(){re.a.emit("hide-modal")},e}();D.a.module("grafana.directives").directive("exportDataModal",function(){return{restrict:"E",templateUrl:"public/app/features/dashboard/export_data/export_data_modal.html",controller:Qs,controllerAs:"ctrl",scope:{panel:"<",data:"<"},bindToController:!0}});var Hs=function(){function e(e,t,a,r,n,i){this.uiSegmentSrv=e,this.datasourceSrv=t,this.$q=a,this.variableSrv=r,this.$rootScope=i,this.removeTagFilterSegment=e.newSegment({fake:!0,value:"-- remove filter --"}),this.buildSegmentModel(),this.$rootScope.onAppEvent("template-variable-value-updated",this.buildSegmentModel.bind(this),n)}return e.$inject=["uiSegmentSrv","datasourceSrv","$q","variableSrv","$scope","$rootScope"],e.prototype.buildSegmentModel=function(){this.segments=[],this.variable.value&&A.a.isArray(this.variable.value);for(var e=0,t=this.variable.filters;e<t.length;e++){var a=t[e];this.segments.length>0&&this.segments.push(this.uiSegmentSrv.newCondition("AND")),void 0!==a.key&&void 0!==a.value&&(this.segments.push(this.uiSegmentSrv.newKey(a.key)),this.segments.push(this.uiSegmentSrv.newOperator(a.operator)),this.segments.push(this.uiSegmentSrv.newKeyValue(a.value)))}this.segments.push(this.uiSegmentSrv.newPlusButton())},e.prototype.getOptions=function(e,t){var a=this;return"operator"===e.type?this.$q.when(this.uiSegmentSrv.newOperators(["=","!=","<",">","=~","!~"])):"condition"===e.type?this.$q.when([this.uiSegmentSrv.newSegment("AND")]):this.datasourceSrv.get(this.variable.datasource).then(function(r){var n={},i=null;return"value"!==e.type?i=r.getTagKeys?r.getTagKeys():Promise.resolve([]):(n.key=a.segments[t-2].value,i=r.getTagValues?r.getTagValues(n):Promise.resolve([])),i.then(function(t){return t=A.a.map(t,function(e){return a.uiSegmentSrv.newSegment({value:e.text})}),"key"===e.type&&t.splice(0,0,D.a.copy(a.removeTagFilterSegment)),t})})},e.prototype.segmentChanged=function(e,t){this.segments[t]=e,e.value===this.removeTagFilterSegment.value?(this.segments.splice(t,3),0===this.segments.length?this.segments.push(this.uiSegmentSrv.newPlusButton()):this.segments.length>2&&(this.segments.splice(Math.max(t-1,0),1),"plus-button"!==this.segments[this.segments.length-1].type&&this.segments.push(this.uiSegmentSrv.newPlusButton()))):("plus-button"===e.type&&(t>2&&this.segments.splice(t,0,this.uiSegmentSrv.newCondition("AND")),this.segments.push(this.uiSegmentSrv.newOperator("=")),this.segments.push(this.uiSegmentSrv.newFake("select value","value","query-segment-value")),e.type="key",e.cssClass="query-segment-key"),t+1===this.segments.length&&this.segments.push(this.uiSegmentSrv.newPlusButton())),this.updateVariableModel()},e.prototype.updateVariableModel=function(){var e=[],t=-1,a=!1;this.segments.forEach(function(r){if("value"===r.type&&r.fake)a=!0;else switch(r.type){case"key":e.push({key:r.value}),t+=1;break;case"value":e[t].value=r.value;break;case"operator":e[t].operator=r.value;break;case"condition":e[t].condition=r.value}}),a||(this.variable.setFilters(e),this.variableSrv.variableUpdated(this.variable,!0))},e}(),zs='\n<div class="gf-form-inline">\n  <div class="gf-form" ng-repeat="segment in ctrl.segments">\n    <metric-segment segment="segment" get-options="ctrl.getOptions(segment, $index)"\n                    on-change="ctrl.segmentChanged(segment, $index)"></metric-segment>\n  </div>\n</div>\n';F.a.directive("adHocFilters",function(){return{restrict:"E",template:zs,controller:Hs,bindToController:!0,controllerAs:"ctrl",scope:{variable:"="}}});var Ys='\n<div class="gf-form-select-wrapper max-width-18">\n  <select class="gf-form-input" ng-model="panel.repeat" ng-options="f.value as f.text for f in variables" ng-change="optionChanged()">\n  <option value=""></option>\n</div>\n';function Gs(e){return{restrict:"E",template:Ys,scope:{panel:"="},link:function(t,a){a.css({display:"block",width:"100%"}),t.variables=e.variables.map(function(e){return{text:e.name,value:e.name}}),0===t.variables.length&&t.variables.unshift({text:"No template variables found",value:null}),t.variables.unshift({text:"Disabled",value:null}),t.panel.repeat&&!t.panel.repeatDirection&&(t.panel.repeatDirection="h"),t.optionChanged=function(){t.panel.repeat&&(t.panel.repeatDirection="h")}}}}j.d.directive("dashRepeatOption",Gs);var Ws=a(65),Ks=a(1234),Js=a.n(Ks),Xs=a(43),Zs=a.n(Xs),eo=function(e){function t(t){var a=e.call(this,t)||this;return a.state={collapsed:a.props.panel.collapsed},a.panelContainer=a.props.getPanelContainer(),a.dashboard=a.panelContainer.getDashboard(),a.toggle=a.toggle.bind(a),a.openSettings=a.openSettings.bind(a),a.delete=a.delete.bind(a),a.update=a.update.bind(a),a}return Ve.c(t,e),t.prototype.toggle=function(){this.dashboard.toggleRow(this.props.panel),this.setState(function(e){return{collapsed:!e.collapsed}})},t.prototype.update=function(){this.dashboard.processRepeats(),this.forceUpdate()},t.prototype.openSettings=function(){re.a.emit("show-modal",{templateHtml:'<row-options row="model.row" on-updated="model.onUpdated()" dismiss="dismiss()"></row-options>',modalClass:"modal--narrow",model:{row:this.props.panel,onUpdated:this.update.bind(this)}})},t.prototype.delete=function(){var e=this;re.a.emit("confirm-modal",{title:"Delete Row",text:"Are you sure you want to remove this row and all its panels?",altActionText:"Delete row only",icon:"fa-trash",onConfirm:function(){e.props.getPanelContainer().getDashboard().removeRow(e.props.panel,!0)},onAltAction:function(){e.props.getPanelContainer().getDashboard().removeRow(e.props.panel,!1)}})},t.prototype.render=function(){var e=Zs()({"dashboard-row":!0,"dashboard-row--collapsed":this.state.collapsed}),t=Zs()({fa:!0,"fa-chevron-down":!this.state.collapsed,"fa-chevron-right":this.state.collapsed}),a=oe.replaceWithText(this.props.panel.title,this.props.panel.scopedVars),r=this.props.panel.panels?this.props.panel.panels.length:0,n=1===r?"panel":"panels";return nt.a.createElement("div",{className:e},nt.a.createElement("a",{className:"dashboard-row__title pointer",onClick:this.toggle},nt.a.createElement("i",{className:t}),a,nt.a.createElement("span",{className:"dashboard-row__panel_count"},"(",r," ",n,")")),!0===this.dashboard.meta.canEdit&&nt.a.createElement("div",{className:"dashboard-row__actions"},nt.a.createElement("a",{className:"pointer",onClick:this.openSettings},nt.a.createElement("i",{className:"fa fa-cog"})),nt.a.createElement("a",{className:"pointer",onClick:this.delete},nt.a.createElement("i",{className:"fa fa-trash"}))),!0===this.state.collapsed&&nt.a.createElement("div",{className:"dashboard-row__toggle-target",onClick:this.toggle}," "),nt.a.createElement("div",{className:"dashboard-row__drag grid-drag-handle"}))},t}(nt.a.Component),to=function(e){function t(t){var a=e.call(this,t)||this;return a.handleRef=function(e){a.container=e},a}return Ve.c(t,e),t.prototype.componentDidMount=function(){this.scrollbar=Kn()({root:this.container.parentElement,scroller:this.container,bar:".baron__bar",barOnCls:"_scrollbar",scrollingCls:"_scrolling",track:".baron__track"})},t.prototype.componentDidUpdate=function(){this.scrollbar.update()},t.prototype.componentWillUnmount=function(){this.scrollbar.dispose()},t.prototype.setScrollTop=function(e){return!!this.container&&(this.container.scrollTop=e,this.scrollbar.update(),!0)},t.prototype.setScrollLeft=function(e){return!!this.container&&(this.container.scrollLeft=e,this.scrollbar.update(),!0)},t.prototype.update=function(){this.scrollbar.update()},t.prototype.render=function(){return nt.a.createElement("div",{className:"baron baron__root baron__clipper"},nt.a.createElement("div",{className:this.props.className+" baron__scroller",ref:this.handleRef},this.props.children),nt.a.createElement("div",{className:"baron__track"},nt.a.createElement("div",{className:"baron__bar"})))},t}(nt.a.Component),ao=a(455),ro=a.n(ao),no=function(e){function t(t){var a=e.call(this,t)||this;return a.onAddPanel=function(e){var t=a.props.getPanelContainer().getDashboard(),r=a.props.panel.gridPos,n={type:e.id,title:"Panel Title",gridPos:{x:r.x,y:r.y,w:r.w,h:r.h}};"row"===e.id&&(n.title="Row title",n.gridPos={x:0,y:0}),e.defaults&&(A.a.defaults(n,e.defaults),n.gridPos.w=e.defaults.gridPos.w,n.gridPos.h=e.defaults.gridPos.h,n.title=e.defaults.title,Re.a.delete(Ne.f)),t.addPanel(n),t.removePanel(a.props.panel)},a.handleCloseAddPanel=a.handleCloseAddPanel.bind(a),a.renderPanelItem=a.renderPanelItem.bind(a),a.panelSizeChanged=a.panelSizeChanged.bind(a),a.state={panelPlugins:a.getPanelPlugins(""),copiedPanelPlugins:a.getCopiedPanelPlugins(""),filter:"",tab:"Add"},a}return Ve.c(t,e),t.prototype.componentDidMount=function(){this.props.panel.events.on("panel-size-changed",this.panelSizeChanged)},t.prototype.componentWillUnmount=function(){this.props.panel.events.off("panel-size-changed",this.panelSizeChanged)},t.prototype.panelSizeChanged=function(){var e=this;setTimeout(function(){e.scrollbar.update()})},t.prototype.getPanelPlugins=function(e){var t=A.a.chain(ke.a.panels).filter({hideFromList:!1}).map(function(e){return e}).value();return t.push({id:"row",name:"Row",sort:8,info:{logos:{small:"public/img/icn-row.svg"}}}),t=this.filterPanels(t,e),A.a.sortBy(t,"sort")},t.prototype.getCopiedPanelPlugins=function(e){var t=A.a.chain(ke.a.panels).filter({hideFromList:!1}).map(function(e){return e}).value(),a=[],r=Re.a.get(Ne.f);if(r){var n=JSON.parse(r),i=A.a.find(t,{id:n.type});if(i){var s=A.a.cloneDeep(i);s.name=n.title,s.sort=-1,s.defaults=n,a.push(s)}}return a=this.filterPanels(a,e),A.a.sortBy(a,"sort")},t.prototype.handleCloseAddPanel=function(e){e.preventDefault();var t=this.props.getPanelContainer().getDashboard();t.removePanel(t.panels[0])},t.prototype.renderText=function(e){var t=this.state.filter.split("");return nt.a.createElement(ro.a,{highlightClassName:"highlight-search-match",textToHighlight:e,searchWords:t})},t.prototype.renderPanelItem=function(e,t){var a=this;return nt.a.createElement("div",{key:t,className:"add-panel__item",onClick:function(){return a.onAddPanel(e)},title:e.name},nt.a.createElement("img",{className:"add-panel__item-img",src:e.info.logos.small}),nt.a.createElement("div",{className:"add-panel__item-name"},this.renderText(e.name)))},t.prototype.noCopiedPanelPlugins=function(){return nt.a.createElement("div",{className:"add-panel__no-panels"},"No copied panels yet.")},t.prototype.filterChange=function(e){this.setState({filter:e.target.value,panelPlugins:this.getPanelPlugins(e.target.value),copiedPanelPlugins:this.getCopiedPanelPlugins(e.target.value)})},t.prototype.filterKeyPress=function(e){if("Enter"===e.key){var t=A.a.head(this.state.panelPlugins);t&&this.onAddPanel(t)}},t.prototype.filterPanels=function(e,t){var a=new RegExp(t,"i");return e.filter(function(e){return a.test(e.name)})},t.prototype.openCopy=function(){this.setState({tab:"Copy",filter:"",panelPlugins:this.getPanelPlugins(""),copiedPanelPlugins:this.getCopiedPanelPlugins("")})},t.prototype.openAdd=function(){this.setState({tab:"Add",filter:"",panelPlugins:this.getPanelPlugins(""),copiedPanelPlugins:this.getCopiedPanelPlugins("")})},t.prototype.render=function(){var e,t=this,a=Zs()({"active active--panel":"Add"===this.state.tab,"":"Copy"===this.state.tab}),r=Zs()({"":"Add"===this.state.tab,"active active--panel":"Copy"===this.state.tab});return"Add"===this.state.tab?e=this.state.panelPlugins.map(this.renderPanelItem):"Copy"===this.state.tab&&(e=this.state.copiedPanelPlugins.length>0?this.state.copiedPanelPlugins.map(this.renderPanelItem):this.noCopiedPanelPlugins()),nt.a.createElement("div",{className:"panel-container add-panel-container"},nt.a.createElement("div",{className:"add-panel"},nt.a.createElement("div",{className:"add-panel__header"},nt.a.createElement("i",{className:"gicon gicon-add-panel"}),nt.a.createElement("span",{className:"add-panel__title"},"New Panel"),nt.a.createElement("ul",{className:"gf-tabs"},nt.a.createElement("li",{className:"gf-tabs-item"},nt.a.createElement("div",{className:"gf-tabs-link pointer "+a,onClick:this.openAdd.bind(this)},"Add")),nt.a.createElement("li",{className:"gf-tabs-item"},nt.a.createElement("div",{className:"gf-tabs-link pointer "+r,onClick:this.openCopy.bind(this)},"Paste"))),nt.a.createElement("button",{className:"add-panel__close",onClick:this.handleCloseAddPanel},nt.a.createElement("i",{className:"fa fa-close"}))),nt.a.createElement(to,{ref:function(e){return t.scrollbar=e},className:"add-panel__items"},nt.a.createElement("div",{className:"add-panel__searchbar"},nt.a.createElement("label",{className:"gf-form gf-form--grow gf-form--has-input-icon"},nt.a.createElement("input",{type:"text",autoFocus:!0,className:"gf-form-input gf-form--grow",placeholder:"Panel Search Filter",value:this.state.filter,onChange:this.filterChange.bind(this),onKeyPress:this.filterKeyPress.bind(this)}),nt.a.createElement("i",{className:"gf-form-input-icon fa fa-search"}))),e)))},t}(nt.a.Component),io=function(e){function t(t){var a=e.call(this,t)||this;return a.state={},a}return Ve.c(t,e),t.prototype.componentDidMount=function(){if(this.element){var e=this.props.getPanelContainer(),t=e.getDashboard(),a=e.getPanelLoader();this.attachedPanel=a.load(this.element,this.props.panel,t)}},t.prototype.componentWillUnmount=function(){this.attachedPanel&&this.attachedPanel.destroy()},t.prototype.render=function(){var e=this;return"row"===this.props.panel.type?nt.a.createElement(eo,{panel:this.props.panel,getPanelContainer:this.props.getPanelContainer}):"add-panel"===this.props.panel.type?nt.a.createElement(no,{panel:this.props.panel,getPanelContainer:this.props.getPanelContainer}):nt.a.createElement("div",{ref:function(t){return e.element=t},className:"panel-height-helper"})},t}(nt.a.Component),so=a(1235),oo=1200;var lo=a.n(so)()({monitorWidth:!0})(function(e){var t=e.size,a=e.layout,r=e.onLayoutChange,n=e.children,i=e.onDragStop,s=e.onResize,o=e.onResizeStop,l=e.onWidthChange,u=e.className,c=e.isResizable,h=e.isDraggable;0===t.width&&console.log("size is zero!");var p=t.width>0?t.width:oo;return p!==oo&&(l(),oo=p),nt.a.createElement(Js.a,{width:oo,className:u,isDraggable:h,isResizable:c,measureBeforeMount:!1,containerPadding:[0,0],useCSSTransforms:!0,margin:[Ne.d,Ne.d],cols:Ne.e,rowHeight:Ne.c,draggableHandle:".grid-drag-handle",layout:a,onResize:s,onResizeStop:o,onDragStop:i,onLayoutChange:r},n)}),uo=function(e){function t(t){var a=e.call(this,t)||this;return a.panelContainer=a.props.getPanelContainer(),a.onLayoutChange=a.onLayoutChange.bind(a),a.onResize=a.onResize.bind(a),a.onResizeStop=a.onResizeStop.bind(a),a.onDragStop=a.onDragStop.bind(a),a.onWidthChange=a.onWidthChange.bind(a),a.state={animated:!1},a.dashboard=a.panelContainer.getDashboard(),a.dashboard.on("panel-added",a.triggerForceUpdate.bind(a)),a.dashboard.on("panel-removed",a.triggerForceUpdate.bind(a)),a.dashboard.on("repeats-processed",a.triggerForceUpdate.bind(a)),a.dashboard.on("view-mode-changed",a.triggerForceUpdate.bind(a)),a.dashboard.on("row-collapsed",a.triggerForceUpdate.bind(a)),a.dashboard.on("row-expanded",a.triggerForceUpdate.bind(a)),a}return Ve.c(t,e),t.prototype.buildLayout=function(){var e=[];this.panelMap={};for(var t=0,a=this.dashboard.panels;t<a.length;t++){var r=a[t],n=r.id.toString();if(this.panelMap[n]=r,r.gridPos){var i={i:n,x:r.gridPos.x,y:r.gridPos.y,w:r.gridPos.w,h:r.gridPos.h};"row"===r.type&&(i.w=Ne.e,i.h=1,i.isResizable=!1,i.isDraggable=r.collapsed),e.push(i)}else console.log("panel without gridpos")}return e},t.prototype.onLayoutChange=function(e){for(var t=0,a=e;t<a.length;t++){var r=a[t];this.panelMap[r.i].updateGridPos(r)}this.dashboard.sortPanelsByGridPos()},t.prototype.triggerForceUpdate=function(){this.forceUpdate()},t.prototype.onWidthChange=function(){for(var e=0,t=this.dashboard.panels;e<t.length;e++){t[e].resizeDone()}},t.prototype.updateGridPos=function(e,t){this.panelMap[e.i].updateGridPos(e),this.onLayoutChange(t)},t.prototype.onResize=function(e,t,a){this.panelMap[a.i].updateGridPos(a)},t.prototype.onResizeStop=function(e,t,a){this.updateGridPos(a,e),this.panelMap[a.i].resizeDone()},t.prototype.onDragStop=function(e,t,a){this.updateGridPos(a,e)},t.prototype.componentDidMount=function(){var e=this;setTimeout(function(){e.setState(function(){return{animated:!0}})})},t.prototype.renderPanels=function(){for(var e=[],t=0,a=this.dashboard.panels;t<a.length;t++){var r=a[t],n=Zs()({panel:!0,"panel--fullscreen":r.fullscreen});e.push(nt.a.createElement("div",{key:r.id.toString(),className:n,id:"panel-"+r.id.toString()},nt.a.createElement(io,{panel:r,getPanelContainer:this.props.getPanelContainer})))}return e},t.prototype.render=function(){return nt.a.createElement(lo,{className:Zs()({layout:!0,animated:this.state.animated}),layout:this.buildLayout(),isResizable:this.dashboard.meta.canEdit,isDraggable:this.dashboard.meta.canEdit,onLayoutChange:this.onLayoutChange,onWidthChange:this.onWidthChange,onDragStop:this.onDragStop,onResize:this.onResize,onResizeStop:this.onResizeStop},this.renderPanels())},t}(nt.a.Component);Object(Ws.a)("dashboardGrid",uo,[["getPanelContainer",{watchDepth:"reference",wrapApply:!1}]]);var co=function(){function e(e,t){this.$compile=e,this.$rootScope=t}return e.$inject=["$compile","$rootScope"],e.prototype.load=function(e,t,a){var r=this.$rootScope.$new();r.panel=t,r.dashboard=a;var n=this.$compile('<plugin-component type="panel" class="panel-height-helper"></plugin-component>')(r);return D.a.element(e).append(n),{destroy:function(){r.$destroy(),n.remove()}}},e}();F.a.service("panelLoader",co);var ho=function(){function e(){this.source=this.row,this.row=this.row.getSaveModel()}return e.prototype.update=function(){this.source.title=this.row.title,this.source.repeat=this.row.repeat,this.onUpdated(),this.dismiss()},e}();j.d.directive("rowOptions",function(){return{restrict:"E",templateUrl:"public/app/features/dashboard/partials/row_options.html",controller:ho,bindToController:!0,controllerAs:"ctrl",scope:{row:"=",dismiss:"&",onUpdated:"&"}}});var po=function(){function e(e,t,a){this.backendSrv=e,this.validationSrv=t,this.contextSrv=a,this.rootName="General",this.isEditor=this.contextSrv.isEditor,this.labelClass||(this.labelClass="width-7"),this.loadInitialValue()}return e.$inject=["backendSrv","validationSrv","contextSrv"],e.prototype.getOptions=function(e){var t=this,a={query:e,type:"dash-folder",permission:"Edit"};return this.backendSrv.get("api/search",a).then(function(a){return!t.isEditor||""!==e&&"g"!==e.toLowerCase()&&"ge"!==e.toLowerCase()&&"gen"!==e.toLowerCase()&&"gene"!==e.toLowerCase()&&"gener"!==e.toLowerCase()&&"genera"!==e.toLowerCase()&&"general"!==e.toLowerCase()||a.unshift({title:t.rootName,id:0}),t.isEditor&&t.enableCreateNew&&""===e&&a.unshift({title:"-- New Folder --",id:-1}),t.enableReset&&""===e&&""!==t.initialTitle&&a.unshift({title:t.initialTitle,id:null}),A.a.map(a,function(e){return{text:e.title,value:e.id}})})},e.prototype.onFolderChange=function(e){if(e){if(-1===e.value)return this.createNewFolder=!0,void this.enterFolderCreation()}else e={value:0,text:this.rootName};this.onChange({$folder:{id:e.value,title:e.text}})},e.prototype.newFolderNameChanged=function(){var e=this;this.newFolderNameTouched=!0,this.validationSrv.validateNewFolderName(this.newFolderName).then(function(){e.hasValidationError=!1}).catch(function(t){e.hasValidationError=!0,e.validationError=t.message})},e.prototype.createFolder=function(e){var t=this;return e&&(e.stopPropagation(),e.preventDefault()),this.backendSrv.createFolder({title:this.newFolderName}).then(function(e){re.a.emit("alert-success",["Folder Created","OK"]),t.closeCreateFolder(),t.folder={text:e.title,value:e.id},t.onFolderChange(t.folder)})},e.prototype.cancelCreateFolder=function(e){e&&(e.stopPropagation(),e.preventDefault()),this.closeCreateFolder(),this.loadInitialValue()},e.prototype.closeCreateFolder=function(){this.exitFolderCreation(),this.createNewFolder=!1,this.hasValidationError=!1,this.validationError=null,this.newFolderName="",this.newFolderNameTouched=!1},e.prototype.loadInitialValue=function(){var e=this,t={text:this.initialTitle,value:null},a={text:this.rootName,value:0};this.getOptions("").then(function(r){var n;e.initialFolderId?n=A.a.find(r,{value:e.initialFolderId}):e.enableReset&&e.initialTitle&&null===e.initialFolderId&&(n=t),n||(n=e.isEditor?a:r.length>0?r[0]:t),e.folder=n,e.folder.value!==e.initialFolderId&&e.onChange({$folder:{id:e.folder.value,title:e.folder.text}})})},e}();F.a.directive("folderPicker",function(){return{restrict:"E",templateUrl:"public/app/features/dashboard/folder_picker/folder_picker.html",controller:po,bindToController:!0,controllerAs:"ctrl",scope:{initialTitle:"<",initialFolderId:"<",labelClass:"@",rootName:"@",onChange:"&",onCreateFolder:"&",enterFolderCreation:"&",exitFolderCreation:"&",enableCreateNew:"@",enableReset:"@"}}});var mo=function(){function e(e){this.backendSrv=e,this.isValidFolderSelection=!0}return e.$inject=["backendSrv"],e.prototype.onFolderChange=function(e){this.folder=e},e.prototype.save=function(){var e=this;return this.backendSrv.moveDashboards(this.dashboards,this.folder).then(function(t){if(t.successCount>0){var a="Dashboard"+(1===t.successCount?"":"s")+" Moved",r=t.successCount+" dashboard"+(1===t.successCount?"":"s")+" moved to "+e.folder.title;re.a.emit("alert-success",[a,r])}return t.totalCount===t.alreadyInFolderCount&&re.a.emit("alert-error",["Error","Dashboards already belongs to folder "+e.folder.title]),e.dismiss(),e.afterSave()})},e.prototype.onEnterFolderCreation=function(){this.isValidFolderSelection=!1},e.prototype.onExitFolderCreation=function(){this.isValidFolderSelection=!0},e}();F.a.directive("moveToFolderModal",function(){return{restrict:"E",templateUrl:"public/app/features/dashboard/move_to_folder_modal/move_to_folder.html",controller:mo,bindToController:!0,controllerAs:"ctrl",scope:{dismiss:"&",dashboards:"=",afterSave:"&"}}});var fo=function(){function e(e,t,a,r,n,i){var s=this;this.$scope=e,this.$route=t,this.$location=a,this.$rootScope=r,this.backendSrv=n,this.dashboardSrv=i,e.dashboard=this.dashboard,this.$scope.$on("$destroy",function(){s.dashboard.updateSubmenuVisibility(),s.$rootScope.$broadcast("refresh"),setTimeout(function(){s.$rootScope.appEvent("dash-scroll",{restore:!0})})}),this.canSaveAs=this.dashboard.meta.canEdit&&j.c.hasEditPermissionInFolders,this.canSave=this.dashboard.meta.canSave,this.canDelete=this.dashboard.meta.canSave,this.buildSectionList(),this.onRouteUpdated(),this.$rootScope.onAppEvent("$routeUpdate",this.onRouteUpdated.bind(this),e),this.$rootScope.appEvent("dash-scroll",{animate:!1,pos:0}),this.$rootScope.onAppEvent("dashboard-saved",this.onPostSave.bind(this),e)}return e.$inject=["$scope","$route","$location","$rootScope","backendSrv","dashboardSrv"],e.prototype.buildSectionList=function(){this.sections=[],this.dashboard.meta.canEdit&&(this.sections.push({title:"General",id:"settings",icon:"gicon gicon-preferences"}),this.sections.push({title:"Annotations",id:"annotations",icon:"gicon gicon-annotation"}),this.sections.push({title:"Variables",id:"templating",icon:"gicon gicon-variable"}),this.sections.push({title:"Links",id:"links",icon:"gicon gicon-link"})),this.dashboard.id&&this.dashboard.meta.canSave&&this.sections.push({title:"Versions",id:"versions",icon:"fa fa-fw fa-history"}),this.dashboard.id&&this.dashboard.meta.canAdmin&&this.sections.push({title:"Permissions",id:"permissions",icon:"fa fa-fw fa-lock"}),this.dashboard.meta.canMakeEditable&&this.sections.push({title:"General",icon:"gicon gicon-preferences",id:"make_editable"}),this.sections.push({title:"JSON Model",id:"dashboard_json",icon:"gicon gicon-json"});for(var e=this.$location.search(),t=this.$location.path(),a=0,r=this.sections;a<r.length;a++){var n=r[a],i=A.a.defaults({editview:n.id},e);n.url=ke.a.appSubUrl+t+"?"+O.a.param(i)}},e.prototype.onRouteUpdated=function(){this.viewId=this.$location.search().editview,this.viewId&&(this.json=D.a.toJson(this.dashboard.getSaveModelClone(),!0)),"settings"===this.viewId&&this.dashboard.meta.canMakeEditable&&(this.viewId="make_editable"),A.a.find(this.sections,{id:this.viewId})||(this.sections.unshift({title:"Not found",id:"404",icon:"fa fa-fw fa-warning"}),this.viewId="404")},e.prototype.openSaveAsModal=function(){this.dashboardSrv.showSaveAsModal()},e.prototype.saveDashboard=function(){this.dashboardSrv.saveDashboard()},e.prototype.saveDashboardJson=function(){var e=this;this.dashboardSrv.saveJSONDashboard(this.json).then(function(){e.$route.reload()})},e.prototype.onPostSave=function(){this.hasUnsavedFolderChange=!1},e.prototype.hideSettings=function(){var e=this,t=this.$location.search();delete t.editview,setTimeout(function(){e.$rootScope.$apply(function(){e.$location.search(t)})})},e.prototype.makeEditable=function(){this.dashboard.editable=!0,this.dashboard.meta.canMakeEditable=!1,this.dashboard.meta.canEdit=!0,this.dashboard.meta.canSave=!0,this.canDelete=!0,this.viewId="settings",this.buildSectionList();var e=A.a.find(this.sections,{id:this.viewId});this.$location.url(e.url)},e.prototype.deleteDashboard=function(){var e=this,t="",a=this.dashboard.title,r=A.a.sumBy(this.dashboard.panels,function(e){return e.alert?1:0});r>0&&(t="DELETE",a="This dashboard contains "+r+" alerts. Deleting this dashboard will also delete those alerts"),j.b.emit("confirm-modal",{title:"Delete",text:"Do you want to delete this dashboard?",text2:a,icon:"fa-trash",confirmText:t,yesText:"Delete",onConfirm:function(){e.dashboard.meta.canSave=!1,e.deleteDashboardConfirmed()}})},e.prototype.deleteDashboardConfirmed=function(){var e=this;this.backendSrv.deleteDashboard(this.dashboard.uid).then(function(){j.b.emit("alert-success",["Dashboard Deleted",e.dashboard.title+" has been deleted"]),e.$location.url("/")})},e.prototype.onFolderChange=function(e){this.dashboard.meta.folderId=e.id,this.dashboard.meta.folderTitle=e.title,this.hasUnsavedFolderChange=!0},e.prototype.getFolder=function(){return{id:this.dashboard.meta.folderId,title:this.dashboard.meta.folderTitle,url:this.dashboard.meta.folderUrl}},e}();j.d.directive("dashboardSettings",function(){return{restrict:"E",templateUrl:"public/app/features/dashboard/settings/settings.html",controller:fo,bindToController:!0,controllerAs:"ctrl",transclude:!0,scope:{dashboard:"="}}});var go=function(){function e(e,t){e.panel.links=e.panel.links||[],e.addLink=function(){e.panel.links.push({type:"dashboard"})},e.searchDashboards=function(e,a){t.search({query:e}).then(function(e){var t=A.a.map(e,function(e){return e.title});a(t)})},e.dashboardChanged=function(e){t.search({query:e.dashboard}).then(function(t){var a=A.a.find(t,{title:e.dashboard});a&&(a.url?e.url=a.url:e.dashUri=a.uri,e.title=a.title)})},e.deleteLink=function(t){e.panel.links=A.a.without(e.panel.links,t)}}return e.$inject=["$scope","backendSrv"],e}();D.a.module("grafana.directives").directive("panelLinksEditor",function(){return{scope:{panel:"="},restrict:"E",controller:"PanelLinksEditorCtrl",templateUrl:"public/app/features/dashboard/panellinks/module.html",link:function(){}}}).controller("PanelLinksEditorCtrl",go);var vo={"external link":"fa-external-link",dashboard:"fa-th-large",question:"fa-question",info:"fa-info",bolt:"fa-bolt",doc:"fa-file-text-o",cloud:"fa-cloud"},yo=function(){function e(e,t){this.iconMap=vo,this.dashboard.links=this.dashboard.links||[],this.mode="list",e.$on("$destroy",function(){t.appEvent("dash-links-updated")})}return e.$inject=["$scope","$rootScope"],e.prototype.backToList=function(){this.mode="list"},e.prototype.setupNew=function(){this.mode="new",this.link={type:"dashboards",icon:"external link"}},e.prototype.addLink=function(){this.dashboard.links.push(this.link),this.mode="list"},e.prototype.editLink=function(e){this.link=e,this.mode="edit",console.log(this.link)},e.prototype.saveLink=function(){this.backToList()},e.prototype.moveLink=function(e,t){A.a.move(this.dashboard.links,e,e+t)},e.prototype.deleteLink=function(e){this.dashboard.links.splice(e,1),this.dashboard.updateSubmenuVisibility()},e}();function bo(e,t,a){return{restrict:"E",link:function(r,n){var i=r.link,s='<div class="gf-form"><a class="pointer gf-form-label" data-placement="bottom"'+(i.asDropdown?' ng-click="fillDropdown(link)" data-toggle="dropdown"':"")+"><i></i> <span></span></a>";function o(){var e=a.getAnchorInfo(i),s=n.find("a");n.find("span").text(e.title),i.asDropdown||(s.attr("href",e.href),function(){var e=n.find("a"),a=t(e.parent().html());e.parent().html(a)}()),s.attr("data-placement","bottom"),s.tooltip({title:t(r.link.tooltip),html:!0,container:"body"})}i.asDropdown&&(s+='<ul class="dropdown-menu" role="menu"><li ng-repeat="dash in link.searchHits"><a href="{{dash.url}}" target="{{dash.target}}">{{dash.title}}</a></li></ul>'),s+="</div>",n.html(s),e(n.contents())(r),n.find("i").attr("class","fa fa-fw "+r.link.icon),n.find("a").attr("target",r.link.target),i.asDropdown&&r.$last&&n.find(".dropdown-menu").addClass("pull-right"),o(),r.$on("refresh",o)}}}D.a.module("grafana.directives").directive("dashLinksEditor",function(){return{restrict:"E",controller:yo,templateUrl:"public/app/features/dashboard/dashlinks/editor.html",bindToController:!0,controllerAs:"ctrl",scope:{dashboard:"="}}});var So=function(){function e(e,t,a,r,n,i){var s=n.getCurrent().id;function o(t){return"dashboards"===t.type?t.tags?t.asDropdown?a.when([{title:t.title,tags:t.tags,keepTime:t.keepTime,includeVars:t.includeVars,target:t.targetBlank?"_blank":"_self",icon:"fa fa-bars",asDropdown:!0}]):e.searchDashboards(t,7):(console.log("Dashboard link missing tag"),a.when([])):"link"===t.type?a.when([{url:t.url,title:t.title,icon:vo[t.icon],tooltip:t.tooltip,target:t.targetBlank?"_blank":"_self",keepTime:t.keepTime,includeVars:t.includeVars}]):a.when([])}function l(){var t=A.a.map(e.links,o);a.all(t).then(function(t){e.generatedLinks=A.a.flatten(t)})}e.searchDashboards=function(e,t){return r.search({tag:e.tags,limit:t}).then(function(t){return A.a.reduce(t,function(t,a){return a.id!==s&&t.push({title:a.title,url:a.url,target:"_self"===e.target?"":e.target,icon:"fa fa-th-large",keepTime:e.keepTime,includeVars:e.includeVars}),t},[])})},e.fillDropdown=function(t){e.searchDashboards(t,100).then(function(e){A.a.each(e,function(e){e.url=i.getLinkUrl(e)}),t.searchHits=e})},l(),t.onAppEvent("dash-links-updated",l,e)}return e.$inject=["$scope","$rootScope","$q","backendSrv","dashboardSrv","linkSrv"],e}();D.a.module("grafana.directives").directive("dashLinksContainer",function(){return{scope:{links:"="},restrict:"E",controller:"DashLinksContainerCtrl",template:'<dash-link ng-repeat="link in generatedLinks" link="link"></dash-link>',link:function(){}}}),D.a.module("grafana.directives").directive("dashLink",bo),D.a.module("grafana.directives").controller("DashLinksContainerCtrl",So);var xo=a(22),wo=a(132),To=a(91),Co=a(450),ko=a(513),_o=a(514),Eo=a(458);var Mo=function(e){for(var t=[],a=1;a<arguments.length;a++)t[a-1]=arguments[a];var r=xo.b.apply(void 0,t)(e);return function(e){return nt.a.createElement(r,Ve.a({},e,{store:_e.b}))}}(function(e){function t(t){var a=e.call(this,t)||this;return a.onOpenAddPermissions=function(){a.setState({isAdding:!0})},a.onRemoveItem=function(e){a.props.removeDashboardPermission(a.props.dashboardId,e)},a.onPermissionChanged=function(e,t){a.props.updateDashboardPermission(a.props.dashboardId,e,t)},a.onAddPermission=function(e){return a.props.addDashboardPermission(a.props.dashboardId,e)},a.onCancelAddPermission=function(){a.setState({isAdding:!1})},a.state={isAdding:!1},a}return Ve.c(t,e),t.prototype.componentDidMount=function(){this.props.getDashboardPermissions(this.props.dashboardId)},t.prototype.render=function(){var e=this.props,t=e.permissions,a=e.folder,r=this.state.isAdding;return nt.a.createElement("div",null,nt.a.createElement("div",{className:"dashboard-settings__header"},nt.a.createElement("div",{className:"page-action-bar"},nt.a.createElement("h3",{className:"d-inline-block"},"Permissions"),nt.a.createElement(wo.a,{className:"page-sub-heading-icon",placement:"auto",content:Eo.a},nt.a.createElement("i",{className:"gicon gicon-question gicon--has-hover"})),nt.a.createElement("div",{className:"page-action-bar__spacer"}),nt.a.createElement("button",{className:"btn btn-success pull-right",onClick:this.onOpenAddPermissions,disabled:r},nt.a.createElement("i",{className:"fa fa-plus"})," Add Permission"))),nt.a.createElement(To.a,{in:r},nt.a.createElement(_o.a,{onAddPermission:this.onAddPermission,onCancel:this.onCancelAddPermission})),nt.a.createElement(ko.a,{items:t,onRemoveItem:this.onRemoveItem,onPermissionChanged:this.onPermissionChanged,isFetching:!1,folderInfo:a}))},t}(rt.PureComponent),function(e){return{permissions:e.dashboard.permissions}},{getDashboardPermissions:Co.c,addDashboardPermission:Co.b,removeDashboardPermission:Co.d,updateDashboardPermission:Co.e}),Po=function(){function e(e){this.backendSrv=e}return e.prototype.load=function(e,t,a){return e.navModel={main:{icon:"fa fa-folder-open",id:"manage-folder",subTitle:"Manage folder dashboards & permissions",url:"",text:"",breadcrumbs:[{title:"Dashboards",url:"dashboards"}],children:[{active:"manage-folder-dashboards"===a,icon:"fa fa-fw fa-th-large",id:"manage-folder-dashboards",text:"Dashboards",url:"dashboards"},{active:"manage-folder-permissions"===a,icon:"fa fa-fw fa-lock",id:"manage-folder-permissions",text:"Permissions",url:"dashboards/permissions"},{active:"manage-folder-settings"===a,icon:"fa fa-fw fa-cog",id:"manage-folder-settings",text:"Settings",url:"dashboards/settings"}]}},this.backendSrv.getFolderByUid(t).then(function(t){e.folderId=t.id;var a=t.title,r=t.url;e.navModel.main.text=a;var n=e.navModel.main.children.find(function(e){return"manage-folder-dashboards"===e.id});(n.url=r,t.canAdmin)?(e.navModel.main.children.find(function(e){return"manage-folder-permissions"===e.id}).url=r+"/permissions",e.navModel.main.children.find(function(e){return"manage-folder-settings"===e.id}).url=r+"/settings"):e.navModel.main.children=[n];return t})},e}(),Do=function(){function e(e,t,a,r){(this.backendSrv=e,this.$routeParams=a,this.$routeParams.uid)&&(this.uid=a.uid,new Po(this.backendSrv).load(this,this.uid,"manage-folder-dashboards").then(function(e){var t=ms.a.stripBaseFromUrl(e.url);t!==r.path()&&r.path(t).replace()}))}return e.$inject=["backendSrv","navModelSrv","$routeParams","$location"],e}(),$o=function(){function e(e,t,a,r,n){this.backendSrv=e,this.validationSrv=t,this.$location=r,this.navModel=a.getNav("create","import"),this.step=1,this.nameExists=!1,this.uidExists=!1,this.autoGenerateUid=!0,this.autoGenerateUidValue="auto-generated",this.folderId=n.folderId?Number(n.folderId)||0:null,this.initialFolderTitle="Select a folder",n.gnetId&&(this.gnetUrl=n.gnetId,this.checkGnetDashboard())}return e.$inject=["backendSrv","validationSrv","navModelSrv","$location","$routeParams"],e.prototype.onUpload=function(e){if(this.dash=e,this.dash.id=null,this.step=2,this.inputs=[],this.dash.__inputs)for(var t=0,a=this.dash.__inputs;t<a.length;t++){var r=a[t],n={name:r.name,label:r.label,info:r.description,value:r.value,type:r.type,pluginId:r.pluginId,options:[]};"datasource"===r.type?this.setDatasourceOptions(r,n):n.info||(n.info="Specify a string constant"),this.inputs.push(n)}this.inputsValid=0===this.inputs.length,this.titleChanged(),this.uidChanged(!0)},e.prototype.setDatasourceOptions=function(e,t){var a=A.a.filter(ke.a.datasources,function(t){return t.type===e.pluginId});0===a.length?t.info="No data sources of type "+e.pluginName+" found":t.info||(t.info="Select a "+e.pluginName+" data source"),t.options=a.map(function(e){return{text:e.name,value:e.name}})},e.prototype.inputValueChanged=function(){this.inputsValid=!0;for(var e=0,t=this.inputs;e<t.length;e++){t[e].value||(this.inputsValid=!1)}},e.prototype.titleChanged=function(){var e=this;this.titleTouched=!0,this.nameExists=!1,this.validationSrv.validateNewDashboardName(this.folderId,this.dash.title).then(function(){e.nameExists=!1,e.hasNameValidationError=!1}).catch(function(t){"EXISTING"===t.type&&(e.nameExists=!0),e.hasNameValidationError=!0,e.nameValidationError=t.message})},e.prototype.uidChanged=function(e){var t=this;this.uidExists=!1,this.hasUidValidationError=!1,!0===e&&this.dash.uid&&(this.autoGenerateUidValue="value set"),this.backendSrv.getDashboardByUid(this.dash.uid).then(function(e){t.uidExists=!0,t.hasUidValidationError=!0,t.uidValidationError="Dashboard named '"+e.dashboard.title+"' in folder '"+e.meta.folderTitle+"' has the same uid"}).catch(function(e){e.isHandled=!0})},e.prototype.onFolderChange=function(e){this.folderId=e.id,this.titleChanged()},e.prototype.onEnterFolderCreation=function(){this.inputsValid=!1},e.prototype.onExitFolderCreation=function(){this.inputValueChanged()},e.prototype.isValid=function(){return this.inputsValid&&null!==this.folderId},e.prototype.saveDashboard=function(){var e=this,t=this.inputs.map(function(e){return{name:e.name,type:e.type,pluginId:e.pluginId,value:e.value}});return this.backendSrv.post("api/dashboards/import",{dashboard:this.dash,overwrite:!0,inputs:t,folderId:this.folderId}).then(function(t){var a=ms.a.stripBaseFromUrl(t.importedUrl);e.$location.url(a)})},e.prototype.loadJsonText=function(){try{this.parseError="";var e=JSON.parse(this.jsonText);this.onUpload(e)}catch(e){return console.log(e),void(this.parseError=e.message)}},e.prototype.checkGnetDashboard=function(){var e=this;this.gnetError="";var t,a=/(^\d+$)|dashboards\/(\d+)/.exec(this.gnetUrl);return a&&a[1]?t=a[1]:a&&a[2]?t=a[2]:this.gnetError="Could not find dashboard",this.backendSrv.get("api/gnet/dashboards/"+t).then(function(t){e.gnetInfo=t,t.json.gnetId=t.id,e.onUpload(t.json)}).catch(function(t){t.isHandled=!0,e.gnetError=t.data.message||t})},e.prototype.back=function(){this.gnetUrl="",this.step=1,this.gnetError="",this.gnetInfo=""},e}(),Ao=function(){function e(e,t,a,r){this.backendSrv=e,this.$location=t,this.validationSrv=a,this.title="",this.titleTouched=!1,this.navModel=r.getNav("dashboards","manage-dashboards",0)}return e.$inject=["backendSrv","$location","validationSrv","navModelSrv"],e.prototype.create=function(){var e=this;if(!this.hasValidationError)return this.backendSrv.createFolder({title:this.title}).then(function(t){re.a.emit("alert-success",["Folder Created","OK"]),e.$location.url(ms.a.stripBaseFromUrl(t.url))})},e.prototype.titleChanged=function(){var e=this;this.titleTouched=!0,this.validationSrv.validateNewFolderName(this.title).then(function(){e.hasValidationError=!1}).catch(function(t){e.hasValidationError=!0,e.validationError=t.message})},e}();Object(Ws.a)("dashboardPermissions",Mo,["dashboardId","folder"]),F.a.controller("FolderDashboardsCtrl",Do),F.a.controller("DashboardImportCtrl",$o),F.a.controller("CreateFolderCtrl",Ao);var Io=function(){function e(e,t,a){var r=this;this.$scope=e,this.backendSrv=t,this.navModel=a.getNav("dashboards","playlists",0),t.get("/api/playlists").then(function(e){r.playlists=e.map(function(e){return e.startUrl="playlists/play/"+e.id,e})})}return e.$inject=["$scope","backendSrv","navModelSrv"],e.prototype.removePlaylistConfirmed=function(e){var t=this;A.a.remove(this.playlists,{id:e.id}),this.backendSrv.delete("/api/playlists/"+e.id).then(function(){t.$scope.appEvent("alert-success",["Playlist deleted",""])},function(){t.$scope.appEvent("alert-error",["Unable to delete playlist",""]),t.playlists.push(e)})},e.prototype.removePlaylist=function(e){var t=this;this.$scope.appEvent("confirm-modal",{title:"Delete",text:"Are you sure you want to delete playlist "+e.name+"?",yesText:"Delete",icon:"fa-trash",onConfirm:function(){t.removePlaylistConfirmed(e)}})},e}();F.a.controller("PlaylistsCtrl",Io);var Oo=function(){function e(e,t){var a=this;this.backendSrv=t,this.query={query:"",tag:[],starred:!1,limit:20},e(function(){a.query.query="",a.query.type="dash-db",a.searchDashboards()},100)}return e.$inject=["$timeout","backendSrv"],e.prototype.searchDashboards=function(){this.tagsMode=!1;var e={};e.promise=this.backendSrv.search(this.query).then(function(e){return{dashboardResult:e,tagResult:[]}}),this.searchStarted(e)},e.prototype.showStarred=function(){this.query.starred=!this.query.starred,this.searchDashboards()},e.prototype.queryHasNoFilters=function(){return""===this.query.query&&!1===this.query.starred&&0===this.query.tag.length},e.prototype.filterByTag=function(e,t){this.query.tag.push(e),this.searchDashboards(),t&&(t.stopPropagation(),t.preventDefault())},e.prototype.getTags=function(){var e={};e.promise=this.backendSrv.get("/api/dashboards/tags").then(function(e){return{dashboardResult:[],tagResult:e}}),this.searchStarted(e)},e}();F.a.directive("playlistSearch",function(){return{restrict:"E",templateUrl:"public/app/features/playlist/partials/playlist_search.html",controller:Oo,bindToController:!0,controllerAs:"ctrl",scope:{searchStarted:"&"}}});var Fo=a(195),qo=function(){function e(e,t,a){this.$location=e,this.$timeout=t,this.backendSrv=a}return e.$inject=["$location","$timeout","backendSrv"],e.prototype.next=function(){var e=this;if(this.$timeout.cancel(this.cancelPromise),this.index>this.dashboards.length-1)window.location.href=this.startUrl;else{var t=this.dashboards[this.index],a=this.$location.search(),r=A.a.pickBy(a,function(e){return null!==e});this.$location.url("dashboard/"+t.uri+"?"+Object(Fo.b)(r)),this.index++,this.cancelPromise=this.$timeout(function(){return e.next()},this.interval)}},e.prototype.prev=function(){this.index=Math.max(this.index-2,0),this.next()},e.prototype.start=function(e){var t=this;this.stop(),this.startUrl=window.location.href,this.index=0,this.isPlaying=!0,this.backendSrv.get("/api/playlists/"+e).then(function(a){t.backendSrv.get("/api/playlists/"+e+"/dashboards").then(function(e){t.dashboards=e,t.interval=ie.a.interval_to_ms(a.interval),t.next()})})},e.prototype.stop=function(){this.isPlaying&&(this.$location.search().kiosk&&re.a.emit("toggle-kiosk-mode",{exit:!0}));this.index=0,this.isPlaying=!1,this.cancelPromise&&this.$timeout.cancel(this.cancelPromise)},e}();F.a.service("playlistSrv",qo);var No=function(){function e(e,t,a,r,n){var i=this;if(this.$scope=e,this.backendSrv=t,this.$location=a,this.filteredDashboards=[],this.filteredTags=[],this.searchQuery="",this.loading=!1,this.playlist={interval:"5m"},this.playlistItems=[],this.dashboardresult=[],this.tagresult=[],this.navModel=n.getNav("dashboards","playlists",0),this.isNew=!r.current.params.id,r.current.params.id){var s=r.current.params.id;t.get("/api/playlists/"+s).then(function(e){i.playlist=e}),t.get("/api/playlists/"+s+"/items").then(function(e){i.playlistItems=e})}}return e.$inject=["$scope","backendSrv","$location","$route","navModelSrv"],e.prototype.filterFoundPlaylistItems=function(){var e=this;this.filteredDashboards=A.a.reject(this.dashboardresult,function(t){return A.a.find(e.playlistItems,function(e){return parseInt(e.value,10)===t.id})}),this.filteredTags=A.a.reject(this.tagresult,function(t){return A.a.find(e.playlistItems,function(e){return e.value===t.term})})},e.prototype.addPlaylistItem=function(e){e.value=e.id.toString(),e.type="dashboard_by_id",e.order=this.playlistItems.length+1,this.playlistItems.push(e),this.filterFoundPlaylistItems()},e.prototype.addTagPlaylistItem=function(e){var t={value:e.term,type:"dashboard_by_tag",order:this.playlistItems.length+1,title:e.term};this.playlistItems.push(t),this.filterFoundPlaylistItems()},e.prototype.removePlaylistItem=function(e){A.a.remove(this.playlistItems,function(t){return e===t}),this.filterFoundPlaylistItems()},e.prototype.savePlaylist=function(e,t){var a=this;e.items=t,(e.id?this.backendSrv.put("/api/playlists/"+e.id,e):this.backendSrv.post("/api/playlists",e)).then(function(){a.$scope.appEvent("alert-success",["Playlist saved",""]),a.$location.path("/playlists")},function(){a.$scope.appEvent("alert-error",["Unable to save playlist",""])})},e.prototype.isPlaylistEmpty=function(){return!this.playlistItems.length},e.prototype.backToList=function(){this.$location.path("/playlists")},e.prototype.searchStarted=function(e){var t=this;e.then(function(e){t.dashboardresult=e.dashboardResult,t.tagresult=e.tagResult,t.filterFoundPlaylistItems()})},e.prototype.movePlaylistItem=function(e,t){var a=this.playlistItems.indexOf(e),r=a+t;r>=0&&r<this.playlistItems.length&&(this.playlistItems.splice(a,1),this.playlistItems.splice(r,0,e))},e.prototype.movePlaylistItemUp=function(e){this.movePlaylistItem(e,-1)},e.prototype.movePlaylistItemDown=function(e){this.movePlaylistItem(e,1)},e}();function Ro(e){e.when("/playlists",{templateUrl:"public/app/features/playlist/partials/playlists.html",controllerAs:"ctrl",controller:"PlaylistsCtrl"}).when("/playlists/create",{templateUrl:"public/app/features/playlist/partials/playlist.html",controllerAs:"ctrl",controller:"PlaylistEditCtrl"}).when("/playlists/edit/:id",{templateUrl:"public/app/features/playlist/partials/playlist.html",controllerAs:"ctrl",controller:"PlaylistEditCtrl"}).when("/playlists/play/:id",{template:"",resolve:{init:["playlistSrv","$route",function(e,t){var a=t.current.params.id;e.start(a)}]}})}F.a.controller("PlaylistEditCtrl",No),D.a.module("grafana.routes").config(Ro);var Lo='\n<span class="panel-title">\n  <span class="icon-gf panel-alert-icon"></span>\n  <span class="panel-title-text">{{ctrl.panel.title | interpolateTemplateVars:this}}</span>\n  <span class="panel-menu-container dropdown">\n    <span class="fa fa-caret-down panel-menu-toggle" data-toggle="dropdown"></span>\n    <ul class="dropdown-menu dropdown-menu--menu panel-menu" role="menu">\n      <li>\n        <a ng-click="ctrl.addDataQuery(datasource);">\n          <i class="fa fa-cog"></i> Edit <span class="dropdown-menu-item-shortcut">e</span>\n        </a>\n      </li>\n      <li class="dropdown-submenu">\n        <a ng-click="ctrl.addDataQuery(datasource);"><i class="fa fa-cube"></i> Actions</a>\n        <ul class="dropdown-menu panel-menu">\n          <li><a ng-click="ctrl.addDataQuery(datasource);"><i class="fa fa-flash"></i> Add Annotation</a></li>\n          <li><a ng-click="ctrl.addDataQuery(datasource);"><i class="fa fa-bullseye"></i> Toggle Legend</a></li>\n          <li><a ng-click="ctrl.addDataQuery(datasource);"><i class="fa fa-download"></i> Export to CSV</a></li>\n          <li><a ng-click="ctrl.addDataQuery(datasource);"><i class="fa fa-eye"></i> View JSON</a></li>\n        </ul>\n      </li>\n      <li><a ng-click="ctrl.addDataQuery(datasource);"><i class="fa fa-trash"></i> Remove</a></li>\n    </ul>\n  </span>\n  <span class="panel-time-info" ng-if="ctrl.timeInfo"><i class="fa fa-clock-o"></i> {{ctrl.timeInfo}}</span>\n</span>';function Vo(e,t){var a="",r="";if(e.divider)return'<li class="divider"></li>';if(e.submenu&&(r="dropdown-submenu"),a+='<li class="'+r+'"><a ',e.click&&(a+=' ng-click="'+e.click+'"'),e.href&&(a+=' href="'+e.href+'"'),a+='><i class="'+e.icon+'"></i>',a+='<span class="dropdown-item-text">'+e.text+"</span>",e.shortcut&&(a+='<span class="dropdown-menu-item-shortcut">'+e.shortcut+"</span>"),a+="</a>",e.submenu){a+='<ul class="dropdown-menu dropdown-menu--menu panel-menu">';for(var n=0,i=e.submenu;n<i.length;n++){a+=Vo(i[n],t)}a+="</ul>"}return a+="</li>"}function Uo(e){return{restrict:"E",template:Lo,link:function(t,a,r){var n,i,s,o,l=a.find(".panel-menu");function u(){var e=a.find("[data-toggle=dropdown]").parentsUntil(".panel").parent(),t=a.find("[data-toggle=dropdown]").parent();if(e=e&&e.length?e[0]:void 0){e=O()(e),O()(".react-grid-item.panel").removeClass("dropdown-menu-open");var r=!t.hasClass("open");e.toggleClass("dropdown-menu-open",r)}}a.click(function(r){var s=r.target.className;n&&n.$destroy(),n=t.$new();var o=function(e){for(var t="",a=0,r=e.getMenu();a<r.length;a++)t+=Vo(r[a],e);return t}(t.ctrl);l.html(o),e(l)(n),(s.indexOf("panel-title-text")>=0||s.indexOf("panel-title")>=0)&&function(e){i||(e.stopPropagation(),u(),a.find("[data-toggle=dropdown]").dropdown("toggle"))}(r)}),a.find(".panel-menu-toggle").click(function(){u()}),a.mousedown(function(e){s=e.pageX,o=e.pageY}),a.mouseup(function(e){i=s!==e.pageX||o!==e.pageY})}}}j.d.directive("panelHeader",Uo);var jo=D.a.module("grafana.directives");jo.directive("grafanaPanel",["$rootScope","$document","$timeout",function(e,t,a){return{restrict:"E",template:'\n  <div class="panel-container">\n    <div class="panel-header" ng-class="{\'grid-drag-handle\': !ctrl.fullscreen}">\n      <span class="panel-info-corner">\n        <i class="fa"></i>\n        <span class="panel-info-corner-inner"></span>\n      </span>\n\n      <span class="panel-loading" ng-show="ctrl.loading">\n        <i class="fa fa-spinner fa-spin"></i>\n      </span>\n\n      <panel-header class="panel-title-container" panel-ctrl="ctrl"></panel-header>\n    </div>\n\n    <div class="panel-content">\n      <ng-transclude class="panel-height-helper"></ng-transclude>\n    </div>\n  </div>\n\n  <div class="panel-full-edit" ng-if="ctrl.editMode">\n    <div class="tabbed-view tabbed-view--panel-edit">\n      <div class="tabbed-view-header">\n        <h3 class="tabbed-view-panel-title">\n          {{ctrl.pluginName}}\n        </h3>\n\n        <ul class="gf-tabs">\n          <li class="gf-tabs-item" ng-repeat="tab in ::ctrl.editorTabs">\n            <a class="gf-tabs-link" ng-click="ctrl.changeTab($index)" ng-class="{active: ctrl.editorTabIndex === $index}">\n              {{::tab.title}}\n            </a>\n          </li>\n        </ul>\n\n        <button class="tabbed-view-close-btn" ng-click="ctrl.exitFullscreen();">\n          <i class="fa fa-remove"></i>\n        </button>\n      </div>\n\n      <div class="tabbed-view-body">\n        <div ng-repeat="tab in ctrl.editorTabs" ng-if="ctrl.editorTabIndex === $index">\n          <panel-editor-tab editor-tab="tab" ctrl="ctrl" index="$index"></panel-editor-tab>\n        </div>\n      </div>\n    </div>\n  </div>\n',transclude:!0,scope:{ctrl:"="},link:function(e,t){var r,n,i,s,o=t.find(".panel-container"),l=t.find(".panel-content"),u=t.find(".panel-info-corner"),c=e.ctrl,h=!1,p=!1;function d(){l.css({height:c.height+"px"})}function m(){var e=c.getInfoMode();u[0].className="panel-info-corner panel-info-corner--"+e,e&&(r&&r.destroy(),r=new Yt.a({target:u[0],content:function(){return c.getInfoContent({mode:"tooltip"})},classes:c.error?"drop-error":"drop-help",openOn:"hover",hoverOpenDelay:100,tetherOptions:{attachment:"bottom left",targetAttachment:"top left",constraints:[{to:"window",attachment:"together",pin:!0}]}}))}c.panel.transparent&&(h=!0,o.addClass("panel-transparent",!0)),c.events.on("component-did-mount",function(){if(c.__proto__.constructor.scrollable){var e=l,t=l.find(":first").find(":first");e.addClass("baron baron__root baron__clipper panel-content--scrollable"),O()('\n            <div class="baron__track">\n              <div class="baron__bar"></div>\n            </div>\n          ').appendTo(e),t.addClass("baron__scroller"),(n=Kn()({root:e[0],scroller:t[0],bar:".baron__bar",barOnCls:"_scrollbar",scrollingCls:"_scrolling"})).scroll()}}),c.events.on("panel-size-changed",function(){c.calculatePanelHeight(),d(),a(function(){n&&n.update(),c.render()})}),c.calculatePanelHeight(),d(),c.events.on("render",function(){h!==c.panel.transparent&&(o.toggleClass("panel-transparent",!0===c.panel.transparent),h=c.panel.transparent),s=void 0!==c.panel.alert,p!==s&&(o.toggleClass("panel-has-alert",s),p=s),c.alertState?(i&&o.removeClass("panel-alert-state--"+i),"ok"!==c.alertState.state&&"alerting"!==c.alertState.state||o.addClass("panel-alert-state--"+c.alertState.state),i=c.alertState.state):i&&(o.removeClass("panel-alert-state--"+i),i=null)}),e.$watchGroup(["ctrl.error","ctrl.panel.description"],m),e.$watchCollection("ctrl.panel.links",m),u.on("click",function(){r.close(),e.$apply(c.openInspector.bind(c))}),t.on("mouseenter",function(){o.toggleClass("panel-hover-highlight",!0),c.dashboard.setPanelFocus(c.panel.id)}),t.on("mouseleave",function(){o.toggleClass("panel-hover-highlight",!1),c.dashboard.setPanelFocus(0)}),e.$on("$destroy",function(){t.off(),u.off(),r&&r.destroy(),n&&n.dispose()})}}}]),jo.directive("panelHelpCorner",["$rootScope",function(e){return{restrict:"E",template:'\n    <span class="alert-error panel-error small pointer" ng-if="ctrl.error" ng-click="ctrl.openInspector()">\n    <span data-placement="top" bs-tooltip="ctrl.error">\n    <i class="fa fa-exclamation"></i><span class="panel-error-arrow"></span>\n    </span>\n    </span>\n    ',link:function(e,t){}}}]);var Bo=function(){function e(e,t,a,r,n,i){var s;e.init=function(){n.sidemenu=!1,re.a.emit("toggle-sidemenu-hidden");var o=a.search();s=parseInt(o.panelId,10),e.onAppEvent("dashboard-initialized",e.initPanelScope),"script"===t.type||"snapshot"===t.type||t.uid?r.loadDashboard(t.type,t.slug,t.uid).then(function(t){t.meta.soloMode=!0,e.initDashboard(t,e)}):i.getDashboardBySlug(t.slug).then(function(e){if(e){var t=ms.a.stripBaseFromUrl(e.meta.url.replace("/d/","/d-solo/"));a.path(t).replace()}})},e.initPanelScope=function(){var t=e.dashboard.getPanelInfoById(s);e.ctrl={dashboard:e.dashboard},e.panel=t.panel,e.panel.soloMode=!0,e.$index=0,e.panel||e.appEvent("alert-error",["Panel not found",""])},e.init()}return e.$inject=["$scope","$routeParams","$location","dashboardLoaderSrv","contextSrv","backendSrv"],e}();function Qo(e){return e.create({scope:{ctrl:"=",editorTab:"=",index:"="},directive:function(e){var t=e.ctrl.pluginId,a=e.index;return Promise.resolve({name:"panel-editor-tab-"+t+a,fn:function(){return e.editorTab.directiveFn()}})}})}D.a.module("grafana.routes").controller("SoloPanelCtrl",Bo),D.a.module("grafana.directives").directive("panelEditorTab",Qo);var Ho=D.a.module("grafana.directives"),zo=function(){function e(){this.panelCtrl=this.queryCtrl.panelCtrl,this.target=this.queryCtrl.target,this.panel=this.panelCtrl.panel,this.target.refId||(this.target.refId=this.panelCtrl.dashboard.getNextQueryLetter(this.panel)),this.toggleCollapse(!0),this.target.isNew&&(delete this.target.isNew,this.toggleCollapse(!1)),this.panel.targets.length<4&&(this.collapsed=!1)}return e.prototype.toggleHideQuery=function(){this.target.hide=!this.target.hide,this.panelCtrl.refresh()},e.prototype.toggleCollapse=function(e){if(this.canCollapse){this.panelCtrl.__collapsedQueryCache||(this.panelCtrl.__collapsedQueryCache={}),e?this.collapsed=!1!==this.panelCtrl.__collapsedQueryCache[this.target.refId]:(this.collapsed=!this.collapsed,this.panelCtrl.__collapsedQueryCache[this.target.refId]=this.collapsed);try{this.collapsedText=this.queryCtrl.getCollapsedText()}catch(e){var t=e.message||e.toString();this.collapsedText="Error: "+t}}},e.prototype.toggleEditorMode=function(){this.canCollapse&&this.collapsed&&(this.collapsed=!1),this.queryCtrl.toggleEditorMode()},e.prototype.removeQuery=function(){this.panelCtrl.__collapsedQueryCache&&delete this.panelCtrl.__collapsedQueryCache[this.target.refId],this.panelCtrl.removeQuery(this.target)},e.prototype.duplicateQuery=function(){var e=D.a.copy(this.target);this.panelCtrl.addQuery(e)},e.prototype.moveQuery=function(e){this.panelCtrl.moveQuery(this.target,e)},e}();Ho.directive("queryEditorRow",function(){return{restrict:"E",controller:zo,bindToController:!0,controllerAs:"ctrl",templateUrl:"public/app/features/panel/partials/query_editor_row.html",transclude:!0,scope:{queryCtrl:"=",canCollapse:"=",hasTextEditMode:"="}}});var Yo='\n<div class="query-troubleshooter" ng-if="ctrl.isOpen">\n  <div class="query-troubleshooter__header">\n    <a class="pointer" ng-click="ctrl.toggleMocking()">Mock Response</a>\n    <a class="pointer" ng-click="ctrl.toggleExpand()" ng-hide="ctrl.allNodesExpanded">\n      <i class="fa fa-plus-square-o"></i> Expand All\n    </a>\n    <a class="pointer" ng-click="ctrl.toggleExpand()" ng-show="ctrl.allNodesExpanded">\n      <i class="fa fa-minus-square-o"></i> Collapse All\n    </a>\n    <a class="pointer" clipboard-button="ctrl.getClipboardText()"><i class="fa fa-clipboard"></i> Copy to Clipboard</a>\n  </div>\n  <div class="query-troubleshooter__body" ng-hide="ctrl.isMocking">\n    <i class="fa fa-spinner fa-spin" ng-show="ctrl.isLoading"></i>\n    <div class="query-troubleshooter-json"></div>\n  </div>\n  <div class="query-troubleshooter__body" ng-show="ctrl.isMocking">\n    <div class="gf-form p-l-1 gf-form--v-stretch">\n\t\t\t<textarea class="gf-form-input" style="width: 95%" rows="10" ng-model="ctrl.mockedResponse"  placeholder="JSON"></textarea>\n    </div>\n  </div>\n</div>\n',Go=function(){function e(e,t){this.$timeout=t,this.onRequestErrorEventListener=this.onRequestError.bind(this),this.onRequestResponseEventListener=this.onRequestResponse.bind(this),re.a.on("ds-request-response",this.onRequestResponseEventListener),re.a.on("ds-request-error",this.onRequestErrorEventListener),e.$on("$destroy",this.removeEventsListeners.bind(this)),e.$watch("ctrl.isOpen",this.stateChanged.bind(this))}return e.$inject=["$scope","$timeout"],e.prototype.removeEventsListeners=function(){re.a.off("ds-request-response",this.onRequestResponseEventListener),re.a.off("ds-request-error",this.onRequestErrorEventListener)},e.prototype.toggleMocking=function(){this.isMocking=!this.isMocking},e.prototype.onRequestError=function(e){this.isOpen&&(this.isOpen=!0,this.hasError=!0,this.onRequestResponse(e))},e.prototype.stateChanged=function(){this.isOpen&&(this.panelCtrl.refresh(),this.isLoading=!0)},e.prototype.getClipboardText=function(){return this.jsonExplorer?JSON.stringify(this.jsonExplorer.json,null,2):""},e.prototype.handleMocking=function(e){var t;try{t=JSON.parse(this.mockedResponse)}catch(e){return void re.a.emit("alert-error",["Failed to parse mocked response"])}e.data=t},e.prototype.onRequestResponse=function(e){this.isOpen&&(this.isMocking?this.handleMocking(e):(this.isLoading=!1,(e=A.a.cloneDeep(e)).headers&&delete e.headers,e.config&&(e.request=e.config,delete e.config,delete e.request.transformRequest,delete e.request.transformResponse,delete e.request.paramSerializer,delete e.request.jsonpCallbackParam,delete e.request.headers,delete e.request.requestId,delete e.request.inspect,delete e.request.retry,delete e.request.timeout),e.data&&(e.response=e.data,200===e.status&&this.hasError&&(this.hasError=!1,this.isOpen=!1),delete e.data,delete e.status,delete e.statusText,delete e.$$config),this.$timeout(A.a.partial(this.renderJsonExplorer,e))))},e.prototype.toggleExpand=function(e){this.jsonExplorer&&(this.allNodesExpanded=!this.allNodesExpanded,this.jsonExplorer.openAtDepth(this.allNodesExpanded?20:1))},e}();j.d.directive("queryTroubleshooter",function(){return{restrict:"E",template:Yo,controller:Go,bindToController:!0,controllerAs:"ctrl",scope:{panelCtrl:"=",isOpen:"="},link:function(e,t,a,r){r.renderJsonExplorer=function(e){var a=t.find(".query-troubleshooter-json");r.jsonExplorer=new j.a(e,3,{animateOpen:!0});var n=r.jsonExplorer.render(!0);a.html(n)}}}});var Wo=function(){function e(e,t,a,r){this.$scope=e,this.backendSrv=t,this.navModel=a.getNav("cfg","users",0),this.get(),this.externalUserMngLinkUrl=ke.a.externalUserMngLinkUrl,this.externalUserMngLinkName=ke.a.externalUserMngLinkName,this.canInvite=!ke.a.disableLoginForm&&!ke.a.externalUserMngLinkName,ke.a.externalUserMngInfo&&(this.externalUserMngInfo=new Se.a({linkTarget:"__blank"}).render(ke.a.externalUserMngInfo))}return e.$inject=["$scope","backendSrv","navModelSrv","$sce"],e.prototype.get=function(){var e=this;this.backendSrv.get("/api/org/users").then(function(t){e.users=t,e.unfiltered=t}),this.backendSrv.get("/api/org/invites").then(function(t){e.pendingInvites=t})},e.prototype.onQueryUpdated=function(){var e=new RegExp(this.searchQuery,"ig");this.users=A.a.filter(this.unfiltered,function(t){return e.test(t.email)||e.test(t.login)})},e.prototype.updateOrgUser=function(e){this.backendSrv.patch("/api/org/users/"+e.userId,e)},e.prototype.removeUser=function(e){var t=this;this.$scope.appEvent("confirm-modal",{title:"Delete",text:"Are you sure you want to delete user "+e.login+"?",yesText:"Delete",icon:"fa-warning",onConfirm:function(){t.removeUserConfirmed(e)}})},e.prototype.removeUserConfirmed=function(e){this.backendSrv.delete("/api/org/users/"+e.userId).then(this.get.bind(this))},e.prototype.revokeInvite=function(e,t){t.stopPropagation(),this.backendSrv.patch("/api/org/invites/"+e.code+"/revoke").then(this.get.bind(this))},e.prototype.copyInviteToClipboard=function(e){e.stopPropagation()},e.prototype.getInviteUrl=function(e){return e.url},e}();F.a.controller("OrgUsersCtrl",Wo);var Ko=function(){function e(e,t,a,r){this.backendSrv=e,this.contextSrv=t,this.$location=a,this.teams=[],this.orgs=[],this.showTeamsList=!1,this.showOrgsList=!1,this.readonlyLoginFields=ke.a.disableLoginForm,this.getUser(),this.getUserTeams(),this.getUserOrgs(),this.navModel=r.getNav("profile","profile-settings",0)}return e.$inject=["backendSrv","contextSrv","$location","navModelSrv"],e.prototype.getUser=function(){var e=this;this.backendSrv.get("/api/user").then(function(t){e.user=t,e.user.theme=t.theme||"dark"})},e.prototype.getUserTeams=function(){var e=this;this.backendSrv.get("/api/user/teams").then(function(t){e.teams=t,e.showTeamsList=e.teams.length>0})},e.prototype.getUserOrgs=function(){var e=this;this.backendSrv.get("/api/user/orgs").then(function(t){e.orgs=t,e.showOrgsList=t.length>1})},e.prototype.setUsingOrg=function(e){this.backendSrv.post("/api/user/using/"+e.orgId).then(function(){window.location.href=ke.a.appSubUrl+"/profile"})},e.prototype.update=function(){var e=this;this.userForm.$valid&&this.backendSrv.put("/api/user/",this.user).then(function(){e.contextSrv.user.name=e.user.name||e.user.login,e.oldTheme!==e.user.theme&&(window.location.href=ke.a.appSubUrl+e.$location.path())})},e}();j.d.controller("ProfileCtrl",Ko);var Jo=function(){function e(e,t,a){a.sidemenu=!1,e.navModel={main:{icon:"gicon gicon-branding",subTitle:"Preferences",text:"Select active organization"}},e.init=function(){e.getUserOrgs()},e.getUserOrgs=function(){t.get("/api/user/orgs").then(function(t){e.orgs=t})},e.setUsingOrg=function(e){t.post("/api/user/using/"+e.orgId).then(function(){window.location.href=ke.a.appSubUrl+"/"})},e.init()}return e.$inject=["$scope","backendSrv","contextSrv"],e}();D.a.module("grafana.controllers").controller("SelectOrgCtrl",Jo);var Xo=function(){function e(e,t,a,r){e.command={},e.authProxyEnabled=ke.a.authProxyEnabled,e.ldapEnabled=ke.a.ldapEnabled,e.navModel=r.getNav("profile","change-password",0),e.changePassword=function(){e.userForm.$valid&&(e.command.newPassword===e.command.confirmNew?t.put("/api/user/password",e.command).then(function(){a.path("profile")}):e.appEvent("alert-warning",["New passwords do not match",""]))}}return e.$inject=["$scope","backendSrv","$location","navModelSrv"],e}();D.a.module("grafana.controllers").controller("ChangePasswordCtrl",Xo);var Zo=function(){function e(e,t,a,r){e.navModel=r.getNav("cfg","admin","global-orgs",1),e.newOrg={name:""},e.createOrg=function(){a.post("/api/orgs/",e.newOrg).then(function(e){a.post("/api/user/using/"+e.orgId).then(function(){window.location.href=ke.a.appSubUrl+"/org"})})}}return e.$inject=["$scope","$http","backendSrv","navModelSrv"],e}();D.a.module("grafana.controllers").controller("NewOrgCtrl",Zo);var el=function(){function e(e,t,a){this.backendSrv=e,this.$location=a,this.navModel=t.getNav("cfg","users",0),this.invite={name:"",email:"",role:"Editor",sendEmail:!0}}return e.$inject=["backendSrv","navModelSrv","$location"],e.prototype.sendInvite=function(){var e=this;if(this.inviteForm.$valid)return this.backendSrv.post("/api/org/invites",this.invite).then(function(){e.$location.path("org/users/")})},e}();F.a.controller("UserInviteCtrl",el);var tl=function(){function e(e,t,a){this.backendSrv=e,this.$location=t,this.navModel=a.getNav("cfg","teams",0)}return e.$inject=["backendSrv","$location","navModelSrv"],e.prototype.create=function(){var e=this,t={name:this.name,email:this.email};this.backendSrv.post("/api/teams",t).then(function(t){t.teamId&&e.$location.path("/org/teams/edit/"+t.teamId)})},e}();F.a.controller("CreateTeamCtrl",tl);var al=function(){function e(e,t,a,r,n){e.init=function(){e.getOrgInfo(),e.navModel=n.getNav("cfg","org-settings",0)},e.getOrgInfo=function(){a.get("/api/org").then(function(t){e.org=t,e.address=t.address,r.user.orgName=t.name})},e.update=function(){if(e.orgForm.$valid){var t={name:e.org.name};a.put("/api/org",t).then(e.getOrgInfo)}},e.updateAddress=function(){e.addressForm.$valid&&a.put("/api/org/address",e.address).then(e.getOrgInfo)},e.init()}return e.$inject=["$scope","$http","backendSrv","contextSrv","navModelSrv"],e}();D.a.module("grafana.controllers").controller("OrgDetailsCtrl",al);var rl=function(){function e(e,t){this.backendSrv=e,this.$location=t,this.timezones=[{value:"",text:"Default"},{value:"browser",text:"Local browser time"},{value:"utc",text:"UTC"}],this.themes=[{value:"",text:"Default"},{value:"dark",text:"Dark"},{value:"light",text:"Light"}]}return e.$inject=["backendSrv","$location"],e.prototype.$onInit=function(){var e=this;return this.backendSrv.get("/api/"+this.mode+"/preferences").then(function(t){e.prefs=t,e.oldTheme=t.theme})},e.prototype.updatePrefs=function(){var e=this;if(this.prefsForm.$valid){var t={theme:this.prefs.theme,timezone:this.prefs.timezone,homeDashboardId:this.prefs.homeDashboardId};this.backendSrv.put("/api/"+this.mode+"/preferences",t).then(function(){window.location.href=ke.a.appSubUrl+e.$location.path()})}},e}(),nl='\n<form name="ctrl.prefsForm" class="section gf-form-group">\n  <h3 class="page-heading">Preferences</h3>\n\n  <div class="gf-form">\n    <span class="gf-form-label width-11">UI Theme</span>\n    <div class="gf-form-select-wrapper max-width-20">\n      <select class="gf-form-input" ng-model="ctrl.prefs.theme" ng-options="f.value as f.text for f in ctrl.themes"></select>\n    </div>\n  </div>\n\n  <div class="gf-form">\n    <span class="gf-form-label width-11">\n      Home Dashboard\n      <info-popover mode="right-normal">\n        Not finding dashboard you want? Star it first, then it should appear in this select box.\n      </info-popover>\n    </span>\n    <dashboard-selector class="gf-form-select-wrapper max-width-20" model="ctrl.prefs.homeDashboardId">\n    </dashboard-selector>\n  </div>\n\n  <div class="gf-form">\n    <label class="gf-form-label width-11">Timezone</label>\n    <div class="gf-form-select-wrapper max-width-20">\n      <select class="gf-form-input" ng-model="ctrl.prefs.timezone" ng-options="f.value as f.text for f in ctrl.timezones"></select>\n    </div>\n  </div>\n\n  <div class="gf-form-button-row">\n    <button type="submit" class="btn btn-success" ng-click="ctrl.updatePrefs()">Save</button>\n  </div>\n</form>\n';F.a.directive("prefsControl",function(){return{restrict:"E",controller:rl,bindToController:!0,controllerAs:"ctrl",template:nl,scope:{mode:"@"}}});var il=function(){function e(e,t,a){this.$scope=e,this.backendSrv=t,this.pages=[],this.perPage=50,this.page=1,this.showPaging=!1,this.navModel=a.getNav("cfg","admin","global-users",1),this.query="",this.getUsers()}return e.$inject=["$scope","backendSrv","navModelSrv"],e.prototype.getUsers=function(){var e=this;this.backendSrv.get("/api/users/search?perpage="+this.perPage+"&page="+this.page+"&query="+this.query).then(function(t){e.users=t.users,e.page=t.page,e.perPage=t.perPage,e.totalPages=Math.ceil(t.totalCount/t.perPage),e.showPaging=e.totalPages>1,e.pages=[];for(var a=1;a<e.totalPages+1;a++)e.pages.push({page:a,current:a===e.page})})},e.prototype.navigateToPage=function(e){this.page=e.page,this.getUsers()},e.prototype.deleteUser=function(e){var t=this;this.$scope.appEvent("confirm-modal",{title:"Delete",text:"Do you want to delete "+e.login+"?",icon:"fa-trash",yesText:"Delete",onConfirm:function(){t.backendSrv.delete("/api/admin/users/"+e.id).then(function(){t.getUsers()})}})},e}(),sl=function(){function e(e,t,a,r,n){e.user={},e.newOrg={name:"",role:"Editor"},e.permissions={},e.navModel=n.getNav("cfg","admin","global-users",1),e.init=function(){t.id&&(e.getUser(t.id),e.getUserOrgs(t.id))},e.getUser=function(t){a.get("/api/users/"+t).then(function(a){e.user=a,e.user_id=t,e.permissions.isGrafanaAdmin=a.isGrafanaAdmin})},e.setPassword=function(){if(e.passwordForm.$valid){var t={password:e.password};a.put("/api/admin/users/"+e.user_id+"/password",t).then(function(){r.path("/admin/users")})}},e.updatePermissions=function(){var t=e.permissions;a.put("/api/admin/users/"+e.user_id+"/permissions",t).then(function(){r.path("/admin/users")})},e.create=function(){e.userForm.$valid&&a.post("/api/admin/users",e.user).then(function(){r.path("/admin/users")})},e.getUserOrgs=function(t){a.get("/api/users/"+t+"/orgs").then(function(t){e.orgs=t})},e.update=function(){e.userForm.$valid&&a.put("/api/users/"+e.user_id,e.user).then(function(){r.path("/admin/users")})},e.updateOrgUser=function(t){a.patch("/api/orgs/"+t.orgId+"/users/"+e.user_id,t).then(function(){})},e.removeOrgUser=function(t){a.delete("/api/orgs/"+t.orgId+"/users/"+e.user_id).then(function(){e.getUser(e.user_id),e.getUserOrgs(e.user_id)})},e.orgsSearchCache=[],e.searchOrgs=function(t,r){e.orgsSearchCache.length>0?r(A.a.map(e.orgsSearchCache,"name")):a.get("/api/orgs",{query:""}).then(function(t){e.orgsSearchCache=t,r(A.a.map(t,"name"))})},e.addOrgUser=function(){if(e.addOrgForm.$valid){var t=A.a.find(e.orgsSearchCache,{name:e.newOrg.name});t&&(e.newOrg.loginOrEmail=e.user.login,a.post("/api/orgs/"+t.id+"/users/",e.newOrg).then(function(){e.getUser(e.user_id),e.getUserOrgs(e.user_id)}))}},e.init()}return e.$inject=["$scope","$routeParams","backendSrv","$location","navModelSrv"],e}(),ol=function(){function e(e,t,a){e.init=function(){e.navModel=a.getNav("cfg","admin","global-orgs",1),e.getOrgs()},e.getOrgs=function(){t.get("/api/orgs").then(function(t){e.orgs=t})},e.deleteOrg=function(a){e.appEvent("confirm-modal",{title:"Delete",text:"Do you want to delete organization "+a.name+"?",text2:"All dashboards for this organization will be removed!",icon:"fa-trash",yesText:"Delete",onConfirm:function(){t.delete("/api/orgs/"+a.id).then(function(){e.getOrgs()})}})},e.init()}return e.$inject=["$scope","backendSrv","navModelSrv"],e}(),ll=function(){function e(e,t,a,r,n){e.init=function(){e.navModel=n.getNav("cfg","admin","global-orgs",1),t.id&&(e.getOrg(t.id),e.getOrgUsers(t.id))},e.getOrg=function(t){a.get("/api/orgs/"+t).then(function(t){e.org=t})},e.getOrgUsers=function(t){a.get("/api/orgs/"+t+"/users").then(function(t){e.orgUsers=t})},e.update=function(){e.orgDetailsForm.$valid&&a.put("/api/orgs/"+e.org.id,e.org).then(function(){r.path("/admin/orgs")})},e.updateOrgUser=function(e){a.patch("/api/orgs/"+e.orgId+"/users/"+e.userId,e)},e.removeOrgUser=function(t){a.delete("/api/orgs/"+t.orgId+"/users/"+t.userId).then(function(){e.getOrgUsers(e.org.id)})},e.init()}return e.$inject=["$scope","$routeParams","backendSrv","$location","navModelSrv"],e}(),ul=function(){function e(e,t,a){this.$routeParams=e,this.backendSrv=t,this.buttonNames=["primary","secondary","inverse","success","warning","danger"],this.buttonSizes=["btn-small","","btn-large"],this.buttonVariants=["-"],this.navModel=a.getNav("cfg","admin","styleguide",1),this.theme=ke.a.bootData.user.lightTheme?"light":"dark"}return e.$inject=["$routeParams","backendSrv","navModelSrv"],e.prototype.switchTheme=function(){this.$routeParams.theme="dark"===this.theme?"light":"dark";var e={theme:this.$routeParams.theme};this.backendSrv.put("/api/user/preferences",e).then(function(){window.location.href=window.location.href})},e}(),cl=function(){function e(e,t,a){this.navModel=a.getNav("cfg","admin","server-settings",1),t.get("/api/admin/settings").then(function(t){e.settings=t})}return e.$inject=["$scope","backendSrv","navModelSrv"],e}(),hl=function(){function e(e){this.navModel=e.getNav("cfg","admin",1)}return e.$inject=["navModelSrv"],e}();F.a.controller("AdminListUsersCtrl",il),F.a.controller("AdminEditUserCtrl",sl),F.a.controller("AdminListOrgsCtrl",ol),F.a.controller("AdminEditOrgCtrl",ll),F.a.controller("AdminSettingsCtrl",cl),F.a.controller("AdminHomeCtrl",hl),F.a.controller("StyleGuideCtrl",ul);var pl=function(){function e(e,t,a,r,n){var i=this;this.$routeParams=e,this.backendSrv=t,this.$location=a,this.$templateCache=r,this.testSeverity="critical",this.defaults={type:"email",sendReminder:!1,frequency:"15m",settings:{httpMethod:"POST",autoResolve:!0,uploadImage:!0},isDefault:!1},this.navModel=n.getNav("alerting","channels",0),this.isNew=!this.$routeParams.id,this.getFrequencySuggestion=function(){return["1m","5m","10m","15m","30m","1h"]},this.backendSrv.get("/api/alert-notifiers").then(function(e){i.notifiers=e;for(var t=0,a=i.notifiers;t<a.length;t++){var r=a[t];i.$templateCache.put(i.getNotifierTemplateId(r.type),r.optionsTemplate)}return i.$routeParams.id?i.backendSrv.get("/api/alert-notifications/"+i.$routeParams.id).then(function(e){return i.navModel.breadcrumbs.push({text:e.name}),i.navModel.node={text:e.name},e.settings=A.a.defaults(e.settings,i.defaults.settings),e}):(i.navModel.breadcrumbs.push({text:"New channel"}),i.navModel.node={text:"New channel"},A.a.defaults(i.model,i.defaults))}).then(function(e){i.model=e,i.notifierTemplateId=i.getNotifierTemplateId(i.model.type)})}return e.$inject=["$routeParams","backendSrv","$location","$templateCache","navModelSrv"],e.prototype.save=function(){var e=this;this.theForm.$valid&&(this.model.id?this.backendSrv.put("/api/alert-notifications/"+this.model.id,this.model).then(function(t){e.model=t,j.b.emit("alert-success",["Notification updated",""])}).catch(function(e){e.data&&e.data.error&&j.b.emit("alert-error",[e.data.error])}):this.backendSrv.post("/api/alert-notifications",this.model).then(function(t){j.b.emit("alert-success",["Notification created",""]),e.$location.path("alerting/notifications")}).catch(function(e){e.data&&e.data.error&&j.b.emit("alert-error",[e.data.error])}))},e.prototype.getNotifierTemplateId=function(e){return"notifier-options-"+e},e.prototype.typeChanged=function(){this.model.settings=A.a.defaults({},this.defaults.settings),this.notifierTemplateId=this.getNotifierTemplateId(this.model.type)},e.prototype.testNotification=function(){if(this.theForm.$valid){var e={name:this.model.name,type:this.model.type,frequency:this.model.frequency,settings:this.model.settings};this.backendSrv.post("/api/alert-notifications/test",e).then(function(e){j.b.emit("alert-success",["Test notification sent",""])})}},e}();j.d.controller("AlertNotificationEditCtrl",pl);var dl=function(){function e(e,t){this.backendSrv=e,this.loadNotifications(),this.navModel=t.getNav("alerting","channels",0)}return e.$inject=["backendSrv","navModelSrv"],e.prototype.loadNotifications=function(){var e=this;this.backendSrv.get("/api/alert-notifications").then(function(t){e.notifications=t})},e.prototype.deleteNotification=function(e){var t=this;this.backendSrv.delete("/api/alert-notifications/"+e).then(function(){t.notifications=t.notifications.filter(function(t){return t.id!==e})})},e}();j.d.controller("AlertNotificationsListCtrl",dl);var ml=function(){function e(e){this.navModel=e.getNav("dashboards","manage-dashboards",0)}return e.$inject=["navModelSrv"],e}(),fl=function(){function e(e,t,a){var r=this;this.$rootScope=e,this.backendSrv=t,this.navModel=a.getNav("dashboards","snapshots",0),this.backendSrv.get("/api/dashboard/snapshots").then(function(e){r.snapshots=e})}return e.$inject=["$rootScope","backendSrv","navModelSrv"],e.prototype.removeSnapshotConfirmed=function(e){var t=this;A.a.remove(this.snapshots,{key:e.key}),this.backendSrv.delete("/api/snapshots/"+e.key).then(function(){},function(){t.snapshots.push(e)})},e.prototype.removeSnapshot=function(e){var t=this;this.$rootScope.appEvent("confirm-modal",{title:"Delete",text:"Are you sure you want to delete snapshot "+e.name+"?",yesText:"Delete",icon:"fa-trash",onConfirm:function(){t.removeSnapshotConfirmed(e)}})},e}();F.a.controller("DashboardListCtrl",ml),F.a.controller("SnapshotListCtrl",fl)}}]);
//# sourceMappingURL=5.3fac4c3e925a0fddc893.js.map