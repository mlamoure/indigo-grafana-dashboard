(window.webpackJsonp=window.webpackJsonp||[]).push([[27],{Z209:function(e,t,a){"use strict";a.r(t);var n,r=a("Obii"),s=a("mrSG"),i=a("q1tI"),o=a.n(i),c=a("kDLi"),l=a("WnbS"),u=function(e){function t(a){var n=e.call(this,a)||this;n.updateDatasource=function(e){return Object(s.__awaiter)(n,void 0,void 0,function(){var t,a;return Object(s.__generator)(this,function(n){for(t in e.jsonData)0===e.jsonData[t].length&&delete e.jsonData[t];for(a in e.secureJsonData)0===e.secureJsonData[a].length&&delete e.secureJsonData[a];return this.props.onOptionsChange(Object(s.__assign)({},e)),[2]})})},n.onAuthProviderChange=function(e){n.updateDatasource(Object(s.__assign)(Object(s.__assign)({},n.state.config),{jsonData:Object(s.__assign)(Object(s.__assign)({},n.state.config.jsonData),{authType:e.value})}))},n.onRegionChange=function(e){n.updateDatasource(Object(s.__assign)(Object(s.__assign)({},n.state.config),{jsonData:Object(s.__assign)(Object(s.__assign)({},n.state.config.jsonData),{defaultRegion:e.value})}))},n.onResetAccessKey=function(){n.updateDatasource(Object(s.__assign)(Object(s.__assign)({},n.state.config),{secureJsonFields:Object(s.__assign)(Object(s.__assign)({},n.state.config.secureJsonFields),{accessKey:!1})}))},n.onAccessKeyChange=function(e){n.updateDatasource(Object(s.__assign)(Object(s.__assign)({},n.state.config),{secureJsonData:Object(s.__assign)(Object(s.__assign)({},n.state.config.secureJsonData),{accessKey:e})}))},n.onResetSecretKey=function(){n.updateDatasource(Object(s.__assign)(Object(s.__assign)({},n.state.config),{secureJsonFields:Object(s.__assign)(Object(s.__assign)({},n.state.config.secureJsonFields),{secretKey:!1})}))},n.onSecretKeyChange=function(e){n.updateDatasource(Object(s.__assign)(Object(s.__assign)({},n.state.config),{secureJsonData:Object(s.__assign)(Object(s.__assign)({},n.state.config.secureJsonData),{secretKey:e})}))},n.onCredentialProfileNameChange=function(e){n.updateDatasource(Object(s.__assign)(Object(s.__assign)({},n.state.config),{database:e}))},n.onArnAssumeRoleChange=function(e){n.updateDatasource(Object(s.__assign)(Object(s.__assign)({},n.state.config),{jsonData:Object(s.__assign)(Object(s.__assign)({},n.state.config.jsonData),{assumeRoleArn:e})}))},n.onCustomMetricsNamespacesChange=function(e){n.updateDatasource(Object(s.__assign)(Object(s.__assign)({},n.state.config),{jsonData:Object(s.__assign)(Object(s.__assign)({},n.state.config.jsonData),{customMetricsNamespaces:e})}))};var r=n.props.options;return n.state={config:t.defaults(r),authProviderOptions:[{label:"Access & secret key",value:"keys"},{label:"Credentials file",value:"credentials"},{label:"ARN",value:"arn"}],regions:[]},n.updateDatasource(n.state.config),n}return Object(s.__extends)(t,e),t.getDerivedStateFromProps=function(e,a){return Object(s.__assign)(Object(s.__assign)({},a),{config:t.defaults(e.options)})},t.prototype.componentDidMount=function(){return Object(s.__awaiter)(this,void 0,void 0,function(){return Object(s.__generator)(this,function(e){return this.loadRegions(),[2]})})},t.prototype.loadRegions=function(){var e=this;Object(l.a)().loadDatasource(this.state.config.name).then(function(e){return e.getRegions()}).then(function(t){e.setState({regions:t.map(function(e){return{value:e.value,label:e.text}})})},function(t){e.setState({regions:["ap-east-1","ap-northeast-1","ap-northeast-2","ap-northeast-3","ap-south-1","ap-southeast-1","ap-southeast-2","ca-central-1","cn-north-1","cn-northwest-1","eu-central-1","eu-north-1","eu-west-1","eu-west-2","eu-west-3","me-south-1","sa-east-1","us-east-1","us-east-2","us-gov-east-1","us-gov-west-1","us-iso-east-1","us-isob-east-1","us-west-1","us-west-2"].map(function(e){return{value:e,label:e}})})})},t.prototype.render=function(){var e=this,t=this.state,a=t.config,n=t.authProviderOptions,r=t.regions;return o.a.createElement(o.a.Fragment,null,o.a.createElement("h3",{className:"page-heading"},"CloudWatch Details"),o.a.createElement("div",{className:"gf-form-group"},o.a.createElement("div",{className:"gf-form-inline"},o.a.createElement("div",{className:"gf-form"},o.a.createElement(c.FormLabel,{className:"width-14"},"Auth Provider"),o.a.createElement(c.Select,{className:"width-30",value:n.find(function(e){return e.value===a.jsonData.authType}),options:n,defaultValue:a.jsonData.authType,onChange:this.onAuthProviderChange}))),"credentials"===a.jsonData.authType&&o.a.createElement("div",{className:"gf-form-inline"},o.a.createElement("div",{className:"gf-form"},o.a.createElement(c.FormLabel,{className:"width-14",tooltip:"Credentials profile name, as specified in ~/.aws/credentials, leave blank for default."},"Credentials Profile Name"),o.a.createElement("div",{className:"width-30"},o.a.createElement(c.Input,{className:"width-30",placeholder:"default",value:a.jsonData.database,onChange:function(t){return e.onCredentialProfileNameChange(t.target.value)}})))),"keys"===a.jsonData.authType&&o.a.createElement("div",null,a.secureJsonFields.accessKey?o.a.createElement("div",{className:"gf-form-inline"},o.a.createElement("div",{className:"gf-form"},o.a.createElement(c.FormLabel,{className:"width-14"},"Access Key ID"),o.a.createElement(c.Input,{className:"width-25",placeholder:"Configured",disabled:!0})),o.a.createElement("div",{className:"gf-form"},o.a.createElement("div",{className:"max-width-30 gf-form-inline"},o.a.createElement(c.Button,{variant:"secondary",type:"button",onClick:this.onResetAccessKey},"Reset")))):o.a.createElement("div",{className:"gf-form-inline"},o.a.createElement("div",{className:"gf-form"},o.a.createElement(c.FormLabel,{className:"width-14"},"Access Key ID"),o.a.createElement("div",{className:"width-30"},o.a.createElement(c.Input,{className:"width-30",value:a.secureJsonData.accessKey||"",onChange:function(t){return e.onAccessKeyChange(t.target.value)}})))),a.secureJsonFields.secretKey?o.a.createElement("div",{className:"gf-form-inline"},o.a.createElement("div",{className:"gf-form"},o.a.createElement(c.FormLabel,{className:"width-14"},"Secret Access Key"),o.a.createElement(c.Input,{className:"width-25",placeholder:"Configured",disabled:!0})),o.a.createElement("div",{className:"gf-form"},o.a.createElement("div",{className:"max-width-30 gf-form-inline"},o.a.createElement(c.Button,{variant:"secondary",type:"button",onClick:this.onResetSecretKey},"Reset")))):o.a.createElement("div",{className:"gf-form-inline"},o.a.createElement("div",{className:"gf-form"},o.a.createElement(c.FormLabel,{className:"width-14"},"Secret Access Key"),o.a.createElement("div",{className:"width-30"},o.a.createElement(c.Input,{className:"width-30",value:a.secureJsonData.secretKey||"",onChange:function(t){return e.onSecretKeyChange(t.target.value)}}))))),"arn"===a.jsonData.authType&&o.a.createElement("div",{className:"gf-form-inline"},o.a.createElement("div",{className:"gf-form"},o.a.createElement(c.FormLabel,{className:"width-14",tooltip:"ARN of Assume Role"},"Assume Role ARN"),o.a.createElement("div",{className:"width-30"},o.a.createElement(c.Input,{className:"width-30",placeholder:"arn:aws:iam:*",value:a.jsonData.assumeRoleArn||"",onChange:function(t){return e.onArnAssumeRoleChange(t.target.value)}})))),o.a.createElement("div",{className:"gf-form-inline"},o.a.createElement("div",{className:"gf-form"},o.a.createElement(c.FormLabel,{className:"width-14",tooltip:"Specify the region, such as for US West (Oregon) use ` us-west-2 ` as the region."},"Default Region"),o.a.createElement(c.Select,{className:"width-30",value:r.find(function(e){return e.value===a.jsonData.defaultRegion}),options:r,defaultValue:a.jsonData.defaultRegion,onChange:this.onRegionChange}))),o.a.createElement("div",{className:"gf-form-inline"},o.a.createElement("div",{className:"gf-form"},o.a.createElement(c.FormLabel,{className:"width-14",tooltip:"Namespaces of Custom Metrics."},"Custom Metrics"),o.a.createElement(c.Input,{className:"width-30",placeholder:"Namespace1,Namespace2",value:a.jsonData.customMetricsNamespaces||"",onChange:function(t){return e.onCustomMetricsNamespacesChange(t.target.value)}})))))},t.defaults=function(e){return e.jsonData.authType=e.jsonData.authType||"credentials",e.jsonData.timeField=e.jsonData.timeField||"@timestamp",e.hasOwnProperty("secureJsonData")||(e.secureJsonData={}),e.hasOwnProperty("jsonData")||(e.jsonData={}),e.hasOwnProperty("secureJsonFields")||(e.secureJsonFields={}),e},t}(i.PureComponent),m={label:"-- remove stat --",value:"-- remove stat --"},p=function(e){var t=e.stats,a=e.values,n=e.onChange,r=e.variableOptionGroup;return o.a.createElement(o.a.Fragment,null,a&&a.map(function(e,i){return o.a.createElement(c.Segment,{allowCustomValue:!0,key:e+i,value:e,options:Object(s.__spread)([m],t,[r]),onChange:function(e){return n("-- remove stat --"===e?a.filter(function(e,t){return t!==i}):a.map(function(t,a){return a===i?e:t}))}})}),a.length!==t.length&&o.a.createElement(c.Segment,{Component:o.a.createElement("a",{className:"gf-form-label query-part"},o.a.createElement("i",{className:"fa fa-plus"})),allowCustomValue:!0,onChange:function(e){return n(Object(s.__spread)(a,[e]))},options:Object(s.__spread)(t.filter(function(e){var t=e.value;return!a.includes(t)}),[r])}))},d=a("Y+p1"),g=a.n(d),f={label:"-- remove dimension --",value:"-- remove dimension --"},h=function(e){var t=e.dimensions,a=e.loadValues,n=e.loadKeys,r=e.onChange,l=Object(s.__read)(Object(i.useState)(t),2),u=l[0],m=l[1];Object(i.useEffect)(function(){var e=Object.entries(u).reduce(function(e,t){var a,n=Object(s.__read)(t,2),r=n[0],i=n[1];return i?Object(s.__assign)(Object(s.__assign)({},e),((a={})[r]=i,a)):e},{});g()(e,t)||r(e)},[u]);var p=function(e){return e.filter(function(e){var t=e.value;return!Object.keys(u).includes(t)})};return o.a.createElement(o.a.Fragment,null,Object.entries(u).map(function(e,t){var r=Object(s.__read)(e,2),l=r[0],d=r[1];return o.a.createElement(i.Fragment,{key:t},o.a.createElement(c.SegmentAsync,{allowCustomValue:!0,value:l,loadOptions:function(){return n().then(function(e){return Object(s.__spread)([f],p(e))})},onChange:function(e){var t,a=l,n=(u[a],Object(s.__rest)(u,["symbol"==typeof a?a:a+""]));m("-- remove dimension --"===e?Object(s.__assign)({},n):Object(s.__assign)(Object(s.__assign)({},n),((t={})[e]="",t)))}}),o.a.createElement("label",{className:"gf-form-label query-segment-operator"},"="),o.a.createElement(c.SegmentAsync,{allowCustomValue:!0,value:d||"select dimension value",loadOptions:function(){return a(l)},onChange:function(e){var t;return m(Object(s.__assign)(Object(s.__assign)({},u),((t={})[l]=e,t)))}}),Object.values(u).length>1&&t+1!==Object.values(u).length&&o.a.createElement("label",{className:"gf-form-label query-keyword"},"AND"))}),Object.values(u).every(function(e){return e})&&o.a.createElement(c.SegmentAsync,{allowCustomValue:!0,Component:o.a.createElement("a",{className:"gf-form-label query-part"},o.a.createElement("i",{className:"fa fa-plus"})),loadOptions:function(){return n().then(p)},onChange:function(e){var t;return m(Object(s.__assign)(Object(s.__assign)({},u),((t={})[e]="",t)))}}))},v=function(e){var t=e.label,a=e.tooltip,n=e.children;return o.a.createElement(o.a.Fragment,null,o.a.createElement(c.FormLabel,{width:8,className:"query-keyword",tooltip:a},t),n)},b=function(e){var t=Object(s.__rest)(e,[]);return o.a.createElement("div",{className:"gf-form-inline"},o.a.createElement(v,Object(s.__assign)({},t)),o.a.createElement("div",{className:"gf-form gf-form--grow"},o.a.createElement("div",{className:"gf-form-label gf-form-label--grow"})))},_=a("LvDl"),O=a.n(_),j=function(e){var t=e.value,a=void 0===t?"":t,n=e.onChange,r=Object(s.__read)(Object(i.useState)(a),2),l=r[0],u=r[1],m=Object(_.debounce)(n,1500);return n=function(e){u(e.target.value),m(e.target.value)},o.a.createElement(c.Input,{type:"text",className:"gf-form-input width-16",value:l,onChange:n})},y=((n={})[c.EventsWithValidation.onBlur]=[{rule:function(e){return new RegExp(/^$|^[a-z][a-zA-Z0-9_]*$/).test(e)},errorMessage:"Invalid format. Only alphanumeric characters and underscores are allowed"}],n),E=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.state={regions:[],namespaces:[],metricNames:[],variableOptionGroup:{},showMeta:!1},t.loadMetricNames=function(){return Object(s.__awaiter)(t,void 0,void 0,function(){var e,t,a;return Object(s.__generator)(this,function(n){return e=this.props.query,t=e.namespace,a=e.region,[2,this.props.datasource.metricFindQuery("metrics("+t+","+a+")").then(this.appendTemplateVariables)]})})},t.appendTemplateVariables=function(e){return Object(s.__spread)(e,[{label:"Template Variables",options:t.props.datasource.variables.map(t.toOption)}])},t.toOption=function(e){return{label:e,value:e}},t}return Object(s.__extends)(t,e),t.prototype.componentWillMount=function(){var e=this.props.query;e.namespace||(e.namespace=""),e.metricName||(e.metricName=""),e.expression||(e.expression=""),e.dimensions||(e.dimensions={}),e.region||(e.region="default"),e.id||(e.id=""),e.alias||(e.alias=""),e.statistics&&e.statistics.length||(e.statistics=["Average"]),e.hasOwnProperty("matchExact")||(e.matchExact=!0)},t.prototype.componentDidMount=function(){var e=this,t=this.props.datasource,a={label:"Template Variables",options:this.props.datasource.variables.map(this.toOption)};Promise.all([t.metricFindQuery("regions()"),t.metricFindQuery("namespaces()")]).then(function(t){var n=Object(s.__read)(t,2),r=n[0],i=n[1];e.setState(Object(s.__assign)(Object(s.__assign)({},e.state),{regions:Object(s.__spread)(r,[a]),namespaces:Object(s.__spread)(i,[a]),variableOptionGroup:a}))})},t.prototype.onChange=function(e){var t=this.props,a=t.onChange,n=t.onRunQuery;a(e),n()},t.prototype.render=function(){var e=this,t=this.props,a=t.query,n=t.datasource,r=t.onChange,i=t.onRunQuery,l=t.data,u=this.state,m=u.regions,d=u.namespaces,g=u.variableOptionGroup,f=u.showMeta,_=l&&Object.values(l).length&&"Done"===l.state;return o.a.createElement(o.a.Fragment,null,o.a.createElement(b,{label:"Region"},o.a.createElement(c.Segment,{value:a.region||"Select region",options:m,allowCustomValue:!0,onChange:function(t){return e.onChange(Object(s.__assign)(Object(s.__assign)({},a),{region:t}))}})),0===a.expression.length&&o.a.createElement(o.a.Fragment,null,o.a.createElement(b,{label:"Namespace"},o.a.createElement(c.Segment,{value:a.namespace||"Select namespace",allowCustomValue:!0,options:d,onChange:function(t){return e.onChange(Object(s.__assign)(Object(s.__assign)({},a),{namespace:t}))}})),o.a.createElement(b,{label:"Metric Name"},o.a.createElement(c.SegmentAsync,{value:a.metricName||"Select metric name",allowCustomValue:!0,loadOptions:this.loadMetricNames,onChange:function(t){return e.onChange(Object(s.__assign)(Object(s.__assign)({},a),{metricName:t}))}})),o.a.createElement(b,{label:"Stats"},o.a.createElement(p,{stats:n.standardStatistics.map(this.toOption),values:a.statistics,onChange:function(t){return e.onChange(Object(s.__assign)(Object(s.__assign)({},a),{statistics:t}))},variableOptionGroup:g})),o.a.createElement(b,{label:"Dimensions"},o.a.createElement(h,{dimensions:a.dimensions,onChange:function(t){return e.onChange(Object(s.__assign)(Object(s.__assign)({},a),{dimensions:t}))},loadKeys:function(){return n.getDimensionKeys(a.namespace,a.region).then(e.appendTemplateVariables)},loadValues:function(t){var r=a.dimensions,i=t,o=(r[i],Object(s.__rest)(r,["symbol"==typeof i?i:i+""]));return n.getDimensionValues(a.region,a.namespace,a.metricName,t,o).then(e.appendTemplateVariables)}}))),a.statistics.length<=1&&o.a.createElement("div",{className:"gf-form-inline"},o.a.createElement("div",{className:"gf-form"},o.a.createElement(v,{className:"query-keyword",label:"Id",tooltip:"Id can include numbers, letters, and underscore, and must start with a lowercase letter."},o.a.createElement(c.Input,{className:"gf-form-input width-8",onBlur:i,onChange:function(e){return r(Object(s.__assign)(Object(s.__assign)({},a),{id:e.target.value}))},validationEvents:y,value:a.id||""}))),o.a.createElement("div",{className:"gf-form gf-form--grow"},o.a.createElement(v,{className:"gf-form--grow",label:"Expression",tooltip:"Optionally you can add an expression here. Please note that if a math expression that is referencing other queries is being used, it will not be possible to create an alert rule based on this query"},o.a.createElement(c.Input,{className:"gf-form-input",onBlur:i,value:a.expression||"",onChange:function(e){return r(Object(s.__assign)(Object(s.__assign)({},a),{expression:e.target.value}))}})))),o.a.createElement("div",{className:"gf-form-inline"},o.a.createElement("div",{className:"gf-form"},o.a.createElement(v,{className:"query-keyword",label:"Period",tooltip:"Minimum interval between points in seconds"},o.a.createElement(c.Input,{className:"gf-form-input width-8",value:a.period||"",placeholder:"auto",onBlur:i,onChange:function(e){return r(Object(s.__assign)(Object(s.__assign)({},a),{period:e.target.value}))}}))),o.a.createElement("div",{className:"gf-form"},o.a.createElement(v,{className:"query-keyword",label:"Alias",tooltip:"Alias replacement variables: {{metric}}, {{stat}}, {{namespace}}, {{region}}, {{period}}, {{label}}, {{YOUR_DIMENSION_NAME}}"},o.a.createElement(j,{value:a.alias,onChange:function(t){return e.onChange(Object(s.__assign)(Object(s.__assign)({},a),{alias:t}))}})),o.a.createElement(c.Switch,{label:"Match Exact",labelClass:"query-keyword",tooltip:"Only show metrics that exactly match all defined dimension names.",checked:a.matchExact,onChange:function(){return e.onChange(Object(s.__assign)(Object(s.__assign)({},a),{matchExact:!a.matchExact}))}}),o.a.createElement("label",{className:"gf-form-label"},o.a.createElement("a",{onClick:function(){return _&&e.setState(Object(s.__assign)(Object(s.__assign)({},e.state),{showMeta:!f}))}},o.a.createElement("i",{className:"fa fa-caret-"+(f?"down":"right")})," ",f?"Hide":"Show"," Query Preview"))),o.a.createElement("div",{className:"gf-form gf-form--grow"},o.a.createElement("div",{className:"gf-form-label gf-form-label--grow"})),f&&_&&o.a.createElement("table",{className:"filter-table form-inline"},o.a.createElement("thead",null,o.a.createElement("tr",null,o.a.createElement("th",null,"Metric Data Query ID"),o.a.createElement("th",null,"Metric Data Query Expression"),o.a.createElement("th",null))),o.a.createElement("tbody",null,l.series[0].meta.gmdMeta.map(function(e){var t=e.ID,a=e.Expression;return o.a.createElement("tr",{key:t},o.a.createElement("td",null,t),o.a.createElement("td",null,a))})))))},t}(i.PureComponent),N=a("KHwQ"),S=a.n(N),w=a("3SGO"),C=a("UvM7"),D=a("GQ3c"),R=a("iODs"),x=a("PbtU"),A=function(e){var t=e.region;return o.a.createElement("p",null,"Please visit the ",o.a.createElement("a",{target:"_blank",className:"text-link",href:"https://"+t+".console.aws.amazon.com/servicequotas/home?region="+t+"#!/services/monitoring/quotas/L-5E141212"},"AWS Service Quotas console")," to request a quota increase or see our ",o.a.createElement("a",{target:"_blank",className:"text-link",href:"https://grafana.com/docs/features/datasources/cloudwatch/#service-quotas"},"documentation")," to learn more.")},M=function(e,t){void 0===t&&(t=7e3);var a=Object(_.memoize)(function(){for(var a=[],n=0;n<arguments.length;n++)a[n]=arguments[n];return Object(_.debounce)(e,t,{leading:!0})},function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return JSON.stringify(e)});return function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return a.apply(void 0,Object(s.__spread)(e)).apply(void 0,Object(s.__spread)(e))}},q=function(e,t){return R.b.dispatch(Object(w.b)(Object(C.a)("CloudWatch request limit reached in "+t+" for data source "+e,"",o.a.createElement(A,{region:t},null))))},I=function(e,t){return R.b.dispatch(Object(w.b)(Object(C.a)(e,t)))},F=function(e){function t(t,a,n,r,s){var i=e.call(this,t)||this;return i.$q=a,i.backendSrv=n,i.templateSrv=r,i.timeSrv=s,i.type="cloudwatch",i.proxyUrl=t.url,i.defaultRegion=t.jsonData.defaultRegion,i.datasourceName=t.name,i.standardStatistics=["Average","Maximum","Minimum","Sum","SampleCount"],i.debouncedAlert=M(q,D.AppNotificationTimeout.Error),i.debouncedCustomAlert=M(I,D.AppNotificationTimeout.Error),i}return t.$inject=["instanceSettings","$q","backendSrv","templateSrv","timeSrv"],Object(s.__extends)(t,e),t.prototype.query=function(e){var t=this;e=S.a.copy(e);var a=O.a.filter(e.targets,function(e){return(""!==e.id||!0!==e.hide)&&(!!e.region&&!!e.namespace&&!!e.metricName&&!O.a.isEmpty(e.statistics)||e.expression.length>0)}).map(function(a){if(a.region=t.replace(t.getActualRegion(a.region),e.scopedVars,!0,"region"),a.namespace=t.replace(a.namespace,e.scopedVars,!0,"namespace"),a.metricName=t.replace(a.metricName,e.scopedVars,!0,"metric name"),a.dimensions=t.convertDimensionFormat(a.dimensions,e.scopedVars),a.statistics=a.statistics.map(function(a){return t.replace(a,e.scopedVars,!0,"statistics")}),a.period=String(t.getPeriod(a,e)),a.id=t.replace(a.id,e.scopedVars,!0,"id"),a.expression=t.replace(a.expression,e.scopedVars,!0,"expression"),a.statistics.some(function(e){if(0===e.indexOf("p")){var t=/^p\d{2}(?:\.\d{1,2})?$/.exec(e);return!t||t[0]!==e}return!1}))throw{message:"Invalid extended statistics"};return O.a.extend({refId:a.refId,intervalMs:e.intervalMs,maxDataPoints:e.maxDataPoints,datasourceId:t.id,type:"timeSeriesQuery"},a)});if(O.a.isEmpty(a)){var n=this.$q.defer();return n.resolve({data:[]}),n.promise}var r={from:e.range.from.valueOf().toString(),to:e.range.to.valueOf().toString(),queries:a};return this.performTimeSeriesQuery(r,e.range)},Object.defineProperty(t.prototype,"variables",{get:function(){return this.templateSrv.variables.map(function(e){return"$"+e.name})},enumerable:!0,configurable:!0}),t.prototype.getPeriod=function(e,t,a){var n,r=this.convertToCloudWatchTime(t.range.from,!1);a=Math.round((a||Date.now())/1e3);return e.period?(n=this.templateSrv.replace(e.period,t.scopedVars),n=/^\d+$/.test(n)?parseInt(n,10):x.a.interval_to_seconds(n)):n=a-r<=1296e3?"AWS/EC2"===e.namespace?300:60:a-r<=5443200?300:3600,n<1&&(n=1),n},t.prototype.buildCloudwatchConsoleUrl=function(e,t,a,n,r){var i=e.region,o=e.namespace,c=e.metricName,l=e.dimensions,u=e.statistics,m=e.period,p=e.expression,d={view:"timeSeries",stacked:!1,title:n,start:t,end:a,region:i=this.getActualRegion(i)},g=r&&r.length&&r.every(function(e){var t=e.Expression;return/SEARCH().*/.test(t)});if(!g&&p)return"";if(g){var f=r&&r.length?r.map(function(e){return{expression:e.Expression}}):[{expression:p}];d=Object(s.__assign)(Object(s.__assign)({},d),{metrics:f})}else d=Object(s.__assign)(Object(s.__assign)({},d),{metrics:Object(s.__spread)(u.map(function(e){return Object(s.__spread)([o,c],Object.entries(l).reduce(function(e,t){var a=Object(s.__read)(t,2),n=a[0],r=a[1];return Object(s.__spread)(e,[n,r[0]])},[]),[{stat:e,period:m}])}))});return"https://"+i+".console.aws.amazon.com/cloudwatch/deeplink.js?region="+i+"#metricsV2:graph="+encodeURIComponent(JSON.stringify(d))},t.prototype.performTimeSeriesQuery=function(e,t){var a=this,n=t.from,i=t.to;return this.awsRequest("/api/tsdb/query",e).then(function(t){return t.results?Object.values(e.queries).reduce(function(e,o){var c=e.data,l=e.error,u=t.results[o.refId];if(!u)return{data:c,error:l};var m=a.buildCloudwatchConsoleUrl(o,n.toISOString(),i.toISOString(),o.refId,u.meta.gmdMeta);return{error:l||u.error?{message:u.error}:null,data:Object(s.__spread)(c,u.series.map(function(e){var t,a,n=e.name,i=e.points,c=Object(r.toDataFrame)({target:n,datapoints:i,refId:o.refId,meta:u.meta});if(m)try{for(var l=Object(s.__values)(c.fields),p=l.next();!p.done;p=l.next()){p.value.config.links=[{url:m,title:"View in CloudWatch console",targetBlank:!0}]}}catch(e){t={error:e}}finally{try{p&&!p.done&&(a=l.return)&&a.call(l)}finally{if(t)throw t.error}}return c}))}},{data:[],error:null}):{data:[]}}).catch(function(t){if(void 0===t&&(t={data:{error:""}}),/^Throttling:.*/.test(t.data.message)){var n=Object.keys(t.data.results);Object.values(e.queries).reduce(function(e,t){var a=t.refId,r=t.region;return!n.includes(a)||e.includes(r)?e:Object(s.__spread)(e,[r])},[]).forEach(function(e){return a.debouncedAlert(a.datasourceName,a.getActualRegion(e))})}throw t.data&&"Metric request error"===t.data.message&&t.data.error&&(t.data.message=t.data.error),t})},t.prototype.transformSuggestDataFromTable=function(e){return O.a.map(e.results.metricFindQuery.tables[0].rows,function(e){return{text:e[0],value:e[1],label:e[1]}})},t.prototype.doMetricQueryRequest=function(e,t){var a=this,n=this.timeSrv.timeRange();return this.awsRequest("/api/tsdb/query",{from:n.from.valueOf().toString(),to:n.to.valueOf().toString(),queries:[O.a.extend({refId:"metricFindQuery",intervalMs:1,maxDataPoints:1,datasourceId:this.id,type:"metricFindQuery",subtype:e},t)]}).then(function(e){return a.transformSuggestDataFromTable(e)})},t.prototype.getRegions=function(){return this.doMetricQueryRequest("regions",null).then(function(e){return Object(s.__spread)([{label:"default",value:"default",text:"default"}],e)})},t.prototype.getNamespaces=function(){return this.doMetricQueryRequest("namespaces",null)},t.prototype.getMetrics=function(e,t){return Object(s.__awaiter)(this,void 0,void 0,function(){return Object(s.__generator)(this,function(a){return e&&t?[2,this.doMetricQueryRequest("metrics",{region:this.templateSrv.replace(this.getActualRegion(t)),namespace:this.templateSrv.replace(e)})]:[2,[]]})})},t.prototype.getDimensionKeys=function(e,t){return Object(s.__awaiter)(this,void 0,void 0,function(){return Object(s.__generator)(this,function(a){return e?[2,this.doMetricQueryRequest("dimension_keys",{region:this.templateSrv.replace(this.getActualRegion(t)),namespace:this.templateSrv.replace(e)})]:[2,[]]})})},t.prototype.getDimensionValues=function(e,t,a,n,r){return Object(s.__awaiter)(this,void 0,void 0,function(){var i;return Object(s.__generator)(this,function(o){switch(o.label){case 0:return t&&a?[4,this.doMetricQueryRequest("dimension_values",{region:this.templateSrv.replace(this.getActualRegion(e)),namespace:this.templateSrv.replace(t),metricName:this.templateSrv.replace(a.trim()),dimensionKey:this.templateSrv.replace(n),dimensions:this.convertDimensionFormat(r,{})})]:[2,[]];case 1:return[2,(i=o.sent()).length?Object(s.__spread)([{value:"*",text:"*",label:"*"}],i):i]}})})},t.prototype.getEbsVolumeIds=function(e,t){return this.doMetricQueryRequest("ebs_volume_ids",{region:this.templateSrv.replace(this.getActualRegion(e)),instanceId:this.templateSrv.replace(t)})},t.prototype.getEc2InstanceAttribute=function(e,t,a){return this.doMetricQueryRequest("ec2_instance_attribute",{region:this.templateSrv.replace(this.getActualRegion(e)),attributeName:this.templateSrv.replace(t),filters:a})},t.prototype.getResourceARNs=function(e,t,a){return this.doMetricQueryRequest("resource_arns",{region:this.templateSrv.replace(this.getActualRegion(e)),resourceType:this.templateSrv.replace(t),tags:a})},t.prototype.metricFindQuery=function(e){return Object(s.__awaiter)(this,void 0,void 0,function(){var t,a,n,r,i,o,c,l,u,m,p,d,g,f,h;return Object(s.__generator)(this,function(s){return e.match(/^regions\(\)/)?[2,this.getRegions()]:e.match(/^namespaces\(\)/)?[2,this.getNamespaces()]:(i=e.match(/^metrics\(([^\)]+?)(,\s?([^,]+?))?\)/))?(a=i[1],t=i[3],[2,this.getMetrics(a,t)]):(o=e.match(/^dimension_keys\(([^\)]+?)(,\s?([^,]+?))?\)/))?(a=o[1],t=o[3],[2,this.getDimensionKeys(a,t)]):(c=e.match(/^dimension_values\(([^,]+?),\s?([^,]+?),\s?([^,]+?),\s?([^,]+?)(,\s?(.+))?\)/))?(t=c[1],a=c[2],n=c[3],l=c[4],r={},c[6]&&(r=JSON.parse(this.templateSrv.replace(c[6]))),[2,this.getDimensionValues(t,a,n,l,r)]):(u=e.match(/^ebs_volume_ids\(([^,]+?),\s?([^,]+?)\)/))?(t=u[1],m=u[2],[2,this.getEbsVolumeIds(t,m)]):(p=e.match(/^ec2_instance_attribute\(([^,]+?),\s?([^,]+?),\s?(.+?)\)/))?(t=p[1],d=p[2],r=JSON.parse(this.templateSrv.replace(p[3])),[2,this.getEc2InstanceAttribute(t,d,r)]):(g=e.match(/^resource_arns\(([^,]+?),\s?([^,]+?),\s?(.+?)\)/))?(t=g[1],f=g[2],h=JSON.parse(this.templateSrv.replace(g[3])),[2,this.getResourceARNs(t,f,h)]):e.match(/^statistics\(\)/)?[2,this.standardStatistics.map(function(e){return{value:e,label:e,text:e}})]:[2,this.$q.when([])]})})},t.prototype.annotationQuery=function(e){var t=this,a=e.annotation,n=O.a.map(a.statistics,function(e){return t.templateSrv.replace(e)}),r=a.prefixMatching?"":"300",s=a.period||r;s=parseInt(s,10);var i={prefixMatching:a.prefixMatching,region:this.templateSrv.replace(this.getActualRegion(a.region)),namespace:this.templateSrv.replace(a.namespace),metricName:this.templateSrv.replace(a.metricName),dimensions:this.convertDimensionFormat(a.dimensions,{}),statistics:n,period:s,actionPrefix:a.actionPrefix||"",alarmNamePrefix:a.alarmNamePrefix||""};return this.awsRequest("/api/tsdb/query",{from:e.range.from.valueOf().toString(),to:e.range.to.valueOf().toString(),queries:[O.a.extend({refId:"annotationQuery",intervalMs:1,maxDataPoints:1,datasourceId:this.id,type:"annotationQuery"},i)]}).then(function(e){return O.a.map(e.results.annotationQuery.tables[0].rows,function(e){return{annotation:a,time:Date.parse(e[0]),title:e[1],tags:[e[2]],text:e[3]}})})},t.prototype.targetContainsTemplate=function(e){var t=this;return this.templateSrv.variableExists(e.region)||this.templateSrv.variableExists(e.namespace)||this.templateSrv.variableExists(e.metricName)||O.a.find(e.dimensions,function(e,a){return t.templateSrv.variableExists(a)||t.templateSrv.variableExists(e)})},t.prototype.testDatasource=function(){var e=this.defaultRegion;return this.getDimensionValues(e,"AWS/Billing","EstimatedCharges","ServiceName",{}).then(function(){return{status:"success",message:"Data source is working"}})},t.prototype.awsRequest=function(e,t){var a={method:"POST",url:e,data:t};return this.backendSrv.datasourceRequest(a).then(function(e){return e.data})},t.prototype.getDefaultRegion=function(){return this.defaultRegion},t.prototype.getActualRegion=function(e){return"default"===e||O.a.isEmpty(e)?this.getDefaultRegion():e},t.prototype.convertToCloudWatchTime=function(e,t){return O.a.isString(e)&&(e=r.dateMath.parse(e,t)),Math.round(e.valueOf()/1e3)},t.prototype.convertDimensionFormat=function(e,t){var a=this;return Object.entries(e).reduce(function(e,n){var r,i,o,c,l=Object(s.__read)(n,2),u=l[0],m=l[1];if(u=a.replace(u,t,!0,"dimension keys"),Array.isArray(m))return Object(s.__assign)(Object(s.__assign)({},e),((r={})[u]=m,r));var p=a.templateSrv.variables.find(function(e){return e.name===a.templateSrv.getVariableName(m)});if(p){if(p.multi){var d=a.templateSrv.replace(m,t,"pipe").split("|");return Object(s.__assign)(Object(s.__assign)({},e),((i={})[u]=d,i))}return Object(s.__assign)(Object(s.__assign)({},e),((o={})[u]=[a.templateSrv.replace(m,t)],o))}return Object(s.__assign)(Object(s.__assign)({},e),((c={})[u]=[m],c))},{})},t.prototype.replace=function(e,t,a,n){var r=this;if(a){var s=this.templateSrv.variables.find(function(t){return t.name===r.templateSrv.getVariableName(e)});s&&s.multi&&this.debouncedCustomAlert("CloudWatch templating error","Multi template variables are not supported for "+(n||e))}return this.templateSrv.replace(e,t)},t}(r.DataSourceApi);a.d(t,"plugin",function(){return V});var k=function(){function e(){}return e.templateUrl="partials/annotations.editor.html",e}(),V=new r.DataSourcePlugin(F).setConfigEditor(u).setQueryEditor(E).setAnnotationQueryCtrl(k)}}]);
//# sourceMappingURL=cloudwatchPlugin.fabf58cbd84a6ac3523b.js.map